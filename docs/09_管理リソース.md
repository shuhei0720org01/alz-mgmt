# 09. 管理リソース - 監視とログの基盤

## 8つの設計領域との対応

このChapterは以下の設計領域を実装します：
- ✅ **6. Management and Monitoring**（管理と監視 - Log Analytics、DCR）
- ✅ **5. Security**（セキュリティ - セキュリティ監視）
- ✅ **2. Identity and Access Management**（ID管理 - Managed Identity）

→ Chapter 01で学んだ8つの設計領域を復習したい方は[01_基礎知識.md](./01_基礎知識.md)へ

---

## このChapterでやること

管理リソースの作成を理解しよう。

**管理リソースって何？**
監視、ログ収集、自動化のためのリソース。

**主な構成要素**：
1. **Log Analytics Workspace**：ログの保管庫
2. **Data Collection Rule（DCR）**：ログ収集のルール
3. **Managed Identity**：自動化用のID

**例えるなら**：
- **Log Analytics**：図書館（本を保管）
- **DCR**：司書（どの本をどう整理するか）
- **Managed Identity**：図書館カード（本を借りる権限）

---

## 管理リソースの役割

### なんで必要なの？

**シナリオ1：セキュリティ監視**
```
VM作成
  ↓
Defender for Cloudが「このVMにエージェント入れて」
  ↓
でもどこにログ送るの？ ← Log Analytics必要
  ↓
どうやってエージェント入れるの？ ← Managed Identity必要
```

**シナリオ2：コンプライアンス**
```
ポリシー：「全VMはログをLog Analyticsに送信」
  ↓
でもワークスペースがない ← 作っとかないとダメ
```

**シナリオ3：トラブルシューティング**
```
VMが遅い
  ↓
ログを見たい
  ↓
Log Analyticsでクエリ実行
  ↓
原因特定
```

---

## Part 1: 設定ファイル（tfvars）

### management_resource_settings

Chapter 3で見たこれ：

```hcl
management_resource_settings = {
  enabled                      = true
  location                     = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name          = "$${management_resource_group_name}"
  
  user_assigned_managed_identities = {
    ama = {
      name = "$${ama_user_assigned_managed_identity_name}"
    }
  }
  
  data_collection_rules = {
    change_tracking = {
      name = "$${dcr_change_tracking_name}"
    }
    defender_sql = {
      name = "$${dcr_defender_sql_name}"
    }
    vm_insights = {
      name = "$${dcr_vm_insights_name}"
    }
  }
}
```

**テンプレート処理後**：
```hcl
management_resource_settings = {
  enabled                      = true
  location                     = "japaneast"
  log_analytics_workspace_name = "law-management-japaneast"
  resource_group_name          = "rg-management"
  
  user_assigned_managed_identities = {
    ama = {
      name = "id-ama-japaneast"
    }
  }
  
  data_collection_rules = {
    change_tracking = {
      name = "dcr-change-tracking"
    }
    defender_sql = {
      name = "dcr-defender-sql"
    }
    vm_insights = {
      name = "dcr-vm-insights"
    }
  }
}
```

### フィールド解説

#### enabled
```hcl
enabled = true
```

**何？**：管理リソース作成の有効/無効

- `true`：作る
- `false`：作らない（既存使う）

#### location
```hcl
location = "japaneast"
```

**何？**：リソースの場所

Log Analyticsワークスペースの場所。

#### log_analytics_workspace_name
```hcl
log_analytics_workspace_name = "law-management-japaneast"
```

**何？**：Log Analyticsワークスペースの名前

**命名規則**：
- `law-`：Log Analytics Workspaceの略
- `management`：用途
- `japaneast`：場所

#### resource_group_name
```hcl
resource_group_name = "rg-management"
```

**何？**：管理リソース用のリソースグループ名

このRGの中に全部入れる：
- Log Analytics Workspace
- Data Collection Rules
- Managed Identity

#### user_assigned_managed_identities
```hcl
user_assigned_managed_identities = {
  ama = {
    name = "id-ama-japaneast"
  }
}
```

**何？**：Azure Monitor Agent（AMA）用のManaged Identity

**AMAって何？**
VMにインストールするエージェント。ログとかメトリクスを収集してLog Analyticsに送る。

**Managed Identityの役割**：
```
VM
  ↓ AMAインストール
VM（AMA付き）
  ↓ Managed Identity使って認証
Log Analytics Workspace
  ↓ ログ送信
ログが保存される
```

パスワード不要で認証できるのが便利。

#### data_collection_rules
```hcl
data_collection_rules = {
  change_tracking = { name = "dcr-change-tracking" }
  defender_sql    = { name = "dcr-defender-sql" }
  vm_insights     = { name = "dcr-vm-insights" }
}
```

**何？**：データ収集ルール（DCR）

**3種類のDCR**：

##### 1. change_tracking
```
「ファイルやレジストリの変更を追跡」
```

**使い道**：
- 誰かがファイル削除した？
- 設定変更された？
- 不審なプログラムインストールされた？

##### 2. defender_sql
```
「SQL Serverのセキュリティログ収集」
```

**使い道**：
- 不正アクセス検知
- 脆弱性スキャン
- コンプライアンス監査

##### 3. vm_insights
```
「VMのパフォーマンスとヘルス監視」
```

**使い道**：
- CPU使用率
- メモリ使用率
- ディスクI/O
- ネットワーク帯域

---

## Part 2: モジュール呼び出し（main.management.tf）

### management_resources モジュール

```hcl
module "management_resources" {
  source = "./modules/management_resources"

  count = var.management_resources_enabled ? 1 : 0

  enable_telemetry             = var.enable_telemetry
  management_resource_settings = local.management_resource_settings

  providers = {
    azurerm = azurerm.management
  }
}
```

#### count
```hcl
count = var.management_resources_enabled ? 1 : 0
```

**何してる？**
管理リソース作成の有効/無効を切り替え。

**使い道**：
```hcl
# tfvars
management_resources_enabled = false  # ←管理リソース作らない
```

#### providers
```hcl
providers = {
  azurerm = azurerm.management
}
```

**何してる？**
Managementサブスクリプションにリソース作成。

### modules/management_resources/main.tf

```hcl
module "management_resources" {
  source  = "Azure/avm-ptn-alz-management/azurerm"
  version = "0.9.0"
  
  location                     = var.management_resource_settings.location
  log_analytics_workspace_name = coalesce(var.management_resource_settings.log_analytics_workspace_name, "law-management-${var.management_resource_settings.location}")
  resource_group_name          = coalesce(var.management_resource_settings.resource_group_name, "rg-management-${var.management_resource_settings.location}")
  
  data_collection_rules                = var.management_resource_settings.data_collection_rules
  user_assigned_managed_identities     = var.management_resource_settings.user_assigned_managed_identities
  
  resource_group_creation_enabled      = true
  linked_automation_account_creation_enabled = false
  ...
}
```

**Azure公式モジュール**を使ってる。

#### coalesce
```hcl
log_analytics_workspace_name = coalesce(
  var.management_resource_settings.log_analytics_workspace_name,
  "law-management-${var.management_resource_settings.location}"
)
```

**何してる？**
- 名前が指定されてればそれを使う
- 指定されてなければデフォルト名を使う

**例**：
```hcl
# 指定あり
log_analytics_workspace_name = "my-custom-law"
# ↓
結果：my-custom-law

# 指定なし
log_analytics_workspace_name = null
# ↓
結果：law-management-japaneast
```

#### resource_group_creation_enabled
```hcl
resource_group_creation_enabled = true
```

**何してる？**
リソースグループも自動で作る。

```
モジュール実行
  ↓
1. rg-management作成
  ↓
2. Log Analytics Workspace作成
  ↓
3. DCR作成
  ↓
4. Managed Identity作成
```

#### linked_automation_account_creation_enabled
```hcl
linked_automation_account_creation_enabled = false
```

**何してる？**
Automation Accountを作らない。

**Automation Accountって何？**
VMの自動パッチ適用とか自動化タスク用。

今回は不要だから`false`。

---

## Part 3: 各リソースの詳細

### Log Analytics Workspace

#### 何ができる？

**1. ログの保管**
```
全てのログをここに集約
- VMのログ
- Firewallのログ
- NSGのフローログ
- Azure ADのサインインログ
```

**2. クエリ実行**
```kql
// 過去24時間のエラーログ
AzureDiagnostics
| where TimeGenerated > ago(24h)
| where Level == "Error"
| summarize count() by Resource
```

**KQL（Kusto Query Language）**でクエリ書ける。めっちゃ強力。

**3. アラート作成**
```
「エラーが10件/分を超えたら通知」
「CPU使用率が80%超えたら通知」
```

#### 設定項目

##### retention_in_days
```hcl
log_analytics_workspace_retention_in_days = 30
```

**何？**：ログの保持期間

- 30日：デフォルト（無料）
- 31日以上：課金あり

**コスト削減技**：
```hcl
# 開発環境
retention_in_days = 30  # 最小

# 本番環境（コンプライアンス要件）
retention_in_days = 365  # 1年保管
```

##### daily_quota_gb
```hcl
log_analytics_workspace_daily_quota_gb = 10
```

**何？**：1日のログ取り込み上限

**使い道**：
```
ログが爆発的に増えた時の防御策
→ クォータに達したらそれ以上取り込まない
→ 課金の暴走を防ぐ
```

**注意**：
クォータに達すると**ログが取り込まれない**から、重要なログが欠損する可能性あり。

##### sku
```hcl
log_analytics_workspace_sku = "PerGB2018"
```

**何？**：料金プラン

- `PerGB2018`：従量課金（一般的）
- `CapacityReservation`：コミットメント（大量利用で割引）

**料金**：
```
PerGB2018：約500円/GB
CapacityReservation：100GB/日から（割引率あり）
```

### Data Collection Rule（DCR）

#### 何してる？

**「どのデータをどう集めるか」のルール**

**構成要素**：
1. **Data Sources**：何を集めるか
2. **Destinations**：どこに送るか
3. **Data Flows**：どう処理するか

#### change_tracking DCR

```
収集するデータ：
- ファイルの変更
- レジストリの変更
- Windowsサービスの変更
- Linuxデーモンの変更
```

**使用例**：
```kql
// 過去24時間に変更されたファイル
ConfigurationChange
| where TimeGenerated > ago(24h)
| where ConfigChangeType == "Files"
| project Computer, FileName, FileSystemPath, TimeGenerated
```

#### defender_sql DCR

```
収集するデータ：
- SQL Serverのセキュリティイベント
- 脆弱性スキャン結果
- 脅威検出アラート
```

**使用例**：
```kql
// SQLの不審なアクセス
SecurityAlert
| where TimeGenerated > ago(24h)
| where AlertType contains "SQL"
| project AlertName, Severity, Entities, TimeGenerated
```

#### vm_insights DCR

```
収集するデータ：
- パフォーマンスカウンター（CPU、メモリ、ディスク、ネットワーク）
- プロセス情報
- ネットワーク接続
```

**使用例**：
```kql
// CPU使用率が高いVM
Perf
| where TimeGenerated > ago(1h)
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| where CounterValue > 80
| summarize avg(CounterValue) by Computer
```

### Managed Identity

#### 何ができる？

**パスワード不要の認証**

**従来の方法**：
```
VMにエージェントインストール
  ↓
設定ファイルに書く：
  username: admin
  password: P@ssw0rd123
  ↓
問題：
- パスワード漏洩リスク
- ローテーション面倒
- 設定ファイルに平文で書くのは危険
```

**Managed Identityの方法**：
```
VMにManaged Identity割り当て
  ↓
エージェントはManaged Identityで認証
  ↓
Azureが自動で認証トークン発行
  ↓
パスワード不要！
```

#### 種類

##### System-assigned（システム割り当て）
```
VMに1対1で紐付く
VMを削除 → Managed Identityも削除
```

##### User-assigned（ユーザー割り当て）
```
独立して存在
複数のVMで共有できる
VMを削除してもManaged Identityは残る
```

**このプロジェクトではUser-assigned**を使ってる。

#### 使われ方

```
1. Managed Identity作成
   id-ama-japaneast

2. VMにManaged Identity割り当て
   VM → id-ama-japaneastを使う

3. Managed IdentityにLog Analytics書き込み権限付与
   id-ama-japaneast → Log Analytics Contributor

4. VMのAMAがManaged Identityで認証
   AMA → id-ama-japaneastのトークン取得
        → Log Analyticsにログ送信
```

---

## Part 4: ポリシーとの連携

### policy_default_values

Chapter 8で見たこれ：

```hcl
policy_default_values = {
  ama_change_tracking_data_collection_rule_id = "$${ama_change_tracking_data_collection_rule_id}"
  ama_user_assigned_managed_identity_id       = "$${ama_user_assigned_managed_identity_id}"
  log_analytics_workspace_id                  = "$${log_analytics_workspace_id}"
}
```

**何をしているのでしょうか？**
管理リソースのIDをポリシーに渡しています。

### どう使われる？

**シナリオ：VMにAMAをデプロイするポリシー**

```
1. ポリシー「VMを作ったらAMAインストール」が発動

2. ポリシーがManaged IdentityのIDを取得
   → policy_default_values.ama_user_assigned_managed_identity_id

3. ポリシーがDCRのIDを取得
   → policy_default_values.ama_change_tracking_data_collection_rule_id

4. VMにAMAインストール + Managed Identity割り当て + DCR関連付け

5. 完了：VMが自動でログ送信開始
```

**自動化されてるのが便利**。

---

## 実践：カスタマイズしてみよう

### 例1: 保持期間の変更

```hcl
# platform-landing-zone.auto.tfvars
management_resource_settings = {
  ...
  log_analytics_workspace_retention_in_days = 90  # 90日保管
}
```

**コスト試算**：
```
30日：無料
90日：約30円/GB（追加60日分）
```

### 例2: 複数のManaged Identity

```hcl
user_assigned_managed_identities = {
  ama = {
    name = "id-ama-japaneast"
  }
  automation = {
    name = "id-automation-japaneast"
  }
  backup = {
    name = "id-backup-japaneast"
  }
}
```

**使い分け**：
- `ama`：Azure Monitor Agent用
- `automation`：自動化スクリプト用
- `backup`：バックアップ処理用

### 例3: カスタムDCR

```hcl
data_collection_rules = {
  change_tracking = {
    name = "dcr-change-tracking"
  }
  custom_app_logs = {
    name = "dcr-custom-app"
    # カスタムアプリのログ収集ルール
  }
}
```

---

## デバッグ技

### Log Analyticsの確認

```bash
# ワークスペース一覧
az monitor log-analytics workspace list --output table

# 特定のワークスペースの詳細
az monitor log-analytics workspace show \
  --resource-group rg-management \
  --workspace-name law-management-japaneast
```

Azureポータル：
```
Log Analytics workspaces → law-management-japaneast
  ↓
Logs → KQLクエリ実行
  ↓
結果表示
```

### DCRの確認

```bash
# DCR一覧
az monitor data-collection rule list --output table

# 特定のDCRの詳細
az monitor data-collection rule show \
  --resource-group rg-management \
  --name dcr-change-tracking
```

### Managed Identityの確認

```bash
# Managed Identity一覧
az identity list --output table

# 特定のManaged Identityの詳細
az identity show \
  --resource-group rg-management \
  --name id-ama-japaneast
```

### ログの確認

```kql
// Heartbeat（VM生存確認）
Heartbeat
| where TimeGenerated > ago(1h)
| summarize count() by Computer

// パフォーマンスデータ
Perf
| where TimeGenerated > ago(1h)
| where ObjectName == "Processor"
| summarize avg(CounterValue) by Computer

// セキュリティイベント
SecurityEvent
| where TimeGenerated > ago(24h)
| where EventID == 4625  // ログイン失敗
| summarize count() by Account
```

---

## よくあるエラー

### エラー1: ワークスペース名の重複

```
Error: A workspace with the name 'law-management-japaneast' already exists
```

**原因**：同じ名前のワークスペースが既に存在

**対処法**：
```hcl
# 名前を変える
log_analytics_workspace_name = "law-management-japaneast-v2"

# または既存を削除
az monitor log-analytics workspace delete \
  --resource-group rg-management \
  --workspace-name law-management-japaneast
```

### エラー2: クォータ超過

```
Warning: Daily cap of 10 GB reached
```

**原因**：1日のログ取り込み量がクォータに達した

**対処法**：
```hcl
# クォータ引き上げ
log_analytics_workspace_daily_quota_gb = 50

# またはログ量を削減（不要なログを無効化）
```

### エラー3: Managed Identityの権限不足

```
Error: Managed Identity does not have permission to write to Log Analytics
```

**原因**：Managed Identityに権限が付与されてない

**対処法**：
```bash
# Log Analytics Contributor権限付与
az role assignment create \
  --assignee <managed-identity-principal-id> \
  --role "Log Analytics Contributor" \
  --scope <log-analytics-workspace-id>
```

---

## コスト最適化

### コスト構造

**Log Analytics**：
```
取り込み：約500円/GB
保持（31日以降）：約15円/GB/月
クエリ：基本無料（大量実行は課金）
```

**DCR**：
```
無料（データ処理量に応じた課金なし）
```

**Managed Identity**：
```
無料
```

### コスト削減技

#### 1. 不要なログを無効化

```hcl
# Defender for SQLが不要なら無効化
data_collection_rules = {
  change_tracking = { ... }
  # defender_sql = { ... }  # ←コメントアウト
  vm_insights = { ... }
}
```

#### 2. サンプリング

```
全ログを取り込まない
→ 1%だけサンプリング
→ コスト1/100
```

**注意**：詳細な分析はできなくなる。

#### 3. 保持期間の最適化

```hcl
# 開発環境：30日（無料）
log_analytics_workspace_retention_in_days = 30

# 本番環境：コンプライアンス要件に応じて
log_analytics_workspace_retention_in_days = 90
```

#### 4. クォータ設定

```hcl
# 暴走防止
log_analytics_workspace_daily_quota_gb = 10
```

---

## まとめ

**管理リソースの役割**：
1. **Log Analytics Workspace**：ログの中央集約
2. **Data Collection Rule**：ログ収集のルール定義
3. **Managed Identity**：パスワード不要の認証

**覚えておくこと**：
- Log Analyticsは全ての監視の基盤
- DCRでログ収集をカスタマイズ
- Managed Identityでセキュアな認証
- ポリシーと連携して自動デプロイ
- KQLでログをクエリ

次のChapterでは、Hub-and-Spokeネットワークの構築を見ていきます。
実際のネットワークリソース（VNet、Firewall、Bastion）を作るよ。

---

**所要時間**: 45分  
**難易度**: ★★★★☆  
**前**: [08_管理グループとポリシー.md](./08_管理グループとポリシー.md)  
**次**: [10_Hub-and-Spoke.md](./10_Hub-and-Spoke.md)
