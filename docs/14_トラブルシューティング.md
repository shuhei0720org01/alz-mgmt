# 14. トラブルシューティング - よくある問題と解決法

## このChapterでやること

実際にハマりやすい問題とその対処法を見ていきましょう。

**デプロイ中に起こりやすいトラブル**：
- OIDC認証エラー
- Terraform State関連
- 権限エラー
- リソース作成エラー
- GitHub Actionsエラー

**このChapterがあれば**：
```
エラー発生
  ↓
このChapterで検索
  ↓
原因と対処法がわかる
  ↓
解決
```

---

## カテゴリ別トラブル

### 1. 認証エラー

#### エラー1-1: OIDC認証失敗（GitHub Actions）

**エラーメッセージ**：
```
Error: Unable to get ACTIONS_ID_TOKEN_REQUEST_URL env variable
```

**原因**：
```
permissions設定がない
  ↓
OIDCトークンが取得できない
```

**対処法**：
```yaml
# .github/workflows/ci.yaml
jobs:
  validate_and_plan:
    permissions:
      id-token: write  # ←これ必須
      contents: read
      pull-requests: write
```

#### エラー1-2: OIDC Issuer Mismatch

**エラーメッセージ**：
```
Error: AADSTS70021: No matching federated identity record found
```

**原因**：
```
Federated Credentialの設定が間違ってる
  ↓
subject（リポジトリパス）が違う
```

**確認**：
```bash
az ad app federated-credential list --id $APP_ID
```

**修正**：
```bash
# 間違ったCredentialを削除
az ad app federated-credential delete \
  --id $APP_ID \
  --federated-credential-id <CREDENTIAL_ID>

# 正しいものを作成
az ad app federated-credential create \
  --id $APP_ID \
  --parameters '{
    "name": "github-actions-main",
    "issuer": "https://token.actions.githubusercontent.com",
    "subject": "repo:your-username/alz-mgmt:ref:refs/heads/main",
    "audiences": ["api://AzureADTokenExchange"]
  }'
```

**subject確認**：
```
repo:<GitHubユーザー名>/<リポジトリ名>:ref:refs/heads/<ブランチ名>

例：
repo:shuhei0720org01/alz-mgmt:ref:refs/heads/main
```

#### エラー1-3: Azure Login失敗（ローカル）

**エラーメッセージ**：
```
Error: No subscriptions found for <user@example.com>
```

**原因**：
```
ログインしたアカウントにSubscriptionがない
  ↓
または
  ↓
正しくログインできてない
```

**対処法**：
```bash
# 再ログイン
az logout
az login

# Subscription確認
az account list --output table

# 特定のTenantでログイン
az login --tenant <TENANT_ID>
```

#### エラー1-4: Service Principal権限不足

**エラーメッセージ**：
```
Error: insufficient privileges to complete the operation
```

**原因**：
```
Service PrincipalにOwner権限がない
  ↓
Management Group作成
Policy割り当て
などができない
```

**対処法**：
```bash
# 現在の権限確認
az role assignment list \
  --assignee $APP_ID \
  --all \
  --output table

# Owner権限付与（Subscription）
az role assignment create \
  --assignee $APP_ID \
  --role "Owner" \
  --scope "/subscriptions/$SUBSCRIPTION_ID"

# Management Group Root Scopeに権限付与（必要な場合）
az role assignment create \
  --assignee $APP_ID \
  --role "Owner" \
  --scope "/providers/Microsoft.Management/managementGroups/$ROOT_MG_ID"
```

---

### 2. Terraform State関連

#### エラー2-1: State Lock取得失敗

**エラーメッセージ**：
```
Error: Error acquiring the state lock
Lock Info:
  ID:        abc123-def456-...
  Path:      alz-mgmt.tfstate
  Operation: OperationTypeApply
  Who:       GitHub Actions
  Created:   2026-01-16 10:00:00 UTC
```

**原因**：
```
前回のterraform実行が途中で止まった
  ↓
Lockが残ってる
  ↓
次の実行がブロックされる
```

**対処法1（推奨）**：ロック解除
```bash
# ロックID確認（エラーメッセージから）
LOCK_ID="abc123-def456-..."

# ロック解除
terraform force-unlock $LOCK_ID
```

**対処法2（Storage Accountから直接削除）**：
```bash
# Azure Portal
Storage Account → Containers → tfstate → .terraform.lock.info
→ Delete

# または CLI
az storage blob delete \
  --account-name $ARM_STORAGE_ACCOUNT_NAME \
  --container-name $ARM_CONTAINER_NAME \
  --name .terraform.lock.info \
  --auth-mode login
```

**注意**：
```
本当に他の人が実行してないか確認してから削除！
  ↓
同時実行するとStateファイル壊れる
```

#### エラー2-2: State File Not Found

**エラーメッセージ**：
```
Error: Failed to get existing workspaces: storage: service returned error: StatusCode=404
```

**原因**：
```
Storage AccountまたはContainerが存在しない
  ↓
または
  ↓
Backend設定の環境変数が間違ってる
```

**確認**：
```bash
# Storage Account確認
az storage account show \
  --name $ARM_STORAGE_ACCOUNT_NAME \
  --resource-group $ARM_RESOURCE_GROUP_NAME

# Container確認
az storage container show \
  --account-name $ARM_STORAGE_ACCOUNT_NAME \
  --name $ARM_CONTAINER_NAME \
  --auth-mode login
```

**対処法**：
```bash
# Containerが存在しない場合、作成
az storage container create \
  --name $ARM_CONTAINER_NAME \
  --account-name $ARM_STORAGE_ACCOUNT_NAME \
  --auth-mode login
```

#### エラー2-3: Storage Account権限エラー

**エラーメッセージ**：
```
Error: storage: service returned error: StatusCode=403
This request is not authorized to perform this operation
```

**原因**：
```
Service PrincipalにStorage Blob Data Contributor権限がない
```

**対処法**：
```bash
# Storage Account IDを取得
STORAGE_ACCOUNT_ID=$(az storage account show \
  --name $ARM_STORAGE_ACCOUNT_NAME \
  --resource-group $ARM_RESOURCE_GROUP_NAME \
  --query id -o tsv)

# 権限付与
az role assignment create \
  --assignee $APP_ID \
  --role "Storage Blob Data Contributor" \
  --scope $STORAGE_ACCOUNT_ID

# 確認
az role assignment list \
  --assignee $APP_ID \
  --scope $STORAGE_ACCOUNT_ID
```

#### エラー2-4: State Drift（差分発生）

**現象**：
```
terraform plan
  ↓
何も変更してないのに変更が検出される
```

**原因**：
```
Azureで直接リソースを変更した
  ↓
Stateファイルと実際のリソースが不一致
```

**対処法1（変更を取り込む）**：
```bash
# 現在の状態をStateに反映
terraform apply -refresh-only

# または特定のリソースだけ
terraform apply -refresh-only -target=azurerm_resource_group.example
```

**対処法2（Azureの変更を戻す）**：
```bash
# terraform applyで元に戻す
terraform apply
```

**予防策**：
```
Azureポータルで直接変更しない
  ↓
全部Terraformで管理
  ↓
Infrastructure as Code
```

---

### 3. リソース作成エラー

#### エラー3-1: Region Availability Zones対応エラー

**エラーメッセージ**：
```
Error: zones - availability zones are not supported in this region
```

**原因**：
```
Japan East/Westでzones指定してる
  ↓
でもAvailability Zones非対応
```

**対処法**：
```hcl
# NG
bastion = {
  zones = ["1", "2", "3"]
}

# OK（Japan region）
bastion = {
  zones = []  # ←空リスト
}
```

**該当リソース**：
```
- Azure Bastion
- Public IP Address
- Virtual Machine（一部）
```

Chapter 3で詳しく解説したやつ。

#### エラー3-2: リソース名の重複

**エラーメッセージ**：
```
Error: A resource with the ID "/subscriptions/.../resourceGroups/rg-test" already exists
```

**原因**：
```
同じ名前のリソースが既に存在
```

**確認**：
```bash
# Resource Group確認
az group show --name rg-test

# 削除（必要なら）
az group delete --name rg-test --yes
```

**予防策**：
```
一意な名前を使う
  ↓
postfixを追加
  ↓
rg-myorg-test-001
```

#### エラー3-3: Subnet Address Prefix重複

**エラーメッセージ**：
```
Error: subnet address prefix overlaps with existing subnet
```

**原因**：
```
サブネットのアドレス範囲が重複
```

**例（NG）**：
```hcl
hub_virtual_network = {
  address_space = ["10.0.0.0/16"]
}

firewall = {
  subnet_address_prefix = "10.0.0.0/24"  # ←OK
}

bastion = {
  subnet_address_prefix = "10.0.0.0/26"  # ←NG（10.0.0.0/24に含まれる）
}
```

**対処法**：
```hcl
firewall = {
  subnet_address_prefix = "10.0.0.0/26"   # 10.0.0.0 - 10.0.0.63
}

bastion = {
  subnet_address_prefix = "10.0.0.64/26"  # 10.0.0.64 - 10.0.0.127
}

gateway = {
  subnet_address_prefix = "10.0.1.0/26"   # 10.0.1.0 - 10.0.1.63
}
```

**ツール**：
```
IPアドレス計算サイト：
https://www.subnet-calculator.com/
```

#### エラー3-4: Management Group名が長すぎる

**エラーメッセージ**：
```
Error: management group name must be 90 characters or less
```

**原因**：
```
root_id + "-" + 名前 が長い
```

**例（NG）**：
```hcl
root_id = "my-very-long-organization-name"
  ↓
Management Group名:
"my-very-long-organization-name-landing-zones-corp"
→ 90文字超える
```

**対処法**：
```hcl
# root_idを短くする
root_id = "myorg"
```

#### エラー3-5: Firewall作成タイムアウト

**エラーメッセージ**：
```
Error: timeout while waiting for state to become 'Succeeded'
```

**原因**：
```
Firewallの作成に時間がかかる（30〜60分）
  ↓
Terraformのタイムアウト
```

**対処法1（タイムアウト延長）**：
```hcl
# variables.tfまたはモジュール内
resource "azurerm_firewall" "example" {
  ...
  
  timeouts {
    create = "90m"  # ←90分に延長
    update = "90m"
    delete = "90m"
  }
}
```

**対処法2（再実行）**：
```bash
# もう一度apply
terraform apply

# Firewallは作成途中で止まってる可能性
# 再実行で続きから再開
```

#### エラー3-6: Policy Assignment失敗

**エラーメッセージ**：
```
Error: policy assignment failed: policy definition not found
```

**原因**：
```
Policy Definitionが存在しない
  ↓
カスタムPolicyの場合、先に定義が必要
```

**対処法**：
```hcl
# Policy Definition作成
resource "azurerm_policy_definition" "example" {
  name         = "custom-policy"
  policy_type  = "Custom"
  mode         = "All"
  display_name = "Custom Policy"
  
  policy_rule = jsonencode({
    if = {
      allOf = [...]
    }
    then = {
      effect = "deny"
    }
  })
}

# Policy Assignment（depends_on指定）
resource "azurerm_management_group_policy_assignment" "example" {
  name                 = "assign-custom-policy"
  policy_definition_id = azurerm_policy_definition.example.id
  management_group_id  = azurerm_management_group.example.id
  
  depends_on = [azurerm_policy_definition.example]  # ←依存関係
}
```

---

### 4. GitHub Actions関連

#### エラー4-1: Workflow Permission Denied

**エラーメッセージ**：
```
Error: Resource not accessible by integration
```

**原因**：
```
GitHubのRepository設定でWorkflow権限が制限されてる
```

**対処法**：
```
GitHub → Settings → Actions → General
  ↓
Workflow permissions:
  ✓ Read and write permissions  # ←これ選択
```

#### エラー4-2: Secrets Not Found

**エラーメッセージ**：
```
Error: Input required and not supplied: client-id
```

**原因**：
```
GitHub Secretsが設定されてない
  ↓
または名前が間違ってる
```

**確認**：
```
GitHub → Settings → Secrets and variables → Actions
  ↓
必要なSecrets:
- AZURE_CLIENT_ID
- AZURE_TENANT_ID
- AZURE_SUBSCRIPTION_ID
- ARM_STORAGE_ACCOUNT_NAME
- ARM_CONTAINER_NAME
- ARM_KEY
- ARM_RESOURCE_GROUP_NAME
```

**対処法**：
```
Secretsを追加
  ↓
名前のスペルミスに注意
```

#### エラー4-3: Environment Protection Ruleエラー

**エラーメッセージ**：
```
Error: Required reviewers not found
```

**原因**：
```
Environment設定でRequired reviewersが空
  ↓
または指定したユーザーが存在しない
```

**対処法**：
```
GitHub → Settings → Environments → production
  ↓
Required reviewers:
  - 自分のアカウント追加
  - または他のレビュアー追加
```

#### エラー4-4: Workflow Concurrent実行エラー

**エラーメッセージ**：
```
Error: Another job is currently holding the lock
```

**原因**：
```
複数のワークフローが同時実行
  ↓
Terraform State Lock競合
```

**対処法1（Concurrency設定）**：
```yaml
# .github/workflows/cd.yaml
jobs:
  plan_and_apply:
    concurrency:
      group: terraform-${{ github.ref }}
      cancel-in-progress: false  # ←前の実行を待つ
```

**対処法2（手動でLock解除）**：
```bash
terraform force-unlock <LOCK_ID>
```

---

### 5. モジュール関連

#### エラー5-1: Module Not Found

**エラーメッセージ**：
```
Error: Module not found
```

**原因**：
```
terraform init してない
  ↓
モジュールがダウンロードされてない
```

**対処法**：
```bash
terraform init
```

#### エラー5-2: Module Version Constraint

**エラーメッセージ**：
```
Error: no available releases match the given constraints
```

**原因**：
```
指定したモジュールバージョンが存在しない
```

**確認**：
```hcl
module "hub_and_spoke_vnet" {
  source  = "Azure/avm-ptn-alz-connectivity-hub-and-spoke-vnet/azurerm"
  version = "0.16.8"  # ←このバージョンが存在するか
}
```

**対処法**：
```
Terraform Registry確認：
https://registry.terraform.io/modules/Azure/avm-ptn-alz-connectivity-hub-and-spoke-vnet/azurerm
  ↓
利用可能なバージョン確認
```

#### エラー5-3: Module Input Variable Error

**エラーメッセージ**：
```
Error: Unsupported argument
```

**原因**：
```
モジュールに存在しない変数を渡してる
```

**対処法**：
```
モジュールのドキュメント確認
  ↓
variables.tf確認
  ↓
正しい変数名を使う
```

---

### 6. デバッグテクニック

#### テクニック1: Terraform Debug Mode

```bash
# デバッグモード有効化
export TF_LOG=DEBUG
export TF_LOG_PATH=terraform-debug.log

# 実行
terraform plan

# ログ確認
cat terraform-debug.log
```

**ログレベル**：
```
TRACE：最も詳細
DEBUG：デバッグ情報
INFO：一般情報
WARN：警告
ERROR：エラーのみ
```

#### テクニック2: Terraform Graph

```bash
# 依存関係の可視化
terraform graph | dot -Tpng > graph.png

# macOS
open graph.png

# Windows
start graph.png
```

**使い道**：
```
リソースの依存関係が見える
  ↓
どの順番で作成されるかわかる
  ↓
循環依存のデバッグ
```

#### テクニック3: Terraform Show

```bash
# Plan結果の詳細表示
terraform show tfplan

# State内容の表示
terraform show

# JSON形式で出力
terraform show -json > state.json
```

#### テクニック4: Terraform Console

```bash
# 対話型コンソール
terraform console

# 変数の確認
> var.root_id
"myorg"

> local.management_group_settings
{
  "root" = {
    ...
  }
}

# 関数のテスト
> format("rg-%s-test", var.root_id)
"rg-myorg-test"
```

**超便利**：
```
設定ファイル修正前に値を確認できる
```

#### テクニック5: Azure CLI Debug

```bash
# Azure CLI Debug Mode
az login --debug

# 詳細ログ
az group list --debug
```

---

### 7. よくある質問と回答

#### Q1: Terraformのバージョンを上げたい

**質問**：
```
Terraform 1.12から1.13にアップグレードしたい
```

**回答**：
```bash
# 1. ローカルでテスト
terraform version  # 現在: 1.12

# Terraformアップグレード
brew upgrade terraform  # macOS
# または公式サイトからダウンロード

terraform version  # 確認: 1.13

# 2. terraform.tf更新
# terraform.tf
terraform {
  required_version = "~> 1.13"  # ←更新
}

# 3. 初期化
terraform init -upgrade

# 4. Plan確認
terraform plan

# 5. 問題なければCommit
git commit -am "Upgrade Terraform to 1.13"

# 6. GitHub Actions設定更新
# .github/workflows/ci.yaml
terraform_cli_version: '1.13.0'  # ←更新
```

#### Q2: リソースをTerraformの管理下から外したい

**質問**：
```
既存のResource Groupを削除せずに、Terraformの管理から外したい
```

**回答**：
```bash
# 1. Stateから削除
terraform state rm azurerm_resource_group.example

# 2. .tfファイルから削除
# main.tf から該当リソースを削除

# 3. Plan確認（削除されないことを確認）
terraform plan
# "No changes" と表示される

# リソースはAzure上に残る
# Terraformの管理から外れただけ
```

#### Q3: 既存のリソースをTerraformにImportしたい

**質問**：
```
手動で作ったResource GroupをTerraformで管理したい
```

**回答**：
```bash
# 1. .tfファイルに定義追加
# main.tf
resource "azurerm_resource_group" "imported" {
  name     = "rg-existing"
  location = "japaneast"
}

# 2. Import
terraform import azurerm_resource_group.imported /subscriptions/<SUB_ID>/resourceGroups/rg-existing

# 3. Plan確認
terraform plan
# 差分があれば調整

# 4. Apply
terraform apply
```

#### Q4: コストを削減したい

**質問**：
```
開発環境でコストを抑えたい
```

**回答**：
```hcl
# 高額なリソースを無効化
hub_virtual_networks = {
  primary = {
    enabled_resources = {
      firewall                              = false  # 約17万円/月
      bastion                               = false  # 約2.7万円/月
      virtual_network_gateway_express_route = false
      virtual_network_gateway_vpn           = false  # 約4万円/月
      private_dns_zones                     = true   # 無料
      private_dns_resolver                  = false
    }
  }
}

hub_and_spoke_networks_settings = {
  enabled_resources = {
    ddos_protection_plan = false  # 約40万円/月
  }
}

# マルチリージョンを単一リージョンに
# secondary は削除
```

**削減できるコスト**：
```
Firewall: 17万円
VPN Gateway: 4万円
Bastion: 2.7万円
DDoS: 40万円
--------------
合計: 約64万円/月 → ほぼ0円
```

#### Q5: ローカルとGitHub Actionsで結果が違う

**質問**：
```
ローカルではplanが通るのに、GitHub Actionsでエラー
```

**チェックポイント**：

1. **Terraformバージョン**：
```bash
# ローカル
terraform version

# GitHub Actions
# .github/workflows/ci.yaml
terraform_cli_version: '1.12.0'  # ←これと一致させる
```

2. **環境変数**：
```bash
# ローカル
env | grep ARM_

# GitHub Actions
# Secretsが正しく設定されてるか確認
```

3. **権限**：
```bash
# ローカル: ユーザーの権限
az account show

# GitHub Actions: Service Principalの権限
az role assignment list --assignee $APP_ID
```

---

## エラー発生時のチェックリスト

### ステップ1: エラーメッセージを読む

```
エラーメッセージの最初の1〜2行
  ↓
エラーの種類がわかる
```

**例**：
```
Error: Error acquiring the state lock
→ State Lock問題

Error: insufficient privileges
→ 権限問題

Error: zones - availability zones are not supported
→ Region問題
```

### ステップ2: ログを確認

```bash
# Terraform実行ログ
terraform plan 2>&1 | tee terraform.log

# GitHub Actions
Actions → 失敗したワークフロー → Details
```

### ステップ3: State確認

```bash
# State一覧
terraform state list

# 特定のリソース確認
terraform state show azurerm_resource_group.example

# State全体
terraform show
```

### ステップ4: Azure確認

```bash
# リソース確認
az resource list --output table

# Resource Group確認
az group list --output table

# Management Group確認
az account management-group list --output table
```

### ステップ5: ドキュメント確認

```
Terraform Azure Provider:
https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs

Azure CLI:
https://docs.microsoft.com/cli/azure/

モジュール:
https://registry.terraform.io/modules/Azure/...
```

### ステップ6: 切り分け

```bash
# 最小構成でテスト
# test.tf
resource "azurerm_resource_group" "test" {
  name     = "rg-test"
  location = "japaneast"
}

terraform plan

# 問題なければ、少しずつ追加
```

---

## 予防策（ベストプラクティス）

### 1. ローカルで確認してからPR

```
コード変更
  ↓
ローカルでterraform plan
  ↓
問題なければCommit
  ↓
PR作成
```

### 2. 小さい変更を頻繁に

```
大量の変更を一度にCommit
  ↓
エラーが出たときの原因特定が大変

小さい変更を頻繁にCommit
  ↓
エラーの原因がすぐわかる
```

### 3. 本番と開発を分ける

```
開発環境：
- 気軽に試す
- 失敗OK

本番環境：
- 慎重にデプロイ
- レビュー必須
```

### 4. バックアップ

```bash
# State Fileのバックアップ
terraform state pull > state-backup.json

# 定期的にバックアップ取得
```

### 5. ドキュメント化

```
何か問題が起きたら：
- 原因
- 対処法
- 再発防止策
をドキュメントに残す
```

---

## まとめ

**トラブルシューティングの流れ**：
```
1. エラーメッセージを読む
2. ログを確認
3. State確認
4. Azure確認
5. ドキュメント確認
6. 切り分け
7. 解決
```

**よくあるエラー**：
- **OIDC認証**：Federated Credential設定
- **State Lock**：前回の実行が残ってる
- **権限**：Service PrincipalにOwner付与
- **Zones**：Japan regionは空リスト
- **Timeout**：Firewall作成は時間かかる

**デバッグツール**：
- `TF_LOG=DEBUG`：詳細ログ
- `terraform console`：変数確認
- `terraform graph`：依存関係可視化
- `terraform state show`：State確認

次のChapterでは、カスタマイズ方法を見ていきます。
自分の組織に合わせた変更方法を解説するよ。

---

**所要時間**: 55分  
**難易度**: ★★★★☆  
**前**: [13_デプロイ手順.md](./13_デプロイ手順.md)  
**次**: [15_カスタマイズ.md](./15_カスタマイズ.md)
