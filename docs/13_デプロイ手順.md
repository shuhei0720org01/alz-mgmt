# 13. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é † - ã‚¼ãƒ­ã‹ã‚‰ç’°å¢ƒã‚’ä½œã‚‹

## ã“ã®Chapterã§ã‚„ã‚‹ã“ã¨

Azure Landing Zonesã‚’å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã€‚

**ã‚¼ãƒ­ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ**ï¼š
```
ä½•ã‚‚ãªã„çŠ¶æ…‹
  â†“
Azureæº–å‚™
  â†“
GitHubæº–å‚™
  â†“
ãƒ‡ãƒ—ãƒ­ã‚¤
  â†“
å®Œæˆ
```

**æ‰€è¦æ™‚é–“**ï¼šç´„2ã€œ3æ™‚é–“

---

## å‰ææ¡ä»¶

### å¿…è¦ãªã‚‚ã®

#### 1. Azureã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

```
- Azure Subscriptionï¼ˆOwneræ¨©é™ï¼‰
- Azure ADãƒ†ãƒŠãƒ³ãƒˆ
```

**ç¢ºèª**ï¼š
```bash
az login
az account show
```

#### 2. ãƒ„ãƒ¼ãƒ«

```
- Azure CLIï¼šæœ€æ–°ç‰ˆ
- Terraformï¼šv1.12ä»¥ä¸Š
- Gitï¼šæœ€æ–°ç‰ˆ
- ã‚¨ãƒ‡ã‚£ã‚¿ï¼šVS Codeæ¨å¥¨
```

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª**ï¼š
```bash
az --version
terraform --version
git --version
code --version
```

#### 3. GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

```
- GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- ãƒªãƒã‚¸ãƒˆãƒªä½œæˆæ¨©é™
```

---

## Phase 1: Azureæº–å‚™

### Step 1-1: Subscriptionã®ç¢ºèª

```bash
# ãƒ­ã‚°ã‚¤ãƒ³
az login

# Subscriptionä¸€è¦§
az account list --output table

# ä½¿ã†Subscriptionã‚’é¸æŠ
az account set --subscription "<SUBSCRIPTION_ID>"

# ç¢ºèª
az account show
```

**é‡è¦**ï¼š
```
ã“ã®Subscriptionã«å¯¾ã—ã¦Owneræ¨©é™ãŒå¿…è¦
  â†“
Management Groupä½œæˆ
ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
RBACãƒ­ãƒ¼ãƒ«ä»˜ä¸
  â†“
å…¨éƒ¨ã‚„ã‚‹ã‹ã‚‰
```

### Step 1-2: Service Principalä½œæˆï¼ˆOIDCç”¨ï¼‰

**ğŸ” OIDCèªè¨¼ã¨ã¯ï¼Ÿï¼ˆåˆå¿ƒè€…å‘ã‘èª¬æ˜ï¼‰**

**å¾“æ¥ã®æ–¹æ³•ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼‰**:
```
GitHub â†’ Azure
ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ "abc123" ã§ã™ã€
```

**å•é¡Œç‚¹**:
- âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ¼ã‚ŒãŸã‚‰å±é™º
- âŒ å®šæœŸçš„ãªæ›´æ–°ãŒå¿…è¦
- âŒ GitHubã«ä¿å­˜ã™ã‚‹ã®ãŒä¸å®‰

**æ–°ã—ã„æ–¹æ³•ï¼ˆOIDCèªè¨¼ï¼‰**:
```
GitHub â†’ Azure
ã€Œç§ã¯GitHubã®å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã§ã™ã‚ˆï¼ˆè¨¼æ˜æ›¸æç¤ºï¼‰ã€
Azure â†’ GitHub
ã€Œæœ¬å½“ã ã€‚ã˜ã‚ƒã‚ä¿¡ã˜ã‚‹ã€
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ï¼ˆè¨¼æ˜æ›¸ãƒ™ãƒ¼ã‚¹ï¼‰
- âœ… è‡ªå‹•æ›´æ–°
- âœ… æ¼æ´©ãƒªã‚¹ã‚¯ãŒä½ã„

**Federated Credentialï¼ˆãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ãƒ†ãƒƒãƒ‰è³‡æ ¼æƒ…å ±ï¼‰ã¨ã¯ï¼Ÿ**:
ã€Œã“ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ä¿¡é ¼ã™ã‚‹ã€ã¨ã„ã†è¨­å®šã€‚
ç‰¹å®šã®GitHubãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã‘ã‚’è¨±å¯ã—ã¾ã™ã€‚

```
Federated Credential = ã€Œä¿¡é ¼ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®ãƒªã‚¹ãƒˆã€
```

**å…·ä½“ä¾‹**:
```
repo:shuhei0720org01/alz-mgmt:ref:refs/heads/main
 â†‘         â†‘             â†‘          â†‘
 |         |             |          mainãƒ–ãƒ©ãƒ³ãƒ
 |         |             ãƒªãƒã‚¸ãƒˆãƒª
 |         ã‚ªãƒ¼ãƒŠãƒ¼
 ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ (GitHub)
```

ã“ã‚Œã§ã€`shuhei0720org01/alz-mgmt` ã® `main` ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

**ã§ã¯ã€å®Ÿéš›ã«è¨­å®šã—ã¦ã„ãã¾ã—ã‚‡ã†**:

```bash
# å¤‰æ•°è¨­å®š
APP_NAME="github-actions-alz-mgmt"
REPO_OWNER="your-github-username"
REPO_NAME="alz-mgmt"
SUBSCRIPTION_ID=$(az account show --query id -o tsv)

# Azure ADã‚¢ãƒ—ãƒªä½œæˆ
az ad app create --display-name "$APP_NAME"

# App IDã‚’å–å¾—
APP_ID=$(az ad app list --display-name "$APP_NAME" --query "[0].appId" -o tsv)
echo "APP_ID: $APP_ID"

# Service Principalä½œæˆ
az ad sp create --id $APP_ID

# Owneræ¨©é™ä»˜ä¸ï¼ˆSubscriptionå…¨ä½“ï¼‰
az role assignment create \
  --assignee $APP_ID \
  --role "Owner" \
  --scope "/subscriptions/$SUBSCRIPTION_ID"

# Federated Credentialä½œæˆï¼ˆmainãƒ–ãƒ©ãƒ³ãƒç”¨ï¼‰
az ad app federated-credential create \
  --id $APP_ID \
  --parameters "{
    \"name\": \"github-actions-main\",
    \"issuer\": \"https://token.actions.githubusercontent.com\",
    \"subject\": \"repo:${REPO_OWNER}/${REPO_NAME}:ref:refs/heads/main\",
    \"audiences\": [\"api://AzureADTokenExchange\"]
  }"

# Federated Credentialä½œæˆï¼ˆPRç”¨ï¼‰
az ad app federated-credential create \
  --id $APP_ID \
  --parameters "{
    \"name\": \"github-actions-pr\",
    \"issuer\": \"https://token.actions.githubusercontent.com\",
    \"subject\": \"repo:${REPO_OWNER}/${REPO_NAME}:pull_request\",
    \"audiences\": [\"api://AzureADTokenExchange\"]
  }"
```

**ä¿å­˜ã—ã¦ãŠãå€¤**ï¼š
```bash
echo "AZURE_CLIENT_ID: $APP_ID"
echo "AZURE_TENANT_ID: $(az account show --query tenantId -o tsv)"
echo "AZURE_SUBSCRIPTION_ID: $SUBSCRIPTION_ID"
```

**ãƒ¡ãƒ¢ã£ã¦ãŠã“ã†ï¼** ã‚ã¨ã§ä½¿ã†ã€‚

### Step 1-3: Storage Accountä½œæˆï¼ˆTerraform Stateç”¨ï¼‰

```bash
# å¤‰æ•°è¨­å®š
LOCATION="japaneast"
RG_NAME="rg-terraform-state"
STORAGE_ACCOUNT_NAME="stterraform$(openssl rand -hex 4)"  # ãƒ©ãƒ³ãƒ€ãƒ ãªåå‰
CONTAINER_NAME="tfstate"

# Resource Groupä½œæˆ
az group create \
  --name $RG_NAME \
  --location $LOCATION

# Storage Accountä½œæˆ
az storage account create \
  --name $STORAGE_ACCOUNT_NAME \
  --resource-group $RG_NAME \
  --location $LOCATION \
  --sku Standard_LRS \
  --kind StorageV2 \
  --allow-blob-public-access false \
  --min-tls-version TLS1_2

# ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
az storage container create \
  --name $CONTAINER_NAME \
  --account-name $STORAGE_ACCOUNT_NAME \
  --auth-mode login

# Service Principalã«æ¨©é™ä»˜ä¸
STORAGE_ACCOUNT_ID=$(az storage account show \
  --name $STORAGE_ACCOUNT_NAME \
  --resource-group $RG_NAME \
  --query id -o tsv)

az role assignment create \
  --assignee $APP_ID \
  --role "Storage Blob Data Contributor" \
  --scope $STORAGE_ACCOUNT_ID
```

**ä¿å­˜ã—ã¦ãŠãå€¤**ï¼š
```bash
echo "ARM_STORAGE_ACCOUNT_NAME: $STORAGE_ACCOUNT_NAME"
echo "ARM_CONTAINER_NAME: $CONTAINER_NAME"
echo "ARM_KEY: alz-mgmt.tfstate"
echo "ARM_RESOURCE_GROUP_NAME: $RG_NAME"
```

**ã“ã‚Œã‚‚ãƒ¡ãƒ¢ã£ã¦ãŠã“ã†ï¼**

---

## Phase 2: GitHubæº–å‚™

### Step 2-1: ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã«cloneæ¸ˆã¿ã®å‰æ
cd ~/projects
git clone https://github.com/$REPO_OWNER/$REPO_NAME.git
cd $REPO_NAME

# ã¾ãŸã¯æ–°è¦ä½œæˆ
mkdir alz-mgmt
cd alz-mgmt
git init
```

### Step 2-2: ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨éƒ¨ã‚³ãƒ”ãƒ¼ï¼š

```bash
# å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yaml
â”‚       â””â”€â”€ cd.yaml
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ archetype_definitions/
â”‚   â””â”€â”€ architecture_definitions/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ config-templating/
â”‚   â”œâ”€â”€ management_groups/
â”‚   â””â”€â”€ management_resources/
â”œâ”€â”€ locals.tf
â”œâ”€â”€ main.*.tf
â”œâ”€â”€ outputs.tf
â”œâ”€â”€ platform-landing-zone.auto.tfvars
â”œâ”€â”€ terraform.tf
â”œâ”€â”€ terraform.tfvars.json
â””â”€â”€ variables.*.tf
```

**æ³¨æ„**ï¼š
```
.gitignore ã‚’ä½œã‚‹ï¼š
```
```gitignore
# Terraform
.terraform/
*.tfstate
*.tfstate.*
*.tfvars
!platform-landing-zone.auto.tfvars
terraform.tfvars.json
.terraform.lock.hcl

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db
```
```

### Step 2-3: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†

**platform-landing-zone.auto.tfvars** ã‚’è‡ªåˆ†ã®ç’°å¢ƒã«åˆã‚ã›ã¦ç·¨é›†ï¼š

```hcl
# æœ€å°é™ã®è¨­å®šä¾‹
starter_location_01 = "japaneast"
starter_location_02 = "japanwest"

root_id                     = "myorg"
root_name                   = "My Organization"
default_location            = "japaneast"
default_postfix             = "001"
subscription_id_management  = "<YOUR_MANAGEMENT_SUBSCRIPTION_ID>"
subscription_id_identity    = "<YOUR_IDENTITY_SUBSCRIPTION_ID>"
subscription_id_connectivity = "<YOUR_CONNECTIVITY_SUBSCRIPTION_ID>"

# æœ€å°æ§‹æˆï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
connectivity_type = "hub_and_spoke_vnet"

hub_and_spoke_networks_settings = {
  enabled_resources = {
    ddos_protection_plan = false  # â†ç„¡åŠ¹åŒ–
  }
}

hub_virtual_networks = {
  primary = {
    location = "japaneast"
    
    enabled_resources = {
      firewall                              = false  # â†ç„¡åŠ¹åŒ–
      bastion                               = false  # â†ç„¡åŠ¹åŒ–
      virtual_network_gateway_express_route = false
      virtual_network_gateway_vpn           = false  # â†ç„¡åŠ¹åŒ–
      private_dns_zones                     = true
      private_dns_resolver                  = false
    }
    
    hub_virtual_network = {
      name          = "vnet-myorg-jpe-hub"
      address_space = ["10.0.0.0/16"]
    }
  }
}
```

**Subscription IDç¢ºèª**ï¼š
```bash
az account list --output table
```

3ã¤ã®SubscriptionãŒå¿…è¦ï¼ˆåŒã˜ã§ã‚‚OKï¼‰ï¼š
- Managementï¼šç®¡ç†ç”¨
- Identityï¼šIDç®¡ç†ç”¨ï¼ˆAD DSç­‰ï¼‰
- Connectivityï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨

### Step 2-4: Commit & Push

```bash
git add .
git commit -m "Initial commit"
git push origin main
```

### Step 2-5: GitHub Secretsè¨­å®š

```
GitHub â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
```

**è¨­å®šã™ã‚‹Secrets**ï¼š

```
AZURE_CLIENT_ID: <Step 1-2ã§ä¿å­˜ã—ãŸå€¤>
AZURE_TENANT_ID: <Step 1-2ã§ä¿å­˜ã—ãŸå€¤>
AZURE_SUBSCRIPTION_ID: <Step 1-2ã§ä¿å­˜ã—ãŸå€¤>
ARM_STORAGE_ACCOUNT_NAME: <Step 1-3ã§ä¿å­˜ã—ãŸå€¤>
ARM_CONTAINER_NAME: tfstate
ARM_KEY: alz-mgmt.tfstate
ARM_RESOURCE_GROUP_NAME: rg-terraform-state
```

**ç¢ºèª**ï¼š
```
GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
  â†“
7å€‹ã®SecretsãŒè¡¨ç¤ºã•ã‚Œã¦ã‚‹
```

### Step 2-6: Environmentè¨­å®šï¼ˆæ¨å¥¨ï¼‰

```
GitHub â†’ Settings â†’ Environments â†’ New environment
  â†“
Name: production
  â†“
Configure environment
```

**è¨­å®š**ï¼š
```
Environment protection rules:
- Required reviewers: è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ 
- Wait timer: 0 minutesï¼ˆã™ãæ‰¿èªï¼‰
```

**åŠ¹æœ**ï¼š
```
mainã«ãƒãƒ¼ã‚¸
  â†“
è‡ªå‹•ã§applyã•ã‚Œãªã„
  â†“
æ‰¿èªå¾…ã¡
  â†“
æ‰¿èª
  â†“
applyå®Ÿè¡Œ
```

---

## Phase 3: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤

**ãªãœãƒ­ãƒ¼ã‚«ãƒ«ã§ï¼Ÿ**
```
GitHub Actionsã§ã„ããªã‚Šã‚„ã‚‹ã¨ï¼š
- ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒãƒƒã‚°ãŒå¤§å¤‰
- ãƒ­ã‚°è¦‹ã‚‹ã®ãŒé¢å€’

ãƒ­ãƒ¼ã‚«ãƒ«ã§ï¼š
- ã™ãã‚¨ãƒ©ãƒ¼ã‚ã‹ã‚‹
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª¿æ•´ã—ã‚„ã™ã„
```

### Step 3-1: TerraformåˆæœŸåŒ–

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
export ARM_STORAGE_ACCOUNT_NAME="<Step 1-3ã®å€¤>"
export ARM_CONTAINER_NAME="tfstate"
export ARM_KEY="alz-mgmt.tfstate"
export ARM_RESOURCE_GROUP_NAME="rg-terraform-state"

# Azureãƒ­ã‚°ã‚¤ãƒ³ï¼ˆOwneræ¨©é™ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
az login

# ä½¿ã†Subscriptionã‚’é¸æŠ
az account set --subscription "<SUBSCRIPTION_ID>"

# TerraformåˆæœŸåŒ–
terraform init

# Backendè¨­å®šã®ç¢ºèª
terraform init \
  -backend-config="storage_account_name=$ARM_STORAGE_ACCOUNT_NAME" \
  -backend-config="container_name=$ARM_CONTAINER_NAME" \
  -backend-config="key=$ARM_KEY" \
  -backend-config="resource_group_name=$ARM_RESOURCE_GROUP_NAME"
```

**æˆåŠŸã™ã‚‹ã¨**ï¼š
```
Terraform has been successfully initialized!
```

### Step 3-2: Terraform Validate

```bash
terraform validate
```

**æˆåŠŸã™ã‚‹ã¨**ï¼š
```
Success! The configuration is valid.
```

**ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰**ï¼š
```
Error: Missing required argument
  on main.tf line 10:
  10: resource "azurerm_resource_group" "example" {
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦å†åº¦validateã€‚

### Step 3-3: Terraform Plan

```bash
terraform plan -out=tfplan
```

**åˆå›ã¯æ™‚é–“ã‹ã‹ã‚‹**ï¼š5ã€œ10åˆ†

**å‡ºåŠ›ä¾‹**ï¼š
```
Plan: 45 to add, 0 to change, 0 to destroy.
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**ï¼š
```
- Management Groupæ§‹é€ 
- Resource Group
- Log Analytics Workspace
- VNetï¼ˆç„¡åŠ¹åŒ–ã—ã¦ã‚Œã°ä½œã‚‰ã‚Œãªã„ï¼‰
- Policy Assignments
```

**å•é¡Œãªã‘ã‚Œã°æ¬¡ã¸**ã€‚

### Step 3-4: Terraform Apply

```bash
terraform apply tfplan
```

**æ‰€è¦æ™‚é–“**ï¼š20ã€œ40åˆ†ï¼ˆåˆå›ï¼‰

**é€²è¡ŒçŠ¶æ³**ï¼š
```
module.management_groups[0].azurerm_management_group.level_1["landing-zones"]: Creating...
module.management_groups[0].azurerm_management_group.level_1["landing-zones"]: Creation complete after 15s
...
```

**å®Œæˆï¼**
```
Apply complete! Resources: 45 added, 0 changed, 0 destroyed.
```

### Step 3-5: ç¢ºèª

#### Management Groupç¢ºèª

```bash
# Azure Portal
https://portal.azure.com/#view/Microsoft_Azure_ManagementGroups/ManagementGroupBrowseBlade/~/MGBrowse_overview

# CLI
az account management-group list --output table
```

**æ§‹é€ **ï¼š
```
myorgï¼ˆRootï¼‰
â”œâ”€â”€ platform
â”‚   â”œâ”€â”€ management
â”‚   â”œâ”€â”€ identity
â”‚   â””â”€â”€ connectivity
â”œâ”€â”€ landing-zones
â”‚   â”œâ”€â”€ corp
â”‚   â””â”€â”€ online
â””â”€â”€ decommissioned
```

#### Resource Groupç¢ºèª

```bash
az group list --output table
```

**ä½œã‚‰ã‚Œã¦ã‚‹ã¯ãš**ï¼š
```
rg-myorg-management-001
rg-myorg-connectivity-001
rg-myorg-identity-001
```

#### Log Analyticsç¢ºèª

```bash
az monitor log-analytics workspace list --output table
```

---

## Phase 4: GitHub Actionsã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### Step 4-1: ãƒ†ã‚¹ãƒˆç”¨ã®å¤‰æ›´

```bash
# æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒ
git checkout -b feature/test-github-actions

# ãƒ†ã‚¹ãƒˆç”¨Resource Groupè¿½åŠ 
cat >> test.tf <<EOF
resource "azurerm_resource_group" "test_github_actions" {
  name     = "rg-test-github-actions"
  location = "japaneast"
}
EOF

# Commit & Push
git add test.tf
git commit -m "Test GitHub Actions"
git push origin feature/test-github-actions
```

### Step 4-2: Pull Requestä½œæˆ

```
GitHub â†’ Pull requests â†’ New pull request
  â†“
base: main â† compare: feature/test-github-actions
  â†“
Create pull request
```

### Step 4-3: CIç¢ºèª

```
PRç”»é¢ â†’ Checks ã‚¿ãƒ–
  â†“
01 Azure Landing Zones Continuous Integration
  â†“
å®Ÿè¡Œä¸­...
```

**ãƒ­ã‚°ç¢ºèª**ï¼š
```
Actions â†’ CIå®Ÿè¡Œ â†’ Details
  â†“
å„ã‚¹ãƒ†ãƒƒãƒ—ã®é€²è¡ŒçŠ¶æ³
```

**æˆåŠŸã™ã‚‹ã¨**ï¼š
```
âœ“ Checkout
âœ“ Setup Terraform
âœ“ Azure Login
âœ“ Terraform Init
âœ“ Terraform Validate
âœ“ Terraform Plan
âœ“ Comment PR

Plan: 1 to add, 0 to change, 0 to destroy.
```

**PRç”»é¢ã«ã‚³ãƒ¡ãƒ³ãƒˆ**ï¼š
```
## Terraform Plan
...
+ azurerm_resource_group.test_github_actions
    name     = "rg-test-github-actions"
    location = "japaneast"
```

### Step 4-4: æ‰¿èª & ãƒãƒ¼ã‚¸

```
PRç”»é¢ â†’ Files changed â†’ Review changes â†’ Approve
  â†“
Merge pull request
  â†“
Confirm merge
```

### Step 4-5: CDç¢ºèª

```
Actions â†’ 02 Azure Landing Zones Continuous Delivery
  â†“
å®Ÿè¡Œä¸­...
```

**Environmentæ‰¿èªè¨­å®šã—ã¦ã‚‹å ´åˆ**ï¼š
```
å®Ÿè¡Œä¸­ â†’ Waiting for approval
  â†“
Review deployments â†’ Approve
  â†“
å®Ÿè¡Œå†é–‹
```

**å®Œäº†**ï¼š
```
âœ“ Checkout
âœ“ Setup Terraform
âœ“ Azure Login
âœ“ Terraform Init
âœ“ Terraform Apply

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

### Step 4-6: Azureç¢ºèª

```bash
az group show --name rg-test-github-actions
```

**ä½œã‚‰ã‚Œã¦ã‚‹ï¼**

### Step 4-7: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
git checkout main
git pull
git checkout -b feature/cleanup-test

# test.tfå‰Šé™¤
git rm test.tf
git commit -m "Cleanup test resource group"
git push origin feature/cleanup-test

# PRä½œæˆ â†’ CI â†’ æ‰¿èª â†’ ãƒãƒ¼ã‚¸ â†’ CD
# rg-test-github-actions ãŒå‰Šé™¤ã•ã‚Œã‚‹
```

---

## Phase 5: æœ¬æ ¼çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤

### Step 5-1: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªä»•æ§˜ã«

```bash
git checkout -b feature/enable-production-resources
```

**platform-landing-zone.auto.tfvars** ç·¨é›†ï¼š

```hcl
# Firewallæœ‰åŠ¹åŒ–
hub_virtual_networks = {
  primary = {
    location = "japaneast"
    
    enabled_resources = {
      firewall                              = true   # â†æœ‰åŠ¹åŒ–
      bastion                               = true   # â†æœ‰åŠ¹åŒ–
      virtual_network_gateway_express_route = false
      virtual_network_gateway_vpn           = false  # â†å¿…è¦ãªã‚‰æœ‰åŠ¹åŒ–
      private_dns_zones                     = true
      private_dns_resolver                  = false
    }
    
    hub_virtual_network = {
      name          = "vnet-myorg-jpe-hub"
      address_space = ["10.0.0.0/16"]
      routing_address_space         = ["10.0.0.0/22"]
      route_table_name_firewall     = "rt-myorg-jpe-firewall"
      route_table_name_user_subnets = "rt-myorg-jpe-user"
    }
    
    firewall = {
      subnet_address_prefix            = "10.0.0.0/26"
      management_subnet_address_prefix = "10.0.0.64/26"
      name                             = "fw-myorg-jpe-hub"
      
      default_ip_configuration = {
        public_ip_config = {
          name = "pip-fw-myorg-jpe-hub"
        }
      }
      
      management_ip_enabled = true
      management_ip_configuration = {
        public_ip_config = {
          name = "pip-fw-myorg-jpe-hub-mgmt"
        }
      }
    }
    
    firewall_policy = {
      name = "fwp-myorg-jpe-hub"
    }
    
    bastion = {
      subnet_address_prefix = "10.0.2.0/27"
      name                  = "bas-myorg-jpe-hub"
      
      public_ip = {
        name  = "pip-bas-myorg-jpe-hub"
        zones = []  # Japan region
      }
    }
  }
}
```

### Step 5-2: Commit & PR

```bash
git add platform-landing-zone.auto.tfvars
git commit -m "Enable Firewall and Bastion for production"
git push origin feature/enable-production-resources

# PRä½œæˆ
```

### Step 5-3: Planç¢ºèª

```
PRç”»é¢ â†’ Checks â†’ Details
  â†“
Plançµæœç¢ºèª
```

**è¿½åŠ ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹**ï¼š
```
+ Azure Firewall
+ Firewall Policy
+ Azure Bastion
+ Public IP x3
+ Route Tables
+ Subnets
```

**ã‚³ã‚¹ãƒˆç¢ºèª**ï¼š
```
Firewall: ç´„17ä¸‡å††/æœˆ
Bastion: ç´„2.7ä¸‡å††/æœˆ
-----------------
åˆè¨ˆ: ç´„20ä¸‡å††/æœˆ
```

**OKï¼Ÿ** â†’ æ‰¿èª & ãƒãƒ¼ã‚¸

### Step 5-4: ãƒ‡ãƒ—ãƒ­ã‚¤å¾…æ©Ÿ

```
CDå®Ÿè¡Œ â†’ 30ã€œ60åˆ†ã‹ã‹ã‚‹
```

**Firewallã®ä½œæˆãŒé…ã„**ã€‚

ã‚³ãƒ¼ãƒ’ãƒ¼é£²ã‚“ã§å¾…ã¨ã†â˜•

---

## Phase 6: å‹•ä½œç¢ºèª

### Step 6-1: Management Groupç¢ºèª

```bash
az account management-group show \
  --name myorg \
  --expand \
  --recurse
```

**éšå±¤æ§‹é€ **ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

### Step 6-2: Policyç¢ºèª

```bash
# Policy Assignmentä¸€è¦§
az policy assignment list --output table

# ç‰¹å®šã®Management Groupã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸPolicy
az policy assignment list \
  --scope "/providers/Microsoft.Management/managementGroups/myorg-landing-zones" \
  --output table
```

### Step 6-3: Log Analyticsç¢ºèª

```bash
# Workspaceç¢ºèª
WORKSPACE_ID=$(az monitor log-analytics workspace show \
  --resource-group rg-myorg-management-001 \
  --workspace-name law-myorg-management-001 \
  --query id -o tsv)

# ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªï¼‰
az monitor log-analytics query \
  --workspace $WORKSPACE_ID \
  --analytics-query "AzureActivity | take 10" \
  --output table
```

### Step 6-4: Firewallç¢ºèª

```bash
# Firewallç¢ºèª
az network firewall show \
  --resource-group rg-myorg-connectivity-001 \
  --name fw-myorg-jpe-hub

# Public IPç¢ºèª
az network firewall show \
  --resource-group rg-myorg-connectivity-001 \
  --name fw-myorg-jpe-hub \
  --query "ipConfigurations[0].publicIpAddress.id" -o tsv
```

### Step 6-5: Bastionç¢ºèª

```bash
az network bastion show \
  --resource-group rg-myorg-connectivity-001 \
  --name bas-myorg-jpe-hub
```

### Step 6-6: Spoke VNetè¿½åŠ ãƒ†ã‚¹ãƒˆ

```bash
git checkout -b feature/add-spoke-vnet
```

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**ï¼š`spoke.tf`

```hcl
resource "azurerm_virtual_network" "spoke1" {
  name                = "vnet-myorg-spoke1"
  location            = "japaneast"
  resource_group_name = azurerm_resource_group.spoke1.name
  address_space       = ["10.1.0.0/16"]
}

resource "azurerm_resource_group" "spoke1" {
  name     = "rg-myorg-spoke1"
  location = "japaneast"
}

# Hub VNetã¨ãƒ”ã‚¢ãƒªãƒ³ã‚°
resource "azurerm_virtual_network_peering" "spoke1_to_hub" {
  name                      = "peer-spoke1-to-hub"
  resource_group_name       = azurerm_resource_group.spoke1.name
  virtual_network_name      = azurerm_virtual_network.spoke1.name
  remote_virtual_network_id = module.hub_and_spoke_vnet[0].hub_virtual_networks["primary"].virtual_network.resource_id
  
  allow_virtual_network_access = true
  allow_forwarded_traffic      = true
  allow_gateway_transit        = false
  use_remote_gateways          = false
}

resource "azurerm_virtual_network_peering" "hub_to_spoke1" {
  name                      = "peer-hub-to-spoke1"
  resource_group_name       = "rg-myorg-connectivity-001"
  virtual_network_name      = "vnet-myorg-jpe-hub"
  remote_virtual_network_id = azurerm_virtual_network.spoke1.id
  
  allow_virtual_network_access = true
  allow_forwarded_traffic      = true
  allow_gateway_transit        = true
  use_remote_gateways          = false
  
  depends_on = [module.hub_and_spoke_vnet]
}
```

```bash
git add spoke.tf
git commit -m "Add spoke VNet"
git push origin feature/add-spoke-vnet

# PR â†’ CI â†’ æ‰¿èª â†’ ãƒãƒ¼ã‚¸ â†’ CD
```

**Spoke VNetãŒä½œã‚‰ã‚Œã‚‹ï¼**

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼1: OIDCèªè¨¼å¤±æ•—

```
Error: Unable to get ACTIONS_ID_TOKEN_REQUEST_URL
```

**åŸå› **ï¼šFederated Credentialã®è¨­å®šé–“é•ã„

**ç¢ºèª**ï¼š
```bash
az ad app federated-credential list --id $APP_ID
```

**subjectç¢ºèª**ï¼š
```json
{
  "subject": "repo:your-github-username/alz-mgmt:ref:refs/heads/main"
}
```

**é–“é•ã£ã¦ãŸã‚‰å‰Šé™¤ã—ã¦å†ä½œæˆ**ï¼š
```bash
az ad app federated-credential delete \
  --id $APP_ID \
  --federated-credential-id <CREDENTIAL_ID>

# å†ä½œæˆï¼ˆPhase 2ã®ã‚³ãƒãƒ³ãƒ‰ï¼‰
```

### ã‚¨ãƒ©ãƒ¼2: Storage Accountæ¨©é™ã‚¨ãƒ©ãƒ¼

```
Error: Failed to get existing workspaces: blob not found
```

**åŸå› **ï¼šService Principalã«Storageæ¨©é™ãŒãªã„

**å¯¾å‡¦æ³•**ï¼š
```bash
STORAGE_ACCOUNT_ID=$(az storage account show \
  --name $ARM_STORAGE_ACCOUNT_NAME \
  --resource-group $ARM_RESOURCE_GROUP_NAME \
  --query id -o tsv)

az role assignment create \
  --assignee $APP_ID \
  --role "Storage Blob Data Contributor" \
  --scope $STORAGE_ACCOUNT_ID
```

### ã‚¨ãƒ©ãƒ¼3: Subscriptionæ¨©é™ã‚¨ãƒ©ãƒ¼

```
Error: insufficient privileges to complete the operation
```

**åŸå› **ï¼šService Principalã«Owneræ¨©é™ãŒãªã„

**ç¢ºèª**ï¼š
```bash
az role assignment list \
  --assignee $APP_ID \
  --scope "/subscriptions/$SUBSCRIPTION_ID"
```

**Owneræ¨©é™ä»˜ä¸**ï¼š
```bash
az role assignment create \
  --assignee $APP_ID \
  --role "Owner" \
  --scope "/subscriptions/$SUBSCRIPTION_ID"
```

### ã‚¨ãƒ©ãƒ¼4: Terraform Lock

```
Error: Error acquiring the state lock
```

**åŸå› **ï¼šå‰å›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¦LockãŒæ®‹ã£ã¦ã‚‹

**å¯¾å‡¦æ³•**ï¼š
```bash
# Azure Portal â†’ Storage Account â†’ tfstateã‚³ãƒ³ãƒ†ãƒŠ
# .terraform.lock.info ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

# ã¾ãŸã¯CLI
az storage blob delete \
  --account-name $ARM_STORAGE_ACCOUNT_NAME \
  --container-name $ARM_CONTAINER_NAME \
  --name .terraform.lock.info \
  --auth-mode login
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… Management Group

```bash
# éšå±¤æ§‹é€ ç¢ºèª
az account management-group list --output table

# æœŸå¾…ã•ã‚Œã‚‹æ§‹é€ ï¼š
# myorg
# â”œâ”€â”€ myorg-platform
# â”‚   â”œâ”€â”€ myorg-management
# â”‚   â”œâ”€â”€ myorg-identity
# â”‚   â””â”€â”€ myorg-connectivity
# â”œâ”€â”€ myorg-landing-zones
# â”‚   â”œâ”€â”€ myorg-corp
# â”‚   â””â”€â”€ myorg-online
# â””â”€â”€ myorg-decommissioned
```

### âœ… Resource Group

```bash
az group list --query "[].{Name:name, Location:location}" --output table

# æœŸå¾…ã•ã‚Œã‚‹Resource Groupï¼š
# rg-myorg-management-001
# rg-myorg-connectivity-001
# rg-myorg-identity-001
# rg-terraform-state
```

### âœ… Log Analytics Workspace

```bash
az monitor log-analytics workspace list --output table

# law-myorg-management-001 ãŒå­˜åœ¨
```

### âœ… VNetï¼ˆæœ‰åŠ¹åŒ–ã—ã¦ã„ã‚‹å ´åˆï¼‰

```bash
az network vnet list --output table

# vnet-myorg-jpe-hub ãŒå­˜åœ¨
```

### âœ… Firewallï¼ˆæœ‰åŠ¹åŒ–ã—ã¦ã„ã‚‹å ´åˆï¼‰

```bash
az network firewall list --output table

# fw-myorg-jpe-hub ãŒå­˜åœ¨
```

### âœ… Policy Assignment

```bash
az policy assignment list \
  --scope "/providers/Microsoft.Management/managementGroups/myorg" \
  --output table

# è¤‡æ•°ã®Policy AssignmentãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### âœ… GitHub Actionså±¥æ­´

```
GitHub â†’ Actions
  â†“
CI/CDã®å®Ÿè¡Œå±¥æ­´ãŒæ®‹ã£ã¦ã‚‹
```

---

## ã¾ã¨ã‚

**ãƒ‡ãƒ—ãƒ­ã‚¤ã®æµã‚Œ**ï¼š
```
Phase 1: Azureæº–å‚™ï¼ˆService Principalã€Storage Accountï¼‰
Phase 2: GitHubæº–å‚™ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã€Secretsï¼‰
Phase 3: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤
Phase 4: GitHub Actionsã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤
Phase 5: æœ¬æ ¼çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤
Phase 6: å‹•ä½œç¢ºèª
```

**æ‰€è¦æ™‚é–“**ï¼š
```
Phase 1: 30åˆ†
Phase 2: 30åˆ†
Phase 3: 60åˆ†
Phase 4: 30åˆ†
Phase 5: 60åˆ†
Phase 6: 20åˆ†
-----------
åˆè¨ˆ: ç´„3.5æ™‚é–“
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**ï¼š
- **Service Principal**: OIDCè¨­å®šå¿…é ˆ
- **Storage Account**: Stateä¿å­˜å…ˆ
- **ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ**: æœ€åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèª
- **æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤**: ã„ããªã‚Šå…¨éƒ¨æœ‰åŠ¹åŒ–ã—ãªã„
- **ã‚³ã‚¹ãƒˆç¢ºèª**: Firewallç­‰ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å‰ã«ç¢ºèª

---

## ç·´ç¿’å•é¡Œ

å®Ÿè·µçš„ãªç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚

### å•é¡Œ1
OIDCèªè¨¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®é•ã„ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚

### å•é¡Œ2
ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã€ä½•ãŒåŸå› ã§ã™ã‹ï¼Ÿ
```
Error: zones are not supported in this region
```

### å•é¡Œ3
Terraform Stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ãªãã€  
Azure Storage Accountã«ä¿å­˜ã™ã‚‹ç†ç”±ã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚

---

## ç·´ç¿’å•é¡Œã®ç­”ãˆ

### ç­”ãˆ1
**OIDCèªè¨¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®é•ã„**:

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: OIDC = ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ = æ¼æ´©ãƒªã‚¹ã‚¯ã‚ã‚Š
2. **æ›´æ–°**: OIDC = è‡ªå‹•æ›´æ–°ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ = å®šæœŸçš„ãªæ‰‹å‹•æ›´æ–°ãŒå¿…è¦
3. **ä¿¡é ¼ãƒ¢ãƒ‡ãƒ«**: OIDC = è¨¼æ˜æ›¸ãƒ™ãƒ¼ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ = ç§˜å¯†æƒ…å ±ã®ä¿å­˜

### ç­”ãˆ2
**åŸå› **: Japan Eastç­‰ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã€Availability Zonesã«å¯¾å¿œã—ã¦ã„ãªã„ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦  
`zones = ["1", "2", "3"]`ã®ã‚ˆã†ã«æŒ‡å®šã—ã¦ã„ã‚‹ã€‚

**è§£æ±ºç­–**: `zones = []`ï¼ˆç©ºãƒªã‚¹ãƒˆï¼‰ã‚’æŒ‡å®šã™ã‚‹ã€‚

```hcl
primary_firewall_client_public_ip_zones = []
```

### ç­”ãˆ3
**Terraform Stateã‚’ãƒªãƒ¢ãƒ¼ãƒˆä¿å­˜ã™ã‚‹ç†ç”±**:

1. **ãƒãƒ¼ãƒ å…±æœ‰**: è¤‡æ•°äººã§åŒã˜Stateã‚’å‚ç…§ã§ãã‚‹ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã ã¨å€‹äººã®PCã«ã—ã‹ä¿å­˜ã•ã‚Œãªã„ã€‚
2. **å®‰å…¨æ€§**: ãƒ­ãƒ¼ã‚«ãƒ«PCã®æ•…éšœã‚„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã§StateãŒå¤±ã‚ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚’å›é¿ã€‚Azure Storageã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã€‚

**è¿½åŠ ã®åˆ©ç‚¹**:
- State Lockingã§ãƒãƒ¼ãƒ å†…ã®ç«¶åˆã‚’é˜²ã’ã‚‹
- GitHub Actionsã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹

---

æ¬¡ã®Chapterã§ã¯ã€ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã¨ãã®å¯¾å‡¦æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã«ãƒãƒã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã™ã‚‹ã‚ˆã€‚

---

**æ‰€è¦æ™‚é–“**: 65åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜…â˜…  
**å‰**: [12_GitHub_Actions.md](./12_GitHub_Actions.md)  
**æ¬¡**: [14_ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.md](./14_ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.md)
