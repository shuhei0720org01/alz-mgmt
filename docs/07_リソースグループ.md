# 07. リソースグループ - 最初のAzureリソース

## このChapterでやること

リソースグループの作成を理解しよう。

**リソースグループって何？**
Azureリソースを入れる「箱」みたいなもん。
VMとかVNetとか、全てのリソースは必ずどこかのリソースグループに属する。

**例えるなら**：

- **リソースグループ**：本棚
- **リソース**：本
- 本棚がないと本を置けないでしょ？

---

## リソースグループの基本

### 構造

```text
リソースグループ
  ├── 場所（location）
  ├── 名前（name）
  ├── タグ（tags）
  └── 中身のリソース
      ├── VNet
      ├── VM
      └── Storage Account
```text

### ルール

**1つのリソースは1つのリソースグループにしか属せない**

```text
OK:
rg-hub
  ├── vnet-hub
  └── firewall

NG:
vnet-hubが2つのRGに属する（できない）
```text

### 削除の挙動

**リソースグループを削除 → 中身のリソースも全部削除**

```bash
# これやると...
az group delete --name rg-hub

# ↓中身も全部消える
# - vnet-hub
# - firewall
# - bastion
# 全部消えちゃう！
```text

めっちゃ便利だけど、間違えると怖い。

---

## Part 1: 設定ファイル（tfvars）

### connectivity_resource_groups

Chapter 3で見たこれ：

```hcl
connectivity_resource_groups = {
  primary = {
    name     = "rg-{{starter_location_01_short}}-connectivity"
    location = "{{starter_location_01}}"
  }
  secondary = {
    name     = "rg-{{starter_location_02_short}}-connectivity"
    location = "{{starter_location_02}}"
  }
}
```text

**テンプレート処理後**：
```hcl
connectivity_resource_groups = {
  primary = {
    name     = "rg-jp-connectivity"
    location = "japaneast"
  }
  secondary = {
    name     = "rg-jp-connectivity"
    location = "japanwest"
  }
}
```text

### タグの追加

```hcl
connectivity_resource_groups = {
  primary = {
    name     = "rg-{{starter_location_01_short}}-connectivity"
    location = "{{starter_location_01}}"
    tags = {
      region = "primary"
      tier   = "network"
    }
  }
}
```text

**タグって何？**
メタデータ。コスト管理とか検索に使う。

### enabled設定

```hcl
connectivity_resource_groups = {
  primary = {
    name     = "rg-jp-connectivity"
    location = "japaneast"
    settings = {
      enabled = true  # ←作る
    }
  }
  secondary = {
    name     = "rg-jp-connectivity"
    location = "japanwest"
    settings = {
      enabled = false  # ←作らない
    }
  }
}
```text

**使い道**：
一時的に無効化したい時とか、段階的にデプロイしたい時に便利。

---

## Part 2: 変数定義（variables.connectivity.tf）

```hcl
variable "connectivity_resource_groups" {
  type = map(object({
    name     = string
    location = string
    tags     = optional(map(string))
    settings = optional(any)
  }))
  default     = {}
  description = "A map of resource groups to create"
}
```text

### 型の解説

#### map(object({...}))

```hcl
map(object({...}))
# ↑キー付きオブジェクトのマップ
```text

**イメージ**：
```hcl
{
  "primary" = {
    name     = "..."
    location = "..."
  }
  "secondary" = {
    name     = "..."
    location = "..."
  }
}
```text

キー（`primary`、`secondary`）で識別できる。

#### optional

```hcl
tags     = optional(map(string))
settings = optional(any)
```text

**意味**：省略してもOK

```hcl
# タグ省略
primary = {
  name     = "rg-hub"
  location = "japaneast"
  # tags省略 → null
}
```text

### デフォルト値

```hcl
default = {}
```text

**意味**：何も指定しなければ空マップ

```hcl
# tfvarsで何も書かない
# ↓
connectivity_resource_groups = {}
# ↓リソースグループ作られない
```text

---

## Part 3: モジュール呼び出し（main.resource.groups.tf）

```hcl
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }

  name             = each.value.name
  location         = each.value.location
  enable_telemetry = var.enable_telemetry
  tags             = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags

  providers = {
    azurerm = azurerm.connectivity
  }
}
```text

**1行ずつ見ていきましょう**

### source / version

```hcl
source  = "Azure/avm-res-resources-resourcegroup/azurerm"
version = "0.2.1"
```text

**何してる？**
Terraform Registryから公式モジュールをダウンロード。

**URL**：
https://registry.terraform.io/modules/Azure/avm-res-resources-resourcegroup/azurerm

### for_each

```hcl
for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }
```text

**複雑！**分解しよう。

#### 基本構造

```hcl
for_each = マップ
```text

マップの各要素に対してリソースを作る。

#### for式

```hcl
{ for key, value in 元のマップ : key => value if 条件 }
```text

**やってること**：
1. `module.config.outputs.connectivity_resource_groups`から各要素を取得
2. 条件（`if`）に合うものだけ残す
3. 新しいマップを作る

#### 条件: try(value.settings.enabled, true)

```hcl
try(value.settings.enabled, true)
```text

**意味**：

- `value.settings.enabled`が存在すればその値
- 存在しなければ`true`

**動作**：
```hcl
# enabled指定あり
settings = { enabled = false }
# ↓
try(value.settings.enabled, true) → false → 作らない

# enabled指定なし
settings = {}
# ↓
try(value.settings.enabled, true) → true → 作る

# settings自体がない
# ↓
try(value.settings.enabled, true) → true → 作る
```text

#### 具体例

```hcl
# 入力
connectivity_resource_groups = {
  primary = {
    name = "rg-primary"
    location = "japaneast"
  }
  secondary = {
    name = "rg-secondary"
    location = "japanwest"
    settings = { enabled = false }
  }
  tertiary = {
    name = "rg-tertiary"
    location = "eastus"
    settings = { enabled = true }
  }
}

# for_each後
{
  "primary" = { name = "rg-primary", location = "japaneast" }
  # secondaryは除外（enabled = false）
  "tertiary" = { name = "rg-tertiary", location = "eastus" }
}

# 結果：primaryとtertiaryだけ作られる
```text

### name / location

```hcl
name     = each.value.name
location = each.value.location
```text

**each.value**：現在処理中の要素

```hcl
# primary処理中
each.value = {
  name = "rg-jp-connectivity"
  location = "japaneast"
}

# ↓
name = "rg-jp-connectivity"
location = "japaneast"
```text

### tags

```hcl
tags = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags
```text

**三項演算子**：
```hcl
条件 ? 真の場合 : 偽の場合
```text

**ロジック**：
```hcl
try(each.value.tags, null) == null
  ? module.config.outputs.tags      # ←個別タグなし → 全体タグ使う
  : each.value.tags                 # ←個別タグあり → それ使う
```text

**動作**：
```hcl
# ケース1: 個別タグなし
primary = {
  name = "rg-hub"
  # tagsなし
}
# ↓全体タグ使う
tags = { deployed_by = "terraform", source = "alz-mgmt" }

# ケース2: 個別タグあり
primary = {
  name = "rg-hub"
  tags = { tier = "network" }
}
# ↓個別タグ使う
tags = { tier = "network" }
```text

### providers

```hcl
providers = {
  azurerm = azurerm.connectivity
}
```text

**何してる？**
Connectivityサブスクリプションにリソース作成。

**provider alias**：
```hcl
# terraform.tf
provider "azurerm" {
  alias           = "connectivity"
  subscription_id = var.subscription_ids["connectivity"]
  ...
}
```text

特定のサブスクリプションを指定しています。

---

## Part 4: モジュールの出力

### 何が出力される？

```hcl
# 使い方
module.resource_groups["primary"].resource_group_id
```text

**出力される情報**：

- `resource_group_id`：リソースグループのID
- `name`：名前
- `location`：場所

### 他のリソースから参照

```hcl
# VNetを作る時
resource "azurerm_virtual_network" "hub" {
  resource_group_name = module.resource_groups["primary"].name
  ...
}
```text

**効果**：

- リソースグループ → VNetの順番で作られる（依存関係）

---

## 実践：リソースグループを追加してみよう

### 例1: 開発環境用RG

```hcl
# platform-landing-zone.auto.tfvars
connectivity_resource_groups = {
  primary = {
    name     = "rg-{{starter_location_01_short}}-connectivity"
    location = "{{starter_location_01}}"
  }
  dev = {
    name     = "rg-{{starter_location_01_short}}-dev"
    location = "{{starter_location_01}}"
    tags = {
      environment = "development"
      tier        = "network"
    }
  }
}
```text

### 例2: 複数リージョン

```hcl
connectivity_resource_groups = {
  japaneast = {
    name     = "rg-jpe-connectivity"
    location = "japaneast"
    tags = { region = "primary" }
  }
  japanwest = {
    name     = "rg-jpw-connectivity"
    location = "japanwest"
    tags = { region = "secondary" }
  }
  eastus = {
    name     = "rg-eus-connectivity"
    location = "eastus"
    tags = { region = "dr" }
  }
}
```text

### 例3: 一時的に無効化

```hcl
connectivity_resource_groups = {
  primary = {
    name     = "rg-jp-connectivity"
    location = "japaneast"
  }
  secondary = {
    name     = "rg-jp-connectivity-sec"
    location = "japanwest"
    settings = {
      enabled = false  # ←一時的に作らない
    }
  }
}
```text

```bash
# 後で有効化
terraform apply  # ←secondaryは作られない

# enabled = trueに変更
terraform apply  # ←secondaryが作られる
```text

---

## デバッグ技

### 出力で確認

```hcl
# outputs.tf
output "debug_resource_groups" {
  value = {
    for key, rg in module.resource_groups : key => {
      id       = rg.resource_group_id
      name     = rg.name
      location = rg.location
    }
  }
}
```text

```bash
terraform apply

# ↓出力
Outputs:
  debug_resource_groups = {
    "primary" = {
      id       = "/subscriptions/.../resourceGroups/rg-jp-connectivity"
      name     = "rg-jp-connectivity"
      location = "japaneast"
    }
  }
```text

### Azureで確認

```bash
# 作成されたか確認
az group list --output table

# 特定のRGの詳細
az group show --name rg-jp-connectivity
```text

---

## よくあるエラー

### エラー1: 名前の重複

```text
Error: A resource with the ID "/subscriptions/.../resourceGroups/rg-hub" already exists
```text

**原因**：同じ名前のリソースグループが既に存在

**対処法**：
```hcl
# 名前を変える
name = "rg-jp-connectivity-v2"

# または既存を削除
az group delete --name rg-jp-connectivity
```text

### エラー2: 無効なlocation

```text
Error: Invalid value for location
```text

**原因**：locationの綴りミス

**対処法**：
```hcl
# NG
location = "japan-east"  # ハイフン入ってる

# OK
location = "japaneast"  # ハイフンなし
```text

### エラー3: for_eachのエラー

```text
Error: The for_each value does not have any elements
```text

**原因**：`connectivity_resource_groups`が空

**対処法**：
```hcl
# tfvarsで最低1個定義
connectivity_resource_groups = {
  primary = {
    name     = "rg-hub"
    location = "japaneast"
  }
}
```text

---

## リソースグループの設計パターン

### パターン1: 機能別

```hcl
connectivity_resource_groups = {
  network = {
    name     = "rg-network"
    location = "japaneast"
  }
  security = {
    name     = "rg-security"
    location = "japaneast"
  }
  management = {
    name     = "rg-management"
    location = "japaneast"
  }
}
```text

**メリット**：役割が明確
**デメリット**：リソース数が多いと管理が大変

### パターン2: リージョン別

```hcl
connectivity_resource_groups = {
  japaneast = {
    name     = "rg-jpe-connectivity"
    location = "japaneast"
  }
  japanwest = {
    name     = "rg-jpw-connectivity"
    location = "japanwest"
  }
}
```text

**メリット**：マルチリージョン構成がわかりやすい
**デメリット**：同じリージョンに複数RGあると混乱

### パターン3: 環境別

```hcl
connectivity_resource_groups = {
  prod = {
    name     = "rg-prod-connectivity"
    location = "japaneast"
  }
  dev = {
    name     = "rg-dev-connectivity"
    location = "japaneast"
  }
}
```text

**メリット**：環境分離が簡単
**デメリット**：Landing Zonesの思想と合わない（サブスクリプションで分離すべき）

### おすすめ：ハイブリッド

```hcl
connectivity_resource_groups = {
  primary_network = {
    name     = "rg-jpe-network"
    location = "japaneast"
    tags = { tier = "network", region = "primary" }
  }
  secondary_network = {
    name     = "rg-jpw-network"
    location = "japanwest"
    tags = { tier = "network", region = "secondary" }
  }
}
```text

**リージョン × 機能**で分ける。わかりやすい。

---

## まとめ

**リソースグループの役割**：
1. **リソースの箱**：全てのリソースはRGに属する
2. **ライフサイクル管理**：RG削除で中身も全部削除
3. **アクセス制御**：RG単位で権限管理
4. **タグ付け**：コスト管理、検索

**覚えておくこと**：

- `for_each`でマップを展開
- `try(value.settings.enabled, true)`で有効/無効制御
- タグはフォールバック（個別 → 全体）
- `providers`でサブスクリプション指定

次のChapterでは、管理グループとポリシーの作成を見ていきます。
ガバナンスの要となる部分です。

---

**所要時間**: 40分  
**難易度**: ★★★☆☆  
**前**: [06_設定テンプレート.md](./06_設定テンプレート.md)  
**次**: [08_管理グループとポリシー.md](./08_管理グループとポリシー.md)
