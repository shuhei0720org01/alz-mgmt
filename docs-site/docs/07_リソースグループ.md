# 07. リソースグループ - 最初のAzureリソース

## このChapterでやること

リソースグループの作成を理解しよう。

**リソースグループって何？**
Azureリソースを入れる「箱」みたいなもん。
VMとかVNetとか、全てのリソースは必ずどこかのリソースグループに属する。

**例えるなら**：

- **リソースグループ**：本棚
- **リソース**：本
- 本棚がないと本を置けないでしょ？

---

## リソースグループの基本

### 構造

```text title="リソースグループの構造"
リソースグループ
  ├── 場所（location）
  ├── 名前（name）
  ├── タグ（tags）
  └── 中身のリソース
      ├── VNet
      ├── VM
      └── Storage Account
```

### ルール

**1つのリソースは1つのリソースグループにしか属せない**

```text title="リソースの所属ルール"
OK:
rg-hub
  ├── vnet-hub
  └── firewall

NG:
vnet-hubが2つのRGに属する（できない）
```

### 削除の挙動

**リソースグループを削除 → 中身のリソースも全部削除**

```bash title="リソースグループの削除"
# これやると...
az group delete --name rg-hub

# ↓中身も全部消える
# - vnet-hub
# - firewall
# - bastion
# 全部消えちゃう！
```

めっちゃ便利だけど、間違えると怖い。

---

## Part 1: 設定ファイル（tfvars）

### connectivity_resource_groups

Chapter 3で見たこれ：

```hcl title="テンプレート変数を使った定義"
connectivity_resource_groups = {
  primary = {
    name     = "rg-{{starter_location_01_short}}-connectivity"
    location = "{{starter_location_01}}"
  }
  secondary = {
    name     = "rg-{{starter_location_02_short}}-connectivity"
    location = "{{starter_location_02}}"
  }
}
```

**テンプレート処理後**：
```hcl title="置換後の実際の値"
connectivity_resource_groups = {
  primary = {
    name     = "rg-jp-connectivity"
    location = "japaneast"
  }
  secondary = {
    name     = "rg-jp-connectivity"
    location = "japanwest"
  }
}
```

### タグの追加

```hcl title="タグ付きリソースグループ"
connectivity_resource_groups = {
  primary = {
    name     = "rg-{{starter_location_01_short}}-connectivity"
    location = "{{starter_location_01}}"
    tags = {
      region = "primary"
      tier   = "network"
    }
  }
}
```

**タグって何？**
メタデータ。コスト管理とか検索に使う。

### enabled設定

```hcl title="有効/無効の制御"
connectivity_resource_groups = {
  primary = {
    name     = "rg-jp-connectivity"
    location = "japaneast"
    settings = {
      enabled = true  # ←作る
    }
  }
  secondary = {
    name     = "rg-jp-connectivity"
    location = "japanwest"
    settings = {
      enabled = false  # ←作らない
    }
  }
}
```

**使い道**：
一時的に無効化したい時とか、段階的にデプロイしたい時に便利。

---

## Part 2: 変数定義（variables.connectivity.tf）

```hcl title="connectivity_resource_groups変数の定義"
variable "connectivity_resource_groups" {
  type = map(object({
    name     = string
    location = string
    tags     = optional(map(string))
    settings = optional(any)
  }))
  default     = {}
  description = "A map of resource groups to create"
}
```

### 型の解説

#### map(object({...}))

```hcl title="型の構造"
map(object({...}))
# ↑キー付きオブジェクトのマップ
```

**イメージ**：
```hcl title="マップ構造の例"
{
  "primary" = {
    name     = "..."
    location = "..."
  }
  "secondary" = {
    name     = "..."
    location = "..."
  }
}
```

キー（`primary`、`secondary`）で識別できる。

#### optional

```hcl title="省略可能な属性"
tags     = optional(map(string))
settings = optional(any)
```

**意味**：省略してもOK

```hcl title="属性の省略例"
# タグ省略
primary = {
  name     = "rg-hub"
  location = "japaneast"
  # tags省略 → null
}
```

### デフォルト値

```hcl title="空マップのデフォルト"
default = {}
```

**意味**：何も指定しなければ空マップ

```hcl title="デフォルト値の動作"
# tfvarsで何も書かない
# ↓
connectivity_resource_groups = {}
# ↓リソースグループ作られない
```

---

## Part 3: モジュール呼び出し（main.resource.groups.tf）

```hcl title="リソースグループモジュールの呼び出し"
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }

  name             = each.value.name
  location         = each.value.location
  enable_telemetry = var.enable_telemetry
  tags             = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags

  providers = {
    azurerm = azurerm.connectivity
  }
}
```

**1行ずつ見ていきましょう**

### source / version

```hcl title="モジュールのソース指定"
source  = "Azure/avm-res-resources-resourcegroup/azurerm"
version = "0.2.1"
```

**何してる？**
Terraform Registryから公式モジュールをダウンロード。

**URL**：
https://registry.terraform.io/modules/Azure/avm-res-resources-resourcegroup/azurerm

### for_each

```hcl title="enabled条件付きfor_each"
for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }
```

複雑！分解しよう。

#### 基本構造

```hcl
for_each = マップ
```

マップの各要素に対してリソースを作る。

#### for式

```hcl title="for式の構文"
{ for key, value in 元のマップ : key => value if 条件 }
```

**やってること**：
1. `module.config.outputs.connectivity_resource_groups`から各要素を取得
2. 条件（`if`）に合うものだけ残す
3. 新しいマップを作る

#### 条件: try(value.settings.enabled, true)

```hcl title="try関数の使用"
try(value.settings.enabled, true)
```

**意味**：

- `value.settings.enabled`が存在すればその値
- 存在しなければ`true`

**動作**：
```hcl title="enabled判定の動作パターン"
# enabled指定あり
settings = { enabled = false }
# ↓
try(value.settings.enabled, true) → false → 作らない

# enabled指定なし
settings = {}
# ↓
try(value.settings.enabled, true) → true → 作る

# settings自体がない
# ↓
try(value.settings.enabled, true) → true → 作る
```

#### 具体例

```hcl title="for_eachによるフィルタリングの実例"
# 入力
connectivity_resource_groups = {
  primary = {
    name = "rg-primary"
    location = "japaneast"
  }
  secondary = {
    name = "rg-secondary"
    location = "japanwest"
    settings = { enabled = false }
  }
  tertiary = {
    name = "rg-tertiary"
    location = "eastus"
    settings = { enabled = true }
  }
}

# for_each後
{
  "primary" = { name = "rg-primary", location = "japaneast" }
  # secondaryは除外（enabled = false）
  "tertiary" = { name = "rg-tertiary", location = "eastus" }
}

# 結果：primaryとtertiaryだけ作られる
```

### name / location

```hcl title="each.valueの使用"
name     = each.value.name
location = each.value.location
```

**each.value**：現在処理中の要素

```hcl title="each.valueの内容"
# primary処理中
each.value = {
  name = "rg-jp-connectivity"
  location = "japaneast"
}

# ↓
name = "rg-jp-connectivity"
location = "japaneast"
```

### tags

```hcl title="タグのフォールバック処理"
tags = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags
```

**三項演算子**：
```hcl
条件 ? 真の場合 : 偽の場合
```

**ロジック**：
```hcl
try(each.value.tags, null) == null
  ? module.config.outputs.tags      # ←個別タグなし → 全体タグ使う
  : each.value.tags                 # ←個別タグあり → それ使う
```

**動作**：
```hcl title="タグの選択ロジック"
# ケース1: 個別タグなし
primary = {
  name = "rg-hub"
  # tagsなし
}
# ↓全体タグ使う
tags = { deployed_by = "terraform", source = "alz-mgmt" }

# ケース2: 個別タグあり
primary = {
  name = "rg-hub"
  tags = { tier = "network" }
}
# ↓個別タグ使う
tags = { tier = "network" }
```

### providers

```hcl title="サブスクリプション指定"
providers = {
  azurerm = azurerm.connectivity
}
```

**何してる？**
Connectivityサブスクリプションにリソース作成。

**provider alias**：
```hcl title="providerの定義（terraform.tf）"
# terraform.tf
provider "azurerm" {
  alias           = "connectivity"
  subscription_id = var.subscription_ids["connectivity"]
  ...
}
```

特定のサブスクリプションを指定しています。

---

## Part 4: モジュールの出力

### 何が出力される？

```hcl title="モジュール出力の参照"
# 使い方
module.resource_groups["primary"].resource_group_id
```

**出力される情報**：

- `resource_group_id`：リソースグループのID
- `name`：名前
- `location`：場所

### 他のリソースから参照

```hcl title="リソースグループ名の参照"
# VNetを作る時
resource "azurerm_virtual_network" "hub" {
  resource_group_name = module.resource_groups["primary"].name
  ...
}
```

**効果**：

- リソースグループ → VNetの順番で作られる（依存関係）

---

## 実践：リソースグループを追加してみよう

### 例1: 開発環境用RG

```hcl title="開発環境用リソースグループの追加"
# platform-landing-zone.auto.tfvars
connectivity_resource_groups = {
  primary = {
    name     = "rg-{{starter_location_01_short}}-connectivity"
    location = "{{starter_location_01}}"
  }
  dev = {
    name     = "rg-{{starter_location_01_short}}-dev"
    location = "{{starter_location_01}}"
    tags = {
      environment = "development"
      tier        = "network"
    }
  }
}
```

### 例2: 複数リージョン

```hcl title="マルチリージョン構成"
connectivity_resource_groups = {
  japaneast = {
    name     = "rg-jpe-connectivity"
    location = "japaneast"
    tags = { region = "primary" }
  }
  japanwest = {
    name     = "rg-jpw-connectivity"
    location = "japanwest"
    tags = { region = "secondary" }
  }
  eastus = {
    name     = "rg-eus-connectivity"
    location = "eastus"
    tags = { region = "dr" }
  }
}
```

### 例3: 一時的に無効化

```hcl title="enabledフラグでの制御"
connectivity_resource_groups = {
  primary = {
    name     = "rg-jp-connectivity"
    location = "japaneast"
  }
  secondary = {
    name     = "rg-jp-connectivity-sec"
    location = "japanwest"
    settings = {
      enabled = false  # ←一時的に作らない
    }
  }
}
```

```bash title="段階的デプロイ"
# 後で有効化
terraform apply  # ←secondaryは作られない

# enabled = trueに変更
terraform apply  # ←secondaryが作られる
```

---

## デバッグ技

### 出力で確認

```hcl title="デバッグ用output定義"
# outputs.tf
output "debug_resource_groups" {
  value = {
    for key, rg in module.resource_groups : key => {
      id       = rg.resource_group_id
      name     = rg.name
      location = rg.location
    }
  }
}
```

```bash title="outputの確認"
terraform apply

# ↓出力
Outputs:
  debug_resource_groups = {
    "primary" = {
      id       = "/subscriptions/.../resourceGroups/rg-jp-connectivity"
      name     = "rg-jp-connectivity"
      location = "japaneast"
    }
  }
```

### Azureで確認

```bash title="Azure CLIでの確認"
# 作成されたか確認
az group list --output table

# 特定のRGの詳細
az group show --name rg-jp-connectivity
```

---

## よくあるエラー

### エラー1: 名前の重複

```
Error: A resource with the ID "/subscriptions/.../resourceGroups/rg-hub" already exists
```

**原因**：同じ名前のリソースグループが既に存在

**対処法**：
```hcl title="名前重複の解決"
# 名前を変える
name = "rg-jp-connectivity-v2"

# または既存を削除
az group delete --name rg-jp-connectivity
```

### エラー2: 無効なlocation

```
Error: Invalid value for location
```

**原因**：locationの綴りミス

**対処法**：
```hcl title="locationの正しい書き方"
# NG
location = "japan-east"  # ハイフン入ってる

# OK
location = "japaneast"  # ハイフンなし
```

### エラー3: for_eachのエラー

```
Error: The for_each value does not have any elements
```

**原因**：`connectivity_resource_groups`が空

**対処法**：
```hcl title="最低限1個の定義が必要"
# tfvarsで最低1個定義
connectivity_resource_groups = {
  primary = {
    name     = "rg-hub"
    location = "japaneast"
  }
}
```

---

## リソースグループの設計パターン

### パターン1: 機能別

```hcl title="機能別リソースグループ"
connectivity_resource_groups = {
  network = {
    name     = "rg-network"
    location = "japaneast"
  }
  security = {
    name     = "rg-security"
    location = "japaneast"
  }
  management = {
    name     = "rg-management"
    location = "japaneast"
  }
}
```

**メリット**：役割が明確
**デメリット**：リソース数が多いと管理が大変

### パターン2: リージョン別

```hcl title="リージョン別リソースグループ"
connectivity_resource_groups = {
  japaneast = {
    name     = "rg-jpe-connectivity"
    location = "japaneast"
  }
  japanwest = {
    name     = "rg-jpw-connectivity"
    location = "japanwest"
  }
}
```

**メリット**：マルチリージョン構成がわかりやすい
**デメリット**：同じリージョンに複数RGあると混乱

### パターン3: 環境別

```hcl title="環境別リソースグループ"
connectivity_resource_groups = {
  prod = {
    name     = "rg-prod-connectivity"
    location = "japaneast"
  }
  dev = {
    name     = "rg-dev-connectivity"
    location = "japaneast"
  }
}
```

**メリット**：環境分離が簡単
**デメリット**：Landing Zonesの思想と合わない（サブスクリプションで分離すべき）

### おすすめ：ハイブリッド

```hcl title="リージョン×機能のハイブリッド"
connectivity_resource_groups = {
  primary_network = {
    name     = "rg-jpe-network"
    location = "japaneast"
    tags = { tier = "network", region = "primary" }
  }
  secondary_network = {
    name     = "rg-jpw-network"
    location = "japanwest"
    tags = { tier = "network", region = "secondary" }
  }
}
```

リージョン × 機能で分ける。わかりやすい。

---

## まとめ

**リソースグループの役割**：
1. **リソースの箱**：全てのリソースはRGに属する
2. **ライフサイクル管理**：RG削除で中身も全部削除
3. **アクセス制御**：RG単位で権限管理
4. **タグ付け**：コスト管理、検索

**覚えておくこと**：

- `for_each`でマップを展開
- `try(value.settings.enabled, true)`で有効/無効制御
- タグはフォールバック（個別 → 全体）
- `providers`でサブスクリプション指定

次のChapterでは、管理グループとポリシーの作成を見ていきます。
ガバナンスの要となる部分です。

## 練習問題

理解度チェックです。休憩中に考えてみましょう。

### 問題1
このプロジェクトで作成される管理リソースグループの名前は何ですか？  
（`starter_location_01 = "japaneast"`の場合）

### 問題2
`for_each = local.resource_groups`を使う理由は何ですか？

### 問題3
次の設定で、リソースグループに付与されるタグは何ですか？

```hcl
management_resource_tags = {
  environment = "prod"
}
```

---

## 練習問題の答え

### 答え1
**`rg-management-jp`**になります。

```hcl
management_resource_group_name = "rg-management-$${starter_location_01_short}"
# starter_location_01_short = "jp"
# 結果: rg-management-jp
```

### 答え2
**複数のリソースグループを一度に作成するため**です。

```hcl
for_each = local.resource_groups
# {
#   "rg-management-jp" = {...}
#   "rg-connectivity-jp" = {...}
#   ...
# }
```

`for_each`を使うことで、mapの要素ごとにリソースを作成できます。

### 答え3
**`environment = "prod"`が付与されます。**

```hcl
tags = {
  environment = "prod"
}
```

`management_resource_tags`に設定した値が、  
そのままリソースグループの`tags`として設定されます。

---

**所要時間**: 40分  
**難易度**: ★★★☆☆  
**前**: [06_設定テンプレート.md](./06_設定テンプレート.md)  
**次**: [08_管理グループとポリシー.md](./08_管理グループとポリシー.md)
