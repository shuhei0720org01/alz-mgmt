# 09. 管理リソース - Log AnalyticsとDCRの完全解説

!!! info "この章で学ぶこと"
    管理リソース（Log Analytics、Data Collection Rules、Managed Identity）の実装を完全に理解します：

    1. 実際の設定ファイル（platform-landing-zone.auto.tfvars）の構造
    2. 変数置換システム（`$${variable_name}`）の仕組み
    3. main.management.tfからモジュール呼び出しの流れ
    4. modules/management_resources/の解説（ローカルモジュール）
    5. 公式モジュール（Azure/avm-ptn-alz-management）の内部構造
    6. 全体フロー図（設定→リソース作成まで）
    7. 実践パターン（カスタマイズ方法）

---

## Part 1: 設定ファイル（platform-landing-zone.auto.tfvars）

ここからも実際のファイルを見ながらいこう。

### management_resource_settings

platform-landing-zone.auto.tfvarsを開いてみよう。management_resource_settingsの設定が書いてある。

```hcl title="platform-landing-zone.auto.tfvars（抜粋）"
management_resource_settings = {
  enabled                      = true
  location                     = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name          = "$${management_resource_group_name}"
  
  user_assigned_managed_identities = {
    ama = {
      name = "$${ama_user_assigned_managed_identity_name}"
    }
  }
  
  data_collection_rules = {
    change_tracking = {
      name = "$${dcr_change_tracking_name}"
    }
    defender_sql = {
      name = "$${dcr_defender_sql_name}"
    }
    vm_insights = {
      name = "$${dcr_vm_insights_name}"
    }
  }
}
```


**すべて`$${変数名}`形式**なのが特徴。これは**変数置換システム**だよ。

### 変数置換システムの仕組み

```text title="変数置換の流れ"
platform-landing-zone.auto.tfvars
↓
management_resource_settings = {
  location = "$${starter_location_01}"  ←プレースホルダー
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  ...
}
↓
main.config.tf
  module "config-templating" {
    custom_replacements = {
      starter_location_01 = "japaneast"
      log_analytics_workspace_name = "law-mgmt-japaneast-001"
      management_resource_group_name = "rg-mgmt-japaneast-001"
      ...
    }
  }
↓
config-templatingモジュールが$${...}を実際の値に置換
↓
locals.tf
  local.management_resource_settings = {
    location = "japaneast"  ←置換後
    log_analytics_workspace_name = "law-mgmt-japaneast-001"
    resource_group_name = "rg-mgmt-japaneast-001"
    ...
  }
```

**なぜこんなことするの？**

- 環境ごとに異なる名前を簡単に管理できる
- `custom_replacements`を変えるだけで全体の設定を変更できる
- テンプレートとして再利用しやすい

### 変数定義（custom_replacements.names）

同じplatform-landing-zone.auto.tfvarsファイルのcustom_replacements.namesを見てみよう。

```hcl title="platform-landing-zone.auto.tfvars（抜粋）"
custom_replacements = {
  names = {
    # Management resources
    ama_user_assigned_managed_identity_name = "id-ama-$${starter_location_01}"
    dcr_change_tracking_name                = "dcr-change-tracking-$${starter_location_01}"
    dcr_defender_sql_name                   = "dcr-defender-sql-$${starter_location_01}"
    dcr_vm_insights_name                    = "dcr-vm-insights-$${starter_location_01}"
    log_analytics_workspace_name            = "law-management-$${starter_location_01}"
    management_resource_group_name          = "rg-management-$${starter_location_01}"

    # Locations
    starter_location_01 = "japaneast"
    starter_location_02 = "japanwest"
    
    # ... その他の変数
  }
}
```

**何してる？**

ここで実際の値を定義してる。例えば：

- `starter_location_01 = "japaneast"`
- `log_analytics_workspace_name = "law-management-japaneast"`（これも`$${starter_location_01}`を含む）

**置換の多段階処理**：

```text title="多段階置換の例"
最初の定義：
log_analytics_workspace_name = "law-management-$${starter_location_01}"

1回目の置換（starter_location_01 = "japaneast"）：
log_analytics_workspace_name = "law-management-japaneast"

最終的な値：
"law-management-japaneast"
```

config-templatingモジュールが全ての`$${...}`を再帰的に置換してくれる。

---

## Part 2: main.management.tfとモジュール構造

次は、モジュール呼び出しを見ていこう。

### main.management.tfの実際

main.management.tfを開いてみよう。

```hcl title="main.management.tf（抜粋）"
module "management_resources" {
  source = "./modules/management_resources"
  count  = var.management_resources_enabled ? 1 : 0

  enable_telemetry             = var.enable_telemetry
  management_resource_settings = local.management_resource_settings

  providers = {
    azurerm = azurerm.management
  }
}
```

**何してる？**

- **count**：`var.management_resources_enabled = true`なら作成、`false`ならスキップ
- **source**：ローカルモジュール`./modules/management_resources`を呼び出し
- **management_resource_settings**：置換済みの設定を渡す（`local.management_resource_settings`）
- **providers**：管理サブスクリプション用のプロバイダを使用

**countパターンの動作**：

```text title="countによる条件付き作成"
var.management_resources_enabled = true
↓
count = 1（モジュール実行）

var.management_resources_enabled = false
↓
count = 0（モジュールスキップ）
```

### modules/management_resources/main.tfの実際

modules/management_resources/main.tfを開いてみよう。

```hcl title="modules/management_resources/main.tf（抜粋）"
module "management_resources" {
  source  = "Azure/avm-ptn-alz-management/azurerm"
  version = "0.9.0"

  # Location (required)
  location = var.management_resource_settings.location

  # Resource names (optional, auto-generated if not specified)
  automation_account_name      = null
  log_analytics_workspace_name = coalesce(
    var.management_resource_settings.log_analytics_workspace_name,
    "law-management-${var.management_resource_settings.location}"
  )
  resource_group_name = coalesce(
    var.management_resource_settings.resource_group_name,
    "rg-management-${var.management_resource_settings.location}"
  )

  # Data Collection Rules
  data_collection_rules = var.management_resource_settings.data_collection_rules

  # User Assigned Managed Identities
  user_assigned_managed_identities = var.management_resource_settings.user_assigned_managed_identities

  # Log Analytics Workspace settings
  log_analytics_workspace_allow_resource_only_permissions    = var.management_resource_settings.log_analytics_workspace_allow_resource_only_permissions
  log_analytics_workspace_cmk_for_query_forced               = var.management_resource_settings.log_analytics_workspace_cmk_for_query_forced
  log_analytics_workspace_daily_quota_gb                     = var.management_resource_settings.log_analytics_workspace_daily_quota_gb
  log_analytics_workspace_internet_ingestion_enabled         = var.management_resource_settings.log_analytics_workspace_internet_ingestion_enabled
  log_analytics_workspace_internet_query_enabled             = var.management_resource_settings.log_analytics_workspace_internet_query_enabled
  log_analytics_workspace_local_authentication_enabled       = var.management_resource_settings.log_analytics_workspace_local_authentication_enabled
  log_analytics_workspace_reservation_capacity_in_gb_per_day = var.management_resource_settings.log_analytics_workspace_reservation_capacity_in_gb_per_day
  log_analytics_workspace_retention_in_days                  = var.management_resource_settings.log_analytics_workspace_retention_in_days
  log_analytics_workspace_sku                                = var.management_resource_settings.log_analytics_workspace_sku

  # Log Analytics Solution Plans
  log_analytics_solution_plans = var.management_resource_settings.log_analytics_solution_plans

  # Sentinel onboarding
  sentinel_onboarding = var.management_resource_settings.sentinel_onboarding

  # Resource creation flags
  resource_group_creation_enabled            = true
  linked_automation_account_creation_enabled = false

  # Tags and telemetry
  tags             = var.management_resource_settings.tags
  enable_telemetry = var.enable_telemetry

  # Timeouts
  timeouts = var.management_resource_settings.timeouts
}
```

**何してる？**

このローカルモジュールは、公式モジュール`Azure/avm-ptn-alz-management/azurerm`を呼び出してる。

**重要なポイント**：

1. **coalesce関数でデフォルト値設定**：
   ```hcl
   log_analytics_workspace_name = coalesce(
     var.management_resource_settings.log_analytics_workspace_name,
     "law-management-${var.management_resource_settings.location}"
   )
   ```
   - ユーザーが指定してれば、その値を使う
   - 指定してなければ、自動生成（`law-management-japaneast`とか）

2. **公式モジュールへのパススルー**：
   ```hcl
   log_analytics_workspace_retention_in_days = var.management_resource_settings.log_analytics_workspace_retention_in_days
   ```
   - 設定ファイルの値を公式モジュールにそのまま渡す

3. **固定値の設定**：
   ```hcl
   resource_group_creation_enabled            = true  # 常に新規RG作成
   linked_automation_account_creation_enabled = false # Automation Accountは作らない
   ```

### modules/management_resources/variables.tfの実際

modules/management_resources/variables.tfを開いてみよう。

```hcl title="modules/management_resources/variables.tf（抜粋）"
variable "enable_telemetry" {
  type        = bool
  default     = true
  description = <<DESCRIPTION
This variable controls whether or not telemetry is enabled for the module.
For more information see <https://aka.ms/avm/telemetryinfo>.
If it is set to false, then no telemetry will be collected.
DESCRIPTION
}

variable "management_resource_settings" {
  type = object({
    enabled  = optional(bool, true)
    location = string

    automation_account_name      = optional(string)
    log_analytics_workspace_name = optional(string)
    resource_group_name          = optional(string)

    data_collection_rules = optional(object({
      change_tracking = optional(object({
        enabled  = optional(bool, true)
        name     = string
        location = optional(string)
        tags     = optional(map(string))
      }))
      vm_insights = optional(object({
        enabled  = optional(bool, true)
        name     = string
        location = optional(string)
        tags     = optional(map(string))
      }))
      defender_sql = optional(object({
        enabled                                                = optional(bool, true)
        name                                                   = string
        location                                               = optional(string)
        tags                                                   = optional(map(string))
        enable_collection_of_sql_queries_for_security_research = optional(bool, false)
      }))
    }))

    log_analytics_solution_plans = optional(list(object({
      product   = string
      publisher = optional(string)
    })))

    log_analytics_workspace_allow_resource_only_permissions    = optional(bool, true)
    log_analytics_workspace_cmk_for_query_forced               = optional(bool)
    log_analytics_workspace_daily_quota_gb                     = optional(number)
    log_analytics_workspace_internet_ingestion_enabled         = optional(bool, true)
    log_analytics_workspace_internet_query_enabled             = optional(bool, true)
    log_analytics_workspace_local_authentication_enabled       = optional(bool, true)
    log_analytics_workspace_reservation_capacity_in_gb_per_day = optional(number)
    log_analytics_workspace_retention_in_days                  = optional(number)
    log_analytics_workspace_sku                                = optional(string)

    sentinel_onboarding = optional(object({
      name                         = optional(string)
      customer_managed_key_enabled = optional(bool)
    }))

    tags = optional(map(string))

    timeouts = optional(object({
      sentinel_onboarding = optional(object({
        create = optional(string)
        delete = optional(string)
        update = optional(string)
        read   = optional(string)
      }))
      data_collection_rule = optional(object({
        create = optional(string)
        delete = optional(string)
        update = optional(string)
        read   = optional(string)
      }))
    }))

    user_assigned_managed_identities = optional(object({
      ama = optional(object({
        enabled  = optional(bool)
        name     = string
        location = optional(string)
        tags     = optional(map(string))
      }))
    }))
  })

  description = <<DESCRIPTION
Configuration settings for the management resources.

Required:
- location: Azure region where management resources will be deployed

Optional resource names (auto-generated if not specified):
- automation_account_name: Automation Account name
- log_analytics_workspace_name: Log Analytics Workspace name
- resource_group_name: Resource Group name

Data Collection Rules:
- change_tracking: Track file/registry changes (default: enabled)
- vm_insights: VM performance monitoring (default: enabled)
- defender_sql: SQL Server security monitoring (default: enabled)

Log Analytics Solution Plans:
- List of solutions to install (e.g., ContainerInsights, VMInsights)

Log Analytics Workspace settings:
- allow_resource_only_permissions: Enable resource-only permissions (default: true)
- cmk_for_query_forced: Force customer-managed keys for queries
- daily_quota_gb: Daily ingestion quota in GB
- internet_ingestion_enabled: Enable internet ingestion (default: true)
- internet_query_enabled: Enable internet queries (default: true)
- local_authentication_enabled: Enable local authentication (default: true)
- reservation_capacity_in_gb_per_day: Reservation capacity for CapacityReservation SKU
- retention_in_days: Data retention period (default: 30 days)
- sku: Pricing tier (default: PerGB2018)

Sentinel Onboarding:
- name: Sentinel onboarding name
- customer_managed_key_enabled: Enable customer-managed keys

Timeouts:
- sentinel_onboarding: Timeout values for Sentinel operations
- data_collection_rule: Timeout values for DCR operations

User Assigned Managed Identities:
- ama: Azure Monitor Agent identity configuration
DESCRIPTION
}
```

**何してる？**

`management_resource_settings`という複雑なオブジェクト型を定義してる。

**主要なフィールド**：

| カテゴリ | フィールド | 型 | デフォルト | 説明 |
|---------|----------|-----|-----------|------|
| **必須** | location | string | - | デプロイ先リージョン |
| **リソース名** | automation_account_name | optional(string) | 自動生成 | Automation Account名 |
| | log_analytics_workspace_name | optional(string) | 自動生成 | Log Analytics Workspace名 |
| | resource_group_name | optional(string) | 自動生成 | Resource Group名 |
| **DCR** | change_tracking | object | enabled=true | ファイル/レジストリ変更追跡 |
| | vm_insights | object | enabled=true | VMパフォーマンス監視 |
| | defender_sql | object | enabled=true | SQL Server セキュリティ |
| **Log Analytics** | retention_in_days | optional(number) | 30 | ログ保持期間（日） |
| | daily_quota_gb | optional(number) | なし | 1日のログ取り込み上限 |
| | sku | optional(string) | "PerGB2018" | 料金プラン |
| | internet_ingestion_enabled | optional(bool) | true | インターネット経由の取り込み |
| | local_authentication_enabled | optional(bool) | true | ローカル認証の有効化 |
| **Sentinel** | sentinel_onboarding | object | null | Sentinelの有効化設定 |
| **UAMI** | user_assigned_managed_identities.ama | object | - | Azure Monitor Agent用ID |
| **タグ** | tags | optional(map(string)) | null | リソースタグ |
| **タイムアウト** | timeouts | object | デフォルト | 作成/削除のタイムアウト |

**ポイント**：

- **locationのみ必須**、他はoptional
- **デフォルト値**：`optional(bool, true)`の形式で指定
- **ネストしたオブジェクト**：DCRやSentinelは複雑な構造

### modules/management_resources/outputs.tf

```hcl title="modules/management_resources/outputs.tf"
output "management_resources" {
  description = "The management resources outputs."
  value       = module.management_resources
}
```

**何してる？**

公式モジュール`module.management_resources`の全アウトプットをそのまま渡してる（パススルー）。

**公式モジュールから返される主なアウトプット**：

- `log_analytics_workspace.id`：Log Analytics WorkspaceのリソースID
- `data_collection_rule_ids`：3つのDCRのリソースID
- `user_assigned_identity_ids`：Managed IdentityのリソースID
- `automation_account.id`：Automation AccountのリソースID（作成時）

これらを`main.management.tf`で受け取って、他のモジュールに渡したり、アウトプットとして公開したりできる。

---

## Part 3: Azure公式モジュール（Azure/avm-ptn-alz-management/azurerm v0.9.0）

さて、ここからが本題。`modules/management_resources/main.tf`から呼び出される公式モジュールの内部を詳しく見ていこう。

**GitHubリポジトリ**：

https://github.com/Azure/terraform-azurerm-avm-ptn-alz-management/tree/v0.9.0


ここからは公式のモジュールを開きながら見ていきましょう。GitHubで上記のリポジトリを開いて、コードと照らし合わせながら読むとわかりやすいです。

### モジュールの構成

```text title="公式モジュールのファイル構成"
terraform-azurerm-avm-ptn-alz-management/
├── main.tf                         # メインリソース定義
├── locals.tf                       # ローカル変数
├── locals.data-collection-rules.tf # DCR定義
├── variables.tf                    # 入力変数
├── outputs.tf                      # 出力変数
├── main.telemetry.tf               # テレメトリ
├── main.deprecated.tf              # 非推奨リソース
└── terraform.tf                    # Terraform設定
```

**作成されるリソース**：

- `azurerm_resource_group.management`：リソースグループ
- `azurerm_log_analytics_workspace.management`：Log Analyticsワークスペース
- `azurerm_automation_account.management`：Automation Account（オプション）
- `azurerm_log_analytics_linked_service.management`：Log AnalyticsとAutomation Accountのリンク
- `azurerm_log_analytics_solution.management`：Log Analyticsソリューション
- `azapi_resource.sentinel_onboarding`：Sentinel有効化
- `azurerm_user_assigned_identity.management`：ユーザー割り当てManaged Identity
- `azapi_resource.data_collection_rule`：Data Collection Rules（3種類）

### main.tf の詳細

#### 1. Resource Group作成

```hcl title="リソースグループの作成"
resource "azurerm_resource_group" "management" {
  count = var.resource_group_creation_enabled ? 1 : 0

  location = var.location
  name     = var.resource_group_name
  tags     = var.tags
}
```

**何してる？**

- `count`で作成を制御（`resource_group_creation_enabled = true`なら作成）
- `location`、`name`、`tags`を設定

**countパターン**：

```text title="countによる条件付き作成"
resource_group_creation_enabled = true
↓
count = 1（リソース作成）

resource_group_creation_enabled = false
↓
count = 0（リソース作成しない・BYO Resource Group）
```

#### 2. Log Analytics Workspace作成

```hcl title="Log Analyticsワークスペースの作成"
resource "azurerm_log_analytics_workspace" "management" {
  count = var.log_analytics_workspace_creation_enabled ? 1 : 0

  location                           = var.location
  name                               = var.log_analytics_workspace_name
  resource_group_name                = local.resource_group_name
  allow_resource_only_permissions    = var.log_analytics_workspace_allow_resource_only_permissions
  cmk_for_query_forced               = var.log_analytics_workspace_cmk_for_query_forced
  daily_quota_gb                     = var.log_analytics_workspace_daily_quota_gb
  internet_ingestion_enabled         = var.log_analytics_workspace_internet_ingestion_enabled
  internet_query_enabled             = var.log_analytics_workspace_internet_query_enabled
  local_authentication_enabled       = var.log_analytics_workspace_local_authentication_enabled
  reservation_capacity_in_gb_per_day = var.log_analytics_workspace_reservation_capacity_in_gb_per_day
  retention_in_days                  = var.log_analytics_workspace_retention_in_days
  sku                                = var.log_analytics_workspace_sku
  tags                               = var.tags
}
```

**何してる？**

Log Analyticsワークスペースを作成してる。約10個のプロパティを設定。

**重要なプロパティ**：

- **retention_in_days**：ログ保持期間（デフォルト30日、それ以上は課金）
- **daily_quota_gb**：1日のログ取り込み上限（クォータ）
- **sku**：料金プラン（`PerGB2018`が一般的）
- **internet_ingestion_enabled**：インターネット経由のログ取り込み許可
- **local_authentication_enabled**：ローカル認証の有効化

**local.resource_group_nameの参照**：

```hcl title="locals.tfで定義された値"
locals {
  resource_group_name = var.resource_group_creation_enabled ? 
    azurerm_resource_group.management[0].name : 
    var.resource_group_name
}
```

**何してる？**

- RGを作成した場合：作成したRGの名前を使う
- RGを作成しない場合（BYO RG）：ユーザー指定の名前を使う

#### 3. Automation Account作成（オプション）

```hcl title="Automation Accountの作成"
resource "azurerm_automation_account" "management" {
  count = var.linked_automation_account_creation_enabled ? 1 : 0

  location                      = coalesce(var.automation_account_location, var.location)
  name                          = var.automation_account_name
  resource_group_name           = local.resource_group_name
  sku_name                      = var.automation_account_sku_name
  local_authentication_enabled  = var.automation_account_local_authentication_enabled
  public_network_access_enabled = var.automation_account_public_network_access_enabled
  tags                          = var.tags

  dynamic "encryption" {
    for_each = var.automation_account_encryption == null ? [] : ["Encryption"]

    content {
      key_vault_key_id          = var.automation_account_encryption.key_vault_key_id
      user_assigned_identity_id = var.automation_account_encryption.user_assigned_identity_id
    }
  }
  
  dynamic "identity" {
    for_each = var.automation_account_identity == null ? [] : ["Identity"]

    content {
      type         = var.automation_account_identity.type
      identity_ids = var.automation_account_identity.identity_ids
    }
  }
}
```

**何してる？**

Automation Accountを作成してる（`linked_automation_account_creation_enabled = true`の場合のみ）。

**Automation Accountとは**：

VMの自動パッチ適用、スケジュール実行タスク、構成管理などの自動化機能を提供するサービス。

**このプロジェクトでは**：

```hcl
linked_automation_account_creation_enabled = false
```

デフォルトで無効。必要に応じて有効化する。

**coalesceの使い方**：

```hcl
location = coalesce(var.automation_account_location, var.location)
```

Automation Accountのリージョンを別指定できる（Log Analyticsと異なるリージョンに配置可能）。

#### 4. Log Analytics Linked Service

```hcl title="Log AnalyticsとAutomation Accountのリンク"
resource "azurerm_log_analytics_linked_service" "management" {
  count = var.linked_automation_account_creation_enabled ? 1 : 0

  resource_group_name = local.resource_group_name
  workspace_id        = local.log_analytics_workspace_id
  read_access_id      = azurerm_automation_account.management[0].id
  write_access_id     = null
}
```

**何してる？**

Log AnalyticsワークスペースとAutomation Accountをリンクしてる。

**リンクの目的**：

- Automation AccountからLog Analyticsのデータを読める
- Log Analyticsのクエリ結果でAutomation Runbookをトリガーできる

#### 5. Log Analytics Solution

```hcl title="Log Analyticsソリューションのインストール"
resource "azurerm_log_analytics_solution" "management" {
  for_each = { for plan in toset(var.log_analytics_solution_plans) : 
    "${plan.publisher}/${plan.product}" => plan }

  location              = var.location
  resource_group_name   = local.resource_group_name
  solution_name         = basename(each.value.product)
  workspace_name        = local.log_analytics_workspace_name
  workspace_resource_id = local.log_analytics_workspace_id
  tags                  = var.tags

  plan {
    product   = each.value.product
    publisher = each.value.publisher
  }

  depends_on = [
    azurerm_log_analytics_linked_service.management,
  ]
}
```

**何してる？**

Log Analyticsソリューション（ContainerInsights、VMInsightsなど）をインストールしてる。

**for_eachの仕組み**：

```text title="ソリューションのインストールフロー"
log_analytics_solution_plans = [
  { product = "OMSGallery/ContainerInsights", publisher = "Microsoft" },
  { product = "OMSGallery/VMInsights", publisher = "Microsoft" }
]
↓
for_each = {
  "Microsoft/OMSGallery/ContainerInsights" => { ... },
  "Microsoft/OMSGallery/VMInsights" => { ... }
}
↓
2つのazurerm_log_analytics_solutionリソースが作成される
```

**depends_on**：

Log Analytics Linked Serviceが作成された後にソリューションをインストールする。

#### 6. Sentinel Onboarding

```hcl title="Sentinelの有効化"
resource "azapi_resource" "sentinel_onboarding" {
  count = var.sentinel_onboarding != null ? 1 : 0

  name      = var.sentinel_onboarding.name
  parent_id = local.log_analytics_workspace_id
  type      = "Microsoft.SecurityInsights/onboardingStates@2024-03-01"
  
  body = {
    properties = {
      customerManagedKey = var.sentinel_onboarding.customer_managed_key_enabled
    }
  }
  
  create_headers = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  delete_headers = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  read_headers   = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  update_headers = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null

  timeouts {
    create = var.timeouts.sentinel_onboarding.create
    delete = var.timeouts.sentinel_onboarding.delete
    read   = var.timeouts.sentinel_onboarding.read
    update = var.timeouts.sentinel_onboarding.update
  }
}
```

**何してる？**

Microsoft Sentinel（SIEM/SOAR）を有効化してる。

**Sentinelとは**：

セキュリティ情報とイベント管理（SIEM）、セキュリティオーケストレーション自動応答（SOAR）のクラウドネイティブサービス。

**azapi_resourceの使用理由**：

Sentinelの新しいonboardingStates APIは、まだazurermプロバイダでサポートされてないため、azapiプロバイダを使ってる。

**タイムアウト設定**：

```hcl
timeouts {
  create = var.timeouts.sentinel_onboarding.create  # デフォルト5分
  delete = var.timeouts.sentinel_onboarding.delete  # デフォルト5分
  read   = var.timeouts.sentinel_onboarding.read    # デフォルト5分
  update = var.timeouts.sentinel_onboarding.update  # デフォルト5分
}
```

Sentinelの有効化には時間がかかる場合があるので、タイムアウトをカスタマイズ可能。

#### 7. User Assigned Managed Identity

```hcl title="Managed Identityの作成"
resource "azurerm_user_assigned_identity" "management" {
  for_each = local.user_assigned_managed_identities

  location            = each.value.location
  name                = each.value.name
  resource_group_name = local.resource_group_name
  tags                = each.value.tags
}
```

**何してる？**

ユーザー割り当てManaged Identityを作成してる。

**for_eachの仕組み**：

```text title="Managed Identityの作成フロー"
user_assigned_managed_identities = {
  ama = {
    name = "id-ama-japaneast"
  }
}
↓
local.user_assigned_managed_identities = {
  "ama" => {
    name     = "id-ama-japaneast",
    location = "japaneast",
    tags     = { ... }
  }
}
↓
azurerm_user_assigned_identity.management["ama"] が作成される
```

#### 8. Data Collection Rules

```hcl title="Data Collection Ruleの作成"
resource "azapi_resource" "data_collection_rule" {
  for_each = local.data_collection_rules

  location                  = each.value.location
  name                      = each.value.name
  parent_id                 = local.resource_group_resource_id
  type                      = each.value.type
  body                      = each.value.body
  create_headers            = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  delete_headers            = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  read_headers              = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  schema_validation_enabled = each.value.schema_validation_enabled
  tags                      = each.value.tags
  update_headers            = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null

  timeouts {
    create = var.timeouts.data_collection_rule.create
    delete = var.timeouts.data_collection_rule.delete
    read   = var.timeouts.data_collection_rule.read
    update = var.timeouts.data_collection_rule.update
  }
}
```

**何してる？**

Data Collection Rules（DCR）を作成してる。azapi_resourceを使用（azurermプロバイダでまだ完全サポートされてないため）。

**for_eachで3種類のDCRを作成**：

- `change_tracking`：変更追跡
- `vm_insights`：VMパフォーマンス監視
- `defender_sql`：SQL Serverセキュリティ

**local.data_collection_rulesの定義**：

`locals.data-collection-rules.tf`で定義されてる（後述）。

**タイムアウト設定**：

```hcl
timeouts {
  create = var.timeouts.data_collection_rule.create  # デフォルト5分
  delete = var.timeouts.data_collection_rule.delete  # デフォルト10分
  read   = var.timeouts.data_collection_rule.read    # デフォルト5分
  update = var.timeouts.data_collection_rule.update  # デフォルト5分
}
```

DCRの作成・削除にも時間がかかるため、タイムアウトをカスタマイズ可能。

### locals.tf の詳細

```hcl title="ローカル変数の定義"
locals {
  resource_group_name        = var.resource_group_creation_enabled ? 
    azurerm_resource_group.management[0].name : 
    var.resource_group_name
  resource_group_resource_id = var.resource_group_creation_enabled ? 
    azurerm_resource_group.management[0].id : 
    provider::azapi::build_resource_id(
      "/subscriptions/${data.azapi_client_config.current.subscription_id}", 
      "Microsoft.Resources/resourceGroups", 
      var.resource_group_name
    )
}

locals {
  log_analytics_workspace_id   = var.log_analytics_workspace_creation_enabled ? 
    azurerm_log_analytics_workspace.management[0].id : 
    var.log_analytics_workspace_id
  log_analytics_workspace_name = var.log_analytics_workspace_creation_enabled ? 
    azurerm_log_analytics_workspace.management[0].name : 
    provider::azapi::parse_resource_id(
      "Microsoft.OperationalInsights/workspaces", 
      var.log_analytics_workspace_id
    ).name
}
```

**何してる？**

リソースグループとLog Analyticsワークスペースの名前とIDを、作成した場合と既存を使う場合で切り替えてる。

**BYOパターン（Bring Your Own）**：

```text title="BYOパターンのフロー"
resource_group_creation_enabled = false
↓
count = 0（RG作成しない）
↓
local.resource_group_name = var.resource_group_name（既存RG名を使う）
↓
local.resource_group_resource_id = provider::azapi::build_resource_id(...)（RG IDを構築）
```

### locals.data-collection-rules.tf の詳細

#### Change Tracking DCR

```hcl title="Change Tracking DCRの定義（一部抜粋）"
locals {
  data_collection_rule_change_tracking = var.data_collection_rules.change_tracking.enabled ? {
    change_tracking = {
      name                      = var.data_collection_rules.change_tracking.name
      type                      = "Microsoft.Insights/dataCollectionRules@2021-04-01"
      parent_id                 = local.resource_group_resource_id
      location                  = var.data_collection_rules.change_tracking.location == null ? 
        var.location : 
        var.data_collection_rules.change_tracking.location
      schema_validation_enabled = true
      tags                      = var.data_collection_rules.change_tracking.tags == null ? 
        var.tags : 
        var.data_collection_rules.change_tracking.tags
      body = {
        properties = {
          description = "Data collection rule for CT"
          dataSources = {
            extensions = [
              {
                streams = [
                  "Microsoft-ConfigurationChange",
                  "Microsoft-ConfigurationChangeV2",
                  "Microsoft-ConfigurationData"
                ]
                extensionName = "ChangeTracking-Windows"
                extensionSettings = {
                  enableFiles     = true
                  enableSoftware  = true
                  enableRegistry  = true
                  enableServices  = true
                  enableInventory = true
                  # ...詳細な設定
                }
                name = "CTDataSource-Windows"
              },
              {
                # Linuxの設定も同様
                extensionName = "ChangeTracking-Linux"
                # ...
              }
            ]
          }
          destinations = {
            logAnalytics = [
              {
                name                = "Microsoft-CT-Dest"
                workspaceResourceId = local.log_analytics_workspace_id
              }
            ]
          }
          dataFlows = [
            {
              streams = [
                "Microsoft-ConfigurationChange",
                "Microsoft-ConfigurationChangeV2",
                "Microsoft-ConfigurationData"
              ]
              destinations = ["Microsoft-CT-Dest"]
            }
          ]
        }
      }
    }
  } : {}
}
```

**何してる？**

Change Tracking DCRの詳細定義をしてる。

**構成要素**：

1. **dataSources**：どのデータを収集するか

- `extensions`：ChangeTracking-WindowsとChangeTracking-Linux拡張機能
- `streams`：収集するデータストリーム（設定変更、ファイル変更、インベントリデータ）
- `extensionSettings`：何を監視するか（ファイル、ソフトウェア、レジストリ、サービス）

2. **destinations**：データの送信先

- `logAnalytics`：Log Analyticsワークスペース

3. **dataFlows**：データの流れ

- どのストリームをどの送信先に送るか

#### VM Insights DCR

```hcl title="VM Insights DCRの定義（一部抜粋）"
locals {
  data_collection_rule_vm_insights = var.data_collection_rules.vm_insights.enabled ? {
    vm_insights = {
      name                      = var.data_collection_rules.vm_insights.name
      parent_id                 = local.resource_group_resource_id
      type                      = "Microsoft.Insights/dataCollectionRules@2021-04-01"
      location                  = var.data_collection_rules.vm_insights.location == null ? 
        var.location : 
        var.data_collection_rules.vm_insights.location
      schema_validation_enabled = false  # VM Insightsは複雑なためバリデーション無効
      tags                      = var.data_collection_rules.vm_insights.tags == null ? 
        var.tags : 
        var.data_collection_rules.vm_insights.tags
      body = {
        properties = {
          description = "Data collection rule for VM Insights."
          dataSources = {
            performanceCounters = [
              {
                name = "VMInsightsPerfCounters"
                streams = [
                  "Microsoft-InsightsMetrics"
                ]
                scheduledTransferPeriod    = "PT1M"
                samplingFrequencyInSeconds = 60
                counterSpecifiers = [
                  "\\VmInsights\\DetailedMetrics"
                ]
              }
            ]
            extensions = [
              {
                streams = [
                  "Microsoft-ServiceMap"
                ]
                extensionName     = "DependencyAgent"
                extensionSettings = {}
                name              = "DependencyAgentDataSource"
              }
            ]
          }
          destinations = {
            logAnalytics = [
              {
                workspaceResourceId = local.log_analytics_workspace_id
                name                = "VMInsightsPerf-Logs-Dest"
              }
            ]
          }
          dataFlows = [
            {
              streams = [
                "Microsoft-InsightsMetrics"
              ]
              destinations = [
                "VMInsightsPerf-Logs-Dest"
              ]
            },
            {
              streams = [
                "Microsoft-ServiceMap"
              ]
              destinations = [
                "VMInsightsPerf-Logs-Dest"
              ]
            }
          ]
        }
      }
    }
  } : {}
}
```

**何してる？**

VM Insights DCRの詳細定義をしてる。

**構成要素**：

1. **performanceCounters**：パフォーマンスカウンターの収集

- `samplingFrequencyInSeconds = 60`：60秒ごとにサンプリング
- `counterSpecifiers`：詳細メトリクス

2. **extensions**：DependencyAgent拡張機能

- VMの依存関係とネットワーク接続を追跡

3. **dataFlows**：2つのストリーム

- `Microsoft-InsightsMetrics`：パフォーマンスメトリクス
- `Microsoft-ServiceMap`：サービスマップデータ

#### Defender for SQL DCR

```hcl title="Defender for SQL DCRの定義（一部抜粋）"
locals {
  data_collection_rule_defender_sql = var.data_collection_rules.defender_sql.enabled ? {
    defender_sql = {
      name                      = var.data_collection_rules.defender_sql.name
      parent_id                 = local.resource_group_resource_id
      type                      = "Microsoft.Insights/dataCollectionRules@2021-04-01"
      location                  = var.data_collection_rules.defender_sql.location == null ? 
        var.location : 
        var.data_collection_rules.defender_sql.location
      schema_validation_enabled = true
      tags                      = var.data_collection_rules.defender_sql.tags == null ? 
        var.tags : 
        var.data_collection_rules.defender_sql.tags
      body = {
        properties = {
          description = "Data collection rule for Defender for SQL."
          dataSources = {
            extensions = [
              {
                extensionName = "MicrosoftDefenderForSQL"
                name          = "MicrosoftDefenderForSQL"
                streams = [
                  "Microsoft-DefenderForSqlAlerts",
                  "Microsoft-DefenderForSqlLogins",
                  "Microsoft-DefenderForSqlTelemetry",
                  "Microsoft-DefenderForSqlScanEvents",
                  "Microsoft-DefenderForSqlScanResults",
                  "Microsoft-SqlAtpStatus-DefenderForSql"
                ]
                extensionSettings = {
                  enableCollectionOfSqlQueriesForSecurityResearch = 
                    var.data_collection_rules.defender_sql.enable_collection_of_sql_queries_for_security_research
                }
              }
            ]
          }
          destinations = {
            logAnalytics = [
              {
                workspaceResourceId = local.log_analytics_workspace_id
                name                = "LogAnalyticsDest"
              }
            ]
          }
          dataFlows = [
            {
              streams = [
                "Microsoft-DefenderForSqlAlerts",
                "Microsoft-DefenderForSqlLogins",
                "Microsoft-DefenderForSqlTelemetry",
                "Microsoft-DefenderForSqlScanEvents",
                "Microsoft-DefenderForSqlScanResults",
                "Microsoft-SqlAtpStatus-DefenderForSql"
              ]
              destinations = [
                "LogAnalyticsDest"
              ]
            }
          ]
        }
      }
    }
  } : {}
}
```

**何してる？**

Defender for SQL DCRの詳細定義をしてる。

**構成要素**：

1. **extensions**：MicrosoftDefenderForSQL拡張機能

- SQL Serverのセキュリティイベントを収集

2. **streams**：6種類のデータストリーム

- `DefenderForSqlAlerts`：セキュリティアラート
- `DefenderForSqlLogins`：ログインイベント
- `DefenderForSqlTelemetry`：テレメトリデータ
- `DefenderForSqlScanEvents`：脆弱性スキャンイベント
- `DefenderForSqlScanResults`：スキャン結果
- `SqlAtpStatus-DefenderForSql`：Advanced Threat Protectionステータス

3. **extensionSettings**：SQLクエリ収集の有効化

- セキュリティ研究用にSQLクエリを収集するかどうか

#### DCRのマージ

```hcl title="3つのDCRをマージ"
locals {
  data_collection_rules = merge(
    local.data_collection_rule_change_tracking,
    local.data_collection_rule_defender_sql,
    local.data_collection_rule_vm_insights
  )
}
```

**何してる？**

3つのDCR定義をマージして、`local.data_collection_rules`を作成してる。

**マージの結果**：

```text title="マージされたDCR"
local.data_collection_rules = {
  change_tracking = { ... },  # 有効なら定義、無効なら省略
  defender_sql = { ... },     # 有効なら定義、無効なら省略
  vm_insights = { ... }       # 有効なら定義、無効なら省略
}
```

これを`for_each`で回して、有効なDCRだけ作成する。

### variables.tf の詳細

主要な変数を見ていこう。

#### location

```hcl title="locationの定義"
variable "location" {
  type        = string
  description = "The Azure region where the resources will be deployed."
  nullable    = false
}
```

**何してる？**

デプロイ先リージョンを指定する必須変数。`nullable = false`で必須化。

#### resource_group_name

```hcl title="resource_group_nameの定義"
variable "resource_group_name" {
  type        = string
  description = "The name of the Azure Resource Group where the resources will be created."
}
```

**何してる？**

リソースグループ名を指定する必須変数。

#### log_analytics_workspace_name

```hcl title="log_analytics_workspace_nameの定義"
variable "log_analytics_workspace_name" {
  type        = string
  default     = null
  description = "The name of the Log Analytics Workspace to create."

  validation {
    condition = (
      var.log_analytics_workspace_creation_enabled == false ||
      (var.log_analytics_workspace_creation_enabled == true && var.log_analytics_workspace_name != null)
    )
    error_message = "You must supply a value for log_analytics_workspace_name when log_analytics_workspace_creation_enabled is true."
  }
}
```

**何してる？**

Log Analyticsワークスペース名を指定する変数。`validation`でバリデーションしてる。

**バリデーションロジック**：

```text title="バリデーションの動作"
log_analytics_workspace_creation_enabled = true
かつ
log_analytics_workspace_name = null
↓
エラー：「名前を指定してください」

log_analytics_workspace_creation_enabled = false
↓
OK（BYOモードなので名前不要）
```

#### data_collection_rules

```hcl title="data_collection_rulesの定義"
variable "data_collection_rules" {
  type = object({
    change_tracking = object({
      enabled  = optional(bool, true)
      name     = string
      location = optional(string, null)
      tags     = optional(map(string), null)
    })
    vm_insights = object({
      enabled  = optional(bool, true)
      name     = string
      location = optional(string, null)
      tags     = optional(map(string), null)
    })
    defender_sql = object({
      enabled                                                = optional(bool, true)
      name                                                   = string
      location                                               = optional(string, null)
      tags                                                   = optional(map(string), null)
      enable_collection_of_sql_queries_for_security_research = optional(bool, false)
    })
  })
  default = {
    change_tracking = {
      name = "dcr-change-tracking"
    }
    vm_insights = {
      name = "dcr-vm-insights"
    }
    defender_sql = {
      name = "dcr-defender-sql"
    }
  }
  description = <<DESCRIPTION
Enables customisation of the data collection rules for Azure Monitor.
This is an object with attributes pertaining to the three DCRs that are created by this module.

Each object has the following attributes:

- enabled (Optional) - Whether or not to create the data collection rule. Defaults to `true`.
- name (Required) - The name of the data collection rule. For the default values, see the default variable value.
- location (Optional) - The Azure region of the data collection rule. Defaults to the value of the location variable.
- tags (Optional) - A map of tags to apply to the data collection rule. Defaults to `null`.

The defender_sql object has an additional attribute:

- enable_collection_of_sql_queries_for_security_research (Optional) - Whether or not to enable collection of SQL queries for security research. Defaults to `false`.
DESCRIPTION
}
```

**何してる？**

3種類のDCRの設定を定義してる。デフォルト値も設定済み。

**デフォルト値の仕組み**：

```text title="デフォルト値の適用"
ユーザーが指定しない場合：
↓
default = {
  change_tracking = { name = "dcr-change-tracking" },
  vm_insights = { name = "dcr-vm-insights" },
  defender_sql = { name = "dcr-defender-sql" }
}
↓
enabled = true（デフォルト）なので、すべて作成される
```

#### log_analytics_workspace_retention_in_days

```hcl title="log_analytics_workspace_retention_in_daysの定義"
variable "log_analytics_workspace_retention_in_days" {
  type        = number
  default     = 30
  description = "The number of days to retain data for the Log Analytics Workspace."
  nullable    = false
}
```

**何してる？**

ログ保持期間をデフォルト30日に設定してる。

**コスト**：

- 30日まで：無料
- 31日以降：約15円/GB/月の追加課金

#### log_analytics_workspace_sku

```hcl title="log_analytics_workspace_skuの定義"
variable "log_analytics_workspace_sku" {
  type        = string
  default     = "PerGB2018"
  description = "The SKU to use for the Log Analytics Workspace."
  nullable    = false
}
```

**何してる？**

料金プランをデフォルト`PerGB2018`（従量課金）に設定してる。

**SKUの種類**：

- `PerGB2018`：従量課金（約500円/GB）
- `CapacityReservation`：コミットメント（100GB/日から、割引率あり）

#### timeouts

```hcl title="timeoutsの定義"
variable "timeouts" {
  type = object({
    sentinel_onboarding = optional(object({
      create = optional(string, "5m")
      delete = optional(string, "5m")
      update = optional(string, "5m")
      read   = optional(string, "5m")
      }), {}
    )
    data_collection_rule = optional(object({
      create = optional(string, "5m")
      delete = optional(string, "10m")
      update = optional(string, "5m")
      read   = optional(string, "5m")
      }), {}
    )
  })
  default     = {}
  description = <<DESCRIPTION
A map of timeouts to apply to the creation and destruction of resources.
If using retry, the maximum elapsed retry time is governed by this value.
DESCRIPTION
}
```

**何してる？**

リソース作成・削除のタイムアウト値を設定してる。

**デフォルト値**：

- Sentinel作成：5分
- DCR作成：5分
- DCR削除：10分（削除は作成より時間がかかることがある）

本番環境では、必要に応じてタイムアウトを延長できる。

### outputs.tf の詳細

```hcl title="主要なアウトプット"
output "automation_account" {
  description = "A curated output of the Azure Automation Account."
  value = {
    dsc_server_endpoint = try(azurerm_automation_account.management[0].dsc_server_endpoint, null)
    hybrid_service_url  = try(azurerm_automation_account.management[0].hybrid_service_url, null)
    id                  = try(azurerm_automation_account.management[0].id, null)
    name                = try(azurerm_automation_account.management[0].name, null)
    identity = {
      tenant_id    = try(azurerm_automation_account.management[0].identity[0].tenant_id, null)
      principal_id = try(azurerm_automation_account.management[0].identity[0].principal_id, null)
    }
  }
}

output "data_collection_rule_ids" {
  description = "Data Collection Rule Resource Ids."
  value = { for key, value in azapi_resource.data_collection_rule : key => {
    id = value.id
    }
  }
}

output "log_analytics_workspace" {
  description = "A curated output of the Log Analytics Workspace."
  value = {
    id           = try(azurerm_log_analytics_workspace.management[0].id, null)
    name         = try(azurerm_log_analytics_workspace.management[0].name, null)
    workspace_id = try(azurerm_log_analytics_workspace.management[0].workspace_id, null)
  }
}

output "resource_group" {
  description = "A curated output of the Azure Resource Group."
  value = {
    id   = local.resource_group_resource_id
    name = local.resource_group_name
  }
}

output "user_assigned_identity_ids" {
  description = "User assigned identity IDs."
  value = { for key, value in azurerm_user_assigned_identity.management : key => {
    id = value.id
    }
  }
}
```

**何してる？**

作成したリソースの重要な情報をアウトプットしてる。

**アウトプットの使い道**：

1. **他のモジュールへの入力**：
   ```hcl
   # ポリシーモジュールにLog Analytics IDを渡す
   log_analytics_workspace_id = module.management_resources.log_analytics_workspace.id
   ```

2. **ポリシーデフォルト値への埋め込み**：
   ```hcl
   policy_default_values = {
     log_analytics_workspace_id = "$${log_analytics_workspace_id}"
   }
   ```

3. **確認用**：
   ```bash
   terraform output management_resources
   ```

---

## Part 4: 全体フロー図

```text title="管理リソース作成の完全フロー"
platform-landing-zone.auto.tfvars
↓
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  data_collection_rules = { ... $${dcr_xxx_name} ... }
  user_assigned_managed_identities = { ama = { name = "$${ama_user_assigned_managed_identity_name}" } }
}
↓
config-templatingモジュール（$${...}を実際の値に置換）
↓
locals.tf（locals.management_resource_settings作成）
  location = "japaneast"
  log_analytics_workspace_name = "law-management-japaneast"
  resource_group_name = "rg-management-japaneast"
  data_collection_rules = { change_tracking = { name = "dcr-change-tracking-japaneast" }, ... }
  user_assigned_managed_identities = { ama = { name = "id-ama-japaneast" } }
↓
main.management.tf
  module "management_resources" {
    source = "./modules/management_resources"
    management_resource_settings = local.management_resource_settings
  }
↓
modules/management_resources/main.tf
  module "management_resources" {
    source  = "Azure/avm-ptn-alz-management/azurerm"
    version = "0.9.0"
    location = var.management_resource_settings.location
    log_analytics_workspace_name = coalesce(var.management_resource_settings.log_analytics_workspace_name, "...")
    ...（約25個のパラメータ）
  }
↓
Azure/avm-ptn-alz-management/azurerm v0.9.0
  ├── main.tf
  │     ├── resource "azurerm_resource_group" "management"
  │     ├── resource "azurerm_log_analytics_workspace" "management"
  │     ├── resource "azurerm_automation_account" "management"（オプション）
  │     ├── resource "azurerm_log_analytics_linked_service" "management"（オプション）
  │     ├── resource "azurerm_log_analytics_solution" "management"
  │     ├── resource "azapi_resource" "sentinel_onboarding"（オプション）
  │     ├── resource "azurerm_user_assigned_identity" "management"
  │     └── resource "azapi_resource" "data_collection_rule"
  ├── locals.tf
  │     ├── local.resource_group_name（作成 or BYO）
  │     ├── local.log_analytics_workspace_id（作成 or BYO）
  │     └── local.user_assigned_managed_identities（展開）
  └── locals.data-collection-rules.tf
        ├── local.data_collection_rule_change_tracking（変更追跡DCR）
        ├── local.data_collection_rule_vm_insights（VMパフォーマンスDCR）
        ├── local.data_collection_rule_defender_sql（SQL SecurityDCR）
        └── local.data_collection_rules（3つをマージ）
↓
作成されるリソース：
  - rg-management-japaneast（Resource Group）
  - law-management-japaneast（Log Analytics Workspace）
  - dcr-change-tracking-japaneast（Change Tracking DCR）
  - dcr-vm-insights-japaneast（VM Insights DCR）
  - dcr-defender-sql-japaneast（Defender for SQL DCR）
  - id-ama-japaneast（User Assigned Managed Identity）
  - OMSGallery/ContainerInsights（Log Analytics Solution）
↓
outputs.tf（アウトプット）
  - log_analytics_workspace.id
  - data_collection_rule_ids
  - user_assigned_identity_ids
  - resource_group.id
↓
ポリシーに渡される
  policy_default_values = {
    log_analytics_workspace_id = <Log Analytics ID>
    ama_change_tracking_data_collection_rule_id = <Change Tracking DCR ID>
    ama_user_assigned_managed_identity_id = <Managed Identity ID>
  }
```

**全体の流れ**：

1. **設定ファイル**：`platform-landing-zone.auto.tfvars`で`$${変数名}`形式で設定
2. **変数置換**：`config-templating`モジュールが`$${...}`を実際の値に置換
3. **ローカル変数**：`locals.tf`で`local.management_resource_settings`作成
4. **モジュール呼び出し**：`main.management.tf`からローカルモジュール呼び出し
5. **ローカルモジュール**：`modules/management_resources/`から公式モジュール呼び出し
6. **公式モジュール**：`Azure/avm-ptn-alz-management`で実リソース作成
7. **アウトプット**：作成したリソースIDをアウトプット
8. **ポリシー連携**：ポリシーのデフォルト値に埋め込み

---

## Part 5: 実践パターン

### パターン1: ログ保持期間の変更

```hcl title="90日保管に変更"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  log_analytics_workspace_retention_in_days = 90  # ←追加
  
  user_assigned_managed_identities = { ... }
  data_collection_rules = { ... }
}
```

**コスト試算**：

```text title="保持期間とコスト"
30日：無料
90日：約15円/GB × (90 - 30) = 約900円/GB（追加60日分）
```

### パターン2: DCRの選択的有効化

```hcl title="Defender for SQLを無効化"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  data_collection_rules = {
    change_tracking = { name = "$${dcr_change_tracking_name}" }
    vm_insights     = { name = "$${dcr_vm_insights_name}" }
    defender_sql    = {  # ←無効化
      enabled = false
      name    = "$${dcr_defender_sql_name}"
    }
  }
  
  user_assigned_managed_identities = { ... }
}
```

**何してる？**

Defender for SQLが不要な環境では無効化してコスト削減。

### パターン3: カスタム名前の設定

```hcl title="custom_replacements.namesに追加"
custom_replacements = {
  names = {
    # 既存の変数
    starter_location_01 = "japaneast"
    
    # 管理リソースの名前をカスタマイズ
    log_analytics_workspace_name = "law-custom-prod-japaneast"
    management_resource_group_name = "rg-custom-mgmt-prod"
    dcr_change_tracking_name = "dcr-ct-prod-japaneast"
    dcr_vm_insights_name = "dcr-vminsights-prod-japaneast"
    dcr_defender_sql_name = "dcr-defendersql-prod-japaneast"
    ama_user_assigned_managed_identity_name = "id-ama-prod-japaneast"
  }
}
```

**何してる？**

環境やプロジェクトに応じた命名規則を適用してる。

### パターン4: Sentinelの有効化

```hcl title="Sentinelを有効化"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  sentinel_onboarding = {  # ←追加
    name                         = "default"
    customer_managed_key_enabled = false
  }
  
  user_assigned_managed_identities = { ... }
  data_collection_rules = { ... }
}
```

**何してる？**

Microsoft Sentinel（SIEM/SOAR）を有効化してる。

**Sentinelとは**：

セキュリティ情報とイベント管理（SIEM）サービス。ログを分析して脅威を検出し、自動対応できる。

**コスト**：

```text title="Sentinelの料金"
約300円/GB（Log Analyticsへの取り込み料金とは別）
```

### パターン5: タイムアウトのカスタマイズ

```hcl title="タイムアウトを延長"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  timeouts = {  # ←追加
    data_collection_rule = {
      create = "10m"  # デフォルト5分から10分に延長
      delete = "15m"  # デフォルト10分から15分に延長
    }
    sentinel_onboarding = {
      create = "10m"  # デフォルト5分から10分に延長
    }
  }
  
  user_assigned_managed_identities = { ... }
  data_collection_rules = { ... }
}
```

**何してる？**

リソース作成・削除のタイムアウトを延長してる。

**使い道**：

- 大規模環境でDCR作成に時間がかかる
- ネットワークが遅い環境

---

## まとめ

**管理リソースの役割**：

- **Log Analytics Workspace**：全てのログを集約する中央集約ストア
- **Data Collection Rules（DCR）**：どのログをどう収集するかのルール定義
- **Managed Identity**：パスワード不要のセキュアな認証

**モジュール構造**：

- **設定ファイル**：`platform-landing-zone.auto.tfvars`で`$${変数名}`形式で設定
- **変数置換**：`config-templating`モジュールが`$${...}`を実際の値に置換
- **ローカルモジュール**：`modules/management_resources/`でパラメータを整形・デフォルト値設定
- **公式モジュール**：`Azure/avm-ptn-alz-management`で実リソース作成

**重要なポイント**：

- **変数置換システム**を使って環境ごとの値を管理
- `$${starter_location_01}`のような多段階置換が可能
- Log Analyticsは監視の基盤（すべてのログがここに集まる）
- DCRで収集ルールをカスタマイズ（3種類：Change Tracking、VM Insights、Defender for SQL）
- Managed IdentityでVMからLog Analyticsへのセキュアな接続
- ポリシーと連携してVMへのAMA自動デプロイ

---

## 練習問題

理解度チェックです。

### 問題1
`platform-landing-zone.auto.tfvars`で使われている`$${変数名}`形式の変数置換システムの目的は何ですか？

### 問題2
Data Collection Rules（DCR）の3種類のタイプを挙げてください。

### 問題3
Managed Identityを使うメリットを2つ挙げてください。

### 問題4
`modules/management_resources/main.tf`で`coalesce`関数が使われている理由は何ですか？

---

## 練習問題の答え

### 答え1
`$${変数名}`形式の変数置換システムの目的：

**1. 環境ごとの値を一元管理**：

- `custom_replacements.names`で環境ごとの値を定義
- 設定ファイル全体で同じ変数を再利用
- 環境切り替えが容易（`starter_location_01 = "japaneast"`を変えるだけ）

**2. 多段階置換が可能**：

```hcl
log_analytics_workspace_name = "law-management-$${starter_location_01}"
↓
"law-management-japaneast"
```

**3. テンプレートとして再利用**：

- 異なる環境（開発、本番）で同じテンプレートを使える
- プロジェクトごとにカスタマイズしやすい

### 答え2
Data Collection Rules（DCR）の3種類：

**1. Change Tracking DCR**：

- ファイル変更、レジストリ変更、サービス変更を監視
- セキュリティ監査に使用

**2. VM Insights DCR**：

- CPU、メモリ、ディスク、ネットワークのパフォーマンス監視
- プロセス・依存関係の可視化

**3. Defender for SQL DCR**：

- SQL Server on VMのセキュリティ監視
- 脆弱性評価、脅威検出

### 答え3
Managed Identityのメリット：

**1. パスワード不要**：

- 認証情報をコードに埋め込まない
- シークレット管理の手間が不要
- 漏洩リスクがゼロ

**2. 自動ローテーション**：

- Azureが自動的に認証情報を更新
- 証明書の期限切れの心配なし
- セキュリティポリシーに準拠

**3. きめ細かいアクセス制御**：

- RBACで必要最小限の権限を付与
- リソース単位で権限を制御

### 答え4
`coalesce`関数を使う理由：

**デフォルト値の自動生成**：

```hcl
log_analytics_workspace_name = coalesce(
  var.management_resource_settings.log_analytics_workspace_name,
  "law-management-${var.management_resource_settings.location}"
)
```

**動作**：

- ユーザーが名前を指定してる場合：その名前を使う
- ユーザーが名前を指定してない場合：自動生成（`law-management-japaneast`など）

**メリット**：

- 設定の簡略化（必須入力を減らせる）
- 命名規則の統一（自動生成の名前が規則に従う）
- 柔軟性（カスタム名も指定できる）

---

次のChapterでは、Hub-and-Spokeネットワークの構築を見ていきます。実際のネットワークリソース（VNet、Firewall、Bastion）を作るよ。

---

**所要時間**: 60分  
**難易度**: ★★★★☆  
**前**: [08_管理グループとポリシー.md](./08_管理グループとポリシー.md)  
**次**: [10_Hub-and-Spoke.md](./10_Hub-and-Spoke.md)
