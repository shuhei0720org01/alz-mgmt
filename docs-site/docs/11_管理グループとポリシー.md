# 11. ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼ - Azure Landing Zonesã®å¿ƒè‡“éƒ¨ğŸ’“

!!! info "ã“ã®ç« ã§å­¦ã¶ã“ã¨"
    Azure Landing Zonesã®æ ¸ã¨ãªã‚‹ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼ã®ä»•çµ„ã¿ã‚’å­¦ã³ã¾ã™ï¼š

    1. ğŸ—‚ï¸ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®éšå±¤æ§‹é€ ï¼ˆæ¦‚å¿µèª¬æ˜ï¼‰
    2. ğŸ“platform-landing-zone.auto.tfvarsã®è§£èª¬ï¼ˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šï¼‰
    3. ğŸ—ï¸main.management.tfã®è§£èª¬ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—ï¼‰
    4. ğŸ“„lib/ãƒ•ã‚©ãƒ«ãƒ€ã®YAMLè§£èª¬ï¼ˆãƒãƒªã‚·ãƒ¼å®šç¾©ï¼‰
    5. ğŸ”„locals.tfã®å¤‰æ›å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿åŠ å·¥ï¼‰
    6. ğŸ§©modules/management_groups/ã®è§£èª¬ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
    7. ğŸ¢å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨è§£èª¬ï¼ˆAzure/avm-ptn-alz/azurermï¼‰
    8. ğŸ›¡ï¸å…¬å¼ã®Azureãƒãƒªã‚·ãƒ¼ã‚’è§£èª¬
    9. ğŸ› ï¸å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•ï¼‰

    **ã“ã®ç« ã®å†…å®¹ã¯ã‚ã¡ã‚ƒã‚ã¡ã‚ƒé•·ã„ã§ã™ãŒã€ä¸€ç•ªé‡è¦ãªã¨ã“ã‚ãªã®ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ï¼ğŸ”¥**

---

## Part 1: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®éšå±¤æ§‹é€ ğŸ—‚ï¸

### ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã¯ä½•ã‹ï¼ŸğŸ¤”

ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€è¤‡æ•°ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¾ã¨ã‚ã¦ã€ãƒãƒªã‚·ãƒ¼ã‚„RBACã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ã„ã¡ã°ã‚“ã‚ã‹ã‚Šã‚„ã™ã„ä¾‹ãˆã‚’ã™ã‚‹ãªã‚‰ã€ã€Œãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã€ã§ã™ğŸ“ã€‚

```
Tenant Rootï¼ˆãƒ†ãƒŠãƒ³ãƒˆãƒ«ãƒ¼ãƒˆï¼‰
â””â”€â”€ alzï¼ˆAzure Landing Zonesï¼‰
    â”œâ”€â”€ platformï¼ˆå…±é€šåŸºç›¤ï¼‰
    â”‚   â”œâ”€â”€ managementï¼ˆç®¡ç†ï¼‰
    â”‚   â”œâ”€â”€ connectivityï¼ˆæ¥ç¶šï¼‰
    â”‚   â””â”€â”€ identityï¼ˆIDç®¡ç†ï¼‰
    â””â”€â”€ landingzonesï¼ˆã‚¢ãƒ—ãƒªç’°å¢ƒï¼‰
        â”œâ”€â”€ corpï¼ˆä¼æ¥­å‘ã‘ï¼‰
        â””â”€â”€ onlineï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‘ã‘ï¼‰
```

---

### ãƒãƒªã‚·ãƒ¼ã®ç¶™æ‰¿æ§‹é€ ğŸ”—

ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ€å¤§ã®ç‰¹å¾´ã¯ã€**è¦ªã‹ã‚‰å­ã¸ã®ãƒãƒªã‚·ãƒ¼ç¶™æ‰¿**ã§ã™ã€‚

**ä¾‹ï¼šå…¨ç’°å¢ƒã§åŒã˜ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã—ãŸã„å ´åˆ**

```
alz ã«ã€Œç‰¹å®šãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–ã¯ä½¿ç”¨ç¦æ­¢ã€ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨
â†“
é…ä¸‹ã®å…¨ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã«è‡ªå‹•é©ç”¨
```

ã“ã‚Œã«ã‚ˆã‚Šã€ä¸€åº¦è¨­å®šã™ã‚Œã°å…¨ç’°å¢ƒã«é©ç”¨ã•ã‚Œã‚‹ã®ã§ã€ç®¡ç†ã®æ‰‹é–“ãŒæ¿€æ¸›ã—ã¾ã™ã€‚

!!! tip "ãƒãƒªã‚·ãƒ¼ç¶™æ‰¿ã®ä½¿ã„åˆ†ã‘ğŸ’¡"
    - **alz**: å…¨ç’°å¢ƒå…±é€šã®ãƒ«ãƒ¼ãƒ«ï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™ã€ã‚¿ã‚°å¿…é ˆãªã©ï¼‰
    - **platform**: å…±é€šåŸºç›¤ã®ãƒ«ãƒ¼ãƒ«ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã€ãƒ­ã‚°è»¢é€ãªã©ï¼‰
    - **landingzones**: ã‚¢ãƒ—ãƒªç’°å¢ƒã®ãƒ«ãƒ¼ãƒ«ï¼ˆVMè¨ºæ–­è¨­å®šã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã©ï¼‰

---

### ã“ã® Chapter ã§å­¦ã¶ã“ã¨ğŸ“

1. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆplatform-landing-zone.auto.tfvarsï¼‰**: ã©ã‚“ãªè¨­å®šãŒã§ãã‚‹ã®ã‹
2. **main.management.tf**: ã©ã†ã‚„ã£ã¦ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹ã®ã‹
3. **lib/ ãƒ•ã‚©ãƒ«ãƒ€**: YAMLã§ãƒãƒªã‚·ãƒ¼ã‚’ã©ã†å®šç¾©ã™ã‚‹ã®ã‹
4. **locals.tf**: è¨­å®šãŒã©ã†å¤‰æ›ã•ã‚Œã‚‹ã®ã‹
5. **modules/management_groups/**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²
6. **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: Azureå…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨æ§‹é€ 
7. **å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³**: ã‚ˆãã‚ã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•

---

## Part 2: platform-landing-zone.auto.tfvarsã®è§£èª¬ğŸ“

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ã™ã¹ã¦ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«é–¢é€£ã™ã‚‹éƒ¨åˆ†ã ã‘ã‚’è§£èª¬ã—ã¾ã™ã€‚

### ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼è¨­å®šğŸ”§

ã“ã‚ŒãŒã“ã®Chapterã®ãƒ¡ã‚¤ãƒ³è¨­å®šã§ã™ã€‚

```hcl title="management_group_settings"
management_group_settings = {
  enabled            = true
  architecture_name  = "alz_custom"
  location           = "$${starter_location_01}"
  parent_resource_id = "$${root_parent_management_group_id}"
  
  policy_default_values = {
    ama_change_tracking_data_collection_rule_id = "$${ama_change_tracking_data_collection_rule_id}"
    ama_mdfc_sql_data_collection_rule_id        = "$${ama_mdfc_sql_data_collection_rule_id}"
    ama_vm_insights_data_collection_rule_id     = "$${ama_vm_insights_data_collection_rule_id}"
    ama_user_assigned_managed_identity_id       = "$${ama_user_assigned_managed_identity_id}"
    ama_user_assigned_managed_identity_name     = "$${ama_user_assigned_managed_identity_name}"
    log_analytics_workspace_id                  = "$${log_analytics_workspace_id}"
    ddos_protection_plan_id                     = "$${ddos_protection_plan_id}"
    private_dns_zone_subscription_id            = "$${subscription_id_connectivity}"
    private_dns_zone_region                     = "$${starter_location_01}"
    private_dns_zone_resource_group_name        = "$${dns_resource_group_name}"
  }
  
  subscription_placement = {
    identity = {
      subscription_id       = "$${subscription_id_identity}"
      management_group_name = "identity"
    }
    connectivity = {
      subscription_id       = "$${subscription_id_connectivity}"
      management_group_name = "connectivity"
    }
    management = {
      subscription_id       = "$${subscription_id_management}"
      management_group_name = "management"
    }
    security = {
      subscription_id       = "$${subscription_id_security}"
      management_group_name = "security"
    }
  }
  
  policy_assignments_to_modify = {
    alz = {
      policy_assignments = {
        Deploy-MDFC-Config-H224 = {
          parameters = {
            ascExportResourceGroupName                  = "$${asc_export_resource_group_name}"
            ascExportResourceGroupLocation              = "$${starter_location_01}"
            emailSecurityContact                        = "$${defender_email_security_contact}"
            enableAscForServers                         = "DeployIfNotExists"
            enableAscForServersVulnerabilityAssessments = "DeployIfNotExists"
            enableAscForSql                             = "DeployIfNotExists"
            enableAscForAppServices                     = "DeployIfNotExists"
            enableAscForStorage                         = "DeployIfNotExists"
            enableAscForContainers                      = "DeployIfNotExists"
            enableAscForKeyVault                        = "DeployIfNotExists"
            enableAscForSqlOnVm                         = "DeployIfNotExists"
            enableAscForArm                             = "DeployIfNotExists"
            enableAscForOssDb                           = "DeployIfNotExists"
            enableAscForCosmosDbs                       = "DeployIfNotExists"
            enableAscForCspm                            = "DeployIfNotExists"
          }
        }
      }
    }
  }
}
```

**ä¸»è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:ğŸŒŸ

#### `architecture_name`

```hcl
architecture_name = "alz_custom"
```

lib/architecture_definitions/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¾ã™ã€‚

â†’ `alz_custom.alz_architecture_definition.yaml` ã‚’èª­ã¿è¾¼ã‚€

#### `parent_resource_id`

```hcl
parent_resource_id = "$${root_parent_management_group_id}"
```

ãƒ«ãƒ¼ãƒˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®IDã§ã™ã€‚é€šå¸¸ã¯ãƒ†ãƒŠãƒ³ãƒˆãƒ«ãƒ¼ãƒˆã¾ãŸã¯æ—¢å­˜ã®è¦ªç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã—ã¾ã™ã€‚

#### `policy_default_values`

ãƒãƒªã‚·ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã™ã€‚ãƒãƒªã‚·ãƒ¼ã«å®šç¾©ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã§ãã¾ã™ã€‚

**é‡è¦ãªãƒãƒªã‚·ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:ğŸ›¡ï¸

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ç”¨é€” |
|----------|------|
| `ama_*_data_collection_rule_id` | Azure Monitor Agentã®ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ«ID |
| `ama_user_assigned_managed_identity_id` | AMAç”¨ãƒãƒãƒ¼ã‚¸ãƒ‰IDã®ãƒªã‚½ãƒ¼ã‚¹ID |
| `log_analytics_workspace_id` | Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒªã‚½ãƒ¼ã‚¹ID |
| `ddos_protection_plan_id` | DDoS Protection Planã®ãƒªã‚½ãƒ¼ã‚¹ID |
| `private_dns_zone_*` | Private DNSã‚¾ãƒ¼ãƒ³ã®è¨­å®š |

ã“ã‚Œã‚‰ã®å€¤ã¯ã€ãƒãƒªã‚·ãƒ¼ãŒä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼ˆVMã€SQL Serverãªã©ï¼‰ã«è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

#### `subscription_placement`

ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«é…ç½®ã™ã‚‹è¨­å®šã§ã™ã€‚

```hcl
subscription_placement = {
  identity = {
    subscription_id       = "$${subscription_id_identity}"
    management_group_name = "identity"
  }
}
```

ã“ã®è¨­å®šã«ã‚ˆã‚Šã€æŒ‡å®šã—ãŸã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒå¯¾å¿œã™ã‚‹ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«è‡ªå‹•çš„ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

#### `policy_assignments_to_modify`

æ—¢å­˜ã®ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ã‚’å¤‰æ›´ã™ã‚‹è¨­å®šã§ã™ã€‚

```hcl
policy_assignments_to_modify = {
  alz = {
    policy_assignments = {
      Deploy-MDFC-Config-H224 = {
        parameters = {
          emailSecurityContact = "$${defender_email_security_contact}"
          # ...
        }
      }
    }
  }
}
```

**ä½¿ã„ã©ã“ã‚**:ğŸ’¡

- ãƒãƒªã‚·ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ›´
- enforcement_modeã®å¤‰æ›´ï¼ˆå¼·åˆ¶ãƒ¢ãƒ¼ãƒ‰/ç›£æŸ»ãƒ¢ãƒ¼ãƒ‰ï¼‰
- ãƒãƒãƒ¼ã‚¸ãƒ‰IDã®è¿½åŠ 


---

## Part 3: main.management.tfã®è§£èª¬ğŸ—ï¸

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€å®Ÿéš›ã«ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

### ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ğŸ—‚ï¸

```hcl title="main.management.tf"
module "management_resources" {
  source = "./modules/management_resources"

  count = var.management_resources_enabled ? 1 : 0

  enable_telemetry             = var.enable_telemetry
  management_resource_settings = local.management_resource_settings

  providers = {
    azurerm = azurerm.management
  }
}

module "management_groups" {
  source = "./modules/management_groups"

  count = var.management_groups_enabled ? 1 : 0

  enable_telemetry          = var.enable_telemetry
  management_group_settings = local.management_group_settings
}

moved {
  from = module.management_groups
  to   = module.management_groups[0]
}

moved {
  from = module.management_resources
  to   = module.management_resources[0]
}
```

---

### countãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹æ¡ä»¶ä»˜ãä½œæˆğŸ”¢

```hcl
count = var.management_resources_enabled ? 1 : 0
```

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚Šã€å¤‰æ•°ã§æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚

**å‹•ä½œ**:

- `var.management_resources_enabled = true` â†’ `count = 1` â†’ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’1ã¤ä½œæˆ
- `var.management_resources_enabled = false` â†’ `count = 0` â†’ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ãªã„

---

### movedãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹çŠ¶æ…‹ç§»è¡ŒğŸ”„

```hcl
moved {
  from = module.management_groups
  to   = module.management_groups[0]
}
```

**ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®å½¹å‰²**:ğŸ’¡

ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ `module.management_groups` ã¨ã„ã†åå‰ã§çŠ¶æ…‹ç®¡ç†ã—ã¦ã„ã¾ã—ãŸã€‚

countãƒ‘ã‚¿ãƒ¼ãƒ³å°å…¥å¾Œã¯ `module.management_groups[0]` ã¨ã„ã†åå‰ã«ãªã‚Šã¾ã™ã€‚

movedãƒ–ãƒ­ãƒƒã‚¯ãŒãªã„ã¨ã€Terraformã¯ã€Œå¤ã„ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã€ã—ã‚ˆã†ã¨ã—ã¾ã™ãŒã€movedãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹ã“ã¨ã§ã€Œåå‰ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã€ã§æ¸ˆã¿ã¾ã™ã€‚

!!! tip "movedãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ğŸ’¡"
    - æ—¢å­˜ç’°å¢ƒã‚’å£Šã•ãšã«ã‚³ãƒ¼ãƒ‰æ§‹é€ ã‚’å¤‰æ›´ã§ãã‚‹
    - terraform plan ã§ `moved` ã¨è¡¨ç¤ºã•ã‚Œã‚‹
    - ä¸€åº¦é©ç”¨ã—ãŸå¾Œã‚‚æ®‹ã—ã¦ãŠãã“ã¨ã§ã€å¤ã„ç’°å¢ƒã‹ã‚‰ã®ç§»è¡Œã‚’ã‚µãƒãƒ¼ãƒˆ

---

### ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°

```hcl
management_resource_settings = local.management_resource_settings
management_group_settings    = local.management_group_settings
```

ã“ã‚Œã‚‰ã®å¤‰æ•°ã¯ `locals.tf` ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼ˆPart 5ã§è§£èª¬ï¼‰ã€‚

---

## Part 4: lib/ãƒ•ã‚©ãƒ«ãƒ€ã®è§£èª¬ğŸ“„

YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®éšå±¤æ§‹é€ ã¨ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

### ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ğŸ—‚ï¸

```
lib/
â”œâ”€â”€ alz_library_metadata.json
â”œâ”€â”€ architecture_definitions/
â”‚   â””â”€â”€ alz_custom.alz_architecture_definition.yaml
â””â”€â”€ archetype_definitions/
    â”œâ”€â”€ root_custom.alz_archetype_override.yaml
    â”œâ”€â”€ platform_custom.alz_archetype_override.yaml
    â”œâ”€â”€ management_custom.alz_archetype_override.yaml
    â”œâ”€â”€ connectivity_custom.alz_archetype_override.yaml
    â”œâ”€â”€ identity_custom.alz_archetype_override.yaml
    â”œâ”€â”€ landing_zones_custom.alz_archetype_override.yaml
    â”œâ”€â”€ corp_custom.alz_archetype_override.yaml
    â”œâ”€â”€ online_custom.alz_archetype_override.yaml
    â”œâ”€â”€ sandbox_custom.alz_archetype_override.yaml
    â”œâ”€â”€ security_custom.alz_archetype_override.yaml
    â””â”€â”€ decommissioned_custom.alz_archetype_override.yaml
```

---

### architecture_definitions: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—éšå±¤ã®å®šç¾©ğŸ¢

```yaml title="lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml"
name: alz_custom
management_groups:
  - id: alz
    display_name: Azure Landing Zones
    archetypes:
      - root_custom
    exists: false
    parent_id: null

  - id: platform
    display_name: Platform
    archetypes:
      - platform_custom
    exists: false
    parent_id: alz

  - id: landingzones
    display_name: Landing Zones
    archetypes:
      - landing_zones_custom
    exists: false
    parent_id: alz

  - id: corp
    display_name: Corp
    archetypes:
      - corp_custom
    exists: false
    parent_id: landingzones

  - id: online
    display_name: Online
    archetypes:
      - online_custom
    exists: false
    parent_id: landingzones

  - id: sandbox
    display_name: Sandbox
    archetypes:
      - sandbox_custom
    exists: false
    parent_id: alz

  - id: security
    display_name: Security
    archetypes:
      - security_custom
    exists: false
    parent_id: platform

  - id: management
    display_name: Management
    archetypes:
      - management_custom
    exists: false
    parent_id: platform

  - id: connectivity
    display_name: Connectivity
    archetypes:
      - connectivity_custom
    exists: false
    parent_id: platform

  - id: identity
    display_name: Identity
    archetypes:
      - identity_custom
    exists: false
    parent_id: platform

  - id: decommissioned
    display_name: Decommissioned
    archetypes:
      - decommissioned_custom
    exists: false
    parent_id: alz
```

**å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ„å‘³**:ğŸ“

- `id`: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸€æ„ãªè­˜åˆ¥å­
- `display_name`: Azureãƒãƒ¼ã‚¿ãƒ«ã§è¡¨ç¤ºã•ã‚Œã‚‹åå‰
- `archetypes`: ã“ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«é©ç”¨ã™ã‚‹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼ˆãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆï¼‰
- `exists`: æ—¢å­˜ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‹ï¼ˆfalseã®å ´åˆã¯æ–°è¦ä½œæˆï¼‰
- `parent_id`: è¦ªç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ID

---

### archetype_definitions: ãƒãƒªã‚·ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºğŸ›¡ï¸

å„ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚

```yaml title="lib/archetype_definitions/root_custom.alz_archetype_override.yaml"
base_archetype: root
name: root_custom
policy_assignments_to_add: []
policy_assignments_to_remove: []
policy_definitions_to_add: []
policy_definitions_to_remove: []
policy_set_definitions_to_add: []
policy_set_definitions_to_remove: []
role_definitions_to_add: []
role_definitions_to_remove: []
```

**å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ„å‘³**:ğŸ“

- `base_archetype`: ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼ˆå…¬å¼ã®ALZã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼‰
- `name`: ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®åå‰
- `policy_assignments_to_add`: è¿½åŠ ã™ã‚‹ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦
- `policy_assignments_to_remove`: å‰Šé™¤ã™ã‚‹ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦
- `policy_definitions_to_add`: è¿½åŠ ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼å®šç¾©
- `policy_definitions_to_remove`: å‰Šé™¤ã™ã‚‹ãƒãƒªã‚·ãƒ¼å®šç¾©
- `policy_set_definitions_to_add`: è¿½åŠ ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–
- `policy_set_definitions_to_remove`: å‰Šé™¤ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–
- `role_definitions_to_add`: è¿½åŠ ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©
- `role_definitions_to_remove`: å‰Šé™¤ã™ã‚‹ãƒ­ãƒ¼ãƒ«å®šç¾©

**å®Ÿéš›ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºä¾‹**:

```yaml title="lib/archetype_definitions/connectivity_custom.alz_archetype_override.yaml"
base_archetype: connectivity
name: connectivity_custom
policy_assignments_to_add: []
policy_assignments_to_remove:
  # DDoS Protection PlanãŒæœªä½œæˆã®å ´åˆã¯å‰Šé™¤
  # - Enable-DDoS-VNET
policy_definitions_to_add: []
policy_definitions_to_remove: []
policy_set_definitions_to_add: []
policy_set_definitions_to_remove: []
role_definitions_to_add: []
role_definitions_to_remove: []
```

!!! tip "ãƒãƒªã‚·ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•ğŸ’¡"
    - ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦æœ‰åŠ¹åŒ–: `# - Enable-DDoS-VNET` â†’ `- Enable-DDoS-VNET`
    - ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ : `policy_definitions_to_add` ã«å®šç¾©ã‚’è¿½åŠ 
    - ä¸è¦ãªãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤: `policy_assignments_to_remove` ã«ãƒãƒªã‚·ãƒ¼åã‚’è¿½åŠ 

---

## Part 5: locals.tfã®å¤‰æ›å‡¦ç†ğŸ”„

platform-landing-zone.auto.tfvars ã®è¨­å®šã‚’ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™å½¢å¼ã«å¤‰æ›ã™ã‚‹å‡¦ç†ã§ã™ã€‚ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼ã«é–¢é€£ã™ã‚‹éƒ¨åˆ†ã ã‘ã‚’è§£èª¬ã—ã¾ã™ã€‚

### ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—é–¢é€£ã®å¤‰æ›å‡¦ç†ğŸ§®

```hcl title="locals.tfï¼ˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—é–¢é€£éƒ¨åˆ†ï¼‰"
# Build policy dependencies
locals {
  management_group_dependencies = {
    policy_assignments = [
      module.management_resources,
      module.hub_and_spoke_vnet,
      module.virtual_wan
    ]
    policy_role_assignments = [
      module.management_resources,
      module.hub_and_spoke_vnet,
      module.virtual_wan
    ]
  }
}

locals {
  management_group_settings = merge(
    module.config.outputs.management_group_settings,
    {
      dependencies = local.management_group_dependencies
    }
  )
  management_resource_settings = merge(
    module.config.outputs.management_resource_settings,
    {
      tags = coalesce(module.config.outputs.management_resource_settings.tags, module.config.outputs.tags)
    }
  )
}
```

---

### ãƒãƒªã‚·ãƒ¼ä¾å­˜é–¢ä¿‚ã®æ§‹ç¯‰

```hcl
locals {
  management_group_dependencies = {
    policy_assignments = [
      module.management_resources,
      module.hub_and_spoke_vnet,
      module.virtual_wan
    ]
    policy_role_assignments = [
      module.management_resources,
      module.hub_and_spoke_vnet,
      module.virtual_wan
    ]
  }
}
```

**ãªãœä¾å­˜é–¢ä¿‚ãŒå¿…è¦ã‹ï¼Ÿ**ğŸ¤”

ãƒãƒªã‚·ãƒ¼ã¯ã€Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚„DDoS Protection Planãªã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã—ã¾ã™ã€‚

ã—ã‹ã—ã€Terraformã¯è‡ªå‹•çš„ã«ã“ã®ä¾å­˜é–¢ä¿‚ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ï¼ˆãƒãƒªã‚·ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æ–‡å­—åˆ—ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ãŸã‚ï¼‰ã€‚

ãã®ãŸã‚ã€æ˜ç¤ºçš„ã«ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

**å®Ÿéš›ã®å‹•ä½œ**:âš™ï¸

1. `module.management_resources` ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆLog Analyticsãªã©ï¼‰
2. `module.hub_and_spoke_vnet` ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆDDoS Planãªã©ï¼‰
3. ãã®å¾Œã€`module.management_groups` ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ï¼‰

---

### è¨­å®šã®ãƒãƒ¼ã‚¸ğŸ”—

```hcl
locals {
  management_group_settings = merge(
    module.config.outputs.management_group_settings,
    {
      dependencies = local.management_group_dependencies
    }
  )
  management_resource_settings = merge(
    module.config.outputs.management_resource_settings,
    {
      tags = coalesce(module.config.outputs.management_resource_settings.tags, module.config.outputs.tags)
    }
  )
}
```

**å‡¦ç†å†…å®¹**:ğŸ“

1. **management_group_settings**:
   - config ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‡ºåŠ›ã‚’å–å¾—
   - ä¾å­˜é–¢ä¿‚æƒ…å ±ã‚’è¿½åŠ 
   - modules/management_groups/ ã«æ¸¡ã™

2. **management_resource_settings**:
   - config ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‡ºåŠ›ã‚’å–å¾—
   - ã‚¿ã‚°æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
   - modules/management_resources/ ã«æ¸¡ã™

---

## Part 6: modules/management_groups/ã®è§£èª¬ğŸ§©

ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã€è¨­å®šã‚’å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™å‰å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ğŸ—‚ï¸

```
modules/management_groups/
â”œâ”€â”€ main.tf          # å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—
â”œâ”€â”€ variables.tf     # å…¥åŠ›å¤‰æ•°å®šç¾©
â”œâ”€â”€ locals.tf        # ãƒ‡ãƒ¼ã‚¿å¤‰æ›å‡¦ç†
â””â”€â”€ terraform.tf     # Terraformè¨­å®š
```

---

### main.tf: å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—ğŸ¢

```hcl title="modules/management_groups/main.tf"
module "management_groups" {
  source                                                        = "Azure/avm-ptn-alz/azurerm"
  version                                                       = "0.14.1"
  architecture_name                                             = var.management_group_settings.architecture_name
  parent_resource_id                                            = var.management_group_settings.parent_resource_id
  location                                                      = var.management_group_settings.location
  policy_default_values                                         = local.policy_default_values
  policy_assignments_to_modify                                  = local.policy_assignments_to_modify
  enable_telemetry                                              = var.enable_telemetry
  management_group_hierarchy_settings                           = var.management_group_settings.management_group_hierarchy_settings
  partner_id                                                    = var.management_group_settings.partner_id
  retries                                                       = var.management_group_settings.retries
  subscription_placement                                        = var.management_group_settings.subscription_placement
  timeouts                                                      = var.management_group_settings.timeouts
  dependencies                                                  = var.management_group_settings.dependencies
  override_policy_definition_parameter_assign_permissions_set   = var.management_group_settings.override_policy_definition_parameter_assign_permissions_set
  override_policy_definition_parameter_assign_permissions_unset = var.management_group_settings.override_policy_definition_parameter_assign_permissions_unset
  management_group_role_assignments                             = var.management_group_settings.management_group_role_assignments
  role_assignment_definition_lookup_enabled                     = var.management_group_settings.role_assignment_definition_lookup_enabled
  policy_assignment_non_compliance_message_settings             = var.management_group_settings.policy_assignment_non_compliance_message_settings
  role_assignment_name_use_random_uuid                          = var.management_group_settings.role_assignment_name_use_random_uuid
}
```

**ä¸»è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:ğŸŒŸ

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ |
|----------|------|
| `architecture_name` | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: `alz_custom`ï¼‰ |
| `parent_resource_id` | è¦ªç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚½ãƒ¼ã‚¹ID |
| `location` | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ |
| `policy_default_values` | ãƒãƒªã‚·ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
| `policy_assignments_to_modify` | ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ã®å¤‰æ›´ |
| `subscription_placement` | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®é…ç½® |
| `dependencies` | ä¾å­˜é–¢ä¿‚ã®å®šç¾© |

---

### locals.tf: ãƒ‡ãƒ¼ã‚¿å¤‰æ›å‡¦ç†ğŸ”„

```hcl title="modules/management_groups/locals.tf"
locals {
  policy_default_values = { for k, v in try(var.management_group_settings.policy_default_values, {}) : k => jsonencode({ value = v }) }
  policy_assignments_to_modify = { for management_group_key, management_group_value in try(var.management_group_settings.policy_assignments_to_modify, {}) : management_group_key => {
    policy_assignments = { for policy_assignment_key, policy_assignment_value in try(management_group_value.policy_assignments, {}) : policy_assignment_key => {
      enforcement_mode        = try(policy_assignment_value.enforcement_mode, null)
      identity                = try(policy_assignment_value.identity, null)
      identity_ids            = try(policy_assignment_value.identity_ids, null)
      parameters              = try({ for parameter_key, parameter_value in try(policy_assignment_value.parameters, {}) : parameter_key => jsonencode({ value = parameter_value }) }, null)
      non_compliance_messages = try(policy_assignment_value.non_compliance_messages, null)
      resource_selectors      = try(policy_assignment_value.resource_selectors, null)
      overrides               = try(policy_assignment_value.overrides, null)
    } }
  } }
}
```

**ã“ã®å¤‰æ›ã®ç›®çš„**:ğŸ’¡

Azure Policyã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§å—ã‘å–ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**å¤‰æ›å‰ï¼ˆplatform-landing-zone.auto.tfvarsï¼‰**:â¬…ï¸

```hcl
policy_default_values = {
  log_analytics_workspace_id = "/subscriptions/.../workspaces/law-001"
}
```

**å¤‰æ›å¾Œï¼ˆå…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™å½¢å¼ï¼‰**:â¡ï¸

```json
{
  "log_analytics_workspace_id": "{\"value\":\"/subscriptions/.../workspaces/law-001\"}"
}
```

---

## Part 7: å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨è§£èª¬ğŸ¢

**å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: `Azure/avm-ptn-alz/azurerm` v0.14.1

**GitHubãƒªãƒã‚¸ãƒˆãƒªï¼š**

https://github.com/Azure/terraform-azurerm-avm-ptn-alz


ã“ã“ã‹ã‚‰ã¯å…¬å¼ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ããªãŒã‚‰è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã“ã‚“ãªæ„Ÿã˜â†“
![ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸¦ã¹ã¦è¦‹ã‚‹](img/ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ4.png)

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã©ã†ã‚„ã£ã¦ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ã„ã‚‹ã®ã‹ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰ç†è§£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

---

### å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¨ä½“åƒ

ã¾ãšã€ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä½•ã‚’ã™ã‚‹ã®ã‹ã€å¤§ããªæµã‚Œã‚’ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

**ã‚„ã£ã¦ã„ã‚‹ã“ã¨**:ğŸ“

```
1. YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆlib/ãƒ•ã‚©ãƒ«ãƒ€ï¼‰
   â†“ ã€Œç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—alzã‚’ä½œã‚‹ã€ã€Œãƒãƒªã‚·ãƒ¼Aã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€ã¿ãŸã„ãªè¨­å®šãŒå…¥ã£ã¦ã‚‹
   
2. ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã™ã‚‹ï¼ˆlocals.tfï¼‰
   â†“ ã€ŒLevel 0ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã“ã‚Œã€ã€Œãƒãƒªã‚·ãƒ¼å®šç¾©ã¯ã“ã‚Œã€ã¿ãŸã„ã«ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
   
3. ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹ï¼ˆmain.management_groups.tfï¼‰
   â†“ Level 0 â†’ Level 1 â†’ Level 2... ã®é †ç•ªã§ä½œæˆ
   
4. ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ä½œã‚‹ï¼ˆmain.policy_definitions.tfï¼‰
   â†“ ã€ŒClassic VMã‚’ç¦æ­¢ã€ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©
   
5. ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ã‚’ä½œã‚‹ï¼ˆmain.policy_set_definitions.tfï¼‰
   â†“ è¤‡æ•°ã®ãƒãƒªã‚·ãƒ¼ã‚’ã¾ã¨ã‚ãŸã‚‚ã®
   
6. ãƒãƒªã‚·ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹ï¼ˆmain.policy_assignments.tfï¼‰
   â†“ ã€Œalzç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã€
   
7. æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ï¼ˆmain.policy_role_assignments.tfï¼‰
   â†“ ãƒãƒªã‚·ãƒ¼ãŒå‹•ããŸã‚ã®æ¨©é™ã‚’è¨­å®š
```

---

### ã‚¹ãƒ†ãƒƒãƒ—1: YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ğŸ“„

**ç›®çš„**: YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€ã€Œã©ã‚“ãªç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹ã‹ã€ã€Œã©ã‚“ãªãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹ã‹ã€ã‚’æŠŠæ¡ã™ã‚‹ã€‚

**èª­ã¿è¾¼ã‚€YAMLã®å ´æ‰€**:

- **ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã® `lib/` ãƒ•ã‚©ãƒ«ãƒ€**: ã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®šç¾©ã€ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰
- **GitHubä¸Šã®å…¬å¼ALZãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: ãƒãƒªã‚·ãƒ¼å®šç¾©ã€ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ã€ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—

â€»ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯https://github.com/shuhei0720org01/alz-mgmtã‚’æ„å‘³ã—ã¦ã„ã¾ã™ã€‚

**å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«**: `main.tf`


```hcl title="Azure/terraform-azurerm-avm-ptn-alz/main.tf"
data "alz_architecture" "this" {
  name                         = var.architecture_name
  root_management_group_id     = var.parent_resource_id
  location                     = var.location
  policy_assignments_to_modify = var.policy_assignments_to_modify
  policy_default_values        = var.policy_default_values
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ãŒå®Ÿéš›ã«ä½•ã‚’ã™ã‚‹ã®ã‹**:

`data "alz_architecture"` ã¯ã€ALZ ProviderãŒæä¾›ã™ã‚‹ç‰¹æ®Šãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§ã™ã€‚

!!! info "å‰æ: ALZ Providerã®è¨­å®šãŒå¿…è¦âš ï¸"
    ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½¿ã†ã«ã¯ã€äº‹å‰ã«ALZ Providerã®è¨­å®šãŒå¿…è¦ã§ã™ï¼ˆã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯[terraform.tf](terraform.tf#L24-L31)ã§è¨­å®šæ¸ˆã¿ï¼‰ã€‚
    
    ```hcl
    provider "alz" {
      library_references = [
        {
          custom_url = "${path.root}/lib"  # â† ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®libãƒ•ã‚©ãƒ«ãƒ€
        }
      ]
    }
    ```
    
    ã“ã®è¨­å®šã«ã‚ˆã‚Šã€ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã® `lib/` ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ å®šç¾©ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
    å…¬å¼ã®ALZãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGitHubã®Azure/Azure-Landing-Zones-Libraryï¼‰ã¯è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚’ä½¿ã†ã¨ï¼š

- **1. ã‚«ã‚¹ã‚¿ãƒ YAMLã‚’èª­ã¿è¾¼ã‚€ï¼ˆã“ã®ãƒªãƒã‚¸ãƒˆãƒªã® `lib/` ãƒ•ã‚©ãƒ«ãƒ€ï¼‰**

  ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã§æŒ‡å®šã—ãŸ `${path.root}/lib` ã‹ã‚‰ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®šç¾©ã¨ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’èª­ã¿è¾¼ã‚€ã€‚

- **2. name ã§æŒ‡å®šã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¢ã™**

  ```hcl
  name = var.architecture_name  # "alz_custom"
  ```

  **ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®** `lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml` ã‚’èª­ã‚€

- **3. YAMLã®å†…å®¹ã‚’è§£æã™ã‚‹**

  **alz_custom.alz_architecture_definition.yaml ã®ä¸­èº«**:

  ```yaml
  name: alz_custom
  management_groups:
    - id: alz
      display_name: Azure Landing Zones
      parent_id: root
      archetypes:
        - root_custom
    - id: platform
      display_name: Platform
      parent_id: alz
      archetypes:
        - platform_custom
    - id: management
      display_name: Management
      parent_id: platform
      archetypes:
        - management_custom
    # ...
  ```

- **4. ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—å®šç¾©ã‚‚èª­ã¿è¾¼ã‚€**

  å„ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã® `archetypes: [root_custom]` ã‚’è¦‹ã¦ã€**ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®** `lib/archetype_definitions/root_custom.alz_archetype_override.yaml` ã‚‚èª­ã‚€ï¼š
  
  ```yaml
  name: root_custom
  base_archetype: root
  policy_assignments_to_add: []
  policy_assignments_to_remove: []
  # ...
  ```

- **5. å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚‚èª­ã¿è¾¼ã‚€ï¼ˆGitHubä¸Šã®åˆ¥ãƒªãƒã‚¸ãƒˆãƒªï¼‰**

  ALZ Providerã¯è‡ªå‹•çš„ã« **GitHubä¸Šã®å…¬å¼ALZãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ï¼ˆ`Azure/Azure-Landing-Zones-Library`ï¼‰ã‹ã‚‰ã‚‚èª­ã¿è¾¼ã¿ã¾ã™ã€‚
  
  ã“ã“ã‹ã‚‰ `Deny-Classic-Resources` ã‚„ `Deploy-MDFC-Config` ãªã©ã®ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’å…¨éƒ¨èª­ã¿è¾¼ã¿ã¾ã™ã€‚
  
  å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­èº«ã«ã¤ã„ã¦ã¯ã€ã“ã®ç« ã®ãƒ‘ãƒ¼ãƒˆ8ã§è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

- **6. ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨**

  ```hcl
  policy_assignments_to_modify = var.policy_assignments_to_modify
  policy_default_values        = var.policy_default_values
  ```

  `policy_assignments_to_modify`: ã€Œã“ã®ãƒãƒªã‚·ãƒ¼ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã€
  
  `policy_default_values`: ã€ŒLog Analyticsã®IDã¯ã“ã‚Œã€ã¿ãŸã„ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

#### çµæœã€ä½•ãŒæ‰‹ã«å…¥ã‚‹ã‹ğŸ

`data.alz_architecture.this` ã¨ã„ã†å¤‰æ•°ã«ã€å…¨éƒ¨ã®æƒ…å ±ãŒå…¥ã‚Šã¾ã™ï¼š

```
data.alz_architecture.this = {
  management_groups = [
    {
      id           = "alz"
      level        = 0
      parent_id    = "root"
      display_name = "Azure Landing Zones"
      archetypes   = ["root_custom"]
      policy_definitions = {
        "Deny-Classic-Resources" = "{ JSONå½¢å¼ã®ãƒãƒªã‚·ãƒ¼å®šç¾© }"
        "Deny-Subnet-Without-Nsg" = "{ JSONå½¢å¼ã®ãƒãƒªã‚·ãƒ¼å®šç¾© }"
        # ... æ•°åå€‹
      }
      policy_assignments = {
        "Deploy-MDFC-Config" = "{ JSONå½¢å¼ã®ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ }"
        # ... æ•°åå€‹
      }
    },
    {
      id           = "platform"
      level        = 1
      parent_id    = "alz"
      display_name = "Platform"
      archetypes   = ["platform_custom"]
      policy_definitions = { ... }
      policy_assignments = { ... }
    },
    # ... å…¨ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—
  ]
}
```

**ã¤ã¾ã‚Š**:ğŸ’¡

- `data "alz_architecture"` ã¯é­”æ³•ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- ä½¿ã†ã ã‘ã§ã€ALZ ProviderãŒå‹æ‰‹ã«YAMLã‚’å…¨éƒ¨èª­ã‚“ã§ãã‚Œã‚‹
- èª­ã¿è¾¼ã‚“ã çµæœãŒ `data.alz_architecture.this` ã«å…¨éƒ¨å…¥ã‚‹
- ã‚ã¨ã¯ã“ã‚Œã‚’ä½¿ã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã£ã¦ã„ã

**ãªãœYAMLèª­ã¿è¾¼ã¿ã‚³ãƒ¼ãƒ‰ãŒè¦‹ãˆãªã„ã®ã‹**:ğŸ¤”

`data "alz_architecture"` ã®å†…éƒ¨å‡¦ç†ã¯ã€ALZ Providerï¼ˆGoè¨€èªã§æ›¸ã‹ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ã®ä¸­ã«éš ã‚Œã¦ã„ã¾ã™ã€‚Terraformã®ã‚³ãƒ¼ãƒ‰ã«ã¯ç¾ã‚Œã¾ã›ã‚“ã€‚

ã“ã‚Œã¯ã€`azurerm_resource_group` ã‚’ä½¿ã†ã¨å‹æ‰‹ã«Azure APIã‚’å‘¼ã‚“ã§ãã‚Œã‚‹ã®ã¨åŒã˜ä»•çµ„ã¿ã§ã™ã€‚å†…éƒ¨ã®å‡¦ç†ã¯è¦‹ãˆãªã„ã‘ã©ã€ä½¿ã†ã ã‘ã§å‹•ãã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã™ã‚‹ï¼ˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ç·¨ï¼‰ğŸ—‚ï¸

**ç›®çš„**: èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ã€Terraformãƒªã‚½ãƒ¼ã‚¹ã§ä½¿ã„ã‚„ã™ã„å½¢ã«æ•´ç†ã™ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `Azure/terraform-azurerm-avm-ptn-alz/locals.tf`

**å•é¡Œ**: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯è¦ªå­é–¢ä¿‚ãŒã‚ã‚‹ã®ã§ã€è¦ªã‚’å…ˆã«ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã§ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯é †ç•ªãŒãƒãƒ©ãƒãƒ©ã€‚ğŸ˜µâ€ğŸ’«

**è§£æ±ºç­–**: ãƒ¬ãƒ™ãƒ«åˆ¥ã«åˆ†ã‘ã‚‹ã€‚ğŸ§©

```hcl title="locals.tfï¼ˆç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰"
locals {
  # ã¾ãšå…¨ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒãƒƒãƒ—ã«å¤‰æ›
  management_groups = { for v in data.alz_architecture.this.management_groups : v.id => {
    id           = v.id
    level        = v.level
    exists       = v.exists
    display_name = v.display_name
    parent_id    = v.parent_id
  } }
  
  # Level 0ã ã‘æŠ½å‡º
  management_groups_level_0 = { for k, v in local.management_groups : k => v if v.level == 0 && !v.exists }
  
  # Level 1ã ã‘æŠ½å‡º
  management_groups_level_1 = { for k, v in local.management_groups : k => v if v.level == 1 && !v.exists }
  
  # Level 2-6ã‚‚åŒæ§˜...
}
```

**ãªãœã“ã†ã™ã‚‹ã®ã‹**:ğŸ’¡

ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®éšå±¤ã¯ã“ã†ãªã£ã¦ã‚‹ï¼š

```
Level 0: alz
  â”œâ”€ Level 1: platform
  â”‚   â”œâ”€ Level 2: management
  â”‚   â”œâ”€ Level 2: connectivity
  â”‚   â””â”€ Level 2: identity
  â””â”€ Level 1: landingzones
      â”œâ”€ Level 2: corp
      â””â”€ Level 2: online
```

Level 1ã‚’ä½œã‚‹ã«ã¯ã€Level 0ï¼ˆè¦ªï¼‰ãŒå…ˆã«å­˜åœ¨ã—ã¦ãªã„ã¨ãƒ€ãƒ¡ã€‚ã ã‹ã‚‰ã€ãƒ¬ãƒ™ãƒ«åˆ¥ã«åˆ†ã‘ã¦ã€é †ç•ªã«ä½œã‚‹ã€‚

**å…·ä½“ä¾‹**:ğŸ“

```hcl
# å…ƒã®ãƒ‡ãƒ¼ã‚¿ï¼ˆé †ç•ªãƒãƒ©ãƒãƒ©ï¼‰
data.alz_architecture.this.management_groups = [
  { id = "management", level = 2, ... },    # Level 2
  { id = "alz", level = 0, ... },           # Level 0
  { id = "platform", level = 1, ... },      # Level 1
]

# æ•´ç†å¾Œ
local.management_groups_level_0 = {
  "alz" = { id = "alz", level = 0, ... }
}
local.management_groups_level_1 = {
  "platform" = { id = "platform", level = 1, ... }
}
local.management_groups_level_2 = {
  "management" = { id = "management", level = 2, ... }
}
```

ã“ã‚Œã§ã€Level 0 â†’ Level 1 â†’ Level 2 ã®é †ã«ä½œã‚Œã‚‹ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã™ã‚‹ï¼ˆãƒãƒªã‚·ãƒ¼å®šç¾©ç·¨ï¼‰ğŸ›¡ï¸

**ç›®çš„**: ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ã€ä½œæˆã—ã‚„ã™ã„å½¢ã«å¤‰æ›ã™ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `Azure/terraform-azurerm-avm-ptn-alz/locals.tf`

**å•é¡Œ**: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒãƒªã‚·ãƒ¼å®šç¾©ã¯ã€ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«å…¥ã‚Œå­ã«ãªã£ã¦ã‚‹ã€‚ğŸŒ€

```
data.alz_architecture.this.management_groups = [
  {
    id = "alz"
    policy_definitions = {
      "Deny-Classic-Resources" = "{ JSON }",
      "Deny-Subnet-Without-Nsg" = "{ JSON }",
      ...
    }
  },
  {
    id = "platform"
    policy_definitions = {
      "Deny-Public-IP" = "{ JSON }",
      ...
    }
  }
]
```

**è§£æ±ºç­–**: ãƒ•ãƒ©ãƒƒãƒˆãªãƒãƒƒãƒ—ã«å¤‰æ›ã™ã‚‹ã€‚ğŸ—ºï¸

```hcl title="locals.tfï¼ˆãƒãƒªã‚·ãƒ¼å®šç¾©ï¼‰"
locals {
  policy_definitions = {
    for pdval in flatten([
      for mg in data.alz_architecture.this.management_groups : [
        for pdname, pd in mg.policy_definitions : {
          key        = pdname
          definition = jsondecode(pd)
          mg         = mg.id
        }
      ]
  ]) : "${pdval.mg}/${pdval.key}" => pdval }
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†è§£ã—ã¦ç†è§£ã™ã‚‹**:ğŸ”

**ã‚¹ãƒ†ãƒƒãƒ—1**: å„ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ«ãƒ¼ãƒ—

```hcl
for mg in data.alz_architecture.this.management_groups : [
  # mg = { id = "alz", policy_definitions = {...}, ... }
]
```

**ã‚¹ãƒ†ãƒƒãƒ—2**: å„ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ãƒ«ãƒ¼ãƒ—

```hcl
for pdname, pd in mg.policy_definitions : {
  key        = pdname          # "Deny-Classic-Resources"
  definition = jsondecode(pd)  # JSONæ–‡å­—åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
  mg         = mg.id           # "alz"
}
```

**ãªãœjsondecode()ãŒå¿…è¦ã‹**: ãƒãƒªã‚·ãƒ¼å®šç¾©ã¯JSONæ–‡å­—åˆ—ã§ä¿å­˜ã•ã‚Œã¦ã‚‹ã®ã§ã€Terraformã§ä½¿ãˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹ã€‚ğŸ§ª

**ã‚¹ãƒ†ãƒƒãƒ—3**: flatten()ã§ä¸€æ¬¡å…ƒé…åˆ—ã«

```hcl
flatten([...])  # å…¥ã‚Œå­ã®é…åˆ—ã‚’å¹³ã‚‰ã«ã™ã‚‹
```

**ã‚¹ãƒ†ãƒƒãƒ—4**: ã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãƒãƒƒãƒ—ã«

```hcl
"${pdval.mg}/${pdval.key}" => pdval
# ä¾‹: "alz/Deny-Classic-Resources" => { key = "Deny-Classic-Resources", ... }
```

**ãªãœã“ã®å½¢å¼ã«ã™ã‚‹ã®ã‹**: åŒã˜åå‰ã®ãƒãƒªã‚·ãƒ¼ãŒè¤‡æ•°ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‹ã‚‰ã€ã€Œç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ID/ãƒãƒªã‚·ãƒ¼åã€ã§ä¸€æ„ã«ã™ã‚‹ã€‚ğŸ”‘

**å¤‰æ›å‰ã¨å¤‰æ›å¾Œã®æ¯”è¼ƒ**:ğŸ”„

=== "å¤‰æ›å‰ï¼ˆå…¥ã‚Œå­ï¼‰"

    ```
    management_groups = [
      {
        id = "alz"
        policy_definitions = {
          "Deny-Classic-Resources" = "{ JSON }"
        }
      },
      {
        id = "platform"
        policy_definitions = {
          "Deny-Public-IP" = "{ JSON }"
        }
      }
    ]
    ```

=== "å¤‰æ›å¾Œï¼ˆãƒ•ãƒ©ãƒƒãƒˆï¼‰"

    ```
    policy_definitions = {
      "alz/Deny-Classic-Resources" = {
        key        = "Deny-Classic-Resources"
        definition = { name = "...", properties = {...} }
        mg         = "alz"
      }
      "platform/Deny-Public-IP" = {
        key        = "Deny-Public-IP"
        definition = { name = "...", properties = {...} }
        mg         = "platform"
      }
    }
    ```

ã“ã‚Œã§ã€`for_each = local.policy_definitions` ã§ãƒ«ãƒ¼ãƒ—ã—ã¦ä½œæˆã§ãã‚‹ã€‚ğŸ’¡

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹ğŸ—ï¸

**ç›®çš„**: å®Ÿéš›ã«Azureã«ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `Azure/terraform-azurerm-avm-ptn-alz/main.management_groups.tf`

**ãªãœãƒ¬ãƒ™ãƒ«ã”ã¨ã«åˆ†ã‘ã¦ä½œã‚‹ã®ã‹**: è¦ªãŒã„ãªã„ã¨å­ã¯ä½œã‚Œãªã„ã‹ã‚‰ã€‚ğŸ§‘â€ğŸ¤â€ğŸ§‘

```hcl title="main.management_groups.tfï¼ˆLevel 0ï¼‰"
resource "azapi_resource" "management_groups_level_0" {
  for_each = local.management_groups_level_0

  name      = each.value.id
  parent_id = "/"
  type      = "Microsoft.Management/managementGroups@2023-04-01"
  body = {
    properties = {
      details = {
        parent = {
          id = "/providers/Microsoft.Management/managementGroups/${each.value.parent_id}"
        }
      }
      displayName = each.value.display_name
    }
  }
  
  depends_on = [terraform_data.management_groups_dependencies]
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è©³ã—ãè¦‹ã‚‹**:ğŸ”

**for_each**: Level 0ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã ã‘ãƒ«ãƒ¼ãƒ—ğŸ”

```hcl
for_each = local.management_groups_level_0
# ä¾‹: { "alz" = { id = "alz", display_name = "Azure Landing Zones", ... } }
```

**name**: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ID

```hcl
name = each.value.id  # "alz"
```

**type**: Azure APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆğŸŒ

```hcl
type = "Microsoft.Management/managementGroups@2023-04-01"
# ã“ã‚Œã§Azure APIã«ã€Œç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã£ã¦ã€ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
```

**body**: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šğŸ“

```hcl
body = {
  properties = {
    details = {
      parent = {
        id = "/providers/Microsoft.Management/managementGroups/${each.value.parent_id}"
        # ä¾‹: "/providers/Microsoft.Management/managementGroups/root"
      }
    }
    displayName = each.value.display_name  # "Azure Landing Zones"
  }
}
```

**depends_on**: ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œâ³

```hcl
depends_on = [terraform_data.management_groups_dependencies]
# management_resourcesã€hub_and_spoke_vnetã€virtual_wan ãŒå…ˆã«ä½œã‚‰ã‚Œã‚‹
```

**ãªãœazapi_resourceã‚’ä½¿ã†ã®ã‹**:ğŸ¤”

æ™®é€šã®`azurerm_management_group`ãƒªã‚½ãƒ¼ã‚¹ã˜ã‚ƒãªãã¦ã€`azapi_resource`ã‚’ä½¿ã£ã¦ã‚‹ç†ç”±ï¼š

1. **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**: Azure APIã¯ä¸€æ™‚çš„ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹ã€‚azapi_resourceã¯è‡ªå‹•ã§ãƒªãƒˆãƒ©ã‚¤ã—ã¦ãã‚Œã‚‹
2. **æŸ”è»Ÿæ€§**: æ–°ã—ã„APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã™ãå¯¾å¿œã§ãã‚‹

**Level 1-6ã‚‚åŒã˜æ§‹é€ **:ğŸ§©

```hcl
resource "azapi_resource" "management_groups_level_1" {
  for_each = local.management_groups_level_1
  # ... åŒã˜å†…å®¹ ...
  depends_on = [azapi_resource.management_groups_level_0]  # Level 0ã‚’å¾…ã¤
}

resource "azapi_resource" "management_groups_level_2" {
  for_each = local.management_groups_level_2
  # ... åŒã˜å†…å®¹ ...
  depends_on = [azapi_resource.management_groups_level_1]  # Level 1ã‚’å¾…ã¤
}
```

**ä½œæˆé †åº**:ğŸ”¢

```
1. Level 0ã‚’ä½œæˆï¼ˆalzï¼‰
   â†“ depends_onã§å¾…æ©Ÿ
2. Level 1ã‚’ä½œæˆï¼ˆplatform, landingzones, sandboxï¼‰
   â†“ depends_onã§å¾…æ©Ÿ
3. Level 2ã‚’ä½œæˆï¼ˆmanagement, connectivity, identity, corp, onlineï¼‰
   â†“ ...
```

---

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ä½œæˆã™ã‚‹ğŸ›¡ï¸

**ç›®çš„**: ã€ŒClassic VMã‚’ç¦æ­¢ã€ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `Azure/terraform-azurerm-avm-ptn-alz/main.policy_definitions.tf`

```hcl title="main.policy_definitions.tf"
resource "azapi_resource" "policy_definitions" {
  for_each = local.policy_definitions

  name      = each.value.definition.name
  parent_id = "/providers/Microsoft.Management/managementGroups/${each.value.mg}"
  type      = "Microsoft.Authorization/policyDefinitions@2023-04-01"
  body = {
    properties = each.value.definition.properties
  }
  
  depends_on = [time_sleep.after_management_groups]
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è©³ã—ãè¦‹ã‚‹**:ğŸ”

**for_each**: ã™ã¹ã¦ã®ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ãƒ«ãƒ¼ãƒ—ğŸ”

```hcl
for_each = local.policy_definitions
# ä¾‹: {
#   "alz/Deny-Classic-Resources" = {
#     definition = { name = "Deny-Classic-Resources", properties = {...} }
#     mg = "alz"
#   }
# }
```

**parent_id**: ã©ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã‚‹ã‹ğŸ”—

```hcl
parent_id = "/providers/Microsoft.Management/managementGroups/${each.value.mg}"
# ä¾‹: "/providers/Microsoft.Management/managementGroups/alz"
```

**ãªãœç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã‚‹ã®ã‹**: ãƒãƒªã‚·ãƒ¼å®šç¾©ã¯ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¬ãƒ™ãƒ«ã§ä½œæˆã•ã‚Œã‚‹ã€‚ãã†ã™ã‚Œã°ã€ãã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨é…ä¸‹ã®å…¨ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã§ä½¿ãˆã‚‹ã€‚ğŸ§‘â€ğŸ¤â€ğŸ§‘

**body**: ãƒãƒªã‚·ãƒ¼ã®å®Ÿéš›ã®å†…å®¹ğŸ“

```hcl
body = {
  properties = each.value.definition.properties
  # {
  #   displayName = "Deny the deployment of classic resources"
  #   policyType = "Custom"
  #   mode = "All"
  #   policyRule = { ... }  # å®Ÿéš›ã®ãƒ«ãƒ¼ãƒ«
  #   parameters = { ... }   # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å®šç¾©
  # }
}
```

**depends_on**: ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ãŒä½œã‚‰ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œâ³

```hcl
depends_on = [time_sleep.after_management_groups]
```

**ãªãœtime_sleepãŒå¿…è¦ã‹**: Azure APIã¯çµæœæ•´åˆæ€§ãƒ¢ãƒ‡ãƒ«ã€‚ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã£ãŸç›´å¾Œã¯ã€ã¾ã Azureå†…éƒ¨ã§ä¼æ’­ä¸­ã€‚30ç§’å¾…ã¤ã“ã¨ã§ã€ç¢ºå®Ÿã«ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚â²ï¸

---

### ã‚¹ãƒ†ãƒƒãƒ—6: ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ã‚’ä½œæˆã™ã‚‹ğŸ›¡ï¸

**ç›®çš„**: ã€Œalzç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã€ã¨ã„ã†å‰²ã‚Šå½“ã¦ã‚’ä½œã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `Azure/terraform-azurerm-avm-ptn-alz/main.policy_assignments.tf`

```hcl title="main.policy_assignments.tfï¼ˆæŠœç²‹ï¼‰"
resource "azapi_resource" "policy_assignments" {
  for_each = local.policy_assignments_final

  location  = var.location
  name      = each.value.assignment.name
  parent_id = "/providers/Microsoft.Management/managementGroups/${each.value.mg}"
  type      = "Microsoft.Authorization/policyAssignments@2024-04-01"
  body = {
    properties = {
      policyDefinitionId = each.value.assignment.properties.policyDefinitionId
      parameters         = each.value.assignment.properties.parameters
      enforcementMode    = each.value.assignment.properties.enforcementMode
      # ...
    }
  }
  
  dynamic "identity" {
    for_each = each.value.assignment.identity != null ? [each.value.assignment.identity] : []
    content {
      type = identity.value.type
    }
  }
  
  depends_on = [time_sleep.after_policy_set_definitions]
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è©³ã—ãè¦‹ã‚‹**:ğŸ”

**location**: ãªãœlocationãŒå¿…è¦ï¼ŸğŸ“

```hcl
location = var.location  # "japaneast"
```

ãƒãƒªã‚·ãƒ¼ãŒãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹å ´åˆï¼ˆDeployIfNotExistsãªã©ï¼‰ã€ãƒãƒãƒ¼ã‚¸ãƒ‰IDãŒå¿…è¦ã€‚ãƒãƒãƒ¼ã‚¸ãƒ‰IDã«ã¯locationãŒå¿…è¦ã€‚

**policyDefinitionId**: ã©ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹ã‹ğŸ›¡ï¸

```hcl
policyDefinitionId = each.value.assignment.properties.policyDefinitionId
# ä¾‹: "/providers/Microsoft.Management/managementGroups/alz/providers/Microsoft.Authorization/policyDefinitions/Deny-Classic-Resources"
```

**parameters**: ãƒãƒªã‚·ãƒ¼ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ğŸ”§

```hcl
parameters = each.value.assignment.properties.parameters
# ä¾‹: {
#   "logAnalyticsWorkspaceId" = { "value" = "/subscriptions/.../workspaces/law-001" }
# }
```

**identity**: ãƒãƒãƒ¼ã‚¸ãƒ‰IDã®è¨­å®šğŸ†”

```hcl
dynamic "identity" {
  for_each = each.value.assignment.identity != null ? [each.value.assignment.identity] : []
  content {
    type = identity.value.type  # "SystemAssigned"
  }
}
```

**ãªãœdynamicä½¿ã†ã®ã‹**: identityãŒå¿…è¦ãªãƒãƒªã‚·ãƒ¼ï¼ˆDeployIfNotExistsï¼‰ã¨ãã†ã˜ã‚ƒãªã„ãƒãƒªã‚·ãƒ¼ï¼ˆDenyï¼‰ãŒã‚ã‚‹ã‹ã‚‰ã€‚å¿…è¦ãªæ™‚ã ã‘identityãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œã‚‹ã€‚ğŸ’¡

---

### ã‚¹ãƒ†ãƒƒãƒ—7: æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ğŸ”‘

**ç›®çš„**: ãƒãƒªã‚·ãƒ¼ãŒãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã€æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `Azure/terraform-azurerm-avm-ptn-alz/main.policy_role_assignments.tf`

**ãªãœæ¨©é™ãŒå¿…è¦ãªã®ã‹**: 

ä¾‹ãˆã°ã€ŒVMã«Log Analyticsã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¨ã„ã†ãƒãƒªã‚·ãƒ¼ãŒã‚ã‚‹ã€‚ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ï¼š

1. ãƒãƒªã‚·ãƒ¼ãŒãƒãƒãƒ¼ã‚¸ãƒ‰IDã‚’æŒã¤
2. ãã®ãƒãƒãƒ¼ã‚¸ãƒ‰IDã«ã€ŒVMã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ¨©é™ã€ãŒå¿…è¦

```hcl title="main.policy_role_assignments.tfï¼ˆæŠœç²‹ï¼‰"
resource "azapi_resource" "policy_role_assignments" {
  for_each = local.policy_role_assignments

  name      = each.key
  parent_id = each.value.scope
  type      = "Microsoft.Authorization/roleAssignments@2022-04-01"
  body = {
    properties = {
      principalId      = each.value.principal_id
      roleDefinitionId = each.value.role_definition_id
    }
  }
  
  depends_on = [terraform_data.policy_role_assignments_dependencies]
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è©³ã—ãè¦‹ã‚‹**:ğŸ”

**principalId**: èª°ã«æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‹ğŸ†”

```hcl
principalId = each.value.principal_id
# ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ã®ãƒãƒãƒ¼ã‚¸ãƒ‰IDã®principal_id
```

**roleDefinitionId**: ã©ã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‹ğŸ”‘

```hcl
roleDefinitionId = each.value.role_definition_id
# ä¾‹: "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
# ã“ã‚Œã¯ã€ŒLog Analytics Contributorã€ãƒ­ãƒ¼ãƒ«
```

**scope**: ã©ã“ã«å¯¾ã™ã‚‹æ¨©é™ã‹ğŸŒ

```hcl
parent_id = each.value.scope
# ä¾‹: "/subscriptions/12345678-1234-1234-1234-123456789012"
# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å…¨ä½“ã«å¯¾ã™ã‚‹æ¨©é™
```

**ã©ã†ã‚„ã£ã¦è‡ªå‹•çš„ã«æ¨©é™ãŒæ±ºã¾ã‚‹ã®ã‹**:ğŸ¤–

ãƒãƒªã‚·ãƒ¼å®šç¾©ã®ä¸­ã«ã€å¿…è¦ãªæ¨©é™ãŒæ›¸ã„ã¦ã‚ã‚‹ï¼š

```json
{
  "policyRule": {
    "then": {
      "effect": "deployIfNotExists",
      "details": {
        "roleDefinitionIds": [
          "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
        ]
      }
    }
  }
}
```

å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã“ã‚Œã‚’èª­ã¿å–ã£ã¦ã€è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ã‚’ä½œæˆã™ã‚‹ã€‚

---

### ã¾ã¨ã‚ï¼šå…¨ä½“ã®æµã‚ŒğŸ“

```
1. YAMLãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆmain.tfï¼‰
   â†“ data.alz_architecture.this ã«å…¨ãƒ‡ãƒ¼ã‚¿æ ¼ç´
   
2. ãƒ‡ãƒ¼ã‚¿æ•´ç†ï¼ˆlocals.tfï¼‰
   â†“ management_groups_level_0-6 ã«åˆ†é¡
   â†“ policy_definitions ã‚’ãƒ•ãƒ©ãƒƒãƒˆåŒ–
   
3. ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆï¼ˆmain.management_groups.tfï¼‰
   â†“ Level 0 â†’ Level 1 â†’ ... ã®é †
   
4. 30ç§’å¾…æ©Ÿï¼ˆtime_sleepï¼‰
   â†“ Azureå†…éƒ¨ã§ã®ä¼æ’­ã‚’å¾…ã¤
   
5. ãƒãƒªã‚·ãƒ¼å®šç¾©ä½œæˆï¼ˆmain.policy_definitions.tfï¼‰
   â†“ å„ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ä½œæˆ
   
6. ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ä½œæˆï¼ˆmain.policy_set_definitions.tfï¼‰
   â†“ è¤‡æ•°ã®ãƒãƒªã‚·ãƒ¼ã‚’ã¾ã¨ã‚ã‚‹
   
7. ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ä½œæˆï¼ˆmain.policy_assignments.tfï¼‰
   â†“ ãƒãƒãƒ¼ã‚¸ãƒ‰IDä»˜ãã§å‰²ã‚Šå½“ã¦
   
8. ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ä½œæˆï¼ˆmain.policy_role_assignments.tfï¼‰
   â†“ ãƒãƒªã‚·ãƒ¼ã«å¿…è¦ãªæ¨©é™ã‚’ä»˜ä¸
```

**å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è³¢ã„ã¨ã“ã‚**:ğŸ§ 

1. **è‡ªå‹•åŒ–**: ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’è¦‹ã¦ã€å¿…è¦ãªæ¨©é™ã‚’è‡ªå‹•ã§ä»˜ä¸
2. **é †åºç®¡ç†**: depends_onã§ç¢ºå®Ÿã«é †ç•ªé€šã‚Šä½œæˆ
3. **ã‚¨ãƒ©ãƒ¼å¯¾ç­–**: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã€time_sleepã§ç¢ºå®Ÿæ€§ã‚’æ‹…ä¿
4. **æŸ”è»Ÿæ€§**: policy_assignments_to_modifyã§ç°¡å˜ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½

---

## Part 8: å…¬å¼ALZãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è©³ç´°è§£èª¬ğŸ“š

ã‚¹ãƒ†ãƒƒãƒ—1ã®5ã§è§¦ã‚ŒãŸå…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­èº«ã‚’ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰è©³ã—ãç†è§£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

---

### å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã¯ä½•ã‹ï¼ŸğŸ“š

**GitHubãƒªãƒã‚¸ãƒˆãƒª**:

â†“ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’é–‹ããªãŒã‚‰è¦‹ã¦ã„ãã¾ã—ã‚‡ã†
https://github.com/Azure/Azure-Landing-Zones-Library

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€Microsoftå…¬å¼ã®ALZï¼ˆAzure Landing Zonesï¼‰ãƒãƒªã‚·ãƒ¼å®šç¾©ãƒ»ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ãƒ»ãƒ­ãƒ¼ãƒ«å®šç¾©ãªã©ãŒã™ã¹ã¦å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**: ALZ ProviderãŒè‡ªå‹•çš„ã«ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’èª­ã¿è¾¼ã‚€ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ğŸ’¡

---

### ãªãœå…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ãªã®ã‹ï¼ŸğŸ“š

ã„ã¡ã‹ã‚‰å…¨éƒ¨ã®ãƒãƒªã‚·ãƒ¼ã‚’æ›¸ãã®ã¯å¤§å¤‰ã§ã™ã€‚

**ä¾‹ãˆã°ã€ã“ã‚“ãªãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã«ãªã‚Šã¾ã™**:ğŸ’¡

- ã€ŒClassic VMã‚’ä½œã‚‰ã›ãªã„ã€
- ã€ŒNSGã®ãªã„ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œã‚‰ã›ãªã„ã€
- ã€ŒVMã«è¨ºæ–­è¨­å®šã‚’è‡ªå‹•ã§ä»˜ã‘ã‚‹ã€
- ã€ŒMicrosoft Defenderã‚’è‡ªå‹•ã§æœ‰åŠ¹åŒ–ã€
- ã€ŒLog Analyticsã«ãƒ­ã‚°ã‚’é€ã‚‹ã€

ã“ã‚Œã‚’å…¨éƒ¨è‡ªåˆ†ã§æ›¸ãã¨ã€æ•°ç™¾å€‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Œã°**:ğŸ

â†’ å…¨éƒ¨æœ€åˆã‹ã‚‰ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ï¼è‡ªåˆ†ã§æ›¸ãå¿…è¦ãªã—ï¼

---

### å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å…¨ä½“åƒğŸ—‚ï¸

```
Azure-Landing-Zones-Library/
â”œâ”€â”€ platform/
â”‚   â””â”€â”€ alz/                           # ALZç”¨ã®å®šç¾©ãŒå…¨éƒ¨ã“ã“
â”‚       â”œâ”€â”€ archetype_definitions/     # ã€Œmanagementç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ä½•ã‚’é©ç”¨ï¼Ÿã€çš„ãªå®šç¾©
â”‚       â”‚   â”œâ”€â”€ alz_root.alz_archetype_definition.json
â”‚       â”‚   â”œâ”€â”€ alz_management.alz_archetype_definition.json
â”‚       â”‚   â”œâ”€â”€ alz_connectivity.alz_archetype_definition.json
â”‚       â”‚   â”œâ”€â”€ alz_identity.alz_archetype_definition.json
â”‚       â”‚   â”œâ”€â”€ alz_landing_zones.alz_archetype_definition.json
â”‚       â”‚   â””â”€â”€ ...ï¼ˆå…¨11å€‹ï¼‰
â”‚       â”œâ”€â”€ policy_definitions/        # å€‹åˆ¥ã®ãƒãƒªã‚·ãƒ¼å®šç¾©ï¼ˆãƒ«ãƒ¼ãƒ«ã®å®Ÿä½“ï¼‰
â”‚       â”‚   â”œâ”€â”€ Deny-Classic-Resources.json
â”‚       â”‚   â”œâ”€â”€ Deny-Subnet-Without-Nsg.json
â”‚       â”‚   â”œâ”€â”€ Deploy-MDFC-Config.json
â”‚       â”‚   â”œâ”€â”€ Deploy-VM-Monitoring.json
â”‚       â”‚   â””â”€â”€ ...ï¼ˆæ•°ç™¾å€‹ï¼ï¼‰
â”‚       â”œâ”€â”€ policy_set_definitions/    # ãƒãƒªã‚·ãƒ¼ã‚’ã¾ã¨ã‚ãŸã‚»ãƒƒãƒˆ
â”‚       â”‚   â”œâ”€â”€ Deploy-Diagnostics-LogAnalytics.json
â”‚       â”‚   â”œâ”€â”€ Enforce-Guardrails-Network.json
â”‚       â”‚   â””â”€â”€ ...ï¼ˆæ•°åå€‹ï¼‰
â”‚       â””â”€â”€ role_definitions/          # ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©
â”‚           â”œâ”€â”€ Network-Management.json
â”‚           â”œâ”€â”€ Application-Owners.json
â”‚           â””â”€â”€ ...ï¼ˆæ•°å€‹ï¼‰
â””â”€â”€ README.md
```

---

### ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—å®šç¾©ã¨ã¯ï¼ŸğŸ“

ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—å®šç¾©ã¯ã€ã€Œã“ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ã©ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹ã‹ã€ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

**å®Ÿéš›ã®ä¾‹**: `alz_management.alz_archetype_definition.json`ğŸ”

GitHubã§è¦‹ã‚‹: https://github.com/Azure/Azure-Landing-Zones-Library/blob/main/platform/alz/archetype_definitions/alz_management.alz_archetype_definition.json

```json
{
  "name": "management",
  "policy_assignments": [
    "Deploy-AzActivity-Log",
    "Deploy-VM-Monitoring",
    "Deploy-VMSS-Monitoring",
    "Deploy-Resource-Diag"
  ],
  "policy_definitions": [],
  "policy_set_definitions": [],
  "role_definitions": [],
  "archetype_config": {
    "parameters": {},
    "access_control": {}
  }
}
```

**ã“ã‚Œã‚’æ—¥æœ¬èªã«ç¿»è¨³ã™ã‚‹ã¨**:ğŸ—£ï¸

```
managementç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ã€ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ï¼š
- Deploy-AzActivity-Logï¼ˆAzure Activity Logã‚’è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
- Deploy-VM-Monitoringï¼ˆVMã®ç›£è¦–ã‚’è‡ªå‹•è¨­å®šï¼‰
- Deploy-VMSS-Monitoringï¼ˆVM Scale Setã®ç›£è¦–ã‚’è‡ªå‹•è¨­å®šï¼‰
- Deploy-Resource-Diagï¼ˆãƒªã‚½ãƒ¼ã‚¹ã®è¨ºæ–­è¨­å®šã‚’è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼å®šç¾©ã¯è¿½åŠ ã—ã¾ã›ã‚“ï¼ˆç©ºï¼‰
ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ã¯è¿½åŠ ã—ã¾ã›ã‚“ï¼ˆç©ºï¼‰
ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©ã¯è¿½åŠ ã—ã¾ã›ã‚“ï¼ˆç©ºï¼‰
```

**å®Ÿéš›ã®å‹•ã**:âš™ï¸

```
1. ã‚ãªãŸãŒã€Œmanagementç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹ã€ã¨YAMLã«æ›¸ã
   â†“
2. lib/archetype_definitions/management_custom.alz_archetype_override.yamlã§
   base_archetype: management ã¨æŒ‡å®š
   â†“
3. ALZ ProviderãŒå…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®alz_management.alz_archetype_definition.jsonã‚’èª­ã‚€
   â†“
4. ã€ŒDeploy-AzActivity-Logã€ã€ŒDeploy-VM-Monitoringã€ãªã©ã®ãƒãƒªã‚·ãƒ¼ãŒ
   managementç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«è‡ªå‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹
```

---

### ãƒãƒªã‚·ãƒ¼å®šç¾©ã®å…·ä½“ä¾‹ğŸ”–

ãƒãƒªã‚·ãƒ¼å®šç¾©ã¯ã€ã€Œã©ã‚“ãªãƒ«ãƒ¼ãƒ«ã§ã€ä½•ã‚’åˆ¶é™ã™ã‚‹ã‹ã€ã‚’å®šç¾©ã—ãŸã‚‚ã®ã§ã™ã€‚

**ä¾‹1: `Deny-Classic-Resources.json`**ğŸ›‘

GitHubã§è¦‹ã‚‹: https://github.com/Azure/Azure-Landing-Zones-Library/blob/main/platform/alz/policy_definitions/Deny-Classic-Resources.json

```json
{
  "name": "Deny-Classic-Resources",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Classic ãƒªã‚½ãƒ¼ã‚¹ã‚’æ‹’å¦",
    "description": "ã‚¯ãƒ©ã‚·ãƒƒã‚¯ ãƒªã‚½ãƒ¼ã‚¹ (VM, Storage ãªã©) ã®ä½œæˆã‚’æ‹’å¦ã—ã¾ã™ã€‚",
    "metadata": {
      "version": "1.0.0",
      "category": "General",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {},
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "field": "type",
            "equals": "Microsoft.ClassicCompute/virtualMachines"
          },
          {
            "field": "type",
            "equals": "Microsoft.ClassicStorage/storageAccounts"
          },
          {
            "field": "type",
            "equals": "Microsoft.ClassicNetwork/virtualNetworks"
          }
        ]
      },
      "then": {
        "effect": "Deny"
      }
    }
  }
}
```

**ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’æ—¥æœ¬èªã«ç¿»è¨³ã™ã‚‹ã¨**:ğŸ—£ï¸

```
ãƒãƒªã‚·ãƒ¼å: Deny-Classic-Resources

ãƒ«ãƒ¼ãƒ«:
  ã‚‚ã—ã€ä½œã‚ã†ã¨ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒä»¥ä¸‹ã®ã©ã‚Œã‹ãªã‚‰ï¼š
    - Classic VMï¼ˆMicrosoft.ClassicCompute/virtualMachinesï¼‰
    - Classic Storageï¼ˆMicrosoft.ClassicStorage/storageAccountsï¼‰
    - Classic VNetï¼ˆMicrosoft.ClassicNetwork/virtualNetworksï¼‰
  
  ãã®ã¨ãï¼š
    - ä½œæˆã‚’æ‹’å¦ã™ã‚‹ï¼ˆDenyï¼‰
```

**å®Ÿéš›ã®å‹•ã**:âš™ï¸

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒClassic VMã‚’ä½œã‚ã†ã€ã¨Azureãƒãƒ¼ã‚¿ãƒ«ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
â†“
AzureãŒã€Œã“ã‚Œã¯Microsoft.ClassicCompute/virtualMachinesã ãªã€ã¨åˆ¤å®š
â†“
ãƒãƒªã‚·ãƒ¼ã®ifã«å¼•ã£ã‹ã‹ã‚‹ï¼ˆanyOfã®1å€‹ç›®ã«ä¸€è‡´ï¼‰
â†“
thenãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆeffect: Denyï¼‰
â†“
ã€Œã“ã®ãƒªã‚½ãƒ¼ã‚¹ã¯ä½œæˆã§ãã¾ã›ã‚“ã€ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹
```

**ä¾‹2: `Deploy-VM-Monitoring.json`**ğŸ–¥ï¸

ã‚‚ã£ã¨è¤‡é›‘ãªä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```json
{
  "name": "Deploy-VM-Monitoring",
  "type": "Microsoft.Authorization/policyDefinitions",
  "properties": {
    "displayName": "VM ã« Azure Monitor Agent ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "VM ã« Azure Monitor Agent (AMA) ã¨ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ« (DCR) ã‚’è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚",
    "metadata": {
      "version": "1.0.0",
      "category": "Monitoring"
    },
    "parameters": {
      "dataCollectionRuleId": {
        "type": "String",
        "metadata": {
          "displayName": "ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ« ID",
          "description": "VM ã«é–¢é€£ä»˜ã‘ã‚‹ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹ ID"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "åŠ¹æœ",
          "description": "ãƒãƒªã‚·ãƒ¼ã®åŠ¹æœã‚’æœ‰åŠ¹åŒ–ã¾ãŸã¯ç„¡åŠ¹åŒ–ã—ã¾ã™"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "location",
            "in": [
              "japaneast",
              "japanwest"
            ]
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "dataCollectionRuleId": {
                    "type": "string"
                  }
                },
                "resources": [
                  {
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "name": "[concat(parameters('vmName'), '-dcr-association')]",
                    "properties": {
                      "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[field('name')]"
                },
                "location": {
                  "value": "[field('location')]"
                },
                "dataCollectionRuleId": {
                  "value": "[parameters('dataCollectionRuleId')]"
                },
              }
            }
          }
        }
      }
    }
  }
}
```

**ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’æ—¥æœ¬èªã«ç¿»è¨³ã™ã‚‹ã¨**:

```
ãƒãƒªã‚·ãƒ¼å: Deploy-VM-Monitoring

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - dataCollectionRuleId: ã©ã®ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ã†ã‹ï¼ˆå¿…é ˆï¼‰
  - effect: ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: DeployIfNotExistsï¼‰

ãƒ«ãƒ¼ãƒ«:
  ã‚‚ã—ã€ä½œã‚ã†ã¨ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒä»¥ä¸‹ã®æ¡ä»¶ã‚’å…¨ã¦æº€ãŸã™ãªã‚‰ï¼š
    - ç¨®é¡ãŒVMï¼ˆMicrosoft.Compute/virtualMachinesï¼‰
    - å ´æ‰€ãŒæ—¥æœ¬æ±ã¾ãŸã¯æ—¥æœ¬è¥¿
  
  ãã®ã¨ãï¼š
    - VMä½œæˆã¯è¨±å¯ã™ã‚‹
    - ã§ã‚‚ã€ä½œæˆå¾Œã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ«ã‚’ç´ã¥ã‘ã‚‹
    - ç´ã¥ã‘ã‚‹ã¨ãã«å¿…è¦ãªæ¨©é™ï¼ˆLog Analytics Contributorï¼‰ã‚’è‡ªå‹•ã§ä»˜ä¸
```

**å®Ÿéš›ã®å‹•ã**:

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæ±æ—¥æœ¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«VMã‚’ä½œã‚ã†ã€ã¨ã™ã‚‹
   â†“
2. AzureãŒã€Œã“ã‚Œã¯Microsoft.Compute/virtualMachinesã§ã€location=japaneastã ãªã€ã¨åˆ¤å®š
   â†“
3. ãƒãƒªã‚·ãƒ¼ã®ifã«å¼•ã£ã‹ã‹ã‚‹ï¼ˆallOfã®ä¸¡æ–¹ã«ä¸€è‡´ï¼‰
   â†“
4. thenãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆeffect: DeployIfNotExistsï¼‰
   â†“
5. VMä½œæˆã¯è¨±å¯ã•ã‚Œã‚‹
   â†“
6. ã§ã‚‚ã€ä½œæˆå¾Œã«è‡ªå‹•çš„ã«ARM TemplateãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
   â†“
7. ARM TemplateãŒã€ŒMicrosoft.Insights/dataCollectionRuleAssociationsã€ã‚’ä½œã‚‹
   â†“
8. VMã¨Data Collection RuleãŒç´ã¥ã
   â†“
9. VMã®ãƒ­ã‚°ãŒè‡ªå‹•çš„ã«Log Analyticsã«é€ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹
```

**ãªãœã“ã‚“ãªã«è¤‡é›‘ãªã®ã‹**:ğŸ¤”

ã€ŒVMã‚’ä½œã£ãŸã‚‰è‡ªå‹•ã§ç›£è¦–è¨­å®šã‚’å…¥ã‚ŒãŸã„ã€ã¨ã„ã†è¦æ±‚ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€‚

- `Deny`ç³»: ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆã€Œã“ã‚Œã¯ä½œã‚‰ã›ãªã„ã€ã ã‘ï¼‰
- `DeployIfNotExists`ç³»: è¤‡é›‘ï¼ˆã€Œä½œã£ãŸå¾Œã«è‡ªå‹•ã§è¨­å®šã‚’è¿½åŠ ã€ï¼‰

---

### ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ï¼ˆã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–ï¼‰ã¨ã¯ï¼ŸğŸ“¦

ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå®šç¾©ã¯ã€ã€Œè¤‡æ•°ã®ãƒãƒªã‚·ãƒ¼ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã€ã§ã™ã€‚

**ãªãœå¿…è¦ã‹**:â“

å€‹åˆ¥ã®ãƒãƒªã‚·ãƒ¼ã‚’1å€‹1å€‹å‰²ã‚Šå½“ã¦ã‚‹ã®ã¯å¤§å¤‰ã€‚

```
managementç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ä»¥ä¸‹ã‚’å‰²ã‚Šå½“ã¦ãŸã„ï¼š
- VMã®è¨ºæ–­è¨­å®š
- Storageã®è¨ºæ–­è¨­å®š
- VNetã®è¨ºæ–­è¨­å®š
- NSGã®è¨ºæ–­è¨­å®š
- Public IPã®è¨ºæ–­è¨­å®š
- Load Balancerã®è¨ºæ–­è¨­å®š
...ï¼ˆæ•°åå€‹ï¼‰
```

**ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆãŒã‚ã‚Œã°**:ğŸ

â†’ ã€ŒDeploy-Diagnostics-LogAnalyticsã€ã¨ã„ã†1å€‹ã®ã‚»ãƒƒãƒˆã‚’å‰²ã‚Šå½“ã¦ã‚‹ã ã‘ã§ã€å…¨éƒ¨é©ç”¨ã•ã‚Œã‚‹ï¼

**å®Ÿéš›ã®ä¾‹**: `Deploy-Diagnostics-LogAnalytics.json`ğŸ”

GitHubã§è¦‹ã‚‹: https://github.com/Azure/Azure-Landing-Zones-Library/blob/main/platform/alz/policy_set_definitions/Deploy-Diagnostics-LogAnalytics.json

```json
{
  "name": "Deploy-Diagnostics-LogAnalytics",
  "type": "Microsoft.Authorization/policySetDefinitions",
  "apiVersion": "2021-06-01",
  "properties": {
    "policyType": "Custom",
    "displayName": "è¨ºæ–­è¨­å®šã‚’ Log Analytics ã«ãƒ‡ãƒ—ãƒ­ã‚¤",
    "description": "è¤‡æ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã®è¨ºæ–­è¨­å®šã‚’ Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚",
    "metadata": {
      "version": "1.0.0",
      "category": "Monitoring"
    },
    "parameters": {
      "logAnalyticsWorkspaceId": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ ID",
          "description": "è¨ºæ–­ãƒ­ã‚°ã®é€ä¿¡å…ˆã¨ãªã‚‹ Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒªã‚½ãƒ¼ã‚¹ ID"
        }
      }
    },
    "policyDefinitions": [
      {
        "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/alz/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VM",
        "parameters": {
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/alz/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VNET",
        "parameters": {
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/alz/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Storage",
        "parameters": {
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          }
        }
      }
      // ... å®Ÿéš›ã«ã¯20å€‹ä»¥ä¸Šã®ãƒãƒªã‚·ãƒ¼å®šç¾©ãŒå«ã¾ã‚Œã‚‹
    ]
  }
}
```

**ã“ã®ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆã‚’æ—¥æœ¬èªã«ç¿»è¨³ã™ã‚‹ã¨**:ğŸ—£ï¸

```
ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆå: Deploy-Diagnostics-LogAnalytics

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - logAnalyticsWorkspaceId: ã©ã®Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ­ã‚°ã‚’é€ã‚‹ã‹

å«ã¾ã‚Œã‚‹ãƒãƒªã‚·ãƒ¼:
  1. Deploy-Diagnostics-VMï¼ˆVMã®è¨ºæ–­è¨­å®šï¼‰
     â†’ logAnalyticsWorkspaceIdã‚’æ¸¡ã™
  2. Deploy-Diagnostics-VNETï¼ˆVNetã®è¨ºæ–­è¨­å®šï¼‰
     â†’ logAnalyticsWorkspaceIdã‚’æ¸¡ã™
  3. Deploy-Diagnostics-Storageï¼ˆStorageã®è¨ºæ–­è¨­å®šï¼‰
     â†’ logAnalyticsWorkspaceIdã‚’æ¸¡ã™
  ...ï¼ˆå…¨20å€‹ä»¥ä¸Šï¼‰
```

**å®Ÿéš›ã®å‹•ã**:âš™ï¸

```
1. ã‚ãªãŸãŒplatform-landing-zone.auto.tfvarsã§è¨­å®š
   policy_default_values = {
     log_analytics_workspace_id = "/subscriptions/.../workspaces/law-001"
   }
   â†“
2. managementç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã€ŒDeploy-Diagnostics-LogAnalyticsã€ã‚»ãƒƒãƒˆãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹
   â†“
3. ã‚»ãƒƒãƒˆå†…ã®å…¨ãƒãƒªã‚·ãƒ¼ï¼ˆ20å€‹ä»¥ä¸Šï¼‰ãŒä¸€æ°—ã«é©ç”¨ã•ã‚Œã‚‹
   â†“
4. å„ãƒãƒªã‚·ãƒ¼ã«log_analytics_workspace_id = "/subscriptions/.../workspaces/law-001"ãŒæ¸¡ã•ã‚Œã‚‹
   â†“
5. VMã‚’ä½œã£ãŸã‚‰ â†’ è‡ªå‹•ã§è¨ºæ–­è¨­å®šãŒå…¥ã‚‹ â†’ law-001ã«ãƒ­ã‚°ãŒé€ã‚‰ã‚Œã‚‹
   VNetã‚’ä½œã£ãŸã‚‰ â†’ è‡ªå‹•ã§è¨ºæ–­è¨­å®šãŒå…¥ã‚‹ â†’ law-001ã«ãƒ­ã‚°ãŒé€ã‚‰ã‚Œã‚‹
   Storageã‚’ä½œã£ãŸã‚‰ â†’ è‡ªå‹•ã§è¨ºæ–­è¨­å®šãŒå…¥ã‚‹ â†’ law-001ã«ãƒ­ã‚°ãŒé€ã‚‰ã‚Œã‚‹
```

---

### å®Ÿéš›ã®ä½¿ã‚ã‚Œæ–¹ï¼šå…¨ä½“ã®æµã‚ŒğŸ”„

**ã‚¹ãƒ†ãƒƒãƒ—1: ALZ ProviderãŒå…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€**

```hcl title="terraform.tf"
provider "alz" {
  library_overwrite_enabled = true
  library_references = [
    {
      custom_url = "${path.root}/lib"  # ã‚ãªãŸã®ã‚«ã‚¹ã‚¿ãƒ å®šç¾©
    }
    # å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGitHubï¼‰ã¯è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹
  ]
}
```

**ã‚¹ãƒ†ãƒƒãƒ—2: data "alz_architecture"ãŒçµ±åˆã™ã‚‹**

```hcl title="å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: main.tf"
data "alz_architecture" "this" {
  name = "alz_custom"  # ã‚ãªãŸã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®šç¾©ï¼ˆlib/architecture_definitions/alz_custom.alz_architecture_definition.yamlï¼‰
}
```

**å†…éƒ¨ã§ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹**:ğŸ”¬

```
1. ALZ ProviderãŒèµ·å‹•
   â†“
2. GitHubã®å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   https://github.com/Azure/Azure-Landing-Zones-Library
   â†“
3. å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨éƒ¨èª­ã¿è¾¼ã‚€
   - archetype_definitions/: 11å€‹
   - policy_definitions/: æ•°ç™¾å€‹
   - policy_set_definitions/: æ•°åå€‹
   - role_definitions/: æ•°å€‹
   â†“
4. ã‚ãªãŸã®lib/ãƒ•ã‚©ãƒ«ãƒ€ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚‚èª­ã¿è¾¼ã‚€
   - architecture_definitions/alz_custom.alz_architecture_definition.yaml
   - archetype_definitions/*_custom.alz_archetype_override.yaml
   â†“
5. ä¸¡æ–¹ã‚’çµ±åˆã™ã‚‹
   - ã‚ãªãŸã®archetype_overrideã§ã€Œbase_archetype: managementã€ã¨æ›¸ã„ã¦ã‚ã‚Œã°
   - å…¬å¼ã®alz_management.alz_archetype_definition.jsonã‚’èª­ã‚“ã§
   - ã€Œpolicy_assignments_to_addã€ã§è¿½åŠ 
   - ã€Œpolicy_assignments_to_removeã€ã§å‰Šé™¤
   â†“
6. æœ€çµ‚çš„ãªè¨­å®šãŒdata.alz_architecture.thisã«å…¥ã‚‹
```

**ã‚¹ãƒ†ãƒƒãƒ—3: çµæœã‚’ç¢ºèª**ğŸ”

`data.alz_architecture.this`ã«å…¥ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼š

```
data.alz_architecture.this = {
  management_groups = [
    {
      id = "management"
      archetypes = ["management_custom"]
      policy_definitions = {
        "Deny-Classic-Resources" = "{å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®JSON}",
        "Deploy-VM-Monitoring" = "{å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®JSON}",
        ...ï¼ˆæ•°ç™¾å€‹ï¼‰
      }
      policy_assignments = {
        "Deploy-AzActivity-Log" = "{å‰²ã‚Šå½“ã¦è¨­å®š}",
        "Deploy-VM-Monitoring" = "{å‰²ã‚Šå½“ã¦è¨­å®š}",
        ...
      }
    },
    ...
  ]
}
```

---

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®ãƒ‘ã‚¿ãƒ¼ãƒ³ğŸ› ï¸

**ãƒ‘ã‚¿ãƒ¼ãƒ³1: å…¬å¼ãƒãƒªã‚·ãƒ¼ã‚’ãã®ã¾ã¾ä½¿ã†**:ğŸŸ¢

```yaml title="lib/archetype_definitions/management_custom.alz_archetype_override.yaml"
base_archetype: management  # å…¬å¼ã®"management"ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
name: management_custom
policy_assignments_to_add: []  # è¿½åŠ ãªã—
policy_assignments_to_remove: []  # å‰Šé™¤ãªã—
policy_definitions_to_add: []
policy_definitions_to_remove: []
```

**çµæœ**:âœ…

â†’ å…¬å¼ã®alz_management.alz_archetype_definition.jsonã«æ›¸ã„ã¦ã‚ã‚‹ãƒãƒªã‚·ãƒ¼ãŒãã®ã¾ã¾é©ç”¨ã•ã‚Œã‚‹

**ãƒ‘ã‚¿ãƒ¼ãƒ³2: å…¬å¼ãƒãƒªã‚·ãƒ¼ã‚’ä¸€éƒ¨å‰Šé™¤**:ğŸ—‘ï¸

```yaml title="lib/archetype_definitions/management_custom.alz_archetype_override.yaml"
base_archetype: management
name: management_custom
policy_assignments_to_remove:
  - Deploy-VM-Monitoring  # ã“ã®å…¬å¼ãƒãƒªã‚·ãƒ¼ã¯ä½¿ã‚ãªã„
```

**çµæœ**:âœ…

```
å…¬å¼ã®alz_management.alz_archetype_definition.jsonã«ã¯ï¼š
  - Deploy-AzActivity-Log
  - Deploy-VM-Monitoring
  - Deploy-VMSS-Monitoring
  - Deploy-Resource-Diag

ã‚ãªãŸã®è¨­å®šã§å‰Šé™¤ï¼š
  - Deploy-VM-Monitoring

æœ€çµ‚çš„ã«é©ç”¨ã•ã‚Œã‚‹ãƒãƒªã‚·ãƒ¼ï¼š
  - Deploy-AzActivity-Log
  - Deploy-VMSS-Monitoring
  - Deploy-Resource-Diag
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³3: å…¬å¼ãƒãƒªã‚·ãƒ¼ + ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼**:â•

```yaml title="lib/archetype_definitions/management_custom.alz_archetype_override.yaml"
base_archetype: management
name: management_custom
policy_assignments_to_add:
  - My-Custom-Policy  # è‡ªåˆ†ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 
policy_definitions_to_add:
  - My-Custom-Policy  # å®šç¾©ã‚‚è¿½åŠ 
```

**çµæœ**:âœ…

```
å…¬å¼ã®ãƒãƒªã‚·ãƒ¼ï¼š
  - Deploy-AzActivity-Log
  - Deploy-VM-Monitoring
  - Deploy-VMSS-Monitoring
  - Deploy-Resource-Diag

ã‚ãªãŸã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ï¼š
  - My-Custom-Policy

æœ€çµ‚çš„ã«é©ç”¨ã•ã‚Œã‚‹ãƒãƒªã‚·ãƒ¼ï¼š
  - Deploy-AzActivity-Log
  - Deploy-VM-Monitoring
  - Deploy-VMSS-Monitoring
  - Deploy-Resource-Diag
  - My-Custom-Policyï¼ˆâ†è¿½åŠ ï¼‰
```

---

### å…¬å¼ãƒãƒªã‚·ãƒ¼ã®ä¸»è¦ã‚«ãƒ†ã‚´ãƒªğŸ·ï¸

| ã‚«ãƒ†ã‚´ãƒª | ãƒãƒªã‚·ãƒ¼ä¾‹ | ä½•ã‚’ã™ã‚‹ã‹ |
|---------|-----------|----------|
| **Denyç³»** | Deny-Classic-Resources | å¤ã„ã‚¿ã‚¤ãƒ—ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆClassic VMï¼‰ã‚’ä½œã‚‰ã›ãªã„ |
| | Deny-Subnet-Without-Nsg | NSGï¼ˆãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼‰ã®ãªã„ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œã‚‰ã›ãªã„ |
| | Deny-Public-IP-Without-DNS | DNSåã®ãªã„Public IPã‚’ä½œã‚‰ã›ãªã„ |
| **Deployç³»** | Deploy-MDFC-Config | Microsoft Defenderã‚’è‡ªå‹•ã§æœ‰åŠ¹åŒ– |
| | Deploy-VM-Monitoring | VMã«ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« |
| | Deploy-Diagnostics-LogAnalytics | è¨ºæ–­è¨­å®šã‚’è‡ªå‹•ã§è¿½åŠ ï¼ˆãƒ­ã‚°ã‚’Log Analyticsã«é€ã‚‹ï¼‰ |
| **Auditç³»** | Audit-UnusedResources | ä½¿ã‚ã‚Œã¦ã„ãªã„ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¤œå‡º |
| | Audit-PublicIP | Public IPã®ä½¿ç”¨çŠ¶æ³ã‚’ç›£æŸ» |
| **Modifyç³»** | Modify-NSG-Rules | NSGã®ãƒ«ãƒ¼ãƒ«ã‚’è‡ªå‹•ä¿®æ­£ |

---

### ã‚ˆãã‚ã‚‹è³ªå•â“

**Q: å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ›´æ–°ã¯ã©ã†ãªã‚‹ï¼Ÿ**ğŸ”„

A: ALZ Providerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã‚‹ã¨ã€æ–°ã—ã„ãƒãƒªã‚·ãƒ¼å®šç¾©ãŒè‡ªå‹•çš„ã«å–ã‚Šè¾¼ã¾ã‚Œã¾ã™ã€‚

```hcl title="terraform.tf"
terraform {
  required_providers {
    alz = {
      source  = "Azure/alz"
      version = "0.20.0"  # â†ã“ã‚Œã‚’0.21.0ã«ä¸Šã’ã‚‹ã¨æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ãŒä½¿ãˆã‚‹
    }
  }
}
```

**å®Ÿéš›ã®å‹•ã**:âš™ï¸

```
version = "0.20.0"ã®ã¨ã
â†“
å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®2024å¹´1æœˆç‰ˆã‚’èª­ã‚€
â†“ version = "0.21.0"ã«å¤‰æ›´
â†“
å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®2024å¹´6æœˆç‰ˆã‚’èª­ã‚€ï¼ˆæ–°ã—ã„ãƒãƒªã‚·ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¦ã‚‹ï¼‰
```

**Q: å…¬å¼ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ï¼Ÿ**ğŸ“

A: å…¬å¼ãƒãƒªã‚·ãƒ¼ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ï¼š

**æ–¹æ³•1: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹**:ğŸ”§

```hcl title="platform-landing-zone.auto.tfvars"
management_group_settings = {
  policy_assignments_to_modify = {
    management = {
      policy_assignments = {
        Deploy-VM-Monitoring = {
          parameters = {
            dataCollectionRuleId = "/subscriptions/.../my-custom-dcr"
          }
        }
      }
    }
  }
}
```

**æ–¹æ³•2: ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦è¿½åŠ **:ğŸ†•

```yaml title="lib/archetype_definitions/management_custom.alz_archetype_override.yaml"
policy_assignments_to_add:
  - My-Custom-VM-Monitoring
policy_definitions_to_add:
  - My-Custom-VM-Monitoring
```

```json title="lib/policy_definitions/My-Custom-VM-Monitoring.json"
{
  "name": "My-Custom-VM-Monitoring",
  ...
}
```

**Q: ã©ã®ãƒãƒªã‚·ãƒ¼ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ãŸã„**ğŸ”

A: 3ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

1. **GitHubã§ç¢ºèª**:
   https://github.com/Azure/Azure-Landing-Zones-Library/tree/main/platform/alz/archetype_definitions
   
2. **Azureãƒãƒ¼ã‚¿ãƒ«ã§ç¢ºèª**:
   ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ— â†’ ãƒãƒªã‚·ãƒ¼ â†’ å‰²ã‚Šå½“ã¦

3. **Terraform planã§ç¢ºèª**:
   ```bash
   terraform plan
   ```
   å‡ºåŠ›ã«ã€Œã©ã®ãƒãƒªã‚·ãƒ¼ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‹ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## Part 9: å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³ğŸ§‘â€ğŸ”¬

ã‚ˆãã‚ã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã®è¿½åŠ ğŸ†•

**ã‚·ãƒŠãƒªã‚ª**: ç‰¹å®šã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿è¨±å¯ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ãŸã„

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’ä½œæˆğŸ“

```json title="lib/policy_definitions/allowed_locations.json"
{
  "name": "Allowed-Locations",
  "properties": {
    "displayName": "Allowed locations",
    "policyType": "Custom",
    "mode": "All",
    "description": "This policy enables you to restrict the locations your organization can specify when deploying resources.",
    "metadata": {
      "category": "General"
    },
    "parameters": {
      "allowedLocations": {
        "type": "Array",
        "metadata": {
          "description": "The list of allowed locations for resources.",
          "displayName": "Allowed locations",
          "strongType": "location"
        }
      }
    },
    "policyRule": {
      "if": {
        "not": {
          "field": "location",
          "in": "[parameters('allowedLocations')]"
        }
      },
      "then": {
        "effect": "deny"
      }
    }
  }
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã«è¿½åŠ â•

```yaml title="lib/archetype_definitions/root_custom.alz_archetype_override.yaml"
base_archetype: root
name: root_custom
policy_assignments_to_add:
  - Allowed-Locations
policy_definitions_to_add:
  - Allowed-Locations
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šğŸ”§

```hcl title="platform-landing-zone.auto.tfvars"
management_group_settings = {
  # ...
  policy_default_values = {
    allowed_locations = ["japaneast", "japanwest"]
  }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ—¢å­˜ãƒãƒªã‚·ãƒ¼ã®ç„¡åŠ¹åŒ–ğŸš«

**ã‚·ãƒŠãƒªã‚ª**: DDoS Protection PlanãŒæœªä½œæˆãªã®ã§ã€DDoSãƒãƒªã‚·ãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ãŸã„

```yaml title="lib/archetype_definitions/connectivity_custom.alz_archetype_override.yaml"
base_archetype: connectivity
name: connectivity_custom
policy_assignments_to_remove:
  - Enable-DDoS-VNET  # ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
```

ã¾ãŸã¯ã€ç›£æŸ»ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ï¼šğŸ•µï¸

```hcl title="platform-landing-zone.auto.tfvars"
management_group_settings = {
  # ...
  policy_assignments_to_modify = {
    connectivity = {
      policy_assignments = {
        Enable-DDoS-VNET = {
          enforcement_mode = "DoNotEnforce"
        }
      }
    }
  }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®é…ç½®ğŸ“¦

**ã‚·ãƒŠãƒªã‚ª**: æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«é…ç½®ã—ãŸã„

```hcl title="platform-landing-zone.auto.tfvars"
management_group_settings = {
  # ...
  subscription_placement = {
    my_new_subscription = {
      subscription_id       = "12345678-1234-1234-1234-123456789012"
      management_group_name = "corp"
    }
  }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒãƒªã‚·ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ›´ğŸ”§

**ã‚·ãƒŠãƒªã‚ª**: Microsoft Defenderã®è¨­å®šã‚’å¤‰æ›´ã—ãŸã„

```hcl title="platform-landing-zone.auto.tfvars"
management_group_settings = {
  # ...
  policy_assignments_to_modify = {
    alz = {
      policy_assignments = {
        Deploy-MDFC-Config-H224 = {
          parameters = {
            emailSecurityContact = "security@example.com"
            enableAscForServers = "DeployIfNotExists"
            enableAscForStorage = "Disabled"  # Storageã®ä¿è­·ã‚’ç„¡åŠ¹åŒ–
          }
        }
      }
    }
  }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã®è¿½åŠ ğŸ‘¤

**ã‚·ãƒŠãƒªã‚ª**: ç‰¹å®šã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«å¯¾ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ãŸã„

```hcl title="platform-landing-zone.auto.tfvars"
management_group_settings = {
  # ...
  management_group_role_assignments = {
    platform_owner = {
      management_group_name      = "platform"
      role_definition_id_or_name = "Owner"
      principal_id               = "12345678-1234-1234-1234-123456789012"
      description                = "Platform team owner access"
    }
  }
}
```

---

## ã¾ã¨ã‚ğŸ“

**ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼ã®å½¹å‰²**ï¼šğŸ—‚ï¸

1. **ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—éšå±¤**: ALZã®æ¨å¥¨æ§‹é€ ã¨ãƒãƒªã‚·ãƒ¼ç¶™æ‰¿ã®ä»•çµ„ã¿
2. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: platform-landing-zone.auto.tfvarsã§ä¸€å…ƒç®¡ç†
3. **YAMLå®šç¾©**: lib/ãƒ•ã‚©ãƒ«ãƒ€ã§éšå±¤æ§‹é€ ã¨ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©
4. **ãƒ‡ãƒ¼ã‚¿å¤‰æ›**: locals.tfã§ä¾å­˜é–¢ä¿‚ã‚’æ§‹ç¯‰
5. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•´å½¢ã¨JSONå¤‰æ›
6. **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: ãƒ¬ãƒ™ãƒ«åˆ¥ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
7. **ãƒãƒªã‚·ãƒ¼ç®¡ç†**: å®šç¾©ãƒ»ã‚»ãƒƒãƒˆãƒ»å‰²ã‚Šå½“ã¦ãƒ»æ¨©é™ã‚’è‡ªå‹•åŒ–
8. **å…¬å¼ALZãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: Microsoftå…¬å¼ã®ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’æ´»ç”¨
9. **æŸ”è»Ÿãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§ãƒãƒªã‚·ãƒ¼ã‚’èª¿æ•´

**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ **ï¼šğŸ—ï¸

- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `platform-landing-zone.auto.tfvars`ã§è¨­å®š
- **main.management.tf**: countãƒ‘ã‚¿ãƒ¼ãƒ³ã¨movedãƒ–ãƒ­ãƒƒã‚¯ã§çŠ¶æ…‹ç®¡ç†
- **lib/ãƒ•ã‚©ãƒ«ãƒ€**: YAMLã§éšå±¤æ§‹é€ ã¨ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©
- **locals.tf**: ä¾å­˜é–¢ä¿‚ã®ç®¡ç†ã¨è¨­å®šã®å¤‰æ›
- **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: `modules/management_groups/`ã§ãƒ‡ãƒ¼ã‚¿å¤‰æ›
- **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: `Azure/avm-ptn-alz/azurerm`ã§ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**ï¼šğŸ’¡

- ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¯éšå±¤æ§‹é€ ã§ãƒãƒªã‚·ãƒ¼ã‚’ç¶™æ‰¿ï¼ˆè¦ªâ†’å­ï¼‰
- lib/ãƒ•ã‚©ãƒ«ãƒ€ã§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã‚’å®šç¾©
- ALZ ProviderãŒè‡ªå‹•çš„ã«YAMLã¨å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€
- ãƒ¬ãƒ™ãƒ«åˆ¥ã«ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆï¼ˆLevel 0 â†’ 1 â†’ 2...ï¼‰
- ãƒãƒªã‚·ãƒ¼ã¯å®šç¾©â†’ã‚»ãƒƒãƒˆâ†’å‰²ã‚Šå½“ã¦â†’æ¨©é™ã®é †ã§ä½œæˆ
- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§å®Ÿç¾


---

## ç·´ç¿’å•é¡ŒğŸ“

ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚ğŸ§

### å•é¡Œ1â“
ALZã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—éšå±¤ã§ã€`alz`ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ç›´ä¸‹ã«ã‚ã‚‹3ã¤ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¯ä½•ã§ã™ã‹ï¼Ÿ

### å•é¡Œ2â“
ãƒãƒªã‚·ãƒ¼ã®ç¶™æ‰¿ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®éšå±¤ã§ãƒãƒªã‚·ãƒ¼Aã‚’`platform`ã«å‰²ã‚Šå½“ã¦ãŸå ´åˆã€ã©ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«é©ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ

```
alz
â”œâ”€â”€ platform
â”‚   â”œâ”€â”€ management
â”‚   â””â”€â”€ connectivity
â””â”€â”€ landingzones
```

### å•é¡Œ3â“
lib/ãƒ•ã‚©ãƒ«ãƒ€ã®2ã¤ã®ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã®å½¹å‰²ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

### å•é¡Œ4â“
ALZ Providerã®`data "alz_architecture"`ã¯ã€ã©ã“ã‹ã‚‰YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿï¼ˆ2ç®‡æ‰€ï¼‰

### å•é¡Œ5â“
ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹éš›ã€ãªãœLevel 0 â†’ Level 1 â†’ Level 2...ã®é †ç•ªã§ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ

---

## ç·´ç¿’å•é¡Œã®ç­”ãˆğŸ“

### ç­”ãˆ1âœ…
`alz`ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®ç›´ä¸‹ã«ã‚ã‚‹3ã¤ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼š

1. **platform**ï¼šå…±é€šåŸºç›¤ï¼ˆmanagement, connectivity, identityï¼‰
2. **landingzones**ï¼šã‚¢ãƒ—ãƒªç’°å¢ƒï¼ˆcorp, onlineï¼‰
3. **sandbox**ï¼šæ¤œè¨¼ãƒ»å®Ÿé¨“ç’°å¢ƒ

ï¼ˆæ³¨ï¼šdecommissionedã‚‚ã‚ã‚Šã¾ã™ãŒã€ä¸»è¦ãª3ã¤ã¯ä¸Šè¨˜ã§ã™ï¼‰

### ç­”ãˆ2âœ…
ãƒãƒªã‚·ãƒ¼AãŒé©ç”¨ã•ã‚Œã‚‹ã®ã¯ï¼š

- `platform` âœ…ï¼ˆç›´æ¥å‰²ã‚Šå½“ã¦ï¼‰
- `management` âœ…ï¼ˆplatformã®å­â†’ç¶™æ‰¿ï¼‰
- `connectivity` âœ…ï¼ˆplatformã®å­â†’ç¶™æ‰¿ï¼‰
- `alz` âŒï¼ˆè¦ªã«ã¯ä¼æ’­ã—ãªã„ï¼‰
- `landingzones` âŒï¼ˆå…„å¼Ÿã«ã¯ä¼æ’­ã—ãªã„ï¼‰

ãƒãƒªã‚·ãƒ¼ã¯è¦ªâ†’å­ã¸ç¶™æ‰¿ã•ã‚Œã¾ã™ãŒã€é€†æ–¹å‘ã‚„å…„å¼Ÿã¸ã®ä¼æ’­ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### ç­”ãˆ3âœ…
**architecture_definitions/**ï¼š

- ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®éšå±¤æ§‹é€ ã‚’å®šç¾©
- ã©ã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ãŒã©ã“ã®å­ã‹ã‚’å®šç¾©
- ä¾‹ï¼š`alz_custom.alz_architecture_definition.yaml`

**archetype_definitions/**ï¼š

- å„ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«é©ç”¨ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã«å¯¾ã™ã‚‹è¿½åŠ ãƒ»å‰Šé™¤ã‚’å®šç¾©
- ä¾‹ï¼š`root_custom.alz_archetype_override.yaml`

### ç­”ãˆ4âœ…
ALZ Providerã¯2ç®‡æ‰€ã‹ã‚‰YAMLã‚’èª­ã¿è¾¼ã¿ã¾ã™ï¼š

**1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã® `lib/` ãƒ•ã‚©ãƒ«ãƒ€**ï¼š

- ã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®šç¾©ã€ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰
- `provider "alz"`ã®`library_references`ã§æŒ‡å®š
- ä¾‹ï¼š`${path.root}/lib`

**2. GitHubä¸Šã®å…¬å¼ALZãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ï¼š

- Microsoftå…¬å¼ã®ãƒãƒªã‚·ãƒ¼å®šç¾©ãƒ»ãƒãƒªã‚·ãƒ¼ã‚»ãƒƒãƒˆãƒ»ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—
- ALZ ProviderãŒè‡ªå‹•çš„ã«èª­ã¿è¾¼ã‚€
- ä¾‹ï¼š`Azure/Azure-Landing-Zones-Library`ãƒªãƒã‚¸ãƒˆãƒª

### ç­”ãˆ5âœ…
ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯è¦ªå­é–¢ä¿‚ãŒã‚ã‚‹ãŸã‚ã€è¦ªãŒå­˜åœ¨ã—ãªã„ã¨å­ã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚

**ä¾‹**ï¼š
```
Level 0: alzï¼ˆè¦ªãªã—ï¼‰
  â†“ ã“ã‚Œã‚’å…ˆã«ä½œã‚‹
Level 1: platformï¼ˆè¦ª: alzï¼‰
  â†“ alzãŒå­˜åœ¨ã—ã¦ã‹ã‚‰ä½œã‚‹
Level 2: managementï¼ˆè¦ª: platformï¼‰
  â†“ platformãŒå­˜åœ¨ã—ã¦ã‹ã‚‰ä½œã‚‹
```

Azure APIã¯è¦ªç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®IDã‚’å¿…è¦ã¨ã™ã‚‹ãŸã‚ã€è¦ªãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§å­ã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

`depends_on`ã‚’ä½¿ã£ã¦ã€Level 0 â†’ Level 1 â†’ Level 2...ã®é †åºã‚’ä¿è¨¼ã—ã¦ã„ã¾ã™ã€‚

---

æ¬¡ã®Chapterã§ã¯ã€ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ï¼ˆLog Analyticsã€Automation Accountã€Data Collection Rulesï¼‰ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ã“ã‚Œã‚‰ãŒãƒãƒªã‚·ãƒ¼ã¨é€£æºã—ã¦VMã®ç›£è¦–ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‚ˆã€‚

---

**æ‰€è¦æ™‚é–“**: 90åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜…â˜…  
**å‰**: [10_ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—.md](./10_ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—.md)  
**æ¬¡**: [12_ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹.md](./12_ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹.md)
