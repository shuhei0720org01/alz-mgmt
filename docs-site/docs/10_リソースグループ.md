# 10. ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— - åŸºç›¤ã®ä½œæˆ ğŸ“¦


!!! info "ã“ã®ç« ã§å­¦ã¶ã“ã¨"
    `main.resource.groups.tf`ã§ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹ä»•çµ„ã¿ã‚’å­¦ã³ã¾ã™ï¼š

    1. ğŸ“¦ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã£ã¦ä½•ï¼Ÿ
    2. ğŸ“main.resource.groups.tfã®è§£èª¬
    3. ğŸ—ï¸å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨æ§‹é€ ï¼ˆå®Œå…¨è§£èª¬ï¼‰
    4. ğŸ”for_eachã®æ´»ç”¨æ–¹æ³•
    5. ğŸ› ï¸å®Ÿè·µï¼šæ–°ã—ã„ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®è¿½åŠ æ–¹æ³•

---

## ã¯ã˜ã‚ã«ï¼šãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã£ã¦ä½•ï¼ŸğŸ“¦

### ğŸ—‚ï¸Azureã®ã€Œãƒ•ã‚©ãƒ«ãƒ€ã€ã¿ãŸã„ãªã‚‚ã®

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€Azureãƒªã‚½ãƒ¼ã‚¹ã‚’ã¾ã¨ã‚ã¦ç®¡ç†ã™ã‚‹ã€Œç®±ã€ã§ã™ã€‚

=== "ä¾‹ï¼šä¼šç¤¾ã®çµ„ç¹”"

    ```text title="çµ„ç¹”æ§‹é€ "
    ä¼šç¤¾
    â”œâ”€â”€ å–¶æ¥­éƒ¨ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
    â”‚   â”œâ”€â”€ å–¶æ¥­ã‚·ã‚¹ãƒ†ãƒ ï¼ˆVMï¼‰
    â”‚   â””â”€â”€ é¡§å®¢DBï¼ˆDatabaseï¼‰
    â”œâ”€â”€ é–‹ç™ºéƒ¨ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
    â”‚   â”œâ”€â”€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ï¼ˆVMï¼‰
    â”‚   â””â”€â”€ ãƒ†ã‚¹ãƒˆDBï¼ˆDatabaseï¼‰
    â””â”€â”€ ç·å‹™éƒ¨ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
        â”œâ”€â”€ çµ¦ä¸ã‚·ã‚¹ãƒ†ãƒ ï¼ˆVMï¼‰
        â””â”€â”€ äººäº‹DBï¼ˆDatabaseï¼‰
    ```

    éƒ¨ç½²ã”ã¨ã«ç®¡ç†ï¼âœ¨

=== "Azure Landing Zonesã®æ§‹æˆ"

    ```text title="ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—æ§‹æˆ"
    Azure Subscription
    â”œâ”€â”€ rg-connectivity-japaneastï¼ˆæ¥ç¶šç”¨ï¼‰
    â”‚   â”œâ”€â”€ VNetï¼ˆä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
    â”‚   â”œâ”€â”€ Firewallï¼ˆãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼‰
    â”‚   â””â”€â”€ Bastionï¼ˆè¸ã¿å°ï¼‰
    â”œâ”€â”€ rg-management-japaneastï¼ˆç®¡ç†ç”¨ï¼‰
    â”‚   â”œâ”€â”€ Log Analytics
    â”‚   â””â”€â”€ Automation Account
    â””â”€â”€ rg-identity-japaneastï¼ˆIDç®¡ç†ç”¨ï¼‰
        â””â”€â”€ Domain Controller
    ```

---

### ğŸŒŸãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒªãƒƒãƒˆ

- **ã¾ã¨ã‚ã¦ç®¡ç†**: é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã‚’1ç®‡æ‰€ã«ğŸ“¦
- **ä¸€æ‹¬å‰Šé™¤**: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨å‰Šé™¤å¯èƒ½ğŸ—‘ï¸
- **ã‚¿ã‚°ç®¡ç†**: ã‚³ã‚¹ãƒˆç®¡ç†ã‚„åˆ†é¡ğŸ·ï¸
- **RBAC**: ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®è¨­å®šğŸ”‘

---

### ğŸ“ã©ã“ã§å®šç¾©ã™ã‚‹ã®ï¼Ÿ

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¯ `platform-landing-zone.auto.tfvars` ã§å®šç¾©ã—ã¾ã™ã€‚

```hcl title="platform-landing-zone.auto.tfvarsï¼ˆæŠœç²‹ï¼‰"
connectivity_resource_groups = {
  ddos = {
    name     = "$${ddos_resource_group_name}"
    location = "$${starter_location_01}"
    settings = {
      enabled = "$${ddos_protection_plan_enabled}"
    }
  }
  vnet_primary = {
    name     = "$${connectivity_hub_primary_resource_group_name}"
    location = "$${starter_location_01}"
    settings = {
      enabled = true
    }
  }
  vnet_secondary = {
    name     = "$${connectivity_hub_secondary_resource_group_name}"
    location = "$${starter_location_02}"
    settings = {
      enabled = true
    }
  }
  dns = {
    name     = "$${dns_resource_group_name}"
    location = "$${starter_location_01}"
    settings = {
      enabled = "$${primary_private_dns_zones_enabled}"
    }
  }
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:

- `$${å¤‰æ•°å}`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ï¼ˆChapter 09ã§è§£èª¬ã—ãŸç½®æ›ã‚·ã‚¹ãƒ†ãƒ ï¼‰
- `enabled`: true/falseã§ä½œæˆå¯å¦ã‚’åˆ¶å¾¡
- 4ç¨®é¡ã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©ï¼šddosã€vnet_primaryã€vnet_secondaryã€dns

**å‡¦ç†ã®æµã‚Œ**:

```
1. platform-landing-zone.auto.tfvars ã§å®šç¾©
  â†“
2. modules/config-templating ã§å¤‰æ•°ç½®æ›
  â†“
3. main.resource.groups.tf ã§ä½œæˆ
```

---

## ğŸ—ï¸Part 1: main.resource.groups.tf ã®å…¨ä½“åƒ

```hcl title="main.resource.groups.tf"
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }

  name             = each.value.name
  location         = each.value.location
  enable_telemetry = var.enable_telemetry
  tags             = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags

  providers = {
    azurerm = azurerm.connectivity
  }
}
```

**ãŸã£ãŸ15è¡Œï¼** ã§ã‚‚å¼·åŠ›ãªå…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ğŸ’ª

---

## ğŸ”Part 2: ã‚³ãƒ¼ãƒ‰ã‚’è©³ã—ãè¦‹ã¦ã„ã

### ğŸ§©2-1: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºæœ¬è¨­å®š

```hcl
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

Azureå…¬å¼ã®ã€ŒAzure Verified Modules (AVM)ã€ã‚’ä½¿ç”¨ã€‚

**AVMã¨ã¯ï¼š**

- MicrosoftãŒå…¬å¼ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã—ã¦ã„ã‚‹Terraformãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ã„ãŸå®Ÿè£…
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã®ã§å®‰å…¨

**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ§‹æˆï¼š**

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `main.tf` | ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ |
| `variables.tf` | å…¥åŠ›å¤‰æ•°å®šç¾© |
| `outputs.tf` | å‡ºåŠ›å®šç¾© |
| `terraform.tf` | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¦ä»¶ |

---

### ğŸ”2-2: for_eachã§ãƒ«ãƒ¼ãƒ—å‡¦ç†

```hcl
for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

`connectivity_resource_groups`ã‹ã‚‰æœ‰åŠ¹ãªãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã ã‘ã‚’é¸ã‚“ã§ãƒ«ãƒ¼ãƒ—ã€‚

**å‡¦ç†ã®æµã‚Œï¼š**

1. `module.config.outputs.connectivity_resource_groups`ã‚’å–å¾—
2. `for key, value in ...`ã§ãƒ«ãƒ¼ãƒ—
3. `if try(value.settings.enabled, true)`ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
4. `{ key => value }`å½¢å¼ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ

**å…·ä½“ä¾‹ï¼š**

```hcl title="å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆconnectivity_resource_groupsï¼‰"
{
  "connectivity" = {
    name     = "rg-connectivity-japaneast"
    location = "japaneast"
    settings = { enabled = true }
  }
  "management" = {
    name     = "rg-management-japaneast"
    location = "japaneast"
    settings = { enabled = false }  # ç„¡åŠ¹
  }
}
```

**ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œï¼š**

```hcl title="for_eachçµæœ"
{
  "connectivity" = {
    name     = "rg-connectivity-japaneast"
    location = "japaneast"
    settings = { enabled = true }
  }
  # "management"ã¯é™¤å¤–ã•ã‚Œã‚‹
}
```

---

### ğŸ›¡ï¸2-3: try()é–¢æ•°ã®å½¹å‰²

```hcl
if try(value.settings.enabled, true)
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

`value.settings.enabled`ãŒå­˜åœ¨ã—ãªã„å ´åˆã€`true`ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ã†ã€‚

**å‹•ä½œï¼š**

```hcl title="ãƒ‘ã‚¿ãƒ¼ãƒ³1: enabledãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹"
{
  settings = { enabled = false }
}
â†’ falseï¼ˆæ˜ç¤ºçš„ã«ç„¡åŠ¹ï¼‰
```

```hcl title="ãƒ‘ã‚¿ãƒ¼ãƒ³2: enabledãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„"
{
  # settingsãŒãªã„
}
â†’ trueï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ï¼‰
```

---

### ğŸ·ï¸2-4: ã‚¿ã‚°ã®å„ªå…ˆé †ä½

```hcl
tags = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å›ºæœ‰ã®ã‚¿ã‚°ãŒãªã‘ã‚Œã°ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ã‚°ã‚’ä½¿ã†ã€‚

**å„ªå…ˆé †ä½ï¼š**

1. `each.value.tags`: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å›ºæœ‰ã®ã‚¿ã‚°
2. `module.config.outputs.tags`: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ã‚°

### â˜ï¸2-5: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŒ‡å®š

---

```hcl
providers = {
  azurerm = azurerm.connectivity
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

`connectivity`ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã€‚

---

## ğŸ—ï¸Part 3: å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨æ§‹é€ 

### ğŸ§©3-1: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“åƒ

**GitHubãƒªãƒã‚¸ãƒˆãƒªï¼š**

https://github.com/Azure/terraform-azurerm-avm-res-resources-resourcegroup


ã“ã“ã‹ã‚‰ã¯å…¬å¼ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ããªãŒã‚‰è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã“ã‚“ãªæ„Ÿã˜â†“
![ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸¦ã¹ã¦è¦‹ã‚‹](img/ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ2.png)

**ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼š**

```text
terraform-azurerm-avm-res-resources-resourcegroup/
â”œâ”€â”€ main.tf                   # ãƒªã‚½ãƒ¼ã‚¹å®šç¾©
â”œâ”€â”€ variables.tf              # å…¥åŠ›å¤‰æ•°
â”œâ”€â”€ outputs.tf                # å‡ºåŠ›
â”œâ”€â”€ terraform.tf              # ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¦ä»¶
â”œâ”€â”€ locals.tf                 # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°
â”œâ”€â”€ main.telemetry.tf         # ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼
â””â”€â”€ data.tf                   # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
```

---

### ğŸ—ï¸3-2: main.tf - ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®ä¸­æ ¸

```hcl title="main.tfï¼ˆå®Œå…¨ç‰ˆï¼‰"
resource "azurerm_resource_group" "this" {
  location = var.location
  name     = var.name
  tags     = var.tags
}

# Resource Lockï¼ˆå‰Šé™¤é˜²æ­¢ï¼‰
resource "azurerm_management_lock" "this" {
  count = var.lock != null ? 1 : 0

  lock_level = var.lock.kind
  name       = coalesce(var.lock.name, "lock-${var.lock.kind}")
  scope      = azurerm_resource_group.this.id
  notes      = var.lock.kind == "CanNotDelete" ? "Cannot delete the resource or its child resources." : "Cannot delete or modify the resource or its child resources."
}

# Role Assignmentï¼ˆRBACæ¨©é™ï¼‰
resource "azurerm_role_assignment" "this" {
  for_each = var.role_assignments

  principal_id                           = each.value.principal_id
  scope                                  = azurerm_resource_group.this.id
  condition                              = each.value.condition
  condition_version                      = each.value.condition_version
  delegated_managed_identity_resource_id = each.value.delegated_managed_identity_resource_id
  role_definition_id                     = strcontains(lower(each.value.role_definition_id_or_name), lower(local.role_definition_resource_substring)) ? "/subscriptions/${data.azurerm_subscription.current.subscription_id}${each.value.role_definition_id_or_name}" : null
  role_definition_name                   = strcontains(lower(each.value.role_definition_id_or_name), lower(local.role_definition_resource_substring)) ? null : each.value.role_definition_id_or_name
  skip_service_principal_aad_check       = each.value.skip_service_principal_aad_check
}
```

**ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼š**

| ãƒªã‚½ãƒ¼ã‚¹ | å¿…é ˆ | ç”¨é€” |
|---------|------|------|
| `azurerm_resource_group` | âœ… å¿…é ˆ | ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—æœ¬ä½“ |
| `azurerm_management_lock` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | å‰Šé™¤é˜²æ­¢ãƒ­ãƒƒã‚¯ |
| `azurerm_role_assignment` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | RBACæ¨©é™è¨­å®š |

---

### ğŸ“3-3: variables.tf - å…¥åŠ›å¤‰æ•°å®šç¾©

```hcl title="variables.tfï¼ˆä¸»è¦éƒ¨åˆ†ï¼‰"
variable "location" {
  type        = string
  description = "Required. The Azure region for deployment of the this resource."
  nullable    = false
}

variable "name" {
  type        = string
  description = "Required. The name of the this resource."

  validation {
    condition     = can(regex("^[a-zA-Z0-9_().-]{1,89}[a-zA-Z0-9_()-]$", var.name))
    error_message = <<ERROR_MESSAGE
    The resource group name must meet the following requirements:
    - `Between 1 and 90 characters long.` 
    - `Can only contain Alphanumerics, underscores, parentheses, hyphens, periods.`
    - `Cannot end in a period`
    ERROR_MESSAGE
  }
}

variable "enable_telemetry" {
  type        = bool
  default     = true
  description = <<DESCRIPTION
This variable controls whether or not telemetry is enabled for the module.
For more information see <https://aka.ms/avm/telemetryinfo>.
If it is set to false, then no telemetry will be collected.
DESCRIPTION
  nullable    = false
}

variable "lock" {
  type = object({
    kind = string
    name = optional(string, null)
  })
  default     = null
  description = <<DESCRIPTION
  Controls the Resource Lock configuration for this resource. The following properties can be specified:
  
  - `kind` - (Required) The type of lock. Possible values are `\"CanNotDelete\"` and `\"ReadOnly\"`.
  - `name` - (Optional) The name of the lock. If not specified, a name will be generated based on the `kind` value. Changing this forces the creation of a new resource.
  DESCRIPTION

  validation {
    condition     = var.lock != null ? contains(["CanNotDelete", "ReadOnly"], var.lock.kind) : true
    error_message = "Lock kind must be either `\"CanNotDelete\"` or `\"ReadOnly\"`."
  }
}

variable "role_assignments" {
  type = map(object({
    role_definition_id_or_name             = string
    principal_id                           = string
    description                            = optional(string, null)
    skip_service_principal_aad_check       = optional(bool, false)
    condition                              = optional(string, null)
    condition_version                      = optional(string, null)
    delegated_managed_identity_resource_id = optional(string, null)
    principal_type                         = optional(string, null)
  }))
  default     = {}
  description = <<DESCRIPTION
Optional. A map of role assignments to create on this resource. The map key is deliberately arbitrary to avoid issues where map keys maybe unknown at plan time.

- `role_definition_id_or_name` - (Required) The ID or name of the role definition to assign to the principal.
- `principal_id` - (Required) The ID of the principal to assign the role to.
- `description` - (Optional) The description of the role assignment.
- `skip_service_principal_aad_check` - (Optional) If set to true, skips the Azure Active Directory check for the service principal in the tenant. Defaults to false.
- `condition` - (Optional) The condition which will be used to scope the role assignment.
- `condition_version` - (Optional) The version of the condition syntax. Valid values are '2.0'.
- `delegated_managed_identity_resource_id` - (Optional) The delegated Azure Resource Id which contains a Managed Identity. Changing this forces a new resource to be created. NOTE:
this field is only used in cross tenant scenario.
DESCRIPTION
  nullable    = false

  validation {
    condition = alltrue(
      [for role in var.role_assignments :
        can(regex("^/providers/Microsoft\\.Authorization/roleDefinitions/[0-9a-fA-F-]+$", role.role_definition_id_or_name))
        ||
        can(regex("^[[:alpha:]]+?", role.role_definition_id_or_name))
      ]
    )
    error_message = <<ERROR_MESSAGE
        role_definition_id_or_name must have the following format: 
         - Using the role definition Id : `/providers/Microsoft.Authorization/roleDefinitions/<role_guid>`
         - Using the role name: Reader | "Storage Blob Data Reader"
      ERROR_MESSAGE
  }
}

variable "tags" {
  type        = map(string)
  default     = null
  description = "(Optional) Tags of the resource."
}
```

**å¤‰æ•°ã®ç¨®é¡ï¼š**

| å¤‰æ•° | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç”¨é€” |
|------|------|-----------|------|
| `location` | âœ… å¿…é ˆ | ãªã— | Azureãƒªãƒ¼ã‚¸ãƒ§ãƒ³ |
| `name` | âœ… å¿…é ˆ | ãªã— | ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å |
| `enable_telemetry` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | `true` | ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼æœ‰åŠ¹åŒ– |
| `lock` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | `null` | å‰Šé™¤é˜²æ­¢ãƒ­ãƒƒã‚¯ |
| `role_assignments` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | `{}` | RBACæ¨©é™ |
| `tags` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | `null` | ã‚¿ã‚° |

---

### ğŸ“¤3-4: outputs.tf - å‡ºåŠ›å®šç¾©

```hcl title="outputs.tf"
output "name" {
  description = "The name of the resource group"
  value       = azurerm_resource_group.this.name
}

output "resource" {
  description = "This is the full output for the resource group."
  value       = azurerm_resource_group.this
}

output "resource_id" {
  description = "The resource Id of the resource group"
  value       = azurerm_resource_group.this.id
}
```

**å‡ºåŠ›ã•ã‚Œã‚‹æƒ…å ±ï¼š**

| å‡ºåŠ› | å†…å®¹ | ç”¨é€” |
|------|------|------|
| `name` | ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å | ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å‚ç…§ |
| `resource` | ãƒªã‚½ãƒ¼ã‚¹å…¨ä½“ | ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ |
| `resource_id` | ãƒªã‚½ãƒ¼ã‚¹ID | ä¾å­˜é–¢ä¿‚ã®æŒ‡å®š |

---

### â˜ï¸3-5: terraform.tf - ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¦ä»¶

```hcl title="terraform.tf"
terraform {
  required_version = ">= 1.9, < 2.0"

  required_providers {
    azapi = {
      source  = "Azure/azapi"
      version = "~> 2.4"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = ">= 3.71, < 5.0.0"
    }
    modtm = {
      source  = "azure/modtm"
      version = "~> 0.3"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
  }
}
```

**å¿…è¦ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼š**

| ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------------|-----------|------|
| `azurerm` | >= 3.71, < 5.0.0 | Azureç®¡ç† |
| `azapi` | ~> 2.4 | ARM APIç›´æ¥æ“ä½œ |
| `modtm` | ~> 0.3 | ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ |
| `random` | ~> 3.5 | ãƒ©ãƒ³ãƒ€ãƒ å€¤ç”Ÿæˆ |

---

### ğŸ§®3-6: locals.tf - ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°

```hcl title="locals.tf"
locals {
  role_definition_resource_substring = "/providers/Microsoft.Authorization/roleDefinitions"
}
```

**å½¹å‰²ï¼š**

Role Definition IDã®åˆ¤å®šã«ä½¿ç”¨ã€‚

---

### ğŸ”3-7: data.tf - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

```hcl title="data.tf"
data "azurerm_subscription" "current" {}
```

**å½¹å‰²ï¼š**

ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã€‚

---

### ğŸ“¡3-8: main.telemetry.tf - ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼

```hcl title="main.telemetry.tfï¼ˆæŠœç²‹ï¼‰"
data "modtm_module_source" "telemetry" {
  count = var.enable_telemetry ? 1 : 0

  module_path = path.module
}

resource "random_uuid" "telemetry" {
  count = var.enable_telemetry ? 1 : 0
}

resource "modtm_telemetry" "telemetry" {
  count = var.enable_telemetry ? 1 : 0

  tags = merge({
    subscription_id = one(data.azapi_client_config.telemetry).subscription_id
    tenant_id       = one(data.azapi_client_config.telemetry).tenant_id
    module_source   = one(data.modtm_module_source.telemetry).module_source
    module_version  = one(data.modtm_module_source.telemetry).module_version
    random_id       = one(random_uuid.telemetry).result
  }, { location = local.main_location })
}
```

**å½¹å‰²ï¼š**

Microsoftã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ç”¨çŠ¶æ³ã‚’é€ä¿¡ï¼ˆåŒ¿ååŒ–ï¼‰ã€‚

---

## ğŸš€Part 4: å‹•ä½œã®å®Œå…¨ãªæµã‚Œ

### 1ï¸âƒ£ã‚¹ãƒ†ãƒƒãƒ—1: è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å–å¾—

```hcl title="module.config.outputs.connectivity_resource_groups"
{
  "connectivity" = {
    name     = "rg-connectivity-japaneast"
    location = "japaneast"
    tags = {
      environment = "production"
      purpose     = "connectivity"
    }
    settings = {
      enabled = true
    }
  }
}
```

---

### 2ï¸âƒ£ã‚¹ãƒ†ãƒƒãƒ—2: for_eachã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

```hcl title="ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†"
for_each = {
  for key, value in module.config.outputs.connectivity_resource_groups : 
    key => value 
    if try(value.settings.enabled, true)
}
```

**çµæœï¼š**

```hcl
{
  "connectivity" = {
    name     = "rg-connectivity-japaneast"
    location = "japaneast"
    tags = { ... }
    settings = { enabled = true }
  }
}
```

---

### 3ï¸âƒ£ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—

```hcl title="å®Ÿéš›ã®å‘¼ã³å‡ºã—"
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  # connectivityç”¨
  name             = "rg-connectivity-japaneast"
  location         = "japaneast"
  enable_telemetry = true
  tags = {
    environment = "production"
    purpose     = "connectivity"
  }

  providers = {
    azurerm = azurerm.connectivity
  }
}
```

---

### 4ï¸âƒ£ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…éƒ¨ã§å®Ÿè¡Œ

```hcl title="main.tfå†…ã§å®Ÿè¡Œ"
resource "azurerm_resource_group" "this" {
  location = "japaneast"
  name     = "rg-connectivity-japaneast"
  tags = {
    environment = "production"
    purpose     = "connectivity"
  }
}
```

---

### 5ï¸âƒ£ã‚¹ãƒ†ãƒƒãƒ—5: ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

```bash
# Terraformå®Ÿè¡Œ
terraform apply
```

**ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼š**

```text
+ azurerm_resource_group.connectivity
  name     = "rg-connectivity-japaneast"
  location = "japaneast"
```

---

## ğŸ› ï¸Part 5: å®Ÿè·µ - æ–°ã—ã„ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®è¿½åŠ ã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ğŸ“ãƒ‘ã‚¿ãƒ¼ãƒ³1: åŸºæœ¬çš„ãªãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ 

**è¦ä»¶ï¼š**ğŸ“

- åå‰: `rg-security-japaneast`
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: `japaneast`
- ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°: è¿½åŠ 

#### æ‰‹é †1: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ğŸ› ï¸

```hcl title="platform-landing-zone.auto.tfvars"
connectivity_resource_groups = {
  connectivity = {
    name     = "rg-connectivity-$${starter_location_01}"
    location = "$${starter_location_01}"
  }
  
  security = {  # æ–°è¦è¿½åŠ 
    name     = "rg-security-$${starter_location_01}"
    location = "$${starter_location_01}"
    tags = {
      purpose = "security"
    }
  }
}
```

#### æ‰‹é †2: Terraformå®Ÿè¡ŒğŸš€

```bash
terraform plan
```

**å‡ºåŠ›ï¼š**

```text
+ module.resource_groups["security"]
  + azurerm_resource_group.this
    name     = "rg-security-japaneast"
    location = "japaneast"
```

```bash
terraform apply
```

#### æ‰‹é †3: ç¢ºèªğŸ”

```bash
az group show --name rg-security-japaneast
```

**å‡ºåŠ›ï¼š**

```json
{
  "id": "/subscriptions/.../resourceGroups/rg-security-japaneast",
  "location": "japaneast",
  "name": "rg-security-japaneast",
  "tags": {
    "purpose": "security"
  }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: å‰Šé™¤é˜²æ­¢ãƒ­ãƒƒã‚¯ä»˜ããƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ğŸ”’

**è¦ä»¶ï¼š**ğŸ“

- åå‰: `rg-production-japaneast`
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: `japaneast`
- å‰Šé™¤é˜²æ­¢ãƒ­ãƒƒã‚¯: æœ‰åŠ¹

!!! warning "main.resource.groups.tf ã®ä¿®æ­£ãŒå¿…è¦"
    ç¾åœ¨ã®`main.resource.groups.tf`ã§ã¯`lock`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã„ã¾ã›ã‚“ã€‚
    
    ä»¥ä¸‹ã®æ‰‹é †ã§main.resource.groups.tfã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

#### æ‰‹é †1: main.resource.groups.tfã‚’ä¿®æ­£ğŸ› ï¸

```hcl title="main.resource.groups.tfï¼ˆä¿®æ­£å‰ï¼‰"
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }

  name             = each.value.name
  location         = each.value.location
  enable_telemetry = var.enable_telemetry
  tags             = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags

  providers = {
    azurerm = azurerm.connectivity
  }
}
```

**ä¿®æ­£å¾Œï¼š**

```hcl title="main.resource.groups.tfï¼ˆä¿®æ­£å¾Œï¼‰"
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }

  name             = each.value.name
  location         = each.value.location
  enable_telemetry = var.enable_telemetry
  tags             = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags
  
  # ãƒ­ãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
  lock = try(each.value.lock, null)

  providers = {
    azurerm = azurerm.connectivity
  }
}
```

#### æ‰‹é †2: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ğŸ”’

```hcl title="platform-landing-zone.auto.tfvars"
connectivity_resource_groups = {
  production = {
    name     = "rg-production-$${starter_location_01}"
    location = "$${starter_location_01}"
    lock = {
      kind = "CanNotDelete"
      name = "production-lock"
    }
  }
}
```

#### æ‰‹é †3: Terraformå®Ÿè¡ŒğŸš€

```bash
terraform plan
```

**å‡ºåŠ›ï¼š**

```text
+ module.resource_groups["production"]
  + azurerm_resource_group.this
    name     = "rg-production-japaneast"
    location = "japaneast"
  
  + azurerm_management_lock.this[0]
    lock_level = "CanNotDelete"
    name       = "production-lock"
```

```bash
terraform apply
```

#### æ‰‹é †4: ãƒ­ãƒƒã‚¯ã®ç¢ºèªğŸ”

```bash
az lock list --resource-group rg-production-japaneast
```

**å‡ºåŠ›ï¼š**

```json
[
  {
    "id": "/subscriptions/.../resourceGroups/rg-production-japaneast/providers/Microsoft.Authorization/locks/production-lock",
    "level": "CanNotDelete",
    "name": "production-lock",
    "notes": "Cannot delete the resource or its child resources."
  }
]
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: RBACæ¨©é™ä»˜ããƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ğŸ›¡ï¸

**è¦ä»¶ï¼š**ğŸ“

- åå‰: `rg-app-japaneast`
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: `japaneast`
- é–‹ç™ºè€…ã«Contributoræ¨©é™
- é–²è¦§è€…ã«Readeræ¨©é™

!!! warning "main.resource.groups.tf ã®ä¿®æ­£ãŒå¿…è¦"
    `role_assignments`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚ç¾åœ¨ã¯æ¸¡ã—ã¦ã„ã¾ã›ã‚“ã€‚

#### æ‰‹é †1: main.resource.groups.tfã‚’ä¿®æ­£ğŸ› ï¸

```hcl title="main.resource.groups.tfï¼ˆä¿®æ­£å¾Œï¼‰"
module "resource_groups" {
  source  = "Azure/avm-res-resources-resourcegroup/azurerm"
  version = "0.2.1"

  for_each = { for key, value in module.config.outputs.connectivity_resource_groups : key => value if try(value.settings.enabled, true) }

  name             = each.value.name
  location         = each.value.location
  enable_telemetry = var.enable_telemetry
  tags             = try(each.value.tags, null) == null ? module.config.outputs.tags : each.value.tags
  
  # ãƒ­ãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
  lock = try(each.value.lock, null)
  
  # RBACæ¨©é™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
  role_assignments = try(each.value.role_assignments, {})

  providers = {
    azurerm = azurerm.connectivity
  }
}
```

#### æ‰‹é †2: Principal IDã‚’å–å¾—ğŸ†”

é–‹ç™ºè€…ã¨é–²è¦§è€…ã®Principal IDã‚’å–å¾—ã—ã¾ã™ã€‚

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Principal IDå–å¾—
az ad user show --id developer@example.com --query id -o tsv

# ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®Principal IDå–å¾—
az ad sp show --id <app-id> --query id -o tsv
```

#### æ‰‹é †3: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ¨©é™ã‚’è¿½åŠ ğŸ”‘

```hcl title="platform-landing-zone.auto.tfvars"
connectivity_resource_groups = {
  app = {
    name     = "rg-app-$${starter_location_01}"
    location = "$${starter_location_01}"
    role_assignments = {
      developer = {
        role_definition_id_or_name = "Contributor"
        principal_id               = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
        description                = "é–‹ç™ºè€…æ¨©é™"
      }
      reader = {
        role_definition_id_or_name = "Reader"
        principal_id               = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"
        description                = "é–²è¦§è€…æ¨©é™"
      }
    }
  }
}
```

#### æ‰‹é †4: Terraformå®Ÿè¡ŒğŸš€

```bash
terraform plan
```

**å‡ºåŠ›ï¼š**

```text
+ module.resource_groups["app"]
  + azurerm_resource_group.this
    name     = "rg-app-japaneast"
    location = "japaneast"
  
  + azurerm_role_assignment.this["developer"]
    principal_id         = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    role_definition_name = "Contributor"
    scope                = "/subscriptions/.../resourceGroups/rg-app-japaneast"
  
  + azurerm_role_assignment.this["reader"]
    principal_id         = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"
    role_definition_name = "Reader"
    scope                = "/subscriptions/.../resourceGroups/rg-app-japaneast"
```

```bash
terraform apply
```

#### æ‰‹é †5: æ¨©é™ã®ç¢ºèªğŸ”

```bash
az role assignment list --resource-group rg-app-japaneast --output table
```

**å‡ºåŠ›ï¼š**

```text
PrincipalName          Role         Scope
---------------------  -----------  ---------------------------------------
developer@example.com  Contributor  /subscriptions/.../rg-app-japaneast
viewer@example.com     Reader       /subscriptions/.../rg-app-japaneast
```

---

## ã¾ã¨ã‚ğŸ“

**ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆã®å½¹å‰²**ï¼šğŸ“¦

1. **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ç”¨**: Azure Verified Modulesã§å®‰å…¨ãƒ»ç¢ºå®Ÿ
2. **for_eachãƒ«ãƒ¼ãƒ—**: è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åŠ¹ç‡çš„ã«ä½œæˆ
3. **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: `enabled`ãƒ•ãƒ©ã‚°ã§æŸ”è»Ÿã«åˆ¶å¾¡

**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ **ï¼šğŸ§©

- **main.resource.groups.tf**: ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§for_eachãƒ«ãƒ¼ãƒ—
- **main.tf**: å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—
- **variables.tf**: å…¥åŠ›å¤‰æ•°å®šç¾©
- **outputs.tf**: ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å‡ºåŠ›
- **terraform.tf**: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¦ä»¶å®šç¾©
- **main.telemetry.tf**: ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**ï¼šğŸŒŸ

- for_eachã§è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä¸€æ‹¬ä½œæˆ
- enabled = trueã®ã‚‚ã®ã ã‘ä½œæˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
- å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å†…éƒ¨ã§azurerm_resource_groupã‚’å‘¼ã³å‡ºã™
- locationã€tagsãªã©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŸ”è»Ÿã«è¨­å®š
- ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã§ä½¿ç”¨çŠ¶æ³ã‚’è¿½è·¡ï¼ˆopt-outå¯èƒ½ï¼‰


---

## ç·´ç¿’å•é¡ŒğŸ’¡

ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚ğŸ“

### å•é¡Œ1â“
ä»¥ä¸‹ã®for_eachå¼ã¯ã€ã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ

```hcl
resource_groups = {
  connectivity = { enabled = true,  location = "japaneast" }
  management   = { enabled = true,  location = "japaneast" }
  identity     = { enabled = false, location = "japaneast" }
}

for_each = { for k, v in var.resource_groups : k => v if v.enabled }
```

### å•é¡Œ2â“
Azure Verified Modulesã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚

### å•é¡Œ3â“
ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®`lock`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¨­å®šã§ãã‚‹2ã¤ã®ãƒ­ãƒƒã‚¯ãƒ¬ãƒ™ãƒ«ã¯ä½•ã§ã™ã‹ï¼Ÿ

### å•é¡Œ4â“
ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã«ã¯ã€ã©ã®å¤‰æ•°ã‚’`false`ã«è¨­å®šã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ

---

## ç·´ç¿’å•é¡Œã®ç­”ãˆğŸ“

### ç­”ãˆ1âœ…

ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¯**2ã¤**ã§ã™ï¼š

- `connectivity`ï¼ˆenabled = trueï¼‰âœ…
- `management`ï¼ˆenabled = trueï¼‰âœ…
- `identity`ï¼ˆenabled = falseï¼‰âŒ ä½œæˆã•ã‚Œãªã„

`if v.enabled`ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šã€`enabled = true`ã®ã‚‚ã®ã ã‘ãŒ`for_each`ã«æ¸¡ã•ã‚Œã¾ã™ã€‚

### ç­”ãˆ2âœ…
Azure Verified Modulesã®ãƒ¡ãƒªãƒƒãƒˆï¼š

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨å“è³ªä¿è¨¼**ï¼šMicrosoftãŒå…¬å¼ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ¤œè¨¼æ¸ˆã¿
2. **ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹å®Ÿè£…**ï¼šAzureã®æ¨å¥¨è¨­å®šãŒè‡ªå‹•é©ç”¨ã•ã‚Œã‚‹
3. **ç¶™ç¶šçš„ãªæ›´æ–°**ï¼šAzure APIã®å¤‰æ›´ã«è‡ªå‹•è¿½å¾“
4. **ãƒ†ã‚¹ãƒˆæ¸ˆã¿**ï¼šæœ¬ç•ªç’°å¢ƒã§ä½¿ãˆã‚‹ä¿¡é ¼æ€§

### ç­”ãˆ3âœ…
ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ­ãƒƒã‚¯ãƒ¬ãƒ™ãƒ«ã¯2ç¨®é¡ï¼š

**1. CanNotDeleteï¼ˆå‰Šé™¤é˜²æ­¢ï¼‰**ï¼š
- èª­ã¿å–ã‚Šãƒ»å¤‰æ›´ï¼šâœ… å¯èƒ½
- å‰Šé™¤ï¼šâŒ ä¸å¯èƒ½

**2. ReadOnlyï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰**ï¼š
- èª­ã¿å–ã‚Šï¼šâœ… å¯èƒ½
- å¤‰æ›´ãƒ»å‰Šé™¤ï¼šâŒ ä¸å¯èƒ½

æœ¬ç•ªç’°å¢ƒã§ã¯`CanNotDelete`ã‚’æ¨å¥¨ï¼ˆå¤‰æ›´ã¯ã§ãã‚‹ã‘ã©èª¤å‰Šé™¤ã¯é˜²ãï¼‰ã€‚

### ç­”ãˆ4âœ…
ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã«ã¯ï¼š

```hcl
enable_telemetry = false
```

ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`true`ã§ã€Microsoftã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ç”¨çŠ¶æ³ãŒé€ä¿¡ã•ã‚Œã¾ã™ï¼ˆå€‹äººæƒ…å ±ã¯å«ã¾ã‚Œãªã„ï¼‰ã€‚

---

æ¬¡ã®Chapterã§ã¯ã€ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼ã®æ§‹ç¯‰ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ALZã®å¿ƒè‡“éƒ¨ã§ã€ä¸€ç•ªè¤‡é›‘ã ã‘ã©è¶…é‡è¦ãªã¨ã“ã‚ã ã‚ˆã€‚ğŸ’“

---

**æ‰€è¦æ™‚é–“**: 40åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜†â˜†  
**å‰**: [09_è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.md](./09_è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.md)  
**æ¬¡**: [11_ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼.md](./11_ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼.md)
