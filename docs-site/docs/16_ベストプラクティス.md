# 16. ベストプラクティス - 運用で気をつけること

## このChapterでやること

Azure Landing Zonesを運用する上でのベストプラクティスをまとめるよ。

**運用で重要なこと**：

- セキュリティ
- コスト管理
- 安定運用
- チーム協業
- ドキュメント

**このChapterは**：
```
失敗から学んだ知見
  +
Microsoftの推奨事項
  =
実践的なベストプラクティス
```

---

## 1. セキュリティ

### 1-1. 最小権限の原則

**やること**：
```
必要最小限の権限だけ付与
```

**NG例**：
```
全員にOwner権限
  ↓
誤操作で全削除のリスク
```

**OK例**：
```
開発者：Contributor（読み書き）
閲覧者：Reader（読み取りのみ）
管理者：Owner（全権限）
```

**実装**：
```hcl title="開発者用カスタムロールの定義"
# カスタムロール定義
resource "azurerm_role_definition" "developer" {
  name  = "Landing Zone Developer"
  scope = "/subscriptions/${var.subscription_id}"
  
  permissions {
    actions = [
      "Microsoft.Resources/subscriptions/resourceGroups/read",
      "Microsoft.Resources/deployments/*",
      "Microsoft.Compute/*",
      "Microsoft.Storage/*",
      "Microsoft.Network/*"
    ]
    not_actions = [
      "Microsoft.Network/virtualNetworks/delete",  # VNet削除は禁止
      "Microsoft.Storage/storageAccounts/delete"   # Storage削除は禁止
    ]
  }
}

# 割り当て
resource "azurerm_role_assignment" "developer" {
  scope                = "/providers/Microsoft.Management/managementGroups/${var.root_id}-landing-zones"
  role_definition_name = azurerm_role_definition.developer.name
  principal_id         = var.developer_group_id
}
```

### 1-2. 多要素認証（MFA）必須

**やること**：
```
Azure ADで条件付きアクセス設定
  ↓
Azure Portalアクセス時にMFA必須
```

**確認**：
```
Azure Portal → Azure AD → Security → Conditional Access
  ↓
Require multi-factor authentication for Azure management
```

### 1-3. Secretsの管理

**NG例**：
```
# terraform.tfvars（Git管理下）
admin_password = "MyPassword123!"  # ←危険
```

**OK例**：
```
# Azure Key Vaultに保存
data "azurerm_key_vault_secret" "admin_password" {
  name         = "admin-password"
  key_vault_id = azurerm_key_vault.example.id
}

# 使用
resource "azurerm_virtual_machine" "example" {
  admin_password = data.azurerm_key_vault_secret.admin_password.value
}
```

**GitHub Secrets**：
```
環境変数は全部GitHub Secretsに
  ↓
コードには書かない
```

### 1-4. ネットワーク分離

**やること**：
```
環境ごとにVNet分離
  ↓
本番 ↔︎ 開発は通信できないように
```

**実装**：
```
本番Spoke VNet: 10.1.0.0/16
開発Spoke VNet: 10.10.0.0/16
  ↓
VNet Peeringは作らない
  ↓
または
  ↓
Firewallで制御
```

### 1-5. Private Endpoint使用

**やること**：
```
PaaSサービスはPrivate Endpoint経由
  ↓
Public Endpoint無効化
```

**例（Storage Account）**：
```hcl title="Storage AccountへのPrivate Endpoint設定"
resource "azurerm_storage_account" "example" {
  name                     = "stexample12345"
  resource_group_name      = azurerm_resource_group.example.name
  location                 = "japaneast"
  account_tier             = "Standard"
  account_replication_type = "LRS"
  
  public_network_access_enabled = false  # ←Public無効
}

resource "azurerm_private_endpoint" "example" {
  name                = "pe-storage"
  location            = "japaneast"
  resource_group_name = azurerm_resource_group.example.name
  subnet_id           = azurerm_subnet.example.id
  
  private_service_connection {
    name                           = "psc-storage"
    private_connection_resource_id = azurerm_storage_account.example.id
    subresource_names              = ["blob"]
    is_manual_connection           = false
  }
}
```

### 1-6. 定期的なアクセスレビュー

**やること**：
```
月1回：

- 誰がどんな権限を持ってるか確認
- 不要な権限を削除
- 退職者のアカウント削除
```

**ツール**：
```bash title="ロール割り当ての確認"
# 全ロール割り当て確認
az role assignment list --all --output table

# 特定のManagement Groupのみ
az role assignment list \
  --scope "/providers/Microsoft.Management/managementGroups/${ROOT_ID}" \
  --output table
```

---

## 2. コスト管理

### 2-1. コスト予測

**やること**：
```
デプロイ前に概算見積もり
```

**ツール**：
```
Azure Pricing Calculator:
https://azure.microsoft.com/pricing/calculator/
```

**主な料金**：
```
Firewall Standard: 約17万円/月
VPN Gateway VpnGw1: 約4万円/月
Bastion Basic: 約2.7万円/月
DDoS Protection: 約40万円/月
Log Analytics: データ量による（5GB/月まで無料）
```

### 2-2. タグ戦略

**やること**：
```
全リソースに必須タグ付与
  ↓
コスト分析が楽になる
```

**必須タグ**：
```hcl title="リソース用の必須タグ定義"
tags = {
  CostCenter  = "1000"           # コストセンター
  Environment = "Production"      # 環境
  Owner       = "platform-team"   # 担当者
  Project     = "ALZ"             # プロジェクト
  AutoShutdown = "Yes"            # 自動停止対象か
}
```

**ポリシーで強制**：
```yaml title="タグ必須ポリシーの適用"
# lib/archetype_definitions/corp_custom.alz_archetype_override.yaml
policy_assignments_to_add:
  - Require-Tags
    assignment_parameters:
      tagName: "CostCenter"
      tagValue: ["1000", "2000", "3000"]
```

### 2-3. 開発環境の自動停止

**やること**：
```
開発環境のVMを夜間・休日停止
  ↓
稼働時間を50%削減
  ↓
コスト半分
```

**実装（Azure Automation）**：
```hcl title="開発環境VM自動停止スケジュール"
resource "azurerm_automation_schedule" "stop_vms" {
  name                    = "schedule-stop-vms"
  resource_group_name     = azurerm_resource_group.automation.name
  automation_account_name = azurerm_automation_account.example.name
  frequency               = "Day"
  start_time              = "2026-01-17T20:00:00+09:00"
  timezone                = "Tokyo Standard Time"
}

resource "azurerm_automation_schedule" "start_vms" {
  name                    = "schedule-start-vms"
  resource_group_name     = azurerm_resource_group.automation.name
  automation_account_name = azurerm_automation_account.example.name
  frequency               = "Week"
  start_time              = "2026-01-20T08:00:00+09:00"
  week_days               = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
  timezone                = "Tokyo Standard Time"
}
```

### 2-4. Reserved Instancesの活用

**やること**：
```
長期利用が確定しているリソースは予約します
  ↓
1年予約: 約40%割引
3年予約: 約60%割引
```

**対象リソース**：
```
- Virtual Machines
- SQL Database
- App Service
- Cosmos DB
```

**購入**：
```
Azure Portal → Reservations → Purchase reservation
```

### 2-5. コストアラート設定

**やること**：
```
予算超過したら通知
```

**実装**：
```hcl title="月次予算とアラート設定"
resource "azurerm_consumption_budget_subscription" "example" {
  name            = "budget-monthly"
  subscription_id = "/subscriptions/${var.subscription_id}"
  
  amount     = 500000  # 50万円
  time_grain = "Monthly"
  
  time_period {
    start_date = "2026-01-01T00:00:00Z"
  }
  
  notification {
    enabled   = true
    threshold = 80  # 80%で通知
    operator  = "GreaterThan"
    
    contact_emails = [
      "platform-team@example.com"
    ]
  }
  
  notification {
    enabled   = true
    threshold = 100  # 100%で通知
    operator  = "GreaterThan"
    
    contact_emails = [
      "cfo@example.com"
    ]
  }
}
```

### 2-6. 不要リソースの削除

**定期的にチェック**：
```bash title="未使用リソースの確認"
# 過去30日間使われてないVM
az vm list --query "[?powerState=='VM deallocated']" --output table

# 孤立したDisk（VMにアタッチされてない）
az disk list --query "[?diskState=='Unattached']" --output table

# 孤立したPublic IP
az network public-ip list --query "[?ipConfiguration==null]" --output table
```

---

## 3. Infrastructure as Code

### 3-1. 全部コード化

**ルール**：
```
Azure Portalで手作業しない
  ↓
全部Terraformで定義
  ↓
Infrastructure as Code
```

**メリット**：
```
- 再現可能
- バージョン管理
- レビュー可能
- 自動化
```

### 3-2. State管理

**やること**：
```
Stateファイルは必ずリモートBackend
  ↓
ローカルに置かない
```

**理由**：
```
ローカル：

- PC壊れたら終わり
- チームで共有できない
- 同時実行できない

リモート（Azure Storage）：

- 安全
- 共有できる
- Lock機能で同時実行防止
```

### 3-3. モジュール化

**やること**：
```
共通処理はモジュール化
  ↓
再利用
```

**例**：
```
modules/
├── spoke-vnet/
│   ├── main.tf
│   ├── variables.tf
│   └── outputs.tf
├── app-service/
│   ├── main.tf
│   ├── variables.tf
│   └── outputs.tf
└── sql-database/
    ├── main.tf
    ├── variables.tf
    └── outputs.tf
```

**使用**：
```hcl title="モジュールの再利用"
module "spoke_production" {
  source = "./modules/spoke-vnet"
  
  name                = "vnet-prd-spoke"
  location            = "japaneast"
  address_space       = ["10.1.0.0/16"]
  hub_vnet_id         = module.hub.vnet_id
}

module "spoke_development" {
  source = "./modules/spoke-vnet"
  
  name                = "vnet-dev-spoke"
  location            = "japaneast"
  address_space       = ["10.10.0.0/16"]
  hub_vnet_id         = module.hub.vnet_id
}
```

### 3-4. 変数の検証

**やること**：
```
変数にvalidationを追加
  ↓
間違った値を事前に防ぐ
```

**例**：
```hcl title="変数のバリデーション設定"
variable "environment" {
  type        = string
  description = "Environment name"
  
  validation {
    condition     = contains(["prd", "stg", "dev"], var.environment)
    error_message = "Environment must be prd, stg, or dev."
  }
}

variable "location" {
  type        = string
  description = "Azure region"
  
  validation {
    condition     = contains(["japaneast", "japanwest"], var.location)
    error_message = "Location must be japaneast or japanwest."
  }
}

variable "vm_size" {
  type        = string
  description = "VM size"
  
  validation {
    condition = can(regex("^Standard_[BDE][0-9]+[a-z]*s_v[0-9]+$", var.vm_size))
    error_message = "VM size must be a valid Azure VM SKU."
  }
}
```

### 3-5. Outputの活用

**やること**：
```
他のモジュールで使う値はoutput
```

**例**：
```hcl title="モジュールのOutput定義"
# modules/hub-vnet/outputs.tf
output "vnet_id" {
  value       = azurerm_virtual_network.hub.id
  description = "Hub VNet ID"
}

output "firewall_private_ip" {
  value       = azurerm_firewall.hub.ip_configuration[0].private_ip_address
  description = "Firewall private IP address"
}

# 使う側
module "hub" {
  source = "./modules/hub-vnet"
  ...
}

resource "azurerm_route" "to_internet" {
  name                   = "route-to-internet"
  resource_group_name    = azurerm_resource_group.example.name
  route_table_name       = azurerm_route_table.example.name
  address_prefix         = "0.0.0.0/0"
  next_hop_type          = "VirtualAppliance"
  next_hop_in_ip_address = module.hub.firewall_private_ip  # ←output使用
}
```

---

## 4. チーム協業

### 4-1. ブランチ戦略

**推奨**：GitHub Flow

```
main（本番）
  ↑
  │ PR・レビュー・マージ
  │
feature/* ブランチ（開発）
```

**手順**：
```
1. mainからfeatureブランチ作成
2. コード変更
3. PR作成
4. CI実行（terraform plan）
5. レビュー
6. 承認
7. mainにマージ
8. CD実行（terraform apply）
```

### 4-2. PR（Pull Request）ルール

**必須項目**：
```
✓ terraform planの結果を確認
✓ 最低1人の承認
✓ CI通過
✓ コンフリクト解決済み
```

**Branch Protection設定**：
```
GitHub → Settings → Branches → Add rule
  ↓
Branch name pattern: main
  ✓ Require pull request reviews before merging
  ✓ Require status checks to pass before merging
    - CI（terraform plan）
  ✓ Require branches to be up to date before merging
```

### 4-3. コードレビューのポイント

**チェック項目**：
```
□ 命名規則に従ってる？
□ タグが全部付いてる？
□ Security Groupのルールは適切？
□ コストへの影響は？
□ 削除されるリソースはない？
□ ドキュメント更新した？
```

**レビューコメント例**：
```
Good:
「このFirewallルール、ソースを0.0.0.0/0に設定していますが、
特定のIPに絞れない？セキュリティリスクあるかも」

Bad:
「ダメ」
```

### 4-4. ペアプログラミング

**推奨**：
```
重要な変更は2人で作業
  ↓
- 知識共有
- ミス防止
- オンボーディング
```

**特に重要な場面**：
```
- 本番環境への初回デプロイ
- ネットワーク構成の大幅変更
- セキュリティポリシーの変更
```

---

## 5. ドキュメント

### 5-1. READMEは必須

**最低限の内容**：
```markdown
# Azure Landing Zones

## 概要
このリポジトリは...

## 前提条件
- Azure Subscription（Owner権限）
- Terraform v1.12+
- Azure CLI

## デプロイ手順
1. ...
2. ...

## ディレクトリ構成
```
├── lib/                    # カスタムポリシー定義
├── modules/                # カスタムモジュール
├── main.*.tf               # メインコード
└── platform-landing-zone.auto.tfvars  # 設定
```

## 環境
- 本番: `subscription_id_xxx`
- 開発: `subscription_id_yyy`

## 連絡先
- チーム: platform-team@example.com
- Slack: #platform-team
```

### 5-2. Architecture Decision Records（ADR）

**やること**：
```
重要な設計判断を記録
```

**例**：
```markdown
# ADR-001: Hub-and-Spokeを採用

## 状況
ネットワーク構成としてHub-and-SpokeとVirtual WANの選択肢があった。

## 決定
Hub-and-Spokeを採用。

## 理由
- 小規模（VNet 10個以下）
- Virtual WANはコストが高い（月50万円追加）
- 細かい制御が必要

## 結果
- コスト削減
- 柔軟な設定が可能

## 日付
2026-01-15
```

### 5-3. ランブック

**やること**：
```
運用手順書を作成
```

**内容例**：
```markdown
# ランブック

## 新しいSpoke VNetの追加

### 手順
1. ブランチ作成
   ```bash
   git checkout -b feature/add-spoke-xxx
   ```

2. spoke-vnets.tfに追加
   ```hcl
   resource "azurerm_virtual_network" "spoke_xxx" {
     ...
   }
   ```

3. PR作成・レビュー・マージ

4. デプロイ確認
   ```bash
   az network vnet show --name vnet-spoke-xxx
   ```

### 所要時間
約30分

### 注意点
- アドレス空間の重複に注意
- タグを忘れずに
```

### 5-4. トラブルシューティングガイド

**やること**：
```
過去のトラブルと解決策を記録
```

**Chapter 14の内容をベースに作成**。

---

## 6. 監視とアラート

### 6-1. Log Analyticsクエリ

**定期的に確認するクエリ**：

#### 1. Firewallで拒否されたトラフィック
```kql title="Firewall拒否ログの抽出"
AzureDiagnostics
| where Category == "AzureFirewallApplicationRule" or Category == "AzureFirewallNetworkRule"
| where msg_s contains "Deny"
| project TimeGenerated, msg_s
| order by TimeGenerated desc
| take 100
```

#### 2. 異常なログイン試行
```kql title="失敗したログイン試行の集計"
SigninLogs
| where ResultType != "0"  // 失敗
| where TimeGenerated > ago(24h)
| summarize FailedAttempts = count() by UserPrincipalName, IPAddress
| where FailedAttempts > 5
| order by FailedAttempts desc
```

#### 3. リソースの変更履歴
```kql title="リソースの書き込み・削除履歴"
AzureActivity
| where OperationName contains "write" or OperationName contains "delete"
| where TimeGenerated > ago(7d)
| project TimeGenerated, Caller, OperationName, ResourceGroup, Resource
| order by TimeGenerated desc
```

### 6-2. アラートルール

**設定すべきアラート**：

#### 1. Firewall CPU使用率
```hcl title="Firewall健全性監視アラート"
resource "azurerm_monitor_metric_alert" "firewall_cpu" {
  name                = "alert-firewall-cpu-high"
  resource_group_name = azurerm_resource_group.connectivity.name
  scopes              = [azurerm_firewall.hub.id]
  description         = "Firewall CPU usage is high"
  
  criteria {
    metric_namespace = "Microsoft.Network/azureFirewalls"
    metric_name      = "FirewallHealth"
    aggregation      = "Average"
    operator         = "LessThan"
    threshold        = 90
  }
  
  action {
    action_group_id = azurerm_monitor_action_group.platform_team.id
  }
}
```

#### 2. Storage Account容量
```hcl title="Storage容量監視アラート"
resource "azurerm_monitor_metric_alert" "storage_capacity" {
  name                = "alert-storage-capacity-high"
  resource_group_name = azurerm_resource_group.management.name
  scopes              = [azurerm_storage_account.logs.id]
  description         = "Storage account is almost full"
  
  criteria {
    metric_namespace = "Microsoft.Storage/storageAccounts"
    metric_name      = "UsedCapacity"
    aggregation      = "Average"
    operator         = "GreaterThan"
    threshold        = 900000000000  # 900GB
  }
  
  action {
    action_group_id = azurerm_monitor_action_group.platform_team.id
  }
}
```

### 6-3. Action Group

**通知先の設定**：
```hcl title="アラート通知先の設定"
resource "azurerm_monitor_action_group" "platform_team" {
  name                = "ag-platform-team"
  resource_group_name = azurerm_resource_group.management.name
  short_name          = "platform"
  
  email_receiver {
    name          = "platform-team"
    email_address = "platform-team@example.com"
  }
  
  sms_receiver {
    name         = "on-call"
    country_code = "81"
    phone_number = "9012345678"
  }
  
  webhook_receiver {
    name        = "slack"
    service_uri = "https://hooks.slack.com/services/..."
  }
}
```

---

## 7. バックアップと災害対策

### 7-1. Terraform Stateのバックアップ

**やること**：
```
定期的にStateファイルをバックアップ
```

**実装**：
```bash title="Terraform Stateバックアップスクリプト"
#!/bin/bash
# backup-tfstate.sh

DATE=$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="./backups"

mkdir -p $BACKUP_DIR

# State pull
terraform state pull > "$BACKUP_DIR/terraform-state-$DATE.json"

# 古いバックアップを削除（30日以上前）
find $BACKUP_DIR -name "terraform-state-*.json" -mtime +30 -delete

echo "Backup completed: $BACKUP_DIR/terraform-state-$DATE.json"
```

**Cron設定**：
```cron title="毎日自動バックアップ設定"
# 毎日午前2時にバックアップ
0 2 * * * /path/to/backup-tfstate.sh
```

### 7-2. マルチリージョン構成

**推奨**：
```
本番環境は2リージョン
  ↓
Japan East（Primary）
Japan West（Secondary）
```

**データ同期**：
```
Storage Account: GRS（Geo-Redundant Storage）
SQL Database: Geo-Replication
```

### 7-3. 災害復旧計画（DR）

**RTO/RPO定義**：
```
RTO（Recovery Time Objective）：復旧目標時間
- Critical: 4時間以内
- High: 24時間以内
- Medium: 72時間以内

RPO（Recovery Point Objective）：データ損失許容時間
- Critical: 1時間以内
- High: 24時間以内
- Medium: 1週間以内
```

**DR手順書**：
```markdown
# 災害復旧手順

## Japan Eastが停止した場合

1. 状況確認
   - Azure Status確認
   - リソースの状態確認

2. Japan Westへのフェイルオーバー
   - DNS切り替え
   - アプリケーション起動確認
   - データベース接続確認

3. ユーザー通知
   - 障害通知メール送信
   - Status Page更新

4. 復旧後
   - Japan Eastへのフェイルバック
   - データ同期確認
```

---

## 8. 変更管理

### 8-1. 変更ウィンドウ

**ルール**：
```
本番環境の変更は決まった時間帯のみ
```

**推奨時間帯**：
```
平日: 20:00 - 23:00（業務時間外）
週末: 土曜日 10:00 - 18:00

避けるべき：

- 月曜日午前（週初め）
- 金曜日午後（週末前）
- 月末・月初（決算処理）
```

### 8-2. 変更承認プロセス

**手順**：
```
1. 変更申請（Change Request）
   - 変更内容
   - 影響範囲
   - リスク
   - ロールバック手順

2. レビュー
   - セキュリティチーム
   - 運用チーム
   - 関係部署

3. 承認
   - マネージャー承認

4. 実施
   - 変更ウィンドウ内で実施
   - 監視体制

5. 完了報告
   - 結果報告
   - ドキュメント更新
```

### 8-3. ロールバック計画

**必須**：
```
変更前に必ずロールバック手順を用意
```

**例**：
```markdown
## ロールバック手順

### 変更内容
Firewall SKUをStandardからPremiumに変更

### ロールバック手順
1. GitでRevert
   ```bash
   git revert <commit-hash>
   git push
   ```

2. CD実行
   - 自動でterraform apply実行
   - Firewall SKUがStandardに戻る

3. 確認
   ```bash
   az network firewall show --name fw-hub
   ```

### 所要時間
約30分

### 注意点
- Firewallの再作成が発生する
- 30分程度通信断が発生
```

---

## 9. 継続的改善

### 9-1. 定期レビュー

**月次レビュー**：
```
□ コスト分析
  - 予算との比較
  - 不要リソース確認

□ セキュリティ監査
  - アクセス権限レビュー
  - ポリシー遵守確認

□ パフォーマンス分析
  - リソース使用率
  - ボトルネック特定

□ インシデント振り返り
  - 発生したトラブル
  - 改善策
```

### 9-2. バージョンアップ

**定期的に更新**：
```
□ Terraform
□ Azure Provider
□ モジュール
□ ポリシー定義
```

**手順**：
```
1. 変更履歴確認
2. 開発環境でテスト
3. 問題なければ本番適用
```

### 9-3. 技術負債の管理

**放置しない**：
```
「後で直す」は直さない
  ↓
技術負債として管理
  ↓
計画的に解消
```

**GitHub Issues活用**：
```
Label: tech-debt
  ↓
優先度をつける
  ↓
スプリントごとに解消
```

---

## まとめ

**ベストプラクティスの柱**：

### 1. セキュリティ
- 最小権限の原則
- MFA必須
- Private Endpoint使用
- 定期的なレビュー

### 2. コスト管理
- 事前見積もり
- タグ戦略
- 自動停止
- コストアラート

### 3. Infrastructure as Code
- 全部コード化
- Stateはリモート
- モジュール化
- バリデーション

### 4. チーム協業
- ブランチ戦略
- PRルール
- コードレビュー
- ドキュメント

### 5. 監視と運用
- Log Analytics
- アラート設定
- バックアップ
- DR計画

### 6. 継続的改善
- 定期レビュー
- バージョンアップ
- 技術負債管理

**重要なマインドセット**：
```
完璧を目指さない
  ↓
まず動かす
  ↓
継続的に改善
```

次は最後のChapter 17（FAQ）です！
よくある質問をまとめるね。

---

**所要時間**: 60分  
**難易度**: ★★★★☆  
**前**: [15_カスタマイズ.md](./15_カスタマイズ.md)  
**次**: [17_FAQ.md](./17_FAQ.md)
