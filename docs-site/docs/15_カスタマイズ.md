# 15. カスタマイズ - 自分の組織に合わせる

## このChapterでやること

Azure Landing Zonesを自分の組織に合わせてカスタマイズしよう。

**デフォルト構成**：
```
Microsoft推奨のベストプラクティス
  ↓
でも全ての組織に完璧に合うわけじゃない
```

**カスタマイズで**：
```
- Management Group構造を変える
- ポリシーを追加・削除
- 命名規則を変える
- ネットワーク構成を調整
```

**このChapterで学ぶこと**：

- libフォルダの使い方
- Management Group構造のカスタマイズ
- ポリシーのカスタマイズ
- 命名規則のカスタマイズ
- ネットワークのカスタマイズ

---

## Part 1: libフォルダの構造

### ファイル構成

```
lib/
├── alz_library_metadata.json
├── archetype_definitions/
│   ├── connectivity_custom.alz_archetype_override.yaml
│   ├── corp_custom.alz_archetype_override.yaml
│   ├── decommissioned_custom.alz_archetype_override.yaml
│   ├── identity_custom.alz_archetype_override.yaml
│   ├── landing_zones_custom.alz_archetype_override.yaml
│   ├── management_custom.alz_archetype_override.yaml
│   ├── online_custom.alz_archetype_override.yaml
│   ├── platform_custom.alz_archetype_override.yaml
│   ├── root_custom.alz_archetype_override.yaml
│   ├── sandbox_custom.alz_archetype_override.yaml
│   └── security_custom.alz_archetype_override.yaml
└── architecture_definitions/
    └── alz_custom.alz_architecture_definition.yaml
```

### 各ファイルの役割

#### architecture_definitions（構造定義）

**alz_custom.alz_architecture_definition.yaml**：
```
Management Groupの階層構造を定義
```

**内容**：
```yaml
name: alz_custom
management_groups:
  - id: alz
    display_name: Azure Landing Zones
    archetypes:
      - root_custom
    parent_id: null
  
  - id: platform
    display_name: Platform
    parent_id: alz
  
  - id: landingzones
    display_name: Landing Zones
    parent_id: alz
  
  ...
```

#### archetype_definitions（ポリシー定義）

**root_custom.alz_archetype_override.yaml**：
```
各Management Groupに適用するポリシーを定義
```

**内容**：
```yaml
base_archetype: root
name: root_custom
policy_assignments_to_add: []      # 追加するポリシー
policy_assignments_to_remove: []   # 削除するポリシー
policy_definitions_to_add: []      # カスタムポリシー定義
policy_set_definitions_to_add: []  # カスタムポリシーセット
```

---

## Part 2: Management Group構造のカスタマイズ

### ケース1: Management Groupを追加

**例**：「Development」Management Groupを追加したい

#### Step 1: architecture_definitionsに追加

**lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml**：

```yaml
management_groups:
  # ...既存のManagement Groups...
  
  - id: development
    display_name: Development
    archetypes:
      - development_custom
    exists: false
    parent_id: landingzones  # Landing Zonesの下に配置
```

**階層構造**：
```
alz
├── platform
├── landingzones
│   ├── corp
│   ├── online
│   └── development  # ←新規追加
├── sandbox
└── decommissioned
```

#### Step 2: archetype_definitionsを作成

**lib/archetype_definitions/development_custom.alz_archetype_override.yaml**：

```yaml
base_archetype: landing_zones
name: development_custom

# 開発環境用のポリシーをカスタマイズ
policy_assignments_to_add: []

# 本番環境向けのポリシーを削除（緩める）
policy_assignments_to_remove:
  - Deploy-SQL-TDE          # 暗号化は開発環境では不要
  - Deploy-SQL-minTLS       # TLS最小バージョン強制も緩和
  - Deny-Subnet-Without-Nsg # NSG必須も緩和（テスト用）

policy_definitions_to_add: []
policy_set_definitions_to_add: []
role_definitions_to_add: []
```

#### Step 3: デプロイ

```bash
# Plan確認
terraform plan

# Apply
terraform apply
```

**結果**：
```
Development Management Groupが作成される
  ↓
ポリシーが緩い（開発しやすい）
```

### ケース2: Management Groupを削除

**例**：「Sandbox」は使わない

#### Step 1: architecture_definitionsから削除

**lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml**：

```yaml
management_groups:
  # ...
  
  # Sandboxをコメントアウトまたは削除
  # - id: sandbox
  #   display_name: Sandbox
  #   archetypes:
  #     - sandbox_custom
  #   exists: false
  #   parent_id: alz
```

#### Step 2: デプロイ

```bash
terraform plan
# 「sandbox」Management Groupが削除される

terraform apply
```

**注意**：
```
Management Groupにサブスクリプションがある場合は削除できない
  ↓
先にサブスクリプションを移動
```

### ケース3: 階層構造を変更

**例**：「Security」を「Platform」の下から「Root」の直下に移動

#### Before:
```
alz
└── platform
    └── security  # ←ここ
```

#### After:
```
alz
├── platform
└── security  # ←ここに移動
```

#### 変更:

**lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml**：

```yaml
- id: security
  display_name: Security
  archetypes:
    - security_custom
  exists: false
  parent_id: alz  # platform → alz に変更
```

---

## Part 3: ポリシーのカスタマイズ

### ケース1: 既存ポリシーを削除

**例**：「許可されたリージョン以外拒否」ポリシーを削除

#### 理由:
```
開発環境で色々なリージョンを試したい
  ↓
でもデフォルトではリージョン制限がある
  ↓
削除して自由に使えるようにする
```

#### 手順:

**lib/archetype_definitions/landing_zones_custom.alz_archetype_override.yaml**：

```yaml
base_archetype: landing_zones
name: landing_zones_custom

policy_assignments_to_add: []

policy_assignments_to_remove:
  - Deny-Resources-Locations  # ←リージョン制限ポリシーを削除

policy_definitions_to_add: []
policy_set_definitions_to_add: []
```

### ケース2: カスタムポリシーを追加

**例**：「特定のタグがないリソースを拒否」ポリシー

#### 手順:

**lib/archetype_definitions/corp_custom.alz_archetype_override.yaml**：

```yaml
base_archetype: corp
name: corp_custom

policy_assignments_to_add:
  - Deny-Resources-Without-Required-Tags  # ←追加

policy_definitions_to_add:
  - name: Deny-Resources-Without-Required-Tags
    display_name: "Require specific tags on resources"
    description: "Enforce required tags on all resources"
    mode: "Indexed"
    metadata:
      category: "Tags"
    
    parameters:
      tagName:
        type: "String"
        metadata:
          displayName: "Tag Name"
          description: "Name of the tag, such as 'CostCenter'"
      
      tagValue:
        type: "Array"
        metadata:
          displayName: "Allowed Tag Values"
          description: "List of allowed values for the tag"
    
    policy_rule:
      if:
        anyOf:
          - field: "[concat('tags[', parameters('tagName'), ']')]"
            exists: false
          - field: "[concat('tags[', parameters('tagName'), ']')]"
            notIn: "[parameters('tagValue')]"
      then:
        effect: "deny"

policy_set_definitions_to_add: []
```

#### Assignmentも追加:

同じファイルに追加：

```yaml
policy_assignments_to_add:
  - assignment_name: Deny-Resources-Without-Required-Tags
    assignment_display_name: "Require CostCenter tag"
    assignment_description: "All resources must have a valid CostCenter tag"
    assignment_effect: "deny"
    assignment_parameters:
      tagName: "CostCenter"
      tagValue:
        - "1000"
        - "2000"
        - "3000"
    assignment_enforcement_mode: "Default"
```

### ケース3: ポリシーパラメータを変更

**例**：「許可されたVM SKU」を変更

#### デフォルト:
```
Standard_B2s, Standard_D2s_v3 のみ許可
```

#### 変更後:
```
Standard_B2s, Standard_D2s_v3, Standard_D4s_v3 も許可
```

#### 手順:

**lib/archetype_definitions/corp_custom.alz_archetype_override.yaml**：

```yaml
policy_assignments_to_add:
  - assignment_name: Deny-VM-SKUs
    assignment_parameters:
      listOfAllowedSKUs:
        - "Standard_B2s"
        - "Standard_D2s_v3"
        - "Standard_D4s_v3"  # ←追加
        - "Standard_E4s_v3"  # ←追加
```

---

## Part 4: 命名規則のカスタマイズ

### デフォルトの命名規則

**terraform.tfvars.json**：
```json
{
  "resource_group_name_prefix": "rg",
  "virtual_network_name_prefix": "vnet",
  "subnet_name_prefix": "snet",
  "network_security_group_name_prefix": "nsg"
}
```

**結果**：
```
rg-myorg-management-001
vnet-myorg-jpe-hub
snet-firewall
nsg-web-001
```

### カスタマイズ例

#### 例1: 環境名を先頭に

**望ましい形**：
```
prd-rg-myorg-management-001  # ←本番
dev-rg-myorg-management-001  # ←開発
```

#### locals.tfに追加:

```hcl
locals {
  environment_prefix = var.environment  # "prd" or "dev"
  
  resource_group_name = format(
    "%s-rg-%s-%s-%s",
    local.environment_prefix,
    var.root_id,
    var.resource_type,
    var.default_postfix
  )
}
```

#### 変数追加:

**variables.tf**：
```hcl
variable "environment" {
  type        = string
  description = "Environment name (prd, stg, dev)"
  default     = "prd"
  
  validation {
    condition     = contains(["prd", "stg", "dev"], var.environment)
    error_message = "Environment must be prd, stg, or dev."
  }
}
```

#### terraform.tfvars.jsonに設定:

```json
{
  "environment": "prd"
}
```

### カスタマイズ例2: リージョン名を省略形に

**デフォルト**：
```
vnet-myorg-japaneast-hub  # ←長い
```

**カスタマイズ後**：
```
vnet-myorg-jpe-hub  # ←短い
```

#### locals.tfに追加:

```hcl
locals {
  region_abbreviations = {
    "japaneast"  = "jpe"
    "japanwest"  = "jpw"
    "eastus"     = "eus"
    "westus"     = "wus"
    "westeurope" = "weu"
  }
  
  region_abbr = lookup(
    local.region_abbreviations,
    var.default_location,
    substr(var.default_location, 0, 3)  # フォールバック
  )
  
  hub_vnet_name = format(
    "vnet-%s-%s-hub",
    var.root_id,
    local.region_abbr
  )
}
```

---

## Part 5: ネットワークのカスタマイズ

### ケース1: カスタムサブネットを追加

**例**：Application Gateway用サブネットを追加

#### platform-landing-zone.auto.tfvarsに追加:

```hcl
hub_virtual_networks = {
  primary = {
    hub_virtual_network = {
      name          = "vnet-myorg-jpe-hub"
      address_space = ["10.0.0.0/16"]
      
      subnets = {
        appgw = {
          name             = "snet-appgw"
          address_prefixes = ["10.0.10.0/24"]
        }
      }
    }
  }
}
```

### ケース2: Firewallルールをカスタマイズ

**例**：特定のFQDNへのアクセスを許可

#### 新規ファイル作成: firewall-rules.tf

```hcl
resource "azurerm_firewall_policy_rule_collection_group" "custom" {
  name               = "custom-rules"
  firewall_policy_id = module.hub_and_spoke_vnet[0].firewall_policy["primary"].id
  priority           = 100
  
  application_rule_collection {
    name     = "allow-microsoft-services"
    priority = 100
    action   = "Allow"
    
    rule {
      name = "allow-azure-portal"
      protocols {
        type = "Https"
        port = 443
      }
      source_addresses = ["*"]
      destination_fqdns = [
        "*.azure.com",
        "*.microsoft.com",
        "*.windows.net"
      ]
    }
    
    rule {
      name = "allow-github"
      protocols {
        type = "Https"
        port = 443
      }
      source_addresses = ["*"]
      destination_fqdns = [
        "*.github.com",
        "*.githubusercontent.com"
      ]
    }
  }
  
  network_rule_collection {
    name     = "allow-ntp"
    priority = 200
    action   = "Allow"
    
    rule {
      name                  = "allow-ntp"
      protocols             = ["UDP"]
      source_addresses      = ["*"]
      destination_addresses = ["*"]
      destination_ports     = ["123"]
    }
  }
  
  depends_on = [module.hub_and_spoke_vnet]
}
```

### ケース3: 追加のSpoke VNetを作成

**例**：本番用とDR用のSpoke VNet

#### spoke-vnets.tf:

```hcl
# 本番用Spoke VNet
resource "azurerm_virtual_network" "spoke_production" {
  name                = "vnet-myorg-spoke-prd"
  location            = "japaneast"
  resource_group_name = azurerm_resource_group.spoke_production.name
  address_space       = ["10.1.0.0/16"]
  
  tags = {
    Environment = "Production"
    CostCenter  = "1000"
  }
}

resource "azurerm_resource_group" "spoke_production" {
  name     = "rg-myorg-spoke-prd"
  location = "japaneast"
}

# Hubとのピアリング（Production → Hub）
resource "azurerm_virtual_network_peering" "spoke_prd_to_hub" {
  name                      = "peer-spoke-prd-to-hub"
  resource_group_name       = azurerm_resource_group.spoke_production.name
  virtual_network_name      = azurerm_virtual_network.spoke_production.name
  remote_virtual_network_id = module.hub_and_spoke_vnet[0].hub_virtual_networks["primary"].virtual_network.resource_id
  
  allow_virtual_network_access = true
  allow_forwarded_traffic      = true
  allow_gateway_transit        = false
  use_remote_gateways          = false
}

# Hub → Production
resource "azurerm_virtual_network_peering" "hub_to_spoke_prd" {
  name                      = "peer-hub-to-spoke-prd"
  resource_group_name       = "rg-myorg-connectivity-001"
  virtual_network_name      = "vnet-myorg-jpe-hub"
  remote_virtual_network_id = azurerm_virtual_network.spoke_production.id
  
  allow_virtual_network_access = true
  allow_forwarded_traffic      = true
  allow_gateway_transit        = true
  use_remote_gateways          = false
  
  depends_on = [module.hub_and_spoke_vnet]
}

# DR用Spoke VNet（同様に作成）
resource "azurerm_virtual_network" "spoke_dr" {
  name                = "vnet-myorg-spoke-dr"
  location            = "japanwest"  # DR用は別リージョン
  resource_group_name = azurerm_resource_group.spoke_dr.name
  address_space       = ["10.2.0.0/16"]
  
  tags = {
    Environment = "DR"
    CostCenter  = "1000"
  }
}

# ...ピアリング設定も同様...
```

---

## Part 6: サブスクリプション配置のカスタマイズ

### デフォルト設定

**platform-landing-zone.auto.tfvars**：
```hcl
subscription_id_management  = "<SUB_ID_1>"
subscription_id_identity    = "<SUB_ID_2>"
subscription_id_connectivity = "<SUB_ID_3>"
```

### カスタマイズ: 1つのサブスクリプションで全部

**小規模な組織の場合**：
```hcl
# 全部同じSubscription ID
subscription_id_management  = "<SINGLE_SUB_ID>"
subscription_id_identity    = "<SINGLE_SUB_ID>"
subscription_id_connectivity = "<SINGLE_SUB_ID>"
```

**メリット**：
```
- コスト削減
- 管理がシンプル
```

**デメリット**：
```
- 分離できない
- 権限管理が複雑
```

### カスタマイズ: 追加のサブスクリプションを配置

**例**：開発用サブスクリプションをDevelopment Management Groupに配置

#### terraform.tfvars.jsonに追加:

```json
{
  "subscription_id_development": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

#### variables.tfに追加:

```hcl
variable "subscription_id_development" {
  type        = string
  description = "Subscription ID for Development"
}
```

#### locals.tfまたはmain.tfでManagement Groupに配置:

```hcl
resource "azurerm_management_group_subscription_association" "development" {
  management_group_id = "/providers/Microsoft.Management/managementGroups/${var.root_id}-development"
  subscription_id     = "/subscriptions/${var.subscription_id_development}"
  
  depends_on = [module.management_groups]
}
```

---

## Part 7: タグのカスタマイズ

### デフォルトタグ

**platform-landing-zone.auto.tfvars**：
```hcl
tags = {
  Environment = "Production"
  ManagedBy   = "Terraform"
}
```

### カスタマイズ: 組織固有のタグ追加

```hcl
tags = {
  Environment = "Production"
  ManagedBy   = "Terraform"
  CostCenter  = "1000"
  Department  = "IT"
  Owner       = "platform-team@example.com"
  Project     = "Azure Landing Zones"
  Compliance  = "ISO27001"
}
```

### リソースタイプごとのタグ

```hcl
management_tags = {
  Environment = "Management"
  Purpose     = "Logging and Monitoring"
}

connectivity_tags = {
  Environment = "Connectivity"
  Purpose     = "Network Hub"
}

identity_tags = {
  Environment = "Identity"
  Purpose     = "Active Directory"
}
```

---

## Part 8: ロギングのカスタマイズ

### Log Analytics Workspaceの保持期間変更

**デフォルト**：30日

**変更**：

#### platform-landing-zone.auto.tfvarsに追加:

```hcl
management_resources_settings = {
  log_analytics_workspace = {
    retention_in_days = 90  # ←90日に延長
  }
}
```

**コスト**：
```
30日: 無料枠
90日: 追加料金（約0.12円/GB/日）
180日: さらに高い
```

### カスタムDCR（Data Collection Rule）追加

**例**：特定のログを収集

#### 新規ファイル: custom-dcr.tf

```hcl
resource "azurerm_monitor_data_collection_rule" "custom_logs" {
  name                = "dcr-custom-logs"
  resource_group_name = "rg-myorg-management-001"
  location            = "japaneast"
  
  destinations {
    log_analytics {
      workspace_resource_id = module.management_resources[0].log_analytics_workspace.id
      name                  = "destination-log-analytics"
    }
  }
  
  data_flow {
    streams      = ["Microsoft-Syslog"]
    destinations = ["destination-log-analytics"]
  }
  
  data_sources {
    syslog {
      facility_names = ["*"]
      log_levels     = ["Warning", "Error", "Critical"]
      name           = "datasource-syslog"
    }
  }
  
  depends_on = [module.management_resources]
}
```

---

## 実践例: 完全カスタマイズ

### 例: 3環境（本番、ステージング、開発）を分離

#### Step 1: Management Group構造

**lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml**：

```yaml
management_groups:
  - id: alz
    display_name: My Organization
    archetypes: [root_custom]
    parent_id: null
  
  - id: platform
    display_name: Platform
    archetypes: [platform_custom]
    parent_id: alz
  
  - id: workloads
    display_name: Workloads
    archetypes: [landing_zones_custom]
    parent_id: alz
  
  - id: production
    display_name: Production
    archetypes: [production_custom]
    parent_id: workloads
  
  - id: staging
    display_name: Staging
    archetypes: [staging_custom]
    parent_id: workloads
  
  - id: development
    display_name: Development
    archetypes: [development_custom]
    parent_id: workloads
```

#### Step 2: 環境ごとのポリシー

**lib/archetype_definitions/production_custom.alz_archetype_override.yaml**：

```yaml
base_archetype: landing_zones
name: production_custom

# 本番環境: 厳しいポリシー
policy_assignments_to_add:
  - Deploy-SQL-TDE          # 暗号化必須
  - Deploy-SQL-minTLS       # TLS 1.2必須
  - Deny-Subnet-Without-Nsg # NSG必須
  - Deny-Public-IP          # Public IP禁止

policy_assignments_to_remove: []
```

**lib/archetype_definitions/development_custom.alz_archetype_override.yaml**：

```yaml
base_archetype: landing_zones
name: development_custom

# 開発環境: 緩いポリシー
policy_assignments_to_add: []

policy_assignments_to_remove:
  - Deploy-SQL-TDE          # 暗号化不要
  - Deploy-SQL-minTLS       # TLS制限なし
  - Deny-Subnet-Without-Nsg # NSGなしOK
  - Deny-Public-IP          # Public IP使用OK
```

#### Step 3: 環境ごとのネットワーク

**platform-landing-zone.auto.tfvars**：

```hcl
# 本番用Hub
hub_virtual_networks = {
  production = {
    location = "japaneast"
    
    enabled_resources = {
      firewall = true   # Firewall有効
      bastion  = true
      vpn_gateway = true
    }
    
    hub_virtual_network = {
      name          = "vnet-prd-jpe-hub"
      address_space = ["10.0.0.0/16"]
    }
  }
  
  # 開発用Hub（簡易版）
  development = {
    location = "japaneast"
    
    enabled_resources = {
      firewall = false  # Firewall無効（コスト削減）
      bastion  = true   # Bastionは有効（便利）
      vpn_gateway = false
    }
    
    hub_virtual_network = {
      name          = "vnet-dev-jpe-hub"
      address_space = ["10.10.0.0/16"]
    }
  }
}
```

---

## カスタマイズのベストプラクティス

### 1. 段階的に変更

```
一度に全部変更しない
  ↓
1つずつ変更 → テスト → 次へ
```

### 2. バージョン管理

```
libフォルダの変更履歴を残す
  ↓
git commit -m "Add Development MG with relaxed policies"
```

### 3. ドキュメント化

```
なぜこのカスタマイズをしたか記録
  ↓
README.mdやWiki
```

### 4. デフォルトを尊重

```
Microsoftのベストプラクティスを基準に
  ↓
必要な部分だけカスタマイズ
  ↓
やりすぎない
```

### 5. テスト環境で検証

```
本番環境でいきなり変更しない
  ↓
開発環境で試す
  ↓
問題なければ本番へ
```

---

## まとめ

**カスタマイズできる項目**：
1. **Management Group構造**：追加・削除・階層変更
2. **ポリシー**：追加・削除・パラメータ変更
3. **命名規則**：prefix、環境名、リージョン名
4. **ネットワーク**：サブネット、Firewallルール、Spoke VNet
5. **サブスクリプション配置**：Management Groupへの割り当て
6. **タグ**：組織固有のタグ追加
7. **ロギング**：保持期間、カスタムDCR

**重要なファイル**：

- `lib/architecture_definitions/alz_custom.alz_architecture_definition.yaml`：構造定義
- `lib/archetype_definitions/*.yaml`：ポリシー定義
- `platform-landing-zone.auto.tfvars`：設定値
- `locals.tf`：命名規則ロジック

**カスタマイズの流れ**：
```
1. 要件整理（何を変更したいか）
2. libフォルダ編集
3. tfvars編集
4. ローカルでplan確認
5. PR作成
6. レビュー
7. デプロイ
```

次のChapterでは、ベストプラクティスを見ていきます。
運用で気をつけるべきポイントをまとめるよ。

---

**所要時間**: 60分  
**難易度**: ★★★★☆  
**前**: [14_トラブルシューティング.md](./14_トラブルシューティング.md)  
**次**: [16_ベストプラクティス.md](./16_ベストプラクティス.md)
