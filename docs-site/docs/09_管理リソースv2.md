# 09. 管理リソース - 監視とログの基盤

!!! info "この章で学ぶこと"
    `modules/management_resources/`モジュールで管理リソースを作成する仕組みを学びます：

    1. 管理リソースって何？なぜ必要？
    2. Log Analytics Workspaceの役割
    3. Data Collection Rulesの仕組み
    4. modules/management_resources/の詳細解説
    5. 実践：カスタム監視ソリューションの追加

---

## はじめに：管理リソースって何？

### Azure環境の「司令塔」

管理リソースは、Azure環境全体を監視・管理するためのリソースです。

=== "リアル世界の例"

    ```text title="工場の管理システム"
    工場
    ├── 生産ライン（ワークロード）
    │   ├── 機械A
    │   ├── 機械B
    │   └── 機械C
    └── 管理室（管理リソース）
        ├── 監視カメラ（Log Analytics）
        ├── 制御盤（Automation Account）
        └── アラートシステム（Monitoring）
    ```

    管理室から全体を把握・制御！

=== "Azure Landing Zones"

    ```text title="管理リソース構成"
    Management Subscription
    └── rg-management-japaneast
        ├── Log Analytics Workspace
        │   └── ログとメトリクスを収集
        ├── Data Collection Rules
        │   ├── VM Insights
        │   ├── Change Tracking
        │   └── Defender for SQL
        ├── Automation Account（オプション）
        │   └── 自動化スクリプト
        └── Sentinel（オプション）
            └── セキュリティ分析
    ```

### 主要な管理リソース

**1. Log Analytics Workspace:**

すべてのログとメトリクスを集約する場所。

**2. Data Collection Rules (DCR):**

どのデータを収集するか定義。

**3. Automation Account:**

定期的なタスクを自動実行。

**4. Microsoft Sentinel:**

セキュリティイベントの分析・対応。

---

## Part 1: Log Analytics Workspaceとは？

### ログの「倉庫」

すべてのAzureリソースからログを集めて保存・分析します。

**収集できるログ：**

- 仮想マシンのパフォーマンスメトリクス
- アプリケーションログ
- セキュリティイベント
- ネットワークトラフィック
- リソースの変更履歴

**できること：**

```kusto title="KQLクエリの例"
// 過去24時間のエラーログを検索
AzureDiagnostics
| where TimeGenerated > ago(24h)
| where Level == "Error"
| summarize count() by ResourceType
```

### SKUの選択

| SKU | 用途 | 料金モデル |
|-----|------|-----------|
| **PerGB2018** | 一般的な使用 | 従量課金（GB単位） |
| **CapacityReservation** | 大量ログ | 容量予約（割引あり） |

---

## Part 2: Data Collection Rulesとは？

### データ収集の「レシピ」

どのリソースから、どんなデータを、どこに送るかを定義します。

**3種類のDCR：**

### 1. VM Insights（VM監視）

仮想マシンのパフォーマンス監視。

**収集するデータ：**

- CPU使用率
- メモリ使用量
- ディスクI/O
- ネットワークトラフィック
- プロセス情報

**用途：**

```text
高CPU使用率を検出 → アラート → 調査・対応
```

### 2. Change Tracking（変更追跡）

システム構成の変更を追跡。

**追跡する変更：**

- インストール済みソフトウェア
- Windowsサービス
- レジストリキー
- ファイルとディレクトリ

**用途：**

```text
問題発生 → 直前の変更を確認 → 原因特定
```

### 3. Defender for SQL（SQL保護）

SQLデータベースのセキュリティ監視。

**収集するデータ：**

- SQLクエリログ
- アクセスパターン
- 脅威の検出
- 脆弱性評価

**用途：**

```text
異常なクエリを検出 → アラート → セキュリティ対応
```

---

## Part 3: modules/management_resources/ の構造

```text title="モジュールの構造"
modules/management_resources/
├── main.tf         ← メインロジック
├── variables.tf    ← 入力変数
├── outputs.tf      ← 出力値
└── terraform.tf    ← バージョン設定
```

---

## Part 4: main.tf の詳細解説

```hcl title="modules/management_resources/main.tf"
module "management_resources" {
  source                                                     = "Azure/avm-ptn-alz-management/azurerm"
  version                                                    = "0.9.0"
  automation_account_name                                    = null
  location                                                   = var.management_resource_settings.location
  log_analytics_workspace_name                               = coalesce(var.management_resource_settings.log_analytics_workspace_name, "law-management-${var.management_resource_settings.location}")
  resource_group_name                                        = coalesce(var.management_resource_settings.resource_group_name, "rg-management-${var.management_resource_settings.location}")
  data_collection_rules                                      = var.management_resource_settings.data_collection_rules
  enable_telemetry                                           = var.enable_telemetry
  linked_automation_account_creation_enabled                 = false
  log_analytics_solution_plans                               = var.management_resource_settings.log_analytics_solution_plans
  log_analytics_workspace_allow_resource_only_permissions    = var.management_resource_settings.log_analytics_workspace_allow_resource_only_permissions
  log_analytics_workspace_cmk_for_query_forced               = var.management_resource_settings.log_analytics_workspace_cmk_for_query_forced
  log_analytics_workspace_daily_quota_gb                     = var.management_resource_settings.log_analytics_workspace_daily_quota_gb
  log_analytics_workspace_internet_ingestion_enabled         = var.management_resource_settings.log_analytics_workspace_internet_ingestion_enabled
  log_analytics_workspace_internet_query_enabled             = var.management_resource_settings.log_analytics_workspace_internet_query_enabled
  log_analytics_workspace_local_authentication_enabled       = var.management_resource_settings.log_analytics_workspace_local_authentication_enabled
  log_analytics_workspace_reservation_capacity_in_gb_per_day = var.management_resource_settings.log_analytics_workspace_reservation_capacity_in_gb_per_day
  log_analytics_workspace_retention_in_days                  = var.management_resource_settings.log_analytics_workspace_retention_in_days
  log_analytics_workspace_sku                                = var.management_resource_settings.log_analytics_workspace_sku
  resource_group_creation_enabled                            = true
  sentinel_onboarding                                        = var.management_resource_settings.sentinel_onboarding
  tags                                                       = var.management_resource_settings.tags
  timeouts                                                   = var.management_resource_settings.timeouts
  user_assigned_managed_identities                           = var.management_resource_settings.user_assigned_managed_identities
}
```

### 4-1: モジュールの基本設定

```hcl
module "management_resources" {
  source  = "Azure/avm-ptn-alz-management/azurerm"
  version = "0.9.0"
```

**何してる？**

Azure公式のALZ管理リソースパターンモジュールを使用。

**このモジュールが作成するリソース：**

- Log Analytics Workspace
- Data Collection Rules
- Automation Account（オプション）
- Microsoft Sentinel（オプション）

### 4-2: リソース名の設定

```hcl
  location                     = var.management_resource_settings.location
  log_analytics_workspace_name = coalesce(var.management_resource_settings.log_analytics_workspace_name, "law-management-${var.management_resource_settings.location}")
  resource_group_name          = coalesce(var.management_resource_settings.resource_group_name, "rg-management-${var.management_resource_settings.location}")
```

**coalesce()の使い方：**

```hcl
coalesce(値1, 値2)
# 値1がnullでなければ値1、nullなら値2
```

**具体例：**

```hcl title="カスタム名を指定した場合"
log_analytics_workspace_name = "my-custom-law"
# → "my-custom-law" を使用
```

```hcl title="指定しない場合"
log_analytics_workspace_name = null
# → "law-management-japaneast" を自動生成
```

### 4-3: Automation Account

```hcl
  automation_account_name                    = null
  linked_automation_account_creation_enabled = false
```

**何してる？**

Automation Accountを作成しない設定。

**なぜ無効？**

最近のAzure Monitor Agentでは、Automation Accountなしで変更追跡が可能になったため。

**有効にする場合：**

```hcl
automation_account_name                    = "aa-management-japaneast"
linked_automation_account_creation_enabled = true
```

### 4-4: Data Collection Rules

```hcl
  data_collection_rules = var.management_resource_settings.data_collection_rules
```

**設定例：**

```hcl title="platform-landing-zone.auto.tfvars"
data_collection_rules = {
  change_tracking = {
    enabled  = true
    name     = "dcr-change-tracking"
    location = "japaneast"
  }
  vm_insights = {
    enabled  = true
    name     = "dcr-vm-insights"
    location = "japaneast"
  }
  defender_sql = {
    enabled  = false  # SQL Server使ってない場合
    name     = "dcr-defender-sql"
  }
}
```

### 4-5: Log Analytics設定

```hcl
  log_analytics_workspace_retention_in_days  = var.management_resource_settings.log_analytics_workspace_retention_in_days
  log_analytics_workspace_daily_quota_gb     = var.management_resource_settings.log_analytics_workspace_daily_quota_gb
  log_analytics_workspace_sku                = var.management_resource_settings.log_analytics_workspace_sku
```

**重要な設定：**

**retention_in_days:**

ログの保持期間（日数）。

```hcl
log_analytics_workspace_retention_in_days = 90  # 90日間保持
```

**daily_quota_gb:**

1日あたりの最大取り込み容量（GB）。

```hcl
log_analytics_workspace_daily_quota_gb = 10  # 1日10GBまで
```

**sku:**

価格プラン。

```hcl
log_analytics_workspace_sku = "PerGB2018"  # 従量課金
```

### 4-6: アクセス制御

```hcl
  log_analytics_workspace_internet_ingestion_enabled   = var.management_resource_settings.log_analytics_workspace_internet_ingestion_enabled
  log_analytics_workspace_internet_query_enabled       = var.management_resource_settings.log_analytics_workspace_internet_query_enabled
  log_analytics_workspace_local_authentication_enabled = var.management_resource_settings.log_analytics_workspace_local_authentication_enabled
```

**セキュリティ設定：**

**internet_ingestion_enabled:**

インターネット経由でのログ送信を許可。

```hcl
internet_ingestion_enabled = true   # パブリックエンドポイント有効
internet_ingestion_enabled = false  # Private Link必須
```

**internet_query_enabled:**

インターネット経由でのクエリを許可。

```hcl
internet_query_enabled = true   # どこからでもクエリ可能
internet_query_enabled = false  # Private Link必須
```

**local_authentication_enabled:**

ローカル認証（ワークスペースキー）を許可。

```hcl
local_authentication_enabled = true   # キー認証OK
local_authentication_enabled = false  # Azure AD認証のみ
```

### 4-7: Microsoft Sentinel

```hcl
  sentinel_onboarding = var.management_resource_settings.sentinel_onboarding
```

**設定例：**

```hcl title="Sentinelを有効化"
sentinel_onboarding = {
  name                         = "sentinel-alz"
  customer_managed_key_enabled = false
}
```

```hcl title="Sentinelを無効化"
sentinel_onboarding = null
```

### 4-8: Managed Identity

```hcl
  user_assigned_managed_identities = var.management_resource_settings.user_assigned_managed_identities
```

**設定例：**

```hcl title="Azure Monitor Agent用のManaged Identity"
user_assigned_managed_identities = {
  ama = {
    enabled  = true
    name     = "id-ama-management"
    location = "japaneast"
  }
}
```

---

## Part 5: 実践 - カスタム監視ソリューションの追加

### シナリオ: Container Insightsを追加

**要件：**

- AKSクラスターの監視を有効化
- Container Insightsソリューションを追加

### 手順1: ソリューションの追加

```hcl title="platform-landing-zone.auto.tfvars"
log_analytics_solution_plans = [
  {
    product   = "OMSGallery/ContainerInsights"
    publisher = "Microsoft"
  }
]
```

### 手順2: 既存ソリューションと併用

```hcl title="複数のソリューション"
log_analytics_solution_plans = [
  {
    product   = "OMSGallery/Updates"
    publisher = "Microsoft"
  },
  {
    product   = "OMSGallery/ContainerInsights"
    publisher = "Microsoft"
  },
  {
    product   = "OMSGallery/ServiceMap"
    publisher = "Microsoft"
  }
]
```

### 手順3: Terraform実行

```bash
terraform plan
```

**出力例：**
```text
Terraform will perform the following actions:

  # module.management_resources[0].azurerm_log_analytics_solution.this["ContainerInsights"] will be created
  + resource "azurerm_log_analytics_solution" "this" {
      + solution_name       = "ContainerInsights"
      + workspace_name      = "law-management-japaneast"
      + workspace_resource_id = "..."
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

```bash
terraform apply
```

---

## Part 6: よくあるパターン

### パターン1: コスト最適化

```hcl title="低コスト設定"
log_analytics_workspace_retention_in_days = 30      # 30日保持
log_analytics_workspace_daily_quota_gb    = 5       # 1日5GBまで
log_analytics_workspace_sku               = "PerGB2018"
```

### パターン2: エンタープライズ設定

```hcl title="大規模環境"
log_analytics_workspace_retention_in_days                  = 730  # 2年保持
log_analytics_workspace_sku                                = "CapacityReservation"
log_analytics_workspace_reservation_capacity_in_gb_per_day = 100  # 100GB/日予約
```

### パターン3: セキュアアクセス

```hcl title="Private Link必須"
log_analytics_workspace_internet_ingestion_enabled   = false
log_analytics_workspace_internet_query_enabled       = false
log_analytics_workspace_local_authentication_enabled = false
```

### パターン4: 特定DCRだけ有効化

```hcl title="VM Insightsのみ"
data_collection_rules = {
  change_tracking = {
    enabled = false
    name    = "dcr-change-tracking"
  }
  vm_insights = {
    enabled  = true
    name     = "dcr-vm-insights"
    location = "japaneast"
  }
  defender_sql = {
    enabled = false
    name    = "dcr-defender-sql"
  }
}
```

---

## Part 7: Log Analytics Workspaceの活用例

### 例1: パフォーマンス分析

```kusto title="CPU使用率の高いVMを検索"
Perf
| where TimeGenerated > ago(1h)
| where ObjectName == "Processor"
| where CounterName == "% Processor Time"
| summarize avg(CounterValue) by Computer
| where avg_CounterValue > 80
```

### 例2: セキュリティ監視

```kusto title="失敗したログイン試行"
SecurityEvent
| where TimeGenerated > ago(24h)
| where EventID == 4625  // Failed logon
| summarize count() by Account, Computer
| order by count_ desc
```

### 例3: コスト分析

```kusto title="データ取り込み量の確認"
Usage
| where TimeGenerated > ago(30d)
| summarize sum(Quantity) by DataType
| order by sum_Quantity desc
```

---

## まとめ

### management_resourcesモジュールのポイント

!!! success "このモジュールの役割"
    **4つの主要機能：**
    
    1. **Log Analytics Workspace**: ログとメトリクスの集約
    2. **Data Collection Rules**: データ収集の定義
    3. **Automation Account**: 自動化タスク（オプション）
    4. **Microsoft Sentinel**: セキュリティ分析（オプション）

### 重要な設定項目

| 設定 | 推奨値 | 用途 |
|------|--------|------|
| **retention_in_days** | 90-730日 | コンプライアンス要件に応じて |
| **daily_quota_gb** | 用途次第 | コスト制御 |
| **sku** | PerGB2018 | 一般的な使用 |
| **internet_*_enabled** | false | セキュリティ重視 |

### Data Collection Rulesの選択

| DCR | 用途 | 推奨 |
|-----|------|------|
| **VM Insights** | VMパフォーマンス監視 | ✅ 必須 |
| **Change Tracking** | 構成変更追跡 | ✅ 推奨 |
| **Defender for SQL** | SQL保護 | SQL使用時のみ |

---

## 次のステップ

管理リソースの作成方法を理解しましたか？

次は[10_Hub-and-Spoke.md](./10_Hub-and-Spoke.md)に進んで、  
`main.connectivity.hub.and.spoke.virtual.network.tf`でHub-and-Spokeネットワークがどう構築されるか学びましょう。

**所要時間**: 40分  
**難易度**: ★★★★☆  
**次**: [10_Hub-and-Spoke.md](./10_Hub-and-Spoke.md)
