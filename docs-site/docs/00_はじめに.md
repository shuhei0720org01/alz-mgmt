# 00. はじめに - このプロジェクトの全体像

## この教科書の使い方

### 📚 学習スタイル

この教科書は、**実際のコードを見ながら読む**ことを強く推奨します。

!!! tip "推奨: GitHubで見る"
    教科書を読みながら、ブラウザで https://github.com/shuhei0720org01/alz-mgmt を開いておきましょう。
    
    - ファイル構造が見える
    - コードを検索できる
    - ファイルをクリックすれば開ける

!!! warning "このリポジトリをクローンしないでください"
    このリポジトリは**学習用のコード例**です。クローンしても実行できません。
    
    実際にデプロイしたい場合は、[Chapter 14: Bootstrap Phase 1](./14_Bootstrap_Phase_1.md)から始めてください。
    Bootstrap完了後、あなた専用のリポジトリが作成されます。

### 📖 読み方

1. **教科書を読む**
   - Webサイトまたは`docs/`フォルダのマークダウン
   
2. **コードを確認する**
   - 教科書で具体的なファイル名（`platform-landing-zone.auto.tfvars`など）が出てきたら、GitHubまたはVSCodeでそのファイルを開く
   
3. **コードを理解する**（重要）
   - コードの構造や設定値を確認する
   - コメントを読んで設計意図を理解する
   - 他のファイルとの関係性を把握する

!!! warning "このリポジトリについて注意"
    **このリポジトリは完成済みのコード例です。**
    
    - ✅ **学習用**: コードを読んで構造を理解する教材として使う
    - ❌ **デプロイ用ではない**: このリポジトリをクローンしても実行できません
    
    **実際にAzure Landing Zonesをデプロイしたい場合**:
    
    1. [Chapter 14: Bootstrap Phase 1](./14_Bootstrap_Phase_1.md)から始めてください
    2. Azure公式のBootstrap手順に従って、最初から環境を構築します
    3. Bootstrap完了後、あなた専用のリポジトリが作成されます
    4. そのリポジトリがこのコード例のような構造になります

---

## 何を作るのか？

このプロジェクトは、**Azure Landing Zones**（アジュール・ランディングゾーンズ）という、  
企業向けのAzure環境を構築するためのTerraformコードです。

「Landing Zone」は飛行機の着陸帯？って意味です。
実際、そのイメージで合っていて、

飛行機が安全に着陸するためには、滑走路だけじゃなくて：

- 管制塔（誰がどこに着陸していいか管理）
- 誘導灯（どこに行けばいいか案内）
- セキュリティゲート（危険なものは入れない）
- 整備場（メンテナンス）

これらが全部揃ってますよね。

Azure Landing Zonesも同じです。  
アプリケーションを「安全に着陸させる」ための環境を整えます。

## 具体的に何ができるの？

このコードを実行すると、Azureにこんな環境ができます：

### 1. 組織構造（管理グループ）
```text title="管理グループの階層構造"
あなたの会社
├── プラットフォーム（基盤チーム）
│   ├── ネットワーク担当
│   ├── 監視担当
│   └── ID管理担当
├── アプリケーション（開発チーム）
│   ├── 本番環境
│   └── 開発環境
└── サンドボックス（実験用）
```

会社の組織図みたいに、Azureのリソースも階層構造で管理できます。

### 2. ネットワーク（2拠点構成）

=== "東日本の拠点（メイン）"

    - Azure Firewall: インターネットとの出入り口を守る門番
    - Bastion: サーバーに安全にログインするための専用ゲート
    - VPN Gateway: 会社のオフィスと接続
    - Express Route Gateway: 専用線で接続（オプション）
    - Private DNS: 内部の名前解決

=== "西日本の拠点（バックアップ）"

    - 東日本と同じ構成
    - 災害時の切り替え先

### 3. 監視・管理システム
- Log Analytics: 全てのログを一箇所に集約
- Automation Account: 定期的な作業を自動化
- Data Collection Rules: どのログを集めるか定義

### 4. セキュリティポリシー（約200個！）
例えば：

- 「インターネットに直接繋がるリソースは作っちゃダメ」
- 「暗号化されてない通信は禁止」
- 「削除保護をONにしなさい」

などなど、会社のルールを自動で強制できます。

## なぜこんな複雑なの？

「こんなに複雑にする必要ある？」って思いますよね。

でも、企業でAzureを使うとき、こんな問題が起きるんです：

### 問題1: 野良リソース
開発者が勝手にリソース作って、誰も管理してない。  
→ **管理グループ+ポリシーで制御**

### 問題2: セキュリティ事故
Public IPを直接インターネットに晒して攻撃される。  
→ **Firewallで全ての通信を監視**

### 問題3: ログがバラバラ
どこで何が起きたかわからない。  
→ **Log Analyticsで全部集約**

### 問題4: 災害時に止まる
東日本のデータセンターがダウンしたらサービス停止。  
→ **西日本にも同じ構成を用意**

### 問題5: 誰がどこまでできるか不明確
権限管理がグチャグチャ。  
→ **管理グループで階層的に権限管理**

Landing Zonesは、これら全ての問題を一気に解決するための「基盤」なんです。

## このプロジェクトの構成

```
alz-mgmt/
├── platform-landing-zone.auto.tfvars  ← ここだけ編集すればOK
├── variables.tf                        ← 変数の定義
├── locals.tf                           ← 計算済みの値
├── terraform.tf                        ← Terraformの設定
├── main.*.tf                           ← メインの処理（複数ファイル）
│
├── modules/                            ← 再利用可能な部品
│   ├── config-templating/              ← 設定の変換エンジン
│   ├── management_groups/              ← 管理グループ・ポリシー
│   └── management_resources/           ← 監視・管理リソース
│
├── lib/                                ← ポリシー定義のYAML
│   ├── archetype_definitions/          ← 管理グループの種類
│   └── architecture_definitions/       ← 全体のアーキテクチャ
│
└── .github/workflows/                  ← GitHub Actions（自動実行）
```

### ファイル名の法則

このプロジェクト、ファイル名が規則的です：

- `main.*.tf`: メインの処理。`*`の部分が役割を表す
  - `main.connectivity.hub.and.spoke.virtual.network.tf` → ハブスポークネットワーク
  - `main.management.tf` → 管理グループ
  - `main.resource.groups.tf` → リソースグループ

- `variables.*.tf`: 変数定義。`*`の部分が対象を表す
  - `variables.connectivity.tf` → ネットワーク関連の変数
  - `variables.management.tf` → 管理関連の変数

- `*.auto.tfvars`: 自動で読み込まれる設定ファイル

## データの流れ

このプロジェクトがどう動くか、データの流れで見てみましょう：

```
1. あなたが設定ファイルを編集
   ↓
   platform-landing-zone.auto.tfvars
   「東日本と西日本で作って！」

2. Terraformが読み込む
   ↓
   terraform.tf, variables.tf
   「OK、変数として受け取ったよ」

3. テンプレートエンジンが変換
   ↓
   modules/config-templating
   「$${starter_location_01}を'japaneast'に置換」

4. 各モジュールが実行される
   ↓
   main.*.tf
   「リソースグループ作成！」
   「ネットワーク構築！」
   「ポリシー適用！」

5. Azureにリソースが作られる
   ↓
   Azure環境
   「完成！」
```

## 実際に何が作られるか

このコードを実行すると、Azureにこれだけのリソースができます：

- リソースグループ: 約10個
- 仮想ネットワーク: 2個（東日本・西日本）
- Azure Firewall: 2個
- Bastion Host: 2個
- VPN Gateway: 2個（オプション）
- Express Route Gateway: 2個（オプション）
- Log Analytics ワークスペース: 1個
- Automation Account: 1個
- 管理グループ: 約10個
- ポリシー定義: 約200個
- ポリシーセット定義: 約40個
- ポリシー割り当て: 約50個
- カスタムロール定義: 数個

合計で、500個以上のリソースが作られます。  
これを手作業でやったら...考えたくないですねw

## 所要時間とコスト

### 構築時間
- 初回実行: 約15〜20分
- 削除: 約10〜15分

### 月額コスト（概算）

**2リージョン構成（東日本+西日本）の場合：**
- Azure Firewall: 約¥340,000/月（2個 × ¥170,000、Standard SKU）
- VPN Gateway: 約¥80,000/月（2個 × ¥40,000、VpnGw1 SKU）
- Bastion: 約¥54,000/月（2個 × ¥27,000、Basic SKU）
- Log Analytics: データ量による（約¥10,000〜）
- その他: 約¥5,000/月

=== "2リージョン構成"
    **合計: 約¥484,000〜/月**

=== "1リージョン構成"
    **約¥242,000/月**（2リージョンの半分）

!!! tip "コスト削減のヒント"
    - VPN不要なら約¥80,000削減
    - Firewall Basicにすると約¥280,000削減（Standard → Basic）
    - 詳細は各章のトラブルシューティングセクションを参照
    
    ※ 実験用なら不要なリソース（Firewall等）を無効化すれば大幅にコスト削減可能

## このプロジェクトの賢いところ

!!! success "5つの賢い設計"
    ### 1. テンプレート機能
    同じ設定を複数地域にコピペしなくていい。  
    `$${starter_location_01}`って書けば自動で`japaneast`に置換してくれる。

    ### 2. モジュール化
    再利用可能な部品に分かれている。  
    他のプロジェクトでも使い回せる。

    ### 3. Azure Verified Modules (AVM)を使用
    Microsoftが公式にメンテナンスしているモジュールを使ってる。  
    自分でイチから書くより安全で確実。

    ### 4. ポリシーのYAML管理
    ポリシー定義をYAMLで管理。  
    Terraformコードより読みやすい。

    ### 5. GitHub Actionsで自動化
    手元でTerraform実行しなくていい。  
    GitHubにpushすれば自動でデプロイ。

## 学習のロードマップ

!!! info "6ステップで理解する"
    このプロジェクトを理解するための順序：

    ### ステップ1: 全体像を掴む（今ここ）
    - このファイルを読む
    - 何ができるのか理解する
    - なぜ必要なのか理解する

    ### ステップ2: 基礎を学ぶ
    - Terraformの基本
    - Azureの基本概念
    - Landing Zonesの設計思想

    ### ステップ3: 設定ファイルを読む
    - `platform-landing-zone.auto.tfvars`を1行ずつ理解
    - どのパラメータが何を制御するか

    ### ステップ4: モジュールを理解する
    - 各モジュールの役割
    - どう連携しているか

    ### ステップ5: 実際に動かす
    - 自分の環境で実行
    - トラブルシューティング

    ### ステップ6: カスタマイズする
    - 自分の要件に合わせて改造
    - 新しい機能を追加

## よくある勘違い

!!! warning "これらは誤解です"
    ### 勘違い1: 「全部理解しないと使えない」
    → **NO!** まずは設定ファイルだけ理解すれば使えます。  
    深く理解するのは後からでOK。

    ### 勘違い2: 「Azureの専門家じゃないとダメ」
    → **NO!** このコースで必要な知識は全部教えます。

    ### 勘違い3: 「一度作ったら変更できない」
    → **NO!** Terraformなので、設定変えて再実行すれば更新されます。

    ### 勘違い4: 「本番環境で使っちゃダメ」
    → **NO!** Microsoftが推奨する構成なので本番でも使えます。  
    ただし、最初は検証環境で試してね。

---

## 練習問題

### 問題1
このプロジェクトで構築される主要な3つのコンポーネントを挙げてください。

### 問題2
なぜこのプロジェクトではTerraformを使っているのですか？

### 問題3
どのChapterから読むべきか、初心者と経験者それぞれの学習ルートを説明してください。

---

## 練習問題の答え

### 答え1
主要な3つのコンポーネント：

1. **管理グループ**: サブスクリプションを階層的に管理し、ポリシーを一括適用
2. **ネットワーク**: Hub-and-Spoke構成でセキュアな通信基盤を構築
3. **管理リソース**: Log Analytics、監視、セキュリティ管理

### 答え2
Terraformを使う理由：

- IaC（Infrastructure as Code）: インフラをコードで管理できる
- 再現性: 同じコードから何度でも同じ環境を構築できる
- バージョン管理: Gitで変更履歴を追跡できる
- マルチクラウド対応: Azure以外のクラウドでも使える知識
- モジュール化: 再利用可能な部品として管理できる

### 答え3
**初心者ルート**:

- Chapter 00（全体像）→ Chapter 01（基礎知識）→ Chapter 02（構造）→ Chapter 14（Bootstrap Phase 1）
- 基礎から順番に読んで、まず動かしてみることが重要

**経験者ルート**:

- Chapter 00（全体像）→ Chapter 03（設定ファイル）→ Chapter 14-15（Bootstrap実践）
- 設定ファイルを理解すれば、すぐにデプロイできる

---

## 次のステップ

全体像は掴めましたか？

次は[01_基礎知識.md](./01_基礎知識.md)に進んで、  
Terraform・Azure・Landing Zonesの基礎を学びましょう。

「もう知ってるよ」って人は飛ばしてもOK。  
でも念のため目を通すことをオススメします。

---

**所要時間**: 10分  
**難易度**: ★☆☆☆☆  
**次**: [01_基礎知識.md](./01_基礎知識.md)
