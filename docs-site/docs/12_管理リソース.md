# 12. ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ - Log Analyticsã¨DCRã®å®Œå…¨è§£èª¬

!!! info "ã“ã®ç« ã§å­¦ã¶ã“ã¨ ğŸ“š"
    ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ï¼ˆLog Analyticsã€Data Collection Rulesã€Managed Identityï¼‰ã®å®Ÿè£…ã‚’å®Œå…¨ã«ç†è§£ã—ã¾ã™ï¼šğŸ› ï¸

    1. å®Ÿéš›ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆplatform-landing-zone.auto.tfvarsï¼‰ã®æ§‹é€ ğŸ—‚ï¸
    2. å¤‰æ•°ç½®æ›ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`$${variable_name}`ï¼‰ã®ä»•çµ„ã¿ğŸ”„
    3. main.management.tfã‹ã‚‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®æµã‚ŒğŸ”—
    4. modules/management_resources/ã®è§£èª¬ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ğŸ“
    5. å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆAzure/avm-ptn-alz-managementï¼‰ã®å†…éƒ¨æ§‹é€ ğŸ¢
    6. å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³ï¼ˆè¨­å®šâ†’ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã¾ã§ï¼‰ğŸ—ºï¸
    7. å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•ï¼‰ğŸ§‘â€ğŸ”¬

---

## Part 1: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆplatform-landing-zone.auto.tfvarsï¼‰ğŸ—‚ï¸

ã“ã“ã‹ã‚‰ã‚‚å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ãªãŒã‚‰ã„ã“ã†ã€‚ğŸ‘€

### management_resource_settingsâš™ï¸

platform-landing-zone.auto.tfvarsã‚’é–‹ã„ã¦ã¿ã‚ˆã†ã€‚management_resource_settingsã®è¨­å®šãŒæ›¸ã„ã¦ã‚ã‚‹ã€‚ğŸ“

```hcl title="platform-landing-zone.auto.tfvarsï¼ˆæŠœç²‹ï¼‰"
management_resource_settings = {
  enabled                      = true
  location                     = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name          = "$${management_resource_group_name}"
  
  user_assigned_managed_identities = {
    ama = {
      name = "$${ama_user_assigned_managed_identity_name}"
    }
  }
  
  data_collection_rules = {
    change_tracking = {
      name = "$${dcr_change_tracking_name}"
    }
    defender_sql = {
      name = "$${dcr_defender_sql_name}"
    }
    vm_insights = {
      name = "$${dcr_vm_insights_name}"
    }
  }
}
```


ã™ã¹ã¦`$${å¤‰æ•°å}`å½¢å¼ãªã®ãŒç‰¹å¾´ã€‚ã“ã‚Œã¯å¤‰æ•°ç½®æ›ã‚·ã‚¹ãƒ†ãƒ ã ã‚ˆã€‚ğŸ”„

---

### å¤‰æ•°ç½®æ›ã‚·ã‚¹ãƒ†ãƒ ã®ä»•çµ„ã¿ğŸ”„

```text title="å¤‰æ•°ç½®æ›ã®æµã‚Œ"
platform-landing-zone.auto.tfvars
â†“
management_resource_settings = {
  location = "$${starter_location_01}"  â†ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  ...
}
â†“
main.config.tf
  module "config-templating" {
    custom_replacements = {
      starter_location_01 = "japaneast"
      log_analytics_workspace_name = "law-mgmt-japaneast-001"
      management_resource_group_name = "rg-mgmt-japaneast-001"
      ...
    }
  }
â†“
config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ$${...}ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
â†“
locals.tf
  local.management_resource_settings = {
    location = "japaneast"  â†ç½®æ›å¾Œ
    log_analytics_workspace_name = "law-mgmt-japaneast-001"
    resource_group_name = "rg-mgmt-japaneast-001"
    ...
  }
```

**ãªãœã“ã‚“ãªã“ã¨ã™ã‚‹ã®ï¼Ÿ**ğŸ¤”

- ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹åå‰ã‚’ç°¡å˜ã«ç®¡ç†ã§ãã‚‹
- `custom_replacements`ã‚’å¤‰ãˆã‚‹ã ã‘ã§å…¨ä½“ã®è¨­å®šã‚’å¤‰æ›´ã§ãã‚‹
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦å†åˆ©ç”¨ã—ã‚„ã™ã„

---

### å¤‰æ•°å®šç¾©ï¼ˆcustom_replacements.namesï¼‰ğŸ“

åŒã˜platform-landing-zone.auto.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã®custom_replacements.namesã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚

```hcl title="platform-landing-zone.auto.tfvarsï¼ˆæŠœç²‹ï¼‰"
custom_replacements = {
  names = {
    # Resource names management
    log_analytics_workspace_name            = "law-management-$${starter_location_01}"
    ddos_protection_plan_name               = "ddos-$${starter_location_01}"
    ama_user_assigned_managed_identity_name = "uami-management-ama-$${starter_location_01}"
    dcr_change_tracking_name                = "dcr-change-tracking"
    dcr_defender_sql_name                   = "dcr-defender-sql"
    dcr_vm_insights_name                    = "dcr-vm-insights"
    
    # ... ãã®ä»–ã®å¤‰æ•°
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ã“ã“ã§å®Ÿéš›ã®å€¤ã‚’å®šç¾©ã—ã¦ã‚‹ã€‚ä¾‹ãˆã°ï¼š

- `log_analytics_workspace_name = "law-management-japaneast"`ï¼ˆã“ã‚Œã‚‚`$${starter_location_01}`ã‚’å«ã‚€ï¼‰

**ç½®æ›ã®å¤šæ®µéšå‡¦ç†**ï¼šğŸ”

```text title="å¤šæ®µéšç½®æ›ã®ä¾‹"
æœ€åˆã®å®šç¾©ï¼š
log_analytics_workspace_name = "law-management-$${starter_location_01}"

1å›ç›®ã®ç½®æ›ï¼ˆstarter_location_01 = "japaneast"ï¼‰ï¼š
log_analytics_workspace_name = "law-management-japaneast"

æœ€çµ‚çš„ãªå€¤ï¼š
"law-management-japaneast"
```

config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…¨ã¦ã®`$${...}`ã‚’å†å¸°çš„ã«ç½®æ›ã—ã¦ãã‚Œã‚‹ã€‚ğŸ¤–

---

## Part 2: main.management.tfã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ğŸ—ï¸

æ¬¡ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’è¦‹ã¦ã„ã“ã†ã€‚ğŸ‘€

### main.management.tfğŸ“

main.management.tfã‚’é–‹ã„ã¦ã¿ã‚ˆã†ã€‚

```hcl title="main.management.tfï¼ˆæŠœç²‹ï¼‰"
module "management_resources" {
  source = "./modules/management_resources"
  count  = var.management_resources_enabled ? 1 : 0

  enable_telemetry             = var.enable_telemetry
  management_resource_settings = local.management_resource_settings

  providers = {
    azurerm = azurerm.management
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

- **count**ï¼š`var.management_resources_enabled = true`ãªã‚‰ä½œæˆã€`false`ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
- **source**ï¼šãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«`./modules/management_resources`ã‚’å‘¼ã³å‡ºã—
- **management_resource_settings**ï¼šç½®æ›æ¸ˆã¿ã®è¨­å®šã‚’æ¸¡ã™ï¼ˆ`local.management_resource_settings`ï¼‰
- **providers**ï¼šç®¡ç†ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ç”¨

**countãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹•ä½œ**ï¼šğŸ”¢

```text title="countã«ã‚ˆã‚‹æ¡ä»¶ä»˜ãä½œæˆ"
var.management_resources_enabled = true
â†“
count = 1ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰

var.management_resources_enabled = false
â†“
count = 0ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚­ãƒƒãƒ—ï¼‰
```

---

### modules/management_resources/main.tfğŸ“

```hcl title="modules/management_resources/main.tf"
module "management_resources" {
  source                                                     = "Azure/avm-ptn-alz-management/azurerm"
  version                                                    = "0.9.0"
  automation_account_name                                    = null
  location                                                   = var.management_resource_settings.location
  log_analytics_workspace_name                               = coalesce(var.management_resource_settings.log_analytics_workspace_name, "law-management-${var.management_resource_settings.location}")
  resource_group_name                                        = coalesce(var.management_resource_settings.resource_group_name, "rg-management-${var.management_resource_settings.location}")
  data_collection_rules                                      = var.management_resource_settings.data_collection_rules
  enable_telemetry                                           = var.enable_telemetry
  linked_automation_account_creation_enabled                 = false
  log_analytics_solution_plans                               = var.management_resource_settings.log_analytics_solution_plans
  log_analytics_workspace_allow_resource_only_permissions    = var.management_resource_settings.log_analytics_workspace_allow_resource_only_permissions
  log_analytics_workspace_cmk_for_query_forced               = var.management_resource_settings.log_analytics_workspace_cmk_for_query_forced
  log_analytics_workspace_daily_quota_gb                     = var.management_resource_settings.log_analytics_workspace_daily_quota_gb
  log_analytics_workspace_internet_ingestion_enabled         = var.management_resource_settings.log_analytics_workspace_internet_ingestion_enabled
  log_analytics_workspace_internet_query_enabled             = var.management_resource_settings.log_analytics_workspace_internet_query_enabled
  log_analytics_workspace_local_authentication_enabled       = var.management_resource_settings.log_analytics_workspace_local_authentication_enabled
  log_analytics_workspace_reservation_capacity_in_gb_per_day = var.management_resource_settings.log_analytics_workspace_reservation_capacity_in_gb_per_day
  log_analytics_workspace_retention_in_days                  = var.management_resource_settings.log_analytics_workspace_retention_in_days
  log_analytics_workspace_sku                                = var.management_resource_settings.log_analytics_workspace_sku
  resource_group_creation_enabled                            = true
  sentinel_onboarding                                        = var.management_resource_settings.sentinel_onboarding
  tags                                                       = var.management_resource_settings.tags
  timeouts                                                   = var.management_resource_settings.timeouts
  user_assigned_managed_identities                           = var.management_resource_settings.user_assigned_managed_identities
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ã“ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«`Azure/avm-ptn-alz-management/azurerm`ã‚’å‘¼ã³å‡ºã—ã¦ã‚‹ã€‚

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**ï¼šğŸ’¡

1. **coalesceé–¢æ•°ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š**ï¼šâš™ï¸
   ```hcl
   log_analytics_workspace_name = coalesce(
     var.management_resource_settings.log_analytics_workspace_name,
     "law-management-${var.management_resource_settings.location}"
   )
   ```
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ã¦ã‚Œã°ã€ãã®å€¤ã‚’ä½¿ã†
   - æŒ‡å®šã—ã¦ãªã‘ã‚Œã°ã€è‡ªå‹•ç”Ÿæˆï¼ˆ`law-management-japaneast`ã¨ã‹ï¼‰

2. **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼**ï¼šğŸ¢
   ```hcl
   log_analytics_workspace_retention_in_days = var.management_resource_settings.log_analytics_workspace_retention_in_days
   ```
   - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å€¤ã‚’å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãã®ã¾ã¾æ¸¡ã™

3. **å›ºå®šå€¤ã®è¨­å®š**ï¼šğŸ”’
   ```hcl
   resource_group_creation_enabled            = true  # å¸¸ã«æ–°è¦RGä½œæˆ
   linked_automation_account_creation_enabled = false # Automation Accountã¯ä½œã‚‰ãªã„
   ```

---

### modules/management_resources/variables.tfğŸ“

```hcl title="modules/management_resources/variables.tf (æŠœç²‹)"
variable "management_resource_settings" {
  type = object({
    automation_account_name      = optional(string)
    location                     = string
    log_analytics_workspace_name = optional(string)
    resource_group_name          = optional(string)
    data_collection_rules = optional(object({
      change_tracking = object({
        enabled  = optional(bool, true)
        name     = string
        location = optional(string)
        tags     = optional(map(string))
      })
      vm_insights = object({
        enabled  = optional(bool, true)
        name     = string
        location = optional(string)
        tags     = optional(map(string))
      })
      defender_sql = object({
        enabled                                                = optional(bool, true)
        name                                                   = string
        location                                               = optional(string)
        tags                                                   = optional(map(string))
        enable_collection_of_sql_queries_for_security_research = optional(bool, false)
      })
    }))
    log_analytics_solution_plans = optional(list(object({
      product   = string
      publisher = optional(string)
    })))
    log_analytics_workspace_allow_resource_only_permissions    = optional(bool, true)
    log_analytics_workspace_cmk_for_query_forced               = optional(bool)
    log_analytics_workspace_daily_quota_gb                     = optional(number)
    log_analytics_workspace_internet_ingestion_enabled         = optional(bool, true)
    log_analytics_workspace_internet_query_enabled             = optional(bool, true)
    log_analytics_workspace_local_authentication_enabled       = optional(bool, true)
    log_analytics_workspace_reservation_capacity_in_gb_per_day = optional(number)
    log_analytics_workspace_retention_in_days                  = optional(number)
    log_analytics_workspace_sku                                = optional(string)
    sentinel_onboarding = optional(object({
      name                         = optional(string)
      customer_managed_key_enabled = optional(bool)
    }))
    tags = optional(map(string))
    timeouts = optional(object({
      sentinel_onboarding = optional(object({
        create = optional(string)
        delete = optional(string)
        update = optional(string)
        read   = optional(string)
      }))
      data_collection_rule = optional(object({
        create = optional(string)
        delete = optional(string)
        update = optional(string)
        read   = optional(string)
      }))
    }), {})
    user_assigned_managed_identities = optional(object({
      ama = object({
        enabled  = optional(bool)
        name     = string
        location = optional(string)
        tags     = optional(map(string))
      })
    }))
  })
  default     = null
  description = "The settings for the management resources..."
}

variable "enable_telemetry" {
  type        = bool
  default     = true
  description = "This variable controls whether or not telemetry is enabled..."
  nullable    = false
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

å—ã‘å–ã£ãŸè¨­å®šå€¤ã‚’å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™ãŸã‚ã®å¤‰æ•°å®šç¾©ã€‚å®Ÿéš›ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ã†ã®ã¯ä»¥ä¸‹ã®7ã¤ã®è¨­å®šã ã‘ã§ååˆ†ï¼š

- `location`ï¼šãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆå¿…é ˆï¼‰
- `log_analytics_workspace_name`ï¼šLog Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰
- `resource_group_name`ï¼šãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰
- `data_collection_rules`ï¼š3ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿åé›†ãƒ«ãƒ¼ãƒ«è¨­å®š
- `user_assigned_managed_identities`ï¼šAzure Monitor Agentç”¨ã®Managed Identityè¨­å®š

Log Analyticsã®è©³ç´°è¨­å®šï¼ˆ`log_analytics_workspace_*`ï¼‰ã‚„Sentinelè¨­å®šã¯ã€çœç•¥ã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§å‹•ä½œã™ã‚‹ã€‚


---

### modules/management_resources/outputs.tf

```hcl title="modules/management_resources/outputs.tf"
output "management_resources" {
  value       = module.management_resources
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«`module.management_resources`ã®å…¨ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ãã®ã¾ã¾æ¸¡ã—ã¦ã‚‹ï¼ˆãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼ï¼‰ã€‚

**å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰è¿”ã•ã‚Œã‚‹ä¸»ãªã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ**ï¼šğŸ“¤

- `log_analytics_workspace.id`ï¼šLog Analytics Workspaceã®ãƒªã‚½ãƒ¼ã‚¹ID
- `data_collection_rule_ids`ï¼š3ã¤ã®DCRã®ãƒªã‚½ãƒ¼ã‚¹ID
- `user_assigned_identity_ids`ï¼šManaged Identityã®ãƒªã‚½ãƒ¼ã‚¹ID
- `automation_account.id`ï¼šAutomation Accountã®ãƒªã‚½ãƒ¼ã‚¹IDï¼ˆä½œæˆæ™‚ï¼‰

ã“ã‚Œã‚‰ã‚’`main.management.tf`ã§å—ã‘å–ã£ã¦ã€ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã—ãŸã‚Šã€ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦å…¬é–‹ã—ãŸã‚Šã§ãã‚‹ã€‚

---

## Part 3: Azureå…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆAzure/avm-ptn-alz-management/azurerm v0.9.0ï¼‰ğŸ¢

ã•ã¦ã€ã“ã“ã‹ã‚‰ãŒæœ¬é¡Œã€‚`modules/management_resources/main.tf`ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…éƒ¨ã‚’è©³ã—ãè¦‹ã¦ã„ã“ã†ã€‚

**GitHubãƒªãƒã‚¸ãƒˆãƒª**ï¼šğŸ”—

https://github.com/Azure/terraform-azurerm-avm-ptn-alz-management/tree/v0.9.0


ã“ã“ã‹ã‚‰ã¯å…¬å¼ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ããªãŒã‚‰è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚GitHubã§ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’é–‹ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã¨ç…§ã‚‰ã—åˆã‚ã›ãªãŒã‚‰èª­ã‚€ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

---

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ§‹æˆğŸ—‚ï¸

```text title="å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ"
terraform-azurerm-avm-ptn-alz-management/
â”œâ”€â”€ main.tf                         # ãƒ¡ã‚¤ãƒ³ãƒªã‚½ãƒ¼ã‚¹å®šç¾©
â”œâ”€â”€ locals.tf                       # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°
â”œâ”€â”€ locals.data-collection-rules.tf # DCRå®šç¾©
â”œâ”€â”€ variables.tf                    # å…¥åŠ›å¤‰æ•°
â”œâ”€â”€ outputs.tf                      # å‡ºåŠ›å¤‰æ•°
â”œâ”€â”€ main.telemetry.tf               # ãƒ†ãƒ¬ãƒ¡ãƒˆãƒª
â”œâ”€â”€ main.deprecated.tf              # éæ¨å¥¨ãƒªã‚½ãƒ¼ã‚¹
â””â”€â”€ terraform.tf                    # Terraformè¨­å®š
```

**ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹**ï¼šğŸ› ï¸

- `azurerm_resource_group.management`ï¼šãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
- `azurerm_log_analytics_workspace.management`ï¼šLog Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
- `azurerm_automation_account.management`ï¼šAutomation Accountï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- `azurerm_log_analytics_linked_service.management`ï¼šLog Analyticsã¨Automation Accountã®ãƒªãƒ³ã‚¯
- `azurerm_log_analytics_solution.management`ï¼šLog Analyticsã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
- `azapi_resource.sentinel_onboarding`ï¼šSentinelæœ‰åŠ¹åŒ–
- `azurerm_user_assigned_identity.management`ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²ã‚Šå½“ã¦Managed Identity
- `azapi_resource.data_collection_rule`ï¼šData Collection Rulesï¼ˆ3ç¨®é¡ï¼‰

---

### main.tf ã®è©³ç´°ğŸ“

#### 1. Resource Groupä½œæˆğŸ—‚ï¸

```hcl title="ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ"
resource "azurerm_resource_group" "management" {
  count = var.resource_group_creation_enabled ? 1 : 0

  location = var.location
  name     = var.resource_group_name
  tags     = var.tags
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

- `count`ã§ä½œæˆã‚’åˆ¶å¾¡ï¼ˆ`resource_group_creation_enabled = true`ãªã‚‰ä½œæˆï¼‰
- `location`ã€`name`ã€`tags`ã‚’è¨­å®š

**countãƒ‘ã‚¿ãƒ¼ãƒ³**ï¼šğŸ”¢

```text title="countã«ã‚ˆã‚‹æ¡ä»¶ä»˜ãä½œæˆ"
resource_group_creation_enabled = true
â†“
count = 1ï¼ˆãƒªã‚½ãƒ¼ã‚¹ä½œæˆï¼‰

resource_group_creation_enabled = false
â†“
count = 0ï¼ˆãƒªã‚½ãƒ¼ã‚¹ä½œæˆã—ãªã„ãƒ»BYO Resource Groupï¼‰
```

#### 2. Log Analytics Workspaceä½œæˆğŸ“Š

```hcl title="Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆ"
resource "azurerm_log_analytics_workspace" "management" {
  count = var.log_analytics_workspace_creation_enabled ? 1 : 0

  location                           = var.location
  name                               = var.log_analytics_workspace_name
  resource_group_name                = local.resource_group_name
  allow_resource_only_permissions    = var.log_analytics_workspace_allow_resource_only_permissions
  cmk_for_query_forced               = var.log_analytics_workspace_cmk_for_query_forced
  daily_quota_gb                     = var.log_analytics_workspace_daily_quota_gb
  internet_ingestion_enabled         = var.log_analytics_workspace_internet_ingestion_enabled
  internet_query_enabled             = var.log_analytics_workspace_internet_query_enabled
  local_authentication_enabled       = var.log_analytics_workspace_local_authentication_enabled
  reservation_capacity_in_gb_per_day = var.log_analytics_workspace_reservation_capacity_in_gb_per_day
  retention_in_days                  = var.log_analytics_workspace_retention_in_days
  sku                                = var.log_analytics_workspace_sku
  tags                               = var.tags
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã‚‹ã€‚ç´„10å€‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã€‚

**é‡è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ï¼šğŸ’¡

- **retention_in_days**ï¼šãƒ­ã‚°ä¿æŒæœŸé–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30æ—¥ã€ãã‚Œä»¥ä¸Šã¯èª²é‡‘ï¼‰
- **daily_quota_gb**ï¼š1æ—¥ã®ãƒ­ã‚°å–ã‚Šè¾¼ã¿ä¸Šé™ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ï¼‰
- **sku**ï¼šæ–™é‡‘ãƒ—ãƒ©ãƒ³ï¼ˆ`PerGB2018`ãŒä¸€èˆ¬çš„ï¼‰
- **internet_ingestion_enabled**ï¼šã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã®ãƒ­ã‚°å–ã‚Šè¾¼ã¿è¨±å¯
- **local_authentication_enabled**ï¼šãƒ­ãƒ¼ã‚«ãƒ«èªè¨¼ã®æœ‰åŠ¹åŒ–

**local.resource_group_nameã®å‚ç…§**ï¼šğŸ”—

```hcl title="locals.tfã§å®šç¾©ã•ã‚ŒãŸå€¤"
locals {
  resource_group_name = var.resource_group_creation_enabled ? 
    azurerm_resource_group.management[0].name : 
    var.resource_group_name
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

- RGã‚’ä½œæˆã—ãŸå ´åˆï¼šä½œæˆã—ãŸRGã®åå‰ã‚’ä½¿ã†
- RGã‚’ä½œæˆã—ãªã„å ´åˆï¼ˆBYO RGï¼‰ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®åå‰ã‚’ä½¿ã†

#### 3. Automation Accountä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ğŸ¤–

```hcl title="Automation Accountã®ä½œæˆ"
resource "azurerm_automation_account" "management" {
  count = var.linked_automation_account_creation_enabled ? 1 : 0

  location                      = coalesce(var.automation_account_location, var.location)
  name                          = var.automation_account_name
  resource_group_name           = local.resource_group_name
  sku_name                      = var.automation_account_sku_name
  local_authentication_enabled  = var.automation_account_local_authentication_enabled
  public_network_access_enabled = var.automation_account_public_network_access_enabled
  tags                          = var.tags

  dynamic "encryption" {
    for_each = var.automation_account_encryption == null ? [] : ["Encryption"]

    content {
      key_vault_key_id          = var.automation_account_encryption.key_vault_key_id
      user_assigned_identity_id = var.automation_account_encryption.user_assigned_identity_id
    }
  }
  
  dynamic "identity" {
    for_each = var.automation_account_identity == null ? [] : ["Identity"]

    content {
      type         = var.automation_account_identity.type
      identity_ids = var.automation_account_identity.identity_ids
    }
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Automation Accountã‚’ä½œæˆã—ã¦ã‚‹ï¼ˆ`linked_automation_account_creation_enabled = true`ã®å ´åˆã®ã¿ï¼‰ã€‚

**Automation Accountã¨ã¯**ï¼šğŸ’¡

VMã®è‡ªå‹•ãƒ‘ãƒƒãƒé©ç”¨ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‚¿ã‚¹ã‚¯ã€æ§‹æˆç®¡ç†ãªã©ã®è‡ªå‹•åŒ–æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚

**ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯**ï¼šğŸ“

```hcl
linked_automation_account_creation_enabled = false
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹ã€‚å¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚

**coalesceã®ä½¿ã„æ–¹**ï¼šâš™ï¸

```hcl
location = coalesce(var.automation_account_location, var.location)
```

Automation Accountã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ¥æŒ‡å®šã§ãã‚‹ï¼ˆLog Analyticsã¨ç•°ãªã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«é…ç½®å¯èƒ½ï¼‰ã€‚

#### 4. Log Analytics Linked ServiceğŸ”—

```hcl title="Log Analyticsã¨Automation Accountã®ãƒªãƒ³ã‚¯"
resource "azurerm_log_analytics_linked_service" "management" {
  count = var.linked_automation_account_creation_enabled ? 1 : 0

  resource_group_name = local.resource_group_name
  workspace_id        = local.log_analytics_workspace_id
  read_access_id      = azurerm_automation_account.management[0].id
  write_access_id     = null
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¨Automation Accountã‚’ãƒªãƒ³ã‚¯ã—ã¦ã‚‹ã€‚

**ãƒªãƒ³ã‚¯ã®ç›®çš„**ï¼šğŸ’¡

- Automation Accountã‹ã‚‰Log Analyticsã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚ã‚‹
- Log Analyticsã®ã‚¯ã‚¨ãƒªçµæœã§Automation Runbookã‚’ãƒˆãƒªã‚¬ãƒ¼ã§ãã‚‹

#### 5. Log Analytics SolutionğŸ§©

```hcl title="Log Analyticsã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
resource "azurerm_log_analytics_solution" "management" {
  for_each = { for plan in toset(var.log_analytics_solution_plans) : 
    "${plan.publisher}/${plan.product}" => plan }

  location              = var.location
  resource_group_name   = local.resource_group_name
  solution_name         = basename(each.value.product)
  workspace_name        = local.log_analytics_workspace_name
  workspace_resource_id = local.log_analytics_workspace_id
  tags                  = var.tags

  plan {
    product   = each.value.product
    publisher = each.value.publisher
  }

  depends_on = [
    azurerm_log_analytics_linked_service.management,
  ]
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Log Analyticsã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆContainerInsightsã€VMInsightsãªã©ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‹ã€‚

**for_eachã®ä»•çµ„ã¿**ï¼šğŸ”

```text title="ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼"
log_analytics_solution_plans = [
  { product = "OMSGallery/ContainerInsights", publisher = "Microsoft" },
  { product = "OMSGallery/VMInsights", publisher = "Microsoft" }
]
â†“
for_each = {
  "Microsoft/OMSGallery/ContainerInsights" => { ... },
  "Microsoft/OMSGallery/VMInsights" => { ... }
}
â†“
2ã¤ã®azurerm_log_analytics_solutionãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹
```

**depends_on**ï¼šğŸ”—

Log Analytics Linked ServiceãŒä½œæˆã•ã‚ŒãŸå¾Œã«ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

#### 6. Sentinel OnboardingğŸ›¡ï¸

```hcl title="Sentinelã®æœ‰åŠ¹åŒ–"
resource "azapi_resource" "sentinel_onboarding" {
  count = var.sentinel_onboarding != null ? 1 : 0

  name      = var.sentinel_onboarding.name
  parent_id = local.log_analytics_workspace_id
  type      = "Microsoft.SecurityInsights/onboardingStates@2024-03-01"
  
  body = {
    properties = {
      customerManagedKey = var.sentinel_onboarding.customer_managed_key_enabled
    }
  }
  
  create_headers = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  delete_headers = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  read_headers   = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  update_headers = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null

  timeouts {
    create = var.timeouts.sentinel_onboarding.create
    delete = var.timeouts.sentinel_onboarding.delete
    read   = var.timeouts.sentinel_onboarding.read
    update = var.timeouts.sentinel_onboarding.update
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Microsoft Sentinelï¼ˆSIEM/SOARï¼‰ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã‚‹ã€‚

**Sentinelã¨ã¯**ï¼šğŸ’¡

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ã¨ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ï¼ˆSIEMï¼‰ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è‡ªå‹•å¿œç­”ï¼ˆSOARï¼‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒ¼ãƒ“ã‚¹ã€‚

**azapi_resourceã®ä½¿ç”¨ç†ç”±**ï¼šğŸ“

Sentinelã®æ–°ã—ã„onboardingStates APIã¯ã€ã¾ã azurermãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„ãŸã‚ã€azapiãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ã£ã¦ã‚‹ã€‚

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**ï¼šâ±ï¸

```hcl
timeouts {
  create = var.timeouts.sentinel_onboarding.create  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
  delete = var.timeouts.sentinel_onboarding.delete  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
  read   = var.timeouts.sentinel_onboarding.read    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
  update = var.timeouts.sentinel_onboarding.update  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
}
```

Sentinelã®æœ‰åŠ¹åŒ–ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã€‚

#### 7. User Assigned Managed IdentityğŸ†”

```hcl title="Managed Identityã®ä½œæˆ"
resource "azurerm_user_assigned_identity" "management" {
  for_each = local.user_assigned_managed_identities

  location            = each.value.location
  name                = each.value.name
  resource_group_name = local.resource_group_name
  tags                = each.value.tags
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²ã‚Šå½“ã¦Managed Identityã‚’ä½œæˆã—ã¦ã‚‹ã€‚

**for_eachã®ä»•çµ„ã¿**ï¼šğŸ”

```text title="Managed Identityã®ä½œæˆãƒ•ãƒ­ãƒ¼"
user_assigned_managed_identities = {
  ama = {
    name = "id-ama-japaneast"
  }
}
â†“
local.user_assigned_managed_identities = {
  "ama" => {
    name     = "id-ama-japaneast",
    location = "japaneast",
    tags     = { ... }
  }
}
â†“
azurerm_user_assigned_identity.management["ama"] ãŒä½œæˆã•ã‚Œã‚‹
```

#### 8. Data Collection RulesğŸ“¦

```hcl title="Data Collection Ruleã®ä½œæˆ"
resource "azapi_resource" "data_collection_rule" {
  for_each = local.data_collection_rules

  location                  = each.value.location
  name                      = each.value.name
  parent_id                 = local.resource_group_resource_id
  type                      = each.value.type
  body                      = each.value.body
  create_headers            = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  delete_headers            = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  read_headers              = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null
  schema_validation_enabled = each.value.schema_validation_enabled
  tags                      = each.value.tags
  update_headers            = var.enable_telemetry ? { "User-Agent" : local.avm_azapi_header } : null

  timeouts {
    create = var.timeouts.data_collection_rule.create
    delete = var.timeouts.data_collection_rule.delete
    read   = var.timeouts.data_collection_rule.read
    update = var.timeouts.data_collection_rule.update
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Data Collection Rulesï¼ˆDCRï¼‰ã‚’ä½œæˆã—ã¦ã‚‹ã€‚azapi_resourceã‚’ä½¿ç”¨ï¼ˆazurermãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã¾ã å®Œå…¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„ãŸã‚ï¼‰ã€‚

**for_eachã§3ç¨®é¡ã®DCRã‚’ä½œæˆ**ï¼šğŸ”

- `change_tracking`ï¼šå¤‰æ›´è¿½è·¡
- `vm_insights`ï¼šVMãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
- `defender_sql`ï¼šSQL Serverã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**local.data_collection_rulesã®å®šç¾©**ï¼šğŸ“

`locals.data-collection-rules.tf`ã§å®šç¾©ã•ã‚Œã¦ã‚‹ï¼ˆå¾Œè¿°ï¼‰ã€‚

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**ï¼šâ±ï¸

```hcl
timeouts {
  create = var.timeouts.data_collection_rule.create  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
  delete = var.timeouts.data_collection_rule.delete  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10åˆ†
  read   = var.timeouts.data_collection_rule.read    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
  update = var.timeouts.data_collection_rule.update  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
}
```

DCRã®ä½œæˆãƒ»å‰Šé™¤ã«ã‚‚æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã€‚

---

### locals.tf ã®è©³ç´°ğŸ“

```hcl title="ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å®šç¾©"
locals {
  resource_group_name        = var.resource_group_creation_enabled ? 
    azurerm_resource_group.management[0].name : 
    var.resource_group_name
  resource_group_resource_id = var.resource_group_creation_enabled ? 
    azurerm_resource_group.management[0].id : 
    provider::azapi::build_resource_id(
      "/subscriptions/${data.azapi_client_config.current.subscription_id}", 
      "Microsoft.Resources/resourceGroups", 
      var.resource_group_name
    )
}

locals {
  log_analytics_workspace_id   = var.log_analytics_workspace_creation_enabled ? 
    azurerm_log_analytics_workspace.management[0].id : 
    var.log_analytics_workspace_id
  log_analytics_workspace_name = var.log_analytics_workspace_creation_enabled ? 
    azurerm_log_analytics_workspace.management[0].name : 
    provider::azapi::parse_resource_id(
      "Microsoft.OperationalInsights/workspaces", 
      var.log_analytics_workspace_id
    ).name
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¨Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®åå‰ã¨IDã‚’ã€ä½œæˆã—ãŸå ´åˆã¨æ—¢å­˜ã‚’ä½¿ã†å ´åˆã§åˆ‡ã‚Šæ›¿ãˆã¦ã‚‹ã€‚

**BYOãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆBring Your Ownï¼‰**ï¼šğŸ’¡

```text title="BYOãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ•ãƒ­ãƒ¼"
resource_group_creation_enabled = false
â†“
count = 0ï¼ˆRGä½œæˆã—ãªã„ï¼‰
â†“
local.resource_group_name = var.resource_group_nameï¼ˆæ—¢å­˜RGåã‚’ä½¿ã†ï¼‰
â†“
local.resource_group_resource_id = provider::azapi::build_resource_id(...)ï¼ˆRG IDã‚’æ§‹ç¯‰ï¼‰
```

---

### locals.data-collection-rules.tf ã®è©³ç´°ğŸ“

#### Change Tracking DCRğŸ”

```hcl title="Change Tracking DCRã®å®šç¾©ï¼ˆä¸€éƒ¨æŠœç²‹ï¼‰"
locals {
  data_collection_rule_change_tracking = var.data_collection_rules.change_tracking.enabled ? {
    change_tracking = {
      name                      = var.data_collection_rules.change_tracking.name
      type                      = "Microsoft.Insights/dataCollectionRules@2021-04-01"
      parent_id                 = local.resource_group_resource_id
      location                  = var.data_collection_rules.change_tracking.location == null ? 
        var.location : 
        var.data_collection_rules.change_tracking.location
      schema_validation_enabled = true
      tags                      = var.data_collection_rules.change_tracking.tags == null ? 
        var.tags : 
        var.data_collection_rules.change_tracking.tags
      body = {
        properties = {
          description = "Data collection rule for CT"
          dataSources = {
            extensions = [
              {
                streams = [
                  "Microsoft-ConfigurationChange",
                  "Microsoft-ConfigurationChangeV2",
                  "Microsoft-ConfigurationData"
                ]
                extensionName = "ChangeTracking-Windows"
                extensionSettings = {
                  enableFiles     = true
                  enableSoftware  = true
                  enableRegistry  = true
                  enableServices  = true
                  enableInventory = true
                  # ...è©³ç´°ãªè¨­å®š
                }
                name = "CTDataSource-Windows"
              },
              {
                # Linuxã®è¨­å®šã‚‚åŒæ§˜
                extensionName = "ChangeTracking-Linux"
                # ...
              }
            ]
          }
          destinations = {
            logAnalytics = [
              {
                name                = "Microsoft-CT-Dest"
                workspaceResourceId = local.log_analytics_workspace_id
              }
            ]
          }
          dataFlows = [
            {
              streams = [
                "Microsoft-ConfigurationChange",
                "Microsoft-ConfigurationChangeV2",
                "Microsoft-ConfigurationData"
              ]
              destinations = ["Microsoft-CT-Dest"]
            }
          ]
        }
      }
    }
  } : {}
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Change Tracking DCRã®è©³ç´°å®šç¾©ã‚’ã—ã¦ã‚‹ã€‚

**æ§‹æˆè¦ç´ **ï¼šğŸ§©

1. **dataSources**ï¼šã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ã‹

- `extensions`ï¼šChangeTracking-Windowsã¨ChangeTracking-Linuxæ‹¡å¼µæ©Ÿèƒ½
- `streams`ï¼šåé›†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆè¨­å®šå¤‰æ›´ã€ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã€ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ï¼‰
- `extensionSettings`ï¼šä½•ã‚’ç›£è¦–ã™ã‚‹ã‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã€ã‚µãƒ¼ãƒ“ã‚¹ï¼‰

2. **destinations**ï¼šãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡å…ˆ

- `logAnalytics`ï¼šLog Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹

3. **dataFlows**ï¼šãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ

- ã©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã©ã®é€ä¿¡å…ˆã«é€ã‚‹ã‹

#### VM Insights DCRğŸ“ˆ

```hcl title="VM Insights DCRã®å®šç¾©ï¼ˆä¸€éƒ¨æŠœç²‹ï¼‰"
locals {
  data_collection_rule_vm_insights = var.data_collection_rules.vm_insights.enabled ? {
    vm_insights = {
      name                      = var.data_collection_rules.vm_insights.name
      parent_id                 = local.resource_group_resource_id
      type                      = "Microsoft.Insights/dataCollectionRules@2021-04-01"
      location                  = var.data_collection_rules.vm_insights.location == null ? 
        var.location : 
        var.data_collection_rules.vm_insights.location
      schema_validation_enabled = false  # VM Insightsã¯è¤‡é›‘ãªãŸã‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹
      tags                      = var.data_collection_rules.vm_insights.tags == null ? 
        var.tags : 
        var.data_collection_rules.vm_insights.tags
      body = {
        properties = {
          description = "Data collection rule for VM Insights."
          dataSources = {
            performanceCounters = [
              {
                name = "VMInsightsPerfCounters"
                streams = [
                  "Microsoft-InsightsMetrics"
                ]
                scheduledTransferPeriod    = "PT1M"
                samplingFrequencyInSeconds = 60
                counterSpecifiers = [
                  "\\VmInsights\\DetailedMetrics"
                ]
              }
            ]
            extensions = [
              {
                streams = [
                  "Microsoft-ServiceMap"
                ]
                extensionName     = "DependencyAgent"
                extensionSettings = {}
                name              = "DependencyAgentDataSource"
              }
            ]
          }
          destinations = {
            logAnalytics = [
              {
                workspaceResourceId = local.log_analytics_workspace_id
                name                = "VMInsightsPerf-Logs-Dest"
              }
            ]
          }
          dataFlows = [
            {
              streams = [
                "Microsoft-InsightsMetrics"
              ]
              destinations = [
                "VMInsightsPerf-Logs-Dest"
              ]
            },
            {
              streams = [
                "Microsoft-ServiceMap"
              ]
              destinations = [
                "VMInsightsPerf-Logs-Dest"
              ]
            }
          ]
        }
      }
    }
  } : {}
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

VM Insights DCRã®è©³ç´°å®šç¾©ã‚’ã—ã¦ã‚‹ã€‚

**æ§‹æˆè¦ç´ **ï¼šğŸ§©

1. **performanceCounters**ï¼šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åé›†

- `samplingFrequencyInSeconds = 60`ï¼š60ç§’ã”ã¨ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
- `counterSpecifiers`ï¼šè©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹

2. **extensions**ï¼šDependencyAgentæ‹¡å¼µæ©Ÿèƒ½

- VMã®ä¾å­˜é–¢ä¿‚ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’è¿½è·¡

3. **dataFlows**ï¼š2ã¤ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ 

- `Microsoft-InsightsMetrics`ï¼šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- `Microsoft-ServiceMap`ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿

#### Defender for SQL DCRğŸ›¡ï¸

```hcl title="Defender for SQL DCRã®å®šç¾©ï¼ˆä¸€éƒ¨æŠœç²‹ï¼‰"
locals {
  data_collection_rule_defender_sql = var.data_collection_rules.defender_sql.enabled ? {
    defender_sql = {
      name                      = var.data_collection_rules.defender_sql.name
      parent_id                 = local.resource_group_resource_id
      type                      = "Microsoft.Insights/dataCollectionRules@2021-04-01"
      location                  = var.data_collection_rules.defender_sql.location == null ? 
        var.location : 
        var.data_collection_rules.defender_sql.location
      schema_validation_enabled = true
      tags                      = var.data_collection_rules.defender_sql.tags == null ? 
        var.tags : 
        var.data_collection_rules.defender_sql.tags
      body = {
        properties = {
          description = "Data collection rule for Defender for SQL."
          dataSources = {
            extensions = [
              {
                extensionName = "MicrosoftDefenderForSQL"
                name          = "MicrosoftDefenderForSQL"
                streams = [
                  "Microsoft-DefenderForSqlAlerts",
                  "Microsoft-DefenderForSqlLogins",
                  "Microsoft-DefenderForSqlTelemetry",
                  "Microsoft-DefenderForSqlScanEvents",
                  "Microsoft-DefenderForSqlScanResults",
                  "Microsoft-SqlAtpStatus-DefenderForSql"
                ]
                extensionSettings = {
                  enableCollectionOfSqlQueriesForSecurityResearch = 
                    var.data_collection_rules.defender_sql.enable_collection_of_sql_queries_for_security_research
                }
              }
            ]
          }
          destinations = {
            logAnalytics = [
              {
                workspaceResourceId = local.log_analytics_workspace_id
                name                = "LogAnalyticsDest"
              }
            ]
          }
          dataFlows = [
            {
              streams = [
                "Microsoft-DefenderForSqlAlerts",
                "Microsoft-DefenderForSqlLogins",
                "Microsoft-DefenderForSqlTelemetry",
                "Microsoft-DefenderForSqlScanEvents",
                "Microsoft-DefenderForSqlScanResults",
                "Microsoft-SqlAtpStatus-DefenderForSql"
              ]
              destinations = [
                "LogAnalyticsDest"
              ]
            }
          ]
        }
      }
    }
  } : {}
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Defender for SQL DCRã®è©³ç´°å®šç¾©ã‚’ã—ã¦ã‚‹ã€‚

**æ§‹æˆè¦ç´ **ï¼šğŸ§©

1. **extensions**ï¼šMicrosoftDefenderForSQLæ‹¡å¼µæ©Ÿèƒ½

- SQL Serverã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†

2. **streams**ï¼š6ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ 

- `DefenderForSqlAlerts`ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ
- `DefenderForSqlLogins`ï¼šãƒ­ã‚°ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
- `DefenderForSqlTelemetry`ï¼šãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿
- `DefenderForSqlScanEvents`ï¼šè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
- `DefenderForSqlScanResults`ï¼šã‚¹ã‚­ãƒ£ãƒ³çµæœ
- `SqlAtpStatus-DefenderForSql`ï¼šAdvanced Threat Protectionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

3. **extensionSettings**ï¼šSQLã‚¯ã‚¨ãƒªåé›†ã®æœ‰åŠ¹åŒ–

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç ”ç©¶ç”¨ã«SQLã‚¯ã‚¨ãƒªã‚’åé›†ã™ã‚‹ã‹ã©ã†ã‹

#### DCRã®ãƒãƒ¼ã‚¸ğŸ”€

```hcl title="3ã¤ã®DCRã‚’ãƒãƒ¼ã‚¸"
locals {
  data_collection_rules = merge(
    local.data_collection_rule_change_tracking,
    local.data_collection_rule_defender_sql,
    local.data_collection_rule_vm_insights
  )
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

3ã¤ã®DCRå®šç¾©ã‚’ãƒãƒ¼ã‚¸ã—ã¦ã€`local.data_collection_rules`ã‚’ä½œæˆã—ã¦ã‚‹ã€‚

**ãƒãƒ¼ã‚¸ã®çµæœ**ï¼šğŸ’¡

```text title="ãƒãƒ¼ã‚¸ã•ã‚ŒãŸDCR"
local.data_collection_rules = {
  change_tracking = { ... },  # æœ‰åŠ¹ãªã‚‰å®šç¾©ã€ç„¡åŠ¹ãªã‚‰çœç•¥
  defender_sql = { ... },     # æœ‰åŠ¹ãªã‚‰å®šç¾©ã€ç„¡åŠ¹ãªã‚‰çœç•¥
  vm_insights = { ... }       # æœ‰åŠ¹ãªã‚‰å®šç¾©ã€ç„¡åŠ¹ãªã‚‰çœç•¥
}
```

ã“ã‚Œã‚’`for_each`ã§å›ã—ã¦ã€æœ‰åŠ¹ãªDCRã ã‘ä½œæˆã™ã‚‹ã€‚

---

### variables.tf ã®è©³ç´°ğŸ“

ä¸»è¦ãªå¤‰æ•°ã‚’è¦‹ã¦ã„ã“ã†ã€‚ğŸ‘€

#### locationğŸ“

```hcl title="locationã®å®šç¾©"
variable "location" {
  type        = string
  description = "The Azure region where the resources will be deployed."
  nullable    = false
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹å¿…é ˆå¤‰æ•°ã€‚`nullable = false`ã§å¿…é ˆåŒ–ã€‚

#### resource_group_nameğŸ—‚ï¸

```hcl title="resource_group_nameã®å®šç¾©"
variable "resource_group_name" {
  type        = string
  description = "The name of the Azure Resource Group where the resources will be created."
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—åã‚’æŒ‡å®šã™ã‚‹å¿…é ˆå¤‰æ•°ã€‚

#### log_analytics_workspace_nameğŸ“Š

```hcl title="log_analytics_workspace_nameã®å®šç¾©"
variable "log_analytics_workspace_name" {
  type        = string
  default     = null
  description = "The name of the Log Analytics Workspace to create."

  validation {
    condition = (
      var.log_analytics_workspace_creation_enabled == false ||
      (var.log_analytics_workspace_creation_enabled == true && var.log_analytics_workspace_name != null)
    )
    error_message = "You must supply a value for log_analytics_workspace_name when log_analytics_workspace_creation_enabled is true."
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åã‚’æŒ‡å®šã™ã‚‹å¤‰æ•°ã€‚`validation`ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã‚‹ã€‚

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯**ï¼šğŸ§ª

```text title="ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œ"
log_analytics_workspace_creation_enabled = true
ã‹ã¤
log_analytics_workspace_name = null
â†“
ã‚¨ãƒ©ãƒ¼ï¼šã€Œåå‰ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€

log_analytics_workspace_creation_enabled = false
â†“
OKï¼ˆBYOãƒ¢ãƒ¼ãƒ‰ãªã®ã§åå‰ä¸è¦ï¼‰
```

#### data_collection_rulesğŸ“¦

```hcl title="data_collection_rulesã®å®šç¾©"
variable "data_collection_rules" {
  type = object({
    change_tracking = object({
      enabled  = optional(bool, true)
      name     = string
      location = optional(string, null)
      tags     = optional(map(string), null)
    })
    vm_insights = object({
      enabled  = optional(bool, true)
      name     = string
      location = optional(string, null)
      tags     = optional(map(string), null)
    })
    defender_sql = object({
      enabled                                                = optional(bool, true)
      name                                                   = string
      location                                               = optional(string, null)
      tags                                                   = optional(map(string), null)
      enable_collection_of_sql_queries_for_security_research = optional(bool, false)
    })
  })
  default = {
    change_tracking = {
      name = "dcr-change-tracking"
    }
    vm_insights = {
      name = "dcr-vm-insights"
    }
    defender_sql = {
      name = "dcr-defender-sql"
    }
  }
  description = <<DESCRIPTION
Enables customisation of the data collection rules for Azure Monitor.
This is an object with attributes pertaining to the three DCRs that are created by this module.

Each object has the following attributes:

- enabled (Optional) - Whether or not to create the data collection rule. Defaults to `true`.
- name (Required) - The name of the data collection rule. For the default values, see the default variable value.
- location (Optional) - The Azure region of the data collection rule. Defaults to the value of the location variable.
- tags (Optional) - A map of tags to apply to the data collection rule. Defaults to `null`.

The defender_sql object has an additional attribute:

- enable_collection_of_sql_queries_for_security_research (Optional) - Whether or not to enable collection of SQL queries for security research. Defaults to `false`.
DESCRIPTION
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

3ç¨®é¡ã®DCRã®è¨­å®šã‚’å®šç¾©ã—ã¦ã‚‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚‚è¨­å®šæ¸ˆã¿ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ä»•çµ„ã¿**ï¼šğŸ’¡

```text title="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®é©ç”¨"
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãªã„å ´åˆï¼š
â†“
default = {
  change_tracking = { name = "dcr-change-tracking" },
  vm_insights = { name = "dcr-vm-insights" },
  defender_sql = { name = "dcr-defender-sql" }
}
â†“
enabled = trueï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ãªã®ã§ã€ã™ã¹ã¦ä½œæˆã•ã‚Œã‚‹
```

#### log_analytics_workspace_retention_in_daysâ³

```hcl title="log_analytics_workspace_retention_in_daysã®å®šç¾©"
variable "log_analytics_workspace_retention_in_days" {
  type        = number
  default     = 30
  description = "The number of days to retain data for the Log Analytics Workspace."
  nullable    = false
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ãƒ­ã‚°ä¿æŒæœŸé–“ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30æ—¥ã«è¨­å®šã—ã¦ã‚‹ã€‚

**ã‚³ã‚¹ãƒˆ**ï¼šğŸ’°

- 30æ—¥ã¾ã§ï¼šç„¡æ–™
- 31æ—¥ä»¥é™ï¼šç´„15å††/GB/æœˆã®è¿½åŠ èª²é‡‘

#### log_analytics_workspace_skuğŸ·ï¸

```hcl title="log_analytics_workspace_skuã®å®šç¾©"
variable "log_analytics_workspace_sku" {
  type        = string
  default     = "PerGB2018"
  description = "The SKU to use for the Log Analytics Workspace."
  nullable    = false
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ`PerGB2018`ï¼ˆå¾“é‡èª²é‡‘ï¼‰ã«è¨­å®šã—ã¦ã‚‹ã€‚

**SKUã®ç¨®é¡**ï¼šğŸ§©

- `PerGB2018`ï¼šå¾“é‡èª²é‡‘ï¼ˆç´„500å††/GBï¼‰
- `CapacityReservation`ï¼šã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆï¼ˆ100GB/æ—¥ã‹ã‚‰ã€å‰²å¼•ç‡ã‚ã‚Šï¼‰

#### timeoutsâ±ï¸

```hcl title="timeoutsã®å®šç¾©"
variable "timeouts" {
  type = object({
    sentinel_onboarding = optional(object({
      create = optional(string, "5m")
      delete = optional(string, "5m")
      update = optional(string, "5m")
      read   = optional(string, "5m")
      }), {}
    )
    data_collection_rule = optional(object({
      create = optional(string, "5m")
      delete = optional(string, "10m")
      update = optional(string, "5m")
      read   = optional(string, "5m")
      }), {}
    )
  })
  default     = {}
  description = <<DESCRIPTION
A map of timeouts to apply to the creation and destruction of resources.
If using retry, the maximum elapsed retry time is governed by this value.
DESCRIPTION
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**ğŸ”

ãƒªã‚½ãƒ¼ã‚¹ä½œæˆãƒ»å‰Šé™¤ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’è¨­å®šã—ã¦ã‚‹ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**ï¼šğŸ’¡

- Sentinelä½œæˆï¼š5åˆ†
- DCRä½œæˆï¼š5åˆ†
- DCRå‰Šé™¤ï¼š10åˆ†ï¼ˆå‰Šé™¤ã¯ä½œæˆã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰

æœ¬ç•ªç’°å¢ƒã§ã¯ã€å¿…è¦ã«å¿œã˜ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ã§ãã‚‹ã€‚

---

### outputs.tf ã®è©³ç´°

```hcl title="ä¸»è¦ãªã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ"
output "automation_account" {
  description = "A curated output of the Azure Automation Account."
  value = {
    dsc_server_endpoint = try(azurerm_automation_account.management[0].dsc_server_endpoint, null)
    hybrid_service_url  = try(azurerm_automation_account.management[0].hybrid_service_url, null)
    id                  = try(azurerm_automation_account.management[0].id, null)
    name                = try(azurerm_automation_account.management[0].name, null)
    identity = {
      tenant_id    = try(azurerm_automation_account.management[0].identity[0].tenant_id, null)
      principal_id = try(azurerm_automation_account.management[0].identity[0].principal_id, null)
    }
  }
}

output "data_collection_rule_ids" {
  description = "Data Collection Rule Resource Ids."
  value = { for key, value in azapi_resource.data_collection_rule : key => {
    id = value.id
    }
  }
}

output "log_analytics_workspace" {
  description = "A curated output of the Log Analytics Workspace."
  value = {
    id           = try(azurerm_log_analytics_workspace.management[0].id, null)
    name         = try(azurerm_log_analytics_workspace.management[0].name, null)
    workspace_id = try(azurerm_log_analytics_workspace.management[0].workspace_id, null)
  }
}

output "resource_group" {
  description = "A curated output of the Azure Resource Group."
  value = {
    id   = local.resource_group_resource_id
    name = local.resource_group_name
  }
}

output "user_assigned_identity_ids" {
  description = "User assigned identity IDs."
  value = { for key, value in azurerm_user_assigned_identity.management : key => {
    id = value.id
    }
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®é‡è¦ãªæƒ…å ±ã‚’ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã—ã¦ã‚‹ã€‚

**ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã®ä½¿ã„é“**ï¼š

1. **ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®å…¥åŠ›**ï¼š
   ```hcl
   # ãƒãƒªã‚·ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«Log Analytics IDã‚’æ¸¡ã™
   log_analytics_workspace_id = module.management_resources.log_analytics_workspace.id
   ```

2. **ãƒãƒªã‚·ãƒ¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¸ã®åŸ‹ã‚è¾¼ã¿**ï¼š
   ```hcl
   policy_default_values = {
     log_analytics_workspace_id = "$${log_analytics_workspace_id}"
   }
   ```

3. **ç¢ºèªç”¨**ï¼š
   ```bash
   terraform output management_resources
   ```

---

## Part 4: å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³ğŸ—ºï¸

```text title="ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®å®Œå…¨ãƒ•ãƒ­ãƒ¼"
platform-landing-zone.auto.tfvars
â†“
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  data_collection_rules = { ... $${dcr_xxx_name} ... }
  user_assigned_managed_identities = { ama = { name = "$${ama_user_assigned_managed_identity_name}" } }
}
â†“
config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ$${...}ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›ï¼‰
â†“
locals.tfï¼ˆlocals.management_resource_settingsä½œæˆï¼‰
  location = "japaneast"
  log_analytics_workspace_name = "law-management-japaneast"
  resource_group_name = "rg-management-japaneast"
  data_collection_rules = { change_tracking = { name = "dcr-change-tracking-japaneast" }, ... }
  user_assigned_managed_identities = { ama = { name = "id-ama-japaneast" } }
â†“
main.management.tf
  module "management_resources" {
    source = "./modules/management_resources"
    management_resource_settings = local.management_resource_settings
  }
â†“
modules/management_resources/main.tf
  module "management_resources" {
    source  = "Azure/avm-ptn-alz-management/azurerm"
    version = "0.9.0"
    location = var.management_resource_settings.location
    log_analytics_workspace_name = coalesce(var.management_resource_settings.log_analytics_workspace_name, "...")
    ...ï¼ˆç´„25å€‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
  }
â†“
Azure/avm-ptn-alz-management/azurerm v0.9.0
  â”œâ”€â”€ main.tf
  â”‚     â”œâ”€â”€ resource "azurerm_resource_group" "management"
  â”‚     â”œâ”€â”€ resource "azurerm_log_analytics_workspace" "management"
  â”‚     â”œâ”€â”€ resource "azurerm_automation_account" "management"ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  â”‚     â”œâ”€â”€ resource "azurerm_log_analytics_linked_service" "management"ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  â”‚     â”œâ”€â”€ resource "azurerm_log_analytics_solution" "management"
  â”‚     â”œâ”€â”€ resource "azapi_resource" "sentinel_onboarding"ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  â”‚     â”œâ”€â”€ resource "azurerm_user_assigned_identity" "management"
  â”‚     â””â”€â”€ resource "azapi_resource" "data_collection_rule"
  â”œâ”€â”€ locals.tf
  â”‚     â”œâ”€â”€ local.resource_group_nameï¼ˆä½œæˆ or BYOï¼‰
  â”‚     â”œâ”€â”€ local.log_analytics_workspace_idï¼ˆä½œæˆ or BYOï¼‰
  â”‚     â””â”€â”€ local.user_assigned_managed_identitiesï¼ˆå±•é–‹ï¼‰
  â””â”€â”€ locals.data-collection-rules.tf
        â”œâ”€â”€ local.data_collection_rule_change_trackingï¼ˆå¤‰æ›´è¿½è·¡DCRï¼‰
        â”œâ”€â”€ local.data_collection_rule_vm_insightsï¼ˆVMãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹DCRï¼‰
        â”œâ”€â”€ local.data_collection_rule_defender_sqlï¼ˆSQL SecurityDCRï¼‰
        â””â”€â”€ local.data_collection_rulesï¼ˆ3ã¤ã‚’ãƒãƒ¼ã‚¸ï¼‰
â†“
ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼š
  - rg-management-japaneastï¼ˆResource Groupï¼‰
  - law-management-japaneastï¼ˆLog Analytics Workspaceï¼‰
  - dcr-change-tracking-japaneastï¼ˆChange Tracking DCRï¼‰
  - dcr-vm-insights-japaneastï¼ˆVM Insights DCRï¼‰
  - dcr-defender-sql-japaneastï¼ˆDefender for SQL DCRï¼‰
  - id-ama-japaneastï¼ˆUser Assigned Managed Identityï¼‰
  - OMSGallery/ContainerInsightsï¼ˆLog Analytics Solutionï¼‰
â†“
outputs.tfï¼ˆã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼‰
  - log_analytics_workspace.id
  - data_collection_rule_ids
  - user_assigned_identity_ids
  - resource_group.id
â†“
ãƒãƒªã‚·ãƒ¼ã«æ¸¡ã•ã‚Œã‚‹
  policy_default_values = {
    log_analytics_workspace_id = <Log Analytics ID>
    ama_change_tracking_data_collection_rule_id = <Change Tracking DCR ID>
    ama_user_assigned_managed_identity_id = <Managed Identity ID>
  }
```

**å…¨ä½“ã®æµã‚Œ**ï¼šğŸ”„

1. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**ï¼š`platform-landing-zone.auto.tfvars`ã§`$${å¤‰æ•°å}`å½¢å¼ã§è¨­å®š
2. **å¤‰æ•°ç½®æ›**ï¼š`config-templating`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ`$${...}`ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
3. **ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°**ï¼š`locals.tf`ã§`local.management_resource_settings`ä½œæˆ
4. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—**ï¼š`main.management.tf`ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—
5. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ï¼š`modules/management_resources/`ã‹ã‚‰å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—
6. **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ï¼š`Azure/avm-ptn-alz-management`ã§å®Ÿãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
7. **ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ**ï¼šä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹IDã‚’ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ
8. **ãƒãƒªã‚·ãƒ¼é€£æº**ï¼šãƒãƒªã‚·ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«åŸ‹ã‚è¾¼ã¿

---

## Part 5: å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³ğŸ§‘â€ğŸ’»

tfvars(è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)ã‚’å¤‰æ›´ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ğŸ“

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ­ã‚°ä¿æŒæœŸé–“ã®å¤‰æ›´

```hcl title="90æ—¥ä¿ç®¡ã«å¤‰æ›´"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  log_analytics_workspace_retention_in_days = 90  # â†è¿½åŠ 
  
  user_assigned_managed_identities = { ... }
  data_collection_rules = { ... }
}
```

**ã‚³ã‚¹ãƒˆè©¦ç®—**ï¼š

```text title="ä¿æŒæœŸé–“ã¨ã‚³ã‚¹ãƒˆ"
30æ—¥ï¼šç„¡æ–™
90æ—¥ï¼šç´„15å††/GB Ã— (90 - 30) = ç´„900å††/GBï¼ˆè¿½åŠ 60æ—¥åˆ†ï¼‰
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: DCRã®é¸æŠçš„æœ‰åŠ¹åŒ–

```hcl title="Defender for SQLã‚’ç„¡åŠ¹åŒ–"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  data_collection_rules = {
    change_tracking = { name = "$${dcr_change_tracking_name}" }
    vm_insights     = { name = "$${dcr_vm_insights_name}" }
    defender_sql    = {  # â†ç„¡åŠ¹åŒ–
      enabled = false
      name    = "$${dcr_defender_sql_name}"
    }
  }
  
  user_assigned_managed_identities = { ... }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

Defender for SQLãŒä¸è¦ãªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›ã€‚

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚«ã‚¹ã‚¿ãƒ åå‰ã®è¨­å®š

```hcl title="custom_replacements.namesã«è¿½åŠ "
custom_replacements = {
  names = {
    # æ—¢å­˜ã®å¤‰æ•°
    starter_location_01 = "japaneast"
    
    # ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ã®åå‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
    log_analytics_workspace_name = "law-custom-prod-japaneast"
    management_resource_group_name = "rg-custom-mgmt-prod"
    dcr_change_tracking_name = "dcr-ct-prod-japaneast"
    dcr_vm_insights_name = "dcr-vminsights-prod-japaneast"
    dcr_defender_sql_name = "dcr-defendersql-prod-japaneast"
    ama_user_assigned_managed_identity_name = "id-ama-prod-japaneast"
  }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

ç’°å¢ƒã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ãŸå‘½åè¦å‰‡ã‚’é©ç”¨ã—ã¦ã‚‹ã€‚

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: Sentinelã®æœ‰åŠ¹åŒ–

```hcl title="Sentinelã‚’æœ‰åŠ¹åŒ–"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  sentinel_onboarding = {  # â†è¿½åŠ 
    name                         = "default"
    customer_managed_key_enabled = false
  }
  
  user_assigned_managed_identities = { ... }
  data_collection_rules = { ... }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

Microsoft Sentinelï¼ˆSIEM/SOARï¼‰ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã‚‹ã€‚

**Sentinelã¨ã¯**ï¼š

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ã¨ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ï¼ˆSIEMï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã€‚ãƒ­ã‚°ã‚’åˆ†æã—ã¦è„…å¨ã‚’æ¤œå‡ºã—ã€è‡ªå‹•å¯¾å¿œã§ãã‚‹ã€‚

**ã‚³ã‚¹ãƒˆ**ï¼š

```text title="Sentinelã®æ–™é‡‘"
ç´„300å††/GBï¼ˆLog Analyticsã¸ã®å–ã‚Šè¾¼ã¿æ–™é‡‘ã¨ã¯åˆ¥ï¼‰
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```hcl title="ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·"
management_resource_settings = {
  location = "$${starter_location_01}"
  log_analytics_workspace_name = "$${log_analytics_workspace_name}"
  resource_group_name = "$${management_resource_group_name}"
  
  timeouts = {  # â†è¿½åŠ 
    data_collection_rule = {
      create = "10m"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†ã‹ã‚‰10åˆ†ã«å»¶é•·
      delete = "15m"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10åˆ†ã‹ã‚‰15åˆ†ã«å»¶é•·
    }
    sentinel_onboarding = {
      create = "10m"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†ã‹ã‚‰10åˆ†ã«å»¶é•·
    }
  }
  
  user_assigned_managed_identities = { ... }
  data_collection_rules = { ... }
}
```

**ä½•ã—ã¦ã‚‹ï¼Ÿ**

ãƒªã‚½ãƒ¼ã‚¹ä½œæˆãƒ»å‰Šé™¤ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ã—ã¦ã‚‹ã€‚

**ä½¿ã„é“**ï¼š

- å¤§è¦æ¨¡ç’°å¢ƒã§DCRä½œæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„ç’°å¢ƒ

---

## ã¾ã¨ã‚ğŸ“

**ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ã®å½¹å‰²**ï¼š

- **Log Analytics Workspace**ï¼šå…¨ã¦ã®ãƒ­ã‚°ã‚’é›†ç´„ã™ã‚‹ä¸­å¤®é›†ç´„ã‚¹ãƒˆã‚¢
- **Data Collection Rulesï¼ˆDCRï¼‰**ï¼šã©ã®ãƒ­ã‚°ã‚’ã©ã†åé›†ã™ã‚‹ã‹ã®ãƒ«ãƒ¼ãƒ«å®šç¾©
- **Managed Identity**ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ã®ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼

**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ **ï¼š

- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**ï¼š`platform-landing-zone.auto.tfvars`ã§`$${å¤‰æ•°å}`å½¢å¼ã§è¨­å®š
- **å¤‰æ•°ç½®æ›**ï¼š`config-templating`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ`$${...}`ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
- **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ï¼š`modules/management_resources/`ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ•´å½¢ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
- **å…¬å¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ï¼š`Azure/avm-ptn-alz-management`ã§å®Ÿãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**ï¼š

- å¤‰æ•°ç½®æ›ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã£ã¦ç’°å¢ƒã”ã¨ã®å€¤ã‚’ç®¡ç†
- `$${starter_location_01}`ã®ã‚ˆã†ãªå¤šæ®µéšç½®æ›ãŒå¯èƒ½
- Log Analyticsã¯ç›£è¦–ã®åŸºç›¤ï¼ˆã™ã¹ã¦ã®ãƒ­ã‚°ãŒã“ã“ã«é›†ã¾ã‚‹ï¼‰
- DCRã§åé›†ãƒ«ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆ3ç¨®é¡ï¼šChange Trackingã€VM Insightsã€Defender for SQLï¼‰
- Managed Identityã§VMã‹ã‚‰Log Analyticsã¸ã®ã‚»ã‚­ãƒ¥ã‚¢ãªæ¥ç¶š
- ãƒãƒªã‚·ãƒ¼ã¨é€£æºã—ã¦VMã¸ã®AMAè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

---

## ç·´ç¿’å•é¡ŒğŸ“

ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚

### å•é¡Œ1
`platform-landing-zone.auto.tfvars`ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹`$${å¤‰æ•°å}`å½¢å¼ã®å¤‰æ•°ç½®æ›ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„ã¯ä½•ã§ã™ã‹ï¼Ÿ

### å•é¡Œ2
Data Collection Rulesï¼ˆDCRï¼‰ã®3ç¨®é¡ã®ã‚¿ã‚¤ãƒ—ã‚’æŒ™ã’ã¦ãã ã•ã„ã€‚

### å•é¡Œ3
Managed Identityã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚

### å•é¡Œ4
`modules/management_resources/main.tf`ã§`coalesce`é–¢æ•°ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ

---

## ç·´ç¿’å•é¡Œã®ç­”ãˆğŸ“

### ç­”ãˆ1
`$${å¤‰æ•°å}`å½¢å¼ã®å¤‰æ•°ç½®æ›ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„ï¼š

**1. ç’°å¢ƒã”ã¨ã®å€¤ã‚’ä¸€å…ƒç®¡ç†**ï¼š

- `custom_replacements.names`ã§ç’°å¢ƒã”ã¨ã®å€¤ã‚’å®šç¾©
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã§åŒã˜å¤‰æ•°ã‚’å†åˆ©ç”¨
- ç’°å¢ƒåˆ‡ã‚Šæ›¿ãˆãŒå®¹æ˜“ï¼ˆ`starter_location_01 = "japaneast"`ã‚’å¤‰ãˆã‚‹ã ã‘ï¼‰

**2. å¤šæ®µéšç½®æ›ãŒå¯èƒ½**ï¼š

```hcl
log_analytics_workspace_name = "law-management-$${starter_location_01}"
â†“
"law-management-japaneast"
```

**3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦å†åˆ©ç”¨**ï¼š

- ç•°ãªã‚‹ç’°å¢ƒï¼ˆé–‹ç™ºã€æœ¬ç•ªï¼‰ã§åŒã˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ãˆã‚‹
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„

### ç­”ãˆ2
Data Collection Rulesï¼ˆDCRï¼‰ã®3ç¨®é¡ï¼š

**1. Change Tracking DCR**ï¼š

- ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå¤‰æ›´ã€ã‚µãƒ¼ãƒ“ã‚¹å¤‰æ›´ã‚’ç›£è¦–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã«ä½¿ç”¨

**2. VM Insights DCR**ï¼š

- CPUã€ãƒ¡ãƒ¢ãƒªã€ãƒ‡ã‚£ã‚¹ã‚¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
- ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ä¾å­˜é–¢ä¿‚ã®å¯è¦–åŒ–

**3. Defender for SQL DCR**ï¼š

- SQL Server on VMã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–
- è„†å¼±æ€§è©•ä¾¡ã€è„…å¨æ¤œå‡º

### ç­”ãˆ3
Managed Identityã®ãƒ¡ãƒªãƒƒãƒˆï¼š

**1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦**ï¼š

- èªè¨¼æƒ…å ±ã‚’ã‚³ãƒ¼ãƒ‰ã«åŸ‹ã‚è¾¼ã¾ãªã„
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã®æ‰‹é–“ãŒä¸è¦
- æ¼æ´©ãƒªã‚¹ã‚¯ãŒã‚¼ãƒ­

**2. è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**ï¼š

- AzureãŒè‡ªå‹•çš„ã«èªè¨¼æƒ…å ±ã‚’æ›´æ–°
- è¨¼æ˜æ›¸ã®æœŸé™åˆ‡ã‚Œã®å¿ƒé…ãªã—
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«æº–æ‹ 

**3. ãã‚ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**ï¼š

- RBACã§å¿…è¦æœ€å°é™ã®æ¨©é™ã‚’ä»˜ä¸
- ãƒªã‚½ãƒ¼ã‚¹å˜ä½ã§æ¨©é™ã‚’åˆ¶å¾¡

### ç­”ãˆ4
`coalesce`é–¢æ•°ã‚’ä½¿ã†ç†ç”±ï¼š

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è‡ªå‹•ç”Ÿæˆ**ï¼š

```hcl
log_analytics_workspace_name = coalesce(
  var.management_resource_settings.log_analytics_workspace_name,
  "law-management-${var.management_resource_settings.location}"
)
```

**å‹•ä½œ**ï¼š

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåå‰ã‚’æŒ‡å®šã—ã¦ã‚‹å ´åˆï¼šãã®åå‰ã‚’ä½¿ã†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåå‰ã‚’æŒ‡å®šã—ã¦ãªã„å ´åˆï¼šè‡ªå‹•ç”Ÿæˆï¼ˆ`law-management-japaneast`ãªã©ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼š

- è¨­å®šã®ç°¡ç•¥åŒ–ï¼ˆå¿…é ˆå…¥åŠ›ã‚’æ¸›ã‚‰ã›ã‚‹ï¼‰
- å‘½åè¦å‰‡ã®çµ±ä¸€ï¼ˆè‡ªå‹•ç”Ÿæˆã®åå‰ãŒè¦å‰‡ã«å¾“ã†ï¼‰
- æŸ”è»Ÿæ€§ï¼ˆã‚«ã‚¹ã‚¿ãƒ åã‚‚æŒ‡å®šã§ãã‚‹ï¼‰

---

æ¬¡ã®Chapterã§ã¯ã€Hub-and-Spokeãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚å®Ÿéš›ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ï¼ˆVNetã€Firewallã€Bastionï¼‰ã‚’ä½œã‚‹ã‚ˆã€‚ğŸš€

---

**æ‰€è¦æ™‚é–“**: 60åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜…â˜†  
**å‰**: [11_ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼.md](./11_ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒãƒªã‚·ãƒ¼.md)  
**æ¬¡**: [13_Hub-and-Spoke.md](./13_Hub-and-Spoke.md)
