# 05. ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•° - locals.tfã®å½¹å‰²

## ã“ã®Chapterã§ã‚„ã‚‹ã“ã¨

`locals.tf`ã®å½¹å‰²ã‚’ç†è§£ã™ã‚‹ã€‚

**ä¾‹ãˆã‚‹ãªã‚‰**ï¼š

- `variables.tf`ï¼šææ–™ï¼ˆåµã€ç ‚ç³–ã€å°éº¦ç²‰ï¼‰
- `locals.tf`ï¼šä¸‹ã”ã—ã‚‰ãˆï¼ˆåµã‚’æº¶ãã€ææ–™ã‚’æ··ãœã‚‹ï¼‰
- `main.tf`ï¼šèª¿ç†ï¼ˆã‚ªãƒ¼ãƒ–ãƒ³ã§ç„¼ãï¼‰

å¤‰æ•°ã‚’ãã®ã¾ã¾ä½¿ã†ã‚“ã˜ã‚ƒãªãã¦ã€**è¨ˆç®—ãƒ»åŠ å·¥ã—ã¦ã‹ã‚‰ä½¿ã†**ã€‚

---

## localsï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ï¼‰ã¨ã¯ï¼Ÿ

### å®šç¾©æ–¹æ³•

```hcl title="ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å®šç¾©"
locals {
  project_name = "alz"
  full_name    = "${local.project_name}-${var.environment}"
}
```

**ä½¿ã„æ–¹**ï¼š
```hcl title="ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å‚ç…§"
resource "azurerm_resource_group" "example" {
  name     = local.full_name  # â†local.ã§å‚ç…§
  location = var.location     # â†å¤‰æ•°ã¯var.ã§å‚ç…§
}
```

**ãƒã‚¤ãƒ³ãƒˆ**ï¼š

- å®šç¾©ï¼š`locals { ... }`ï¼ˆè¤‡æ•°å½¢ï¼‰
- å‚ç…§ï¼š`local.xxx`ï¼ˆå˜æ•°å½¢ï¼‰

### variablesã¨ã®é•ã„

**åˆå¿ƒè€…ãŒã‚ˆãæ··ä¹±ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ã—ã£ã‹ã‚Šç†è§£ã—ã¾ã—ã‚‡ã†ã€‚**

| é …ç›® | variables.tf | locals.tf |
|------|--------------|-----------|
| å¤–éƒ¨ã‹ã‚‰è¨­å®š | âœ… ã§ãã‚‹ | âŒ ã§ããªã„ |
| è¨ˆç®—ãƒ»åŠ å·¥ | âŒ ã§ããªã„ | âœ… ã§ãã‚‹ |
| å‚ç…§æ–¹æ³• | `var.xxx` | `local.xxx` |
| ä½¿ã†å ´é¢ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã™ã‚‹å€¤ | è¨ˆç®—ã—ãŸå€¤ |
| å¤‰æ›´ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚° | å®Ÿè¡Œæ™‚ã«æŒ‡å®š | ã‚³ãƒ¼ãƒ‰å†…ã§å›ºå®š |

**å…·ä½“ä¾‹ã§ç†è§£ã™ã‚‹**:

```hcl title="variablesã¨localsã®ä½¿ã„åˆ†ã‘"
# variables.tfï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºã‚ã‚‹ï¼‰
variable "environment" {
  type = string
  default = "prod"
}

variable "location" {
  type = string
  default = "japaneast"
}

# locals.tfï¼ˆè‡ªå‹•ã§è¨ˆç®—ã™ã‚‹ï¼‰
locals {
  # environmentã¨locationã‚’çµ„ã¿åˆã‚ã›ã¦ãƒªã‚½ãƒ¼ã‚¹åã‚’ä½œã‚‹
  resource_group_name = "rg-${var.environment}-${var.location}"
  # â†’ "rg-prod-japaneast"
  
  # è¤‡é›‘ãªæ¡ä»¶åˆ¤å®š
  is_production = var.environment == "prod" ? true : false
  
  # è¨ˆç®—çµæœ
  subnet_count = var.enable_vpn ? 5 : 4
}
```

**ã©ã£ã¡ã‚’ä½¿ãˆã°ã„ã„ã‹è¿·ã£ãŸã‚‰**:

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´ã•ã›ãŸã„ï¼Ÿ
  YES â†’ variables
  NO  â†’ locals
```

**ğŸ“Š å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®è¦–è¦šåŒ–**

```
ã€Terraformå®Ÿè¡Œã®æµã‚Œã€‘

1. å…¥åŠ›ï¼ˆvariablesï¼‰
   â†“
   var.environment = "prod"
   var.location = "japaneast"
   var.enable_vpn = true
   â†“

2. åŠ å·¥ï¼ˆlocalsï¼‰
   â†“
   local.resource_group_name = "rg-prod-japaneast"  â† æ–‡å­—åˆ—çµåˆ
   local.is_production = true                        â† æ¡ä»¶åˆ¤å®š
   local.subnet_count = 5                            â† è¨ˆç®—
   â†“

3. å‡ºåŠ›ï¼ˆresourcesï¼‰
   â†“
   resource "azurerm_resource_group" "example" {
     name     = local.resource_group_name  â† åŠ å·¥æ¸ˆã¿ã®å€¤ã‚’ä½¿ã†
     location = var.location               â† å…¥åŠ›å€¤ã‚’ãã®ã¾ã¾ä½¿ã†
   }
```

**ğŸ¯ å…·ä½“ä¾‹ã§ã‚‚ã†ä¸€åº¦**

```hcl title="å®Ÿéš›ã®ä½¿ç”¨ä¾‹"
# â‘  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›
variable "project" { default = "webapp" }
variable "env" { default = "prod" }
variable "region" { default = "japaneast" }

# â‘¡ locals ã§åŠ å·¥ãƒ»è¨ˆç®—
locals {
  # åå‰ã‚’è‡ªå‹•ç”Ÿæˆ
  resource_group_name = "rg-${var.project}-${var.env}-${var.region}"
  # â†’ "rg-webapp-prod-japaneast"
  
  # ã‚¿ã‚°ã‚’è‡ªå‹•ç”Ÿæˆ
  common_tags = {
    Project     = var.project
    Environment = var.env
    ManagedBy   = "Terraform"
  }
  
  # æœ¬ç•ªç’°å¢ƒã‹ã©ã†ã‹åˆ¤å®š
  is_production = var.env == "prod"
  
  # æœ¬ç•ªãªã‚‰3å°ã€ãã‚Œä»¥å¤–ã¯1å°
  vm_count = local.is_production ? 3 : 1
}

# â‘¢ resources ã§å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
resource "azurerm_resource_group" "main" {
  name     = local.resource_group_name  # â† åŠ å·¥æ¸ˆã¿
  location = var.region                 # â† ãã®ã¾ã¾
  tags     = local.common_tags          # â† åŠ å·¥æ¸ˆã¿
}
```

**è¦šãˆæ–¹**:

- variables: å…¥åŠ›ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºã‚ã‚‹ï¼‰
- locals: å‡¦ç†ï¼ˆè‡ªå‹•ã§è¨ˆç®—ï¼‰
- resources: å‡ºåŠ›ï¼ˆå®Ÿéš›ã«ä½œã‚‹ï¼‰

---

## Part 1: å®šæ•°å®šç¾©

```hcl title="æ¥ç¶šã‚¿ã‚¤ãƒ—ã®å®šæ•°å®šç¾©"
locals {
  const = {
    connectivity = {
      virtual_wan        = "virtual_wan"
      hub_and_spoke_vnet = "hub_and_spoke_vnet"
      none               = "none"
    }
  }
}
```

**ã“ã‚Œã¯ä½•ï¼Ÿ**

å®šæ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚ãƒã‚¸ãƒƒã‚¯ã‚¹ãƒˆãƒªãƒ³ã‚°ï¼ˆæ–‡å­—åˆ—ç›´æ›¸ãï¼‰ã‚’é¿ã‘ã‚‹ãŸã‚ã§ã™ã€‚

**æ‚ªã„ä¾‹**ï¼š
```hcl title="ãƒã‚¸ãƒƒã‚¯ã‚¹ãƒˆãƒªãƒ³ã‚°ï¼ˆéæ¨å¥¨ï¼‰"
if (var.connectivity_type == "hub_and_spoke_vnet") {  # â†ã‚¿ã‚¤ãƒã—ã‚„ã™ã„
  ...
}
```

**è‰¯ã„ä¾‹**ï¼š
```hcl title="å®šæ•°ã‚’ä½¿ã£ãŸå®‰å…¨ãªè¨˜è¿°"
if (var.connectivity_type == local.const.connectivity.hub_and_spoke_vnet) {
  # â†è£œå®ŒãŒåŠ¹ãã€ã‚¿ã‚¤ãƒã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
  ...
}
```

**å®šç¾©ã•ã‚Œã¦ã‚‹å®šæ•°**ï¼š

- `virtual_wan`ï¼šVirtual WANä½¿ã†
- `hub_and_spoke_vnet`ï¼šHub-and-Spokeä½¿ã†
- `none`ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œã‚‰ãªã„

ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®`const`ã¿ãŸã„ãªã‚‚ã‚“ã€‚

---

## Part 2: æ¥ç¶šã‚¿ã‚¤ãƒ—ã®åˆ¤å®š

```hcl title="æ¥ç¶šã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹ãƒ•ãƒ©ã‚°è¨­å®š"
locals {
  connectivity_enabled                    = var.connectivity_type != local.const.connectivity.none
  connectivity_virtual_wan_enabled        = var.connectivity_type == local.const.connectivity.virtual_wan
  connectivity_hub_and_spoke_vnet_enabled = var.connectivity_type == local.const.connectivity.hub_and_spoke_vnet
}
```

**ã“ã‚Œã¯ä½•ï¼Ÿ**

`connectivity_type`ã®å€¤ã‚’è¦‹ã¦ã€ãƒ•ãƒ©ã‚°ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚

### connectivity_enabled

```hcl title="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœ‰åŠ¹åŒ–ãƒ•ãƒ©ã‚°"
connectivity_enabled = var.connectivity_type != local.const.connectivity.none
```

**æ„å‘³**ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œã‚‹ã®ï¼Ÿ

**ä¾‹**ï¼š
```hcl
# tfvars
connectivity_type = "hub_and_spoke_vnet"

# çµæœ
local.connectivity_enabled = true  # â†noneã˜ã‚ƒãªã„ã‹ã‚‰true
```

```hcl
# tfvars
connectivity_type = "none"

# çµæœ
local.connectivity_enabled = false  # â†noneã ã‹ã‚‰false
```

**ä½¿ã„é“**ï¼š
```hcl
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œã‚‹æ™‚ã ã‘ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
resource "azurerm_xxx" "example" {
  count = local.connectivity_enabled ? 1 : 0
  ...
}
```

### connectivity_virtual_wan_enabled

```hcl
connectivity_virtual_wan_enabled = var.connectivity_type == local.const.connectivity.virtual_wan
```

**æ„å‘³**ï¼šVirtual WANä½¿ã†ã®ï¼Ÿ

**ä¾‹**ï¼š
```hcl
# tfvars
connectivity_type = "virtual_wan"

# çµæœ
local.connectivity_virtual_wan_enabled = true
```

### connectivity_hub_and_spoke_vnet_enabled

```hcl
connectivity_hub_and_spoke_vnet_enabled = var.connectivity_type == local.const.connectivity.hub_and_spoke_vnet
```

**æ„å‘³**ï¼šHub-and-Spokeä½¿ã†ã®ï¼Ÿ

**ä¾‹**ï¼š
```hcl
# tfvars
connectivity_type = "hub_and_spoke_vnet"

# çµæœ
local.connectivity_hub_and_spoke_vnet_enabled = true
```

**ãªã‚“ã§ã“ã‚“ãªã“ã¨ã™ã‚‹ã®ï¼Ÿ**

main.tfã§æ¡ä»¶åˆ†å²ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€‚

```hcl
# ã“ã‚Œã‚ˆã‚Š
module "virtual_wan" {
  count = var.connectivity_type == "virtual_wan" ? 1 : 0
  ...
}

# ã“ã£ã¡ã®æ–¹ãŒèª­ã¿ã‚„ã™ã„
module "virtual_wan" {
  count = local.connectivity_virtual_wan_enabled ? 1 : 0
  ...
}
```

---

## Part 3: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¾å­˜é–¢ä¿‚

```hcl title="ãƒªã‚½ãƒ¼ã‚¹ä½œæˆé †åºã®åˆ¶å¾¡"
locals {
  resource_groups = {
    resource_groups = module.resource_groups
  }
  hub_and_spoke_networks_settings = merge(module.config.outputs.hub_and_spoke_networks_settings, local.resource_groups)
  hub_virtual_networks            = (merge({ vnets = module.config.outputs.hub_virtual_networks }, local.resource_groups)).vnets
  virtual_wan_settings            = merge(module.config.outputs.virtual_wan_settings, local.resource_groups)
  virtual_hubs                    = (merge({ vhubs = module.config.outputs.virtual_hubs }, local.resource_groups)).vhubs
}
```

**ã“ã‚Œã¯ä½•ï¼Ÿ**

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å…ˆã«ä½œã£ã¦ã‹ã‚‰ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œã‚‹ãŸã‚ã®ä»•çµ„ã¿ã€‚

### Terraformã®ä¾å­˜é–¢ä¿‚

**å•é¡Œ**ï¼š
```hcl
# ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
resource "azurerm_resource_group" "network" {
  name = "rg-network"
}

# VNet
resource "azurerm_virtual_network" "hub" {
  resource_group_name = azurerm_resource_group.network.name
  # â†‘ã“ã‚Œã§ä¾å­˜é–¢ä¿‚ãŒã§ãã‚‹ï¼ˆRGâ†’VNetï¼‰
}
```

ã§ã‚‚ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ã£ã¦ã‚‹å ´åˆã¯æ˜ç¤ºçš„ã«ä¾å­˜é–¢ä¿‚ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚

### resource_groups

```hcl
resource_groups = {
  resource_groups = module.resource_groups
}
```

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‡ºåŠ›ã‚’ä¿å­˜ã€‚

### mergeé–¢æ•°

```hcl
hub_and_spoke_networks_settings = merge(
  module.config.outputs.hub_and_spoke_networks_settings,
  local.resource_groups
)
```

**mergeé–¢æ•°**ï¼š2ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒãƒ¼ã‚¸ã™ã‚‹

**ã‚¤ãƒ¡ãƒ¼ã‚¸**ï¼š
```hcl
# å…ƒã®ãƒ‡ãƒ¼ã‚¿
hub_and_spoke_networks_settings = {
  location = "japaneast"
  cidr     = "10.0.0.0/16"
}

# ãƒãƒ¼ã‚¸å¾Œ
hub_and_spoke_networks_settings = {
  location = "japaneast"
  cidr     = "10.0.0.0/16"
  resource_groups = module.resource_groups  # â†è¿½åŠ 
}
```

**åŠ¹æœ**ï¼š

- `resource_groups`ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€TerraformãŒè‡ªå‹•ã§ä¾å­˜é–¢ä¿‚ã‚’ç†è§£ã™ã‚‹
- ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é †ç•ªã§ä½œã‚‰ã‚Œã‚‹

### hub_virtual_networks

```hcl
hub_virtual_networks = (merge({ vnets = module.config.outputs.hub_virtual_networks }, local.resource_groups)).vnets
```

ã¡ã‚‡ã£ã¨è¤‡é›‘ã ã‹ã‚‰åˆ†è§£ã—ã‚ˆã†ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—1: mergeã™ã‚‹
```hcl
merge(
  { vnets = module.config.outputs.hub_virtual_networks },
  local.resource_groups
)

# çµæœ
{
  vnets = { ... }
  resource_groups = module.resource_groups
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: .vnetsã§å–ã‚Šå‡ºã™
```hcl
(...).vnets

# çµæœ
{ ... }  # â†vnetsã®ä¸­èº«ã ã‘
```

**ãªã‚“ã§ã“ã‚“ãªã“ã¨ã™ã‚‹ã®ï¼Ÿ**

- `resource_groups`ã‚’å«ã‚ã¦ä¾å­˜é–¢ä¿‚ã‚’ä½œã‚‹
- ã§ã‚‚æœ€çµ‚çš„ã«ã¯`vnets`ã ã‘ã»ã—ã„

ãƒˆãƒªãƒƒã‚­ãƒ¼ã ã‘ã©ã€Terraformã®ä¾å­˜é–¢ä¿‚ã‚·ã‚¹ãƒ†ãƒ ã‚’æº€ãŸã™ãŸã‚ã®æŠ€ã€‚

---

## Part 4: ãƒãƒªã‚·ãƒ¼ã®ä¾å­˜é–¢ä¿‚

```hcl title="ãƒãƒªã‚·ãƒ¼å‰²ã‚Šå½“ã¦ã®ä¾å­˜é–¢ä¿‚å®šç¾©"
locals {
  management_group_dependencies = {
    policy_assignments = [
      module.management_resources,
      module.hub_and_spoke_vnet,
      module.virtual_wan
    ]
    policy_role_assignments = [
      module.management_resources,
      module.hub_and_spoke_vnet,
      module.virtual_wan
    ]
  }
}
```

**ã“ã‚Œã¯ä½•ï¼Ÿ**

ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒãƒªã‚·ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹å‰ã«ã€ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å…ˆã«ä½œã‚‹ãŸã‚ã®ä»•çµ„ã¿ã€‚

### ãªã‚“ã§å¿…è¦ãªã®ï¼Ÿ

**ã‚·ãƒŠãƒªã‚ª**ï¼š

1. Log Analyticsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œã‚‹
2. ãƒãƒªã‚·ãƒ¼ã§ã€Œå…¨ãƒªã‚½ãƒ¼ã‚¹ã¯Log Analyticsã«ãƒ­ã‚°é€ä¿¡ã€ã‚’è¨­å®š

**å•é¡Œ**ï¼š
ãƒãƒªã‚·ãƒ¼ã‚’å…ˆã«ä½œã‚‹ã¨ã€Log AnalyticsãŒã¾ã ãªã„ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

**è§£æ±ºç­–**ï¼š
```hcl
policy_assignments = [
  module.management_resources,  # â†ã“ã‚Œã‚‰ã‚’å…ˆã«ä½œã‚‹
  module.hub_and_spoke_vnet,
  module.virtual_wan
]
```

ãƒªã‚¹ãƒˆã«å«ã‚ã‚‹ã“ã¨ã§ã€TerraformãŒé †ç•ªã‚’ç†è§£ã™ã‚‹ã€‚

### policy_assignments vs policy_role_assignments

**policy_assignments**ï¼š
ãƒãƒªã‚·ãƒ¼å®šç¾©ã‚’å‰²ã‚Šå½“ã¦ã‚‹ï¼ˆã€Œãƒ­ã‚°é€ä¿¡ã—ãªã•ã„ã€ï¼‰

**policy_role_assignments**ï¼š
ãƒãƒªã‚·ãƒ¼ã®ãƒãƒãƒ¼ã‚¸ãƒ‰IDã«æ¨©é™ã‚’ä¸ãˆã‚‹ï¼ˆã€Œãƒ­ã‚°é€ä¿¡ã™ã‚‹æ¨©é™ã‚ã’ã‚‹ã‚ˆã€ï¼‰

ã©ã£ã¡ã‚‚å…ˆã«ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

---

## Part 5: æœ€çµ‚çš„ãªè¨­å®šã®ãƒãƒ¼ã‚¸

### management_group_settings

```hcl title="ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã®ãƒãƒ¼ã‚¸"
locals {
  management_group_settings = merge(
    module.config.outputs.management_group_settings,
    {
      dependencies = local.management_group_dependencies
    }
  )
}
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š

1. `module.config`ã‹ã‚‰ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šã‚’å–å¾—
2. `dependencies`ï¼ˆä¾å­˜é–¢ä¿‚ï¼‰ã‚’è¿½åŠ 
3. ãƒãƒ¼ã‚¸ã—ã¦æœ€çµ‚è¨­å®šã‚’ä½œã‚‹

**ã‚¤ãƒ¡ãƒ¼ã‚¸**ï¼š
```hcl
# å…ƒã®è¨­å®š
management_group_settings = {
  root_name = "alz"
  policies  = [ ... ]
}

# ãƒãƒ¼ã‚¸å¾Œ
management_group_settings = {
  root_name    = "alz"
  policies     = [ ... ]
  dependencies = {  # â†è¿½åŠ 
    policy_assignments = [ ... ]
    policy_role_assignments = [ ... ]
  }
}
```

### management_resource_settings

```hcl title="ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã®ãƒãƒ¼ã‚¸"
locals {
  management_resource_settings = merge(
    module.config.outputs.management_resource_settings,
    {
      tags = coalesce(module.config.outputs.management_resource_settings.tags, module.config.outputs.tags)
    }
  )
}
```

coalesceé–¢æ•°ã£ã¦ä½•ï¼Ÿ

```hcl
coalesce(å€¤1, å€¤2, å€¤3, ...)
# â†æœ€åˆã®nullã˜ã‚ƒãªã„å€¤ã‚’è¿”ã™
```

**ä¾‹**ï¼š
```hcl
coalesce(null, null, "hello")  # â†"hello"
coalesce("first", "second")    # â†"first"
```

**ã“ã®å ´åˆ**ï¼š
```hcl
tags = coalesce(
  module.config.outputs.management_resource_settings.tags,
  module.config.outputs.tags
)
```

**æ„å‘³**ï¼š

- ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹å°‚ç”¨ã®ã‚¿ã‚°ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
- ãªã‘ã‚Œã°å…¨ä½“ã®ã‚¿ã‚°ã‚’ä½¿ã†

**ä½¿ã„é“**ï¼š
```hcl
# å…¨ä½“ã®ã‚¿ã‚°
tags = {
  environment = "prod"
}

# ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹å°‚ç”¨ã®ã‚¿ã‚°ï¼ˆæŒ‡å®šã—ã¦ãªã„ï¼‰
management_resource_settings.tags = null

# çµæœ
# â†“å…¨ä½“ã®ã‚¿ã‚°ãŒä½¿ã‚ã‚Œã‚‹
management_resource_settings.tags = { environment = "prod" }
```

---

## locals.tfã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¾ã¨ã‚

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: å®šæ•°å®šç¾©

```hcl title="enumãƒ‘ã‚¿ãƒ¼ãƒ³"
locals {
  const = {
    status = {
      active   = "active"
      inactive = "inactive"
    }
  }
}

# ä½¿ã„æ–¹
status = local.const.status.active
```

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼šã‚¿ã‚¤ãƒé˜²æ­¢ã€è£œå®ŒãŒåŠ¹ã

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ¡ä»¶åˆ†å²

```hcl title="ç’°å¢ƒåˆ¥ã®åˆ†å²"
locals {
  is_production = var.environment == "prod"
  instance_count = local.is_production ? 3 : 1
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼šè¤‡é›‘ãªæ¡ä»¶ã‚’ã‚ã‹ã‚Šã‚„ã™ã

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒ‡ãƒ¼ã‚¿åŠ å·¥

```hcl title="ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åã®çŸ­ç¸®"
locals {
  location_short = {
    "japaneast" = "jpe"
    "japanwest" = "jpw"
  }
  
  resource_name = "${var.prefix}-${local.location_short[var.location]}"
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼šå¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’1ç®‡æ‰€ã«é›†ç´„

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ä¾å­˜é–¢ä¿‚ã®æ˜ç¤º

```hcl title="ãƒªã‚½ãƒ¼ã‚¹ä½œæˆé †åºã®åˆ¶å¾¡"
locals {
  config_with_deps = merge(
    var.config,
    { dependencies = [module.base_resources] }
  )
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼šãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆé †åºã‚’åˆ¶å¾¡

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

```hcl title="çœç•¥æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤"
locals {
  tags = coalesce(var.custom_tags, var.default_tags)
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼šæŸ”è»Ÿãªè¨­å®šã€çœç•¥æ™‚ã®æŒ™å‹•ã‚’åˆ¶å¾¡

---

## å®Ÿè·µï¼šlocals.tfã‚’æ›¸ã„ã¦ã¿ã‚ˆã†

### ä¾‹1: ç’°å¢ƒåˆ¥ã®è¨­å®š

```hcl title="ç’°å¢ƒã«ã‚ˆã‚‹è¨­å®šåˆ‡ã‚Šæ›¿ãˆ"
# variables.tf
variable "environment" {
  type = string
}

# locals.tf
locals {
  env_config = {
    dev = {
      instance_size = "Standard_B2s"
      instance_count = 1
    }
    prod = {
      instance_size = "Standard_D4s_v3"
      instance_count = 3
    }
  }
  
  config = local.env_config[var.environment]
}

# main.tf
resource "azurerm_virtual_machine" "example" {
  count = local.config.instance_count
  size  = local.config.instance_size
  ...
}
```

### ä¾‹2: å‘½åè¦å‰‡ã®çµ±ä¸€

```hcl title="ãƒªã‚½ãƒ¼ã‚¹åã®è‡ªå‹•ç”Ÿæˆ"
# variables.tf
variable "project" { type = string }
variable "environment" { type = string }
variable "location" { type = string }

# locals.tf
locals {
  location_codes = {
    "japaneast" = "jpe"
    "japanwest" = "jpw"
  }
  
  naming_prefix = "${var.project}-${var.environment}-${local.location_codes[var.location]}"
  
  resource_names = {
    vnet          = "${local.naming_prefix}-vnet"
    subnet        = "${local.naming_prefix}-subnet"
    nsg           = "${local.naming_prefix}-nsg"
    resource_group = "rg-${local.naming_prefix}"
  }
}

# main.tf
resource "azurerm_resource_group" "example" {
  name = local.resource_names.resource_group
}

resource "azurerm_virtual_network" "example" {
  name = local.resource_names.vnet
}
```

### ä¾‹3: æ¡ä»¶ä»˜ããƒªã‚½ãƒ¼ã‚¹ä½œæˆ

```hcl title="æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¶å¾¡"
# variables.tf
variable "enable_monitoring" { type = bool }
variable "enable_backup" { type = bool }

# locals.tf
locals {
  monitoring_enabled = var.enable_monitoring
  backup_enabled     = var.enable_backup
  
  # ä¸¡æ–¹æœ‰åŠ¹ãªå ´åˆã®ã¿é«˜åº¦ãªç›£è¦–ã‚’æœ‰åŠ¹åŒ–
  advanced_monitoring_enabled = local.monitoring_enabled && local.backup_enabled
}

# main.tf
resource "azurerm_log_analytics_workspace" "example" {
  count = local.monitoring_enabled ? 1 : 0
  ...
}

resource "azurerm_recovery_services_vault" "example" {
  count = local.backup_enabled ? 1 : 0
  ...
}

resource "azurerm_monitor_diagnostic_setting" "advanced" {
  count = local.advanced_monitoring_enabled ? 1 : 0
  ...
}
```

---

## ãƒ‡ãƒãƒƒã‚°æŠ€ï¼šlocals ã®å€¤ã‚’ç¢ºèªã™ã‚‹

**outputä½¿ãŠã†**

```hcl title="ãƒ‡ãƒãƒƒã‚°ç”¨outputå®šç¾©"
# outputs.tf
output "debug_locals" {
  value = {
    connectivity_enabled = local.connectivity_enabled
    is_production        = local.is_production
    resource_names       = local.resource_names
  }
}
```

**å®Ÿè¡Œ**ï¼š
```bash
terraform plan

# å‡ºåŠ›
Outputs:
  debug_locals = {
    connectivity_enabled = true
    is_production = false
    resource_names = {
      vnet = "myapp-dev-jpe-vnet"
      ...
    }
  }
```

ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®ä¸­èº«ãŒè¦‹ãˆã‚‹ã‹ã‚‰ã€ãƒ‡ãƒãƒƒã‚°ãŒæ¥½ã€‚

---

## ã¾ã¨ã‚

**locals.tfã®å½¹å‰²**ï¼š

1. **å®šæ•°å®šç¾©**ï¼šãƒã‚¸ãƒƒã‚¯ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚’é¿ã‘ã‚‹
2. **æ¡ä»¶åˆ¤å®š**ï¼šãƒ•ãƒ©ã‚°ã‚’ä½œã£ã¦å¯èª­æ€§å‘ä¸Š
3. **ä¾å­˜é–¢ä¿‚**ï¼šãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆé †åºã‚’åˆ¶å¾¡
4. **ãƒ‡ãƒ¼ã‚¿åŠ å·¥**ï¼šå¤‰æ•°ã‚’è¨ˆç®—ãƒ»å¤‰æ›
5. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**ï¼šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

**è¦šãˆã¦ãŠãã“ã¨**ï¼š

- å®šç¾©ï¼š`locals { ... }`ï¼ˆè¤‡æ•°å½¢ï¼‰
- å‚ç…§ï¼š`local.xxx`ï¼ˆå˜æ•°å½¢ï¼‰
- å¤–éƒ¨ã‹ã‚‰å€¤ã‚’æ¸¡ã›ãªã„ï¼ˆå†…éƒ¨è¨ˆç®—å°‚ç”¨ï¼‰
- `merge()`ã€`coalesce()`ã‚’ä½¿ã„ã“ãªãã†

---

## ç·´ç¿’å•é¡Œ

ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚

### å•é¡Œ1
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã€`local.resource_group_name`ã®å€¤ã¯ä½•ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ

```hcl title="ç·´ç¿’å•é¡Œ1"
variable "environment" {
  default = "prod"
}

variable "location" {
  default = "japaneast"
}

locals {
  resource_group_name = "rg-${var.environment}-${var.location}"
}
```

### å•é¡Œ2
`variables`ã¨`locals`ã®é•ã„ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚  
ã©ã‚“ãªæ™‚ã«`locals`ã‚’ä½¿ã†ã¹ãã§ã™ã‹ï¼Ÿ

### å•é¡Œ3
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ä½•ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ

```hcl title="ç·´ç¿’å•é¡Œ3"
locals {
  is_production = var.environment == "prod" ? true : false
}
```

---

## ç·´ç¿’å•é¡Œã®ç­”ãˆ

### ç­”ãˆ1
```
rg-prod-japaneast
```

æ–‡å­—åˆ—è£œé–“ã§`var.environment`ï¼ˆprodï¼‰ã¨`var.location`ï¼ˆjapaneastï¼‰ãŒçµåˆã•ã‚Œã¾ã™ã€‚

### ç­”ãˆ2
**é•ã„**:

- `variables`: å¤–éƒ¨ã‹ã‚‰å€¤ã‚’å—ã‘å–ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šï¼‰
- `locals`: å†…éƒ¨ã§è¨ˆç®—ã™ã‚‹ï¼ˆè‡ªå‹•ã§æ±ºã¾ã‚‹ï¼‰

**localsã‚’ä½¿ã†ã¹ãæ™‚**:

- è¤‡æ•°ã®å¤‰æ•°ã‚’çµ„ã¿åˆã‚ã›ã¦æ–°ã—ã„å€¤ã‚’ä½œã‚‹æ™‚
- æ¡ä»¶åˆ¤å®šã‚’ã—ã¦å€¤ã‚’æ±ºã‚ã‚‹æ™‚
- åŒã˜è¨ˆç®—ã‚’ç¹°ã‚Šè¿”ã—ä½¿ã†æ™‚ï¼ˆDRYåŸå‰‡ï¼‰

### ç­”ãˆ3
ä¸‰é …æ¼”ç®—å­ã‚’ä½¿ã£ã¦ã€ç’°å¢ƒãŒæœ¬ç•ªï¼ˆprodï¼‰ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚

```
var.environment == "prod" ? true : false
         â†‘                  â†‘      â†‘
      æ¡ä»¶å¼             çœŸã®å ´åˆ å½ã®å ´åˆ
```

- `environment`ãŒ`"prod"`ãªã‚‰`true`
- ãã‚Œä»¥å¤–ãªã‚‰`false`

ã“ã®å€¤ã‚’ä½¿ã£ã¦ã€æœ¬ç•ªç’°å¢ƒã ã‘ç‰¹åˆ¥ãªè¨­å®šã‚’é©ç”¨ã§ãã¾ã™ã€‚

---

æ¬¡ã®Chapterã§ã€`modules/config-templating/`ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
å¤‰æ•°ã‚’å®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã«å¤‰æ›ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã©ã†å‹•ã„ã¦ã‚‹ã‹è§£èª¬ã™ã‚‹ã­ã€‚

---

**æ‰€è¦æ™‚é–“**: 40åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜†â˜†  
**å‰**: [04_å¤‰æ•°å®šç¾©.md](./04_å¤‰æ•°å®šç¾©.md)  
**æ¬¡**: [06_è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.md](./06_è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.md)
