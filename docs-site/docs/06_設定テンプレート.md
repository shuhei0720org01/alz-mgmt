# 06. è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ - config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

## ã“ã®Chapterã§ã‚„ã‚‹ã“ã¨

`modules/config-templating/`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã‚ˆã†ã€‚

**ä¾‹ãˆã‚‹ãªã‚‰**ï¼š

- **Mad Libs**ï¼ˆç©´åŸ‹ã‚ã‚²ãƒ¼ãƒ ï¼‰ã¿ãŸã„ãªã‚„ã¤
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼šã€Œä»Šæ—¥ã®å¤©æ°—ã¯`{{weather}}`ã ã‚ˆã€
- å¤‰æ•°ï¼š`weather = "æ™´ã‚Œ"`
- çµæœï¼šã€Œä»Šæ—¥ã®å¤©æ°—ã¯æ™´ã‚Œã ã‚ˆã€

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†…ã®`{{xxx}}`ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã‚Œã‚‹ã‚“ã ã€‚

---

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ§‹æˆ

```title="modules/config-templating/ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ"
modules/config-templating/
  â”œâ”€â”€ data.tf           # å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿å–å¾—
  â”œâ”€â”€ locals.config.tf  # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ã®ãƒ­ã‚¸ãƒƒã‚¯
  â”œâ”€â”€ outputs.tf        # å‡¦ç†çµæœã®å‡ºåŠ›
  â”œâ”€â”€ terraform.tf      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š
  â””â”€â”€ variables.tf      # å…¥åŠ›å¤‰æ•°
```

**æµã‚Œ**ï¼š
1. `variables.tf`ï¼šå…¥åŠ›ã‚’å—ã‘å–ã‚‹
2. `data.tf`ï¼šAzureãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
3. `locals.config.tf`ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‡¦ç†
4. `outputs.tf`ï¼šçµæœã‚’å‡ºåŠ›

---

## Part 1: å…¥åŠ›å¤‰æ•°ï¼ˆvariables.tfï¼‰

### starter_locations

```hcl title="ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®å…¥åŠ›å¤‰æ•°"
variable "starter_locations" {
  type        = list(string)
  description = "The default for Azure resources. (e.g 'uksouth')"
}
```

**ä¾‹**ï¼š
```hcl title="ãƒªãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®šä¾‹"
starter_locations = ["japaneast", "japanwest"]
```

### subscription_id_xxx

```hcl title="ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDå…¥åŠ›å¤‰æ•°"
variable "subscription_id_connectivity" {
  type        = string
  description = "value of the subscription id for the Connectivity subscription"
}
```

4ã¤ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã‚’å—ã‘å–ã‚‹ã€‚

### custom_replacements

```hcl title="ã‚«ã‚¹ã‚¿ãƒ ç½®æ›å…¥åŠ›å¤‰æ•°"
variable "custom_replacements" {
  type = object({
    names                      = optional(map(string), {})
    resource_group_identifiers = optional(map(string), {})
    resource_identifiers       = optional(map(string), {})
  })
}
```

Chapter 3ã§è¦‹ãŸ`custom_replacements`ã‚’ãã®ã¾ã¾å—ã‘å–ã‚‹ã‚“ã ã€‚

### inputs

```hcl title="å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å¤‰æ•°"
variable "inputs" {
  type        = any
  description = "A map of input variables"
}
```

**type = any**ï¼šä½•ã§ã‚‚å—ã‘å–ã‚Œã‚‹

ã“ã®`inputs`ã®ä¸­èº«ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ã•ã‚Œã‚‹ã€‚

---

## Part 2: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆdata.tfï¼‰

### regions ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```hcl title="Azureãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—"
module "regions" {
  source           = "Azure/avm-utl-regions/azurerm"
  version          = "0.9.2"
  use_cached_data  = false
  enable_telemetry = var.enable_telemetry
}
```

**ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ**
Azureã®å…¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

**å–å¾—ã§ãã‚‹æƒ…å ±**ï¼š

- `geo_code`ï¼šåœ°ç†ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼š`jp`ã€`us`ï¼‰
- `short_name`ï¼šçŸ­ç¸®åï¼ˆä¾‹ï¼š`jpe`ã€`jpw`ï¼‰
- `display_name`ï¼šè¡¨ç¤ºåï¼ˆä¾‹ï¼š`Japan East`ï¼‰

**ä½¿ã„é“**ï¼š
```hcl
# japaneastã®geo_code
module.regions.regions_by_name["japaneast"].geo_code  # â†"jp"

# japaneastã®short_name
module.regions.regions_by_name["japaneast"].short_name  # â†"jpe"
```

### azurerm_client_config

```hcl title="Azureæ¥ç¶šæƒ…å ±ã®å–å¾—"
data "azurerm_client_config" "current" {}
```

**ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ**
ç¾åœ¨ã®Azureæ¥ç¶šæƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

**å–å¾—ã§ãã‚‹æƒ…å ±**ï¼š

- `tenant_id`ï¼šãƒ†ãƒŠãƒ³ãƒˆID
- `subscription_id`ï¼šã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ID

---

## Part 3: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ï¼ˆlocals.config.tfï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°

#### starter_locations

```hcl title="ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®ãƒãƒƒãƒ—åŒ–"
locals {
  starter_locations = {
    for i, location in var.starter_locations :
    "starter_location_${format("%02d", i + 1)}" => location
  }
}
```

**ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ**
ãƒªã‚¹ãƒˆã‚’ãƒãƒƒãƒ—ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚

**ä¾‹**ï¼š
```hcl
# å…¥åŠ›
var.starter_locations = ["japaneast", "japanwest"]

# å‡ºåŠ›
local.starter_locations = {
  "starter_location_01" = "japaneast"
  "starter_location_02" = "japanwest"
}
```

**format("%02d", i + 1)**ï¼š

- `%02d`ï¼š2æ¡ã®æ•°å­—ã€è¶³ã‚Šãªã‘ã‚Œã°0åŸ‹ã‚
- `i + 1`ï¼š0å§‹ã¾ã‚Šã‚’1å§‹ã¾ã‚Šã«å¤‰æ›

```hcl
format("%02d", 1)   # â†"01"
format("%02d", 2)   # â†"02"
format("%02d", 15)  # â†"15"
```

#### starter_locations_short

```hcl title="ãƒªãƒ¼ã‚¸ãƒ§ãƒ³çŸ­ç¸®åã®ç”Ÿæˆ"
locals {
  starter_locations_short = {
    for i, location in var.starter_locations :
    "starter_location_${format("%02d", i + 1)}_short" => coalesce(
      # 1. User override
      try(var.starter_locations_short["starter_location_${format("%02d", i + 1)}_short"], null),
      # 2. Official geo_code
      try(module.regions.regions_by_name[location].geo_code, null),
      # 3. Calculated short_name
      try(module.regions.regions_by_name[location].short_name, null),
      # 4. Last resort: full region name
      location
    )
  }
}
```

è¤‡é›‘ï¼åˆ†è§£ã—ã¦è¦‹ã‚ˆã†ã€‚

##### coalesceã§å„ªå…ˆé †ä½ä»˜ã‘

```hcl
coalesce(å€¤1, å€¤2, å€¤3, å€¤4)
# â†æœ€åˆã®nullã˜ã‚ƒãªã„å€¤ã‚’è¿”ã™
```

**å„ªå…ˆé †ä½**ï¼š
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸Šæ›¸ã**ï¼šæ‰‹å‹•ã§æŒ‡å®šã—ãŸå€¤
2. **geo_code**ï¼š`jp`ã€`us`ã¿ãŸã„ãªåœ°ç†ã‚³ãƒ¼ãƒ‰
3. **short_name**ï¼š`jpe`ã€`jpw`ã¿ãŸã„ãªçŸ­ç¸®å
4. **ãƒ•ãƒ«ãƒãƒ¼ãƒ **ï¼š`japaneast`ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰

##### tryé–¢æ•°

```hcl
try(å¼, ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤)
# â†å¼ãŒã‚¨ãƒ©ãƒ¼ãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã‚’è¿”ã™
```

**ä¾‹**ï¼š
```hcl
try(var.xxx["key"], null)
# â†‘xxxãŒå­˜åœ¨ã—ãªã„or keyãŒãªã„ â†’ null
```

##### å®Ÿéš›ã®å‹•ä½œ

```hcl
# å…¥åŠ›
var.starter_locations = ["japaneast", "japanwest"]
var.starter_locations_short = {}  # ä½•ã‚‚æŒ‡å®šã—ã¦ãªã„

# å‡¦ç†
# japaneastã®å ´åˆï¼š
# 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸Šæ›¸ã: nullï¼ˆæŒ‡å®šã—ã¦ãªã„ï¼‰
# 2. geo_code: "jp"ï¼ˆã“ã‚ŒãŒæ¡ç”¨ã•ã‚Œã‚‹ï¼‰

# å‡ºåŠ›
local.starter_locations_short = {
  "starter_location_01_short" = "jp"
  "starter_location_02_short" = "jp"
}
```

**æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹å ´åˆ**ï¼š
```hcl
# å…¥åŠ›
var.starter_locations_short = {
  "starter_location_01_short" = "jpe"
  "starter_location_02_short" = "jpw"
}

# å‡ºåŠ›ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šãŒå„ªå…ˆï¼‰
local.starter_locations_short = {
  "starter_location_01_short" = "jpe"
  "starter_location_02_short" = "jpw"
}
```

#### built_in_replacements

```hcl title="çµ„ã¿è¾¼ã¿ç½®æ›ãƒ«ãƒ¼ãƒ«ã®çµ±åˆ"
locals {
  built_in_replacements = merge(
    local.starter_locations,
    local.starter_locations_short,
    {
      root_parent_management_group_id = var.root_parent_management_group_id == "" ? data.azurerm_client_config.current.tenant_id : var.root_parent_management_group_id
      subscription_id_connectivity    = var.subscription_id_connectivity
      subscription_id_identity        = var.subscription_id_identity
      subscription_id_management      = var.subscription_id_management
      subscription_id_security        = var.subscription_id_security
  })
}
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
å…¨ã¦ã®çµ„ã¿è¾¼ã¿ç½®æ›ãƒ«ãƒ¼ãƒ«ã‚’1ã¤ã®ãƒãƒƒãƒ—ã«ã¾ã¨ã‚ã¦ã‚‹ã€‚

**çµæœ**ï¼ˆä¾‹ï¼‰ï¼š
```hcl
local.built_in_replacements = {
  # ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  "starter_location_01"       = "japaneast"
  "starter_location_02"       = "japanwest"
  "starter_location_01_short" = "jp"
  "starter_location_02_short" = "jp"
  
  # ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—
  "root_parent_management_group_id" = "12345678-1234-1234-1234-123456789012"
  
  # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
  "subscription_id_connectivity" = "aaaa-bbbb-cccc-dddd"
  "subscription_id_identity"     = "1111-2222-3333-4444"
  "subscription_id_management"   = "5555-6666-7777-8888"
  "subscription_id_security"     = "9999-0000-1111-2222"
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚«ã‚¹ã‚¿ãƒ ç½®æ›ã®å‡¦ç†

#### custom_names

```hcl title="ã‚«ã‚¹ã‚¿ãƒ åã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†"
locals {
  custom_names_json           = replace(replace(tostring(jsonencode(var.custom_replacements.names)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
  custom_names_json_templated = templatestring(local.custom_names_json, local.built_in_replacements)
  custom_names_json_final     = replace(replace(replace(replace(local.custom_names_json_templated, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"")
  custom_names                = jsondecode(local.custom_names_json_final)
}
```

**ä½•ã“ã‚Œï¼Ÿ**
ã‚ã¡ã‚ƒãã¡ã‚ƒè¤‡é›‘ã ã‘ã©ã€ã‚„ã£ã¦ã‚‹ã“ã¨ã¯å˜ç´”ã€‚

**å•é¡Œ**ï¼š
`templatestring()`é–¢æ•°ã¯æ–‡å­—åˆ—ã—ã‹å—ã‘å–ã‚Œãªã„ã€‚
ã§ã‚‚ã€`var.custom_replacements.names`ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚

**è§£æ±ºç­–**ï¼š
1. **JSONåŒ–**ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ JSONæ–‡å­—åˆ—
2. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†**ï¼š`{{xxx}}`ã‚’ç½®æ›
3. **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™**ï¼šJSONæ–‡å­—åˆ— â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

#### è©³ç´°ãªæµã‚Œ

**ğŸ¤” ãã®å‰ã«: ãªãœ jsonencode/jsondecode ã‚’ä½¿ã†ã®ã‹ï¼Ÿ**

**å•é¡Œ**: Terraformã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾æ–‡å­—åˆ—æ“ä½œã§ããªã„

```hcl
# ã“ã†ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹
custom_replacements = {
  firewall_name = "fw-{{starter_location_01}}"
  enabled = true
}

# ã“ã‚Œã‚’æ–‡å­—åˆ—æ“ä½œã—ã¦ã€{{xxx}}ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›ã—ãŸã„
# ã§ã‚‚ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¾ã¾ templatestring() ã¯ä½¿ãˆãªã„
```

**è§£æ±ºç­–**: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ JSONæ–‡å­—åˆ— â†’ æ–‡å­—åˆ—æ“ä½œ â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™

```hcl
# ã‚¹ãƒ†ãƒƒãƒ—1: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ JSONæ–‡å­—åˆ—ã«å¤‰æ›
json_string = jsonencode(custom_replacements)
# â†’ '{"firewall_name":"fw-{{starter_location_01}}","enabled":true}'

# ã‚¹ãƒ†ãƒƒãƒ—2: JSONæ–‡å­—åˆ—ã§ç½®æ›å‡¦ç†
replaced = templatestring(json_string, {starter_location_01 = "japaneast"})
# â†’ '{"firewall_name":"fw-japaneast","enabled":true}'

# ã‚¹ãƒ†ãƒƒãƒ—3: JSONæ–‡å­—åˆ— â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™
result = jsondecode(replaced)
# â†’ {firewall_name = "fw-japaneast", enabled = true}
```

**åˆå¿ƒè€…å‘ã‘ã¾ã¨ã‚**:

- jsonencode(): ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ JSONæ–‡å­—åˆ—ï¼ˆæ–‡å­—åˆ—æ“ä½œå¯èƒ½ã«ã™ã‚‹ï¼‰
- jsondecode(): JSONæ–‡å­—åˆ— â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆTerraformã§ä½¿ãˆã‚‹å½¢ã«æˆ»ã™ï¼‰
- ç†ç”±: Terraformã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ç›´æ¥æ–‡å­—åˆ—æ“ä½œã§ããªã„ãŸã‚

---

##### 1. custom_names_json
```hcl
custom_names_json = replace(replace(tostring(jsonencode(...)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
```hcl
# å…¥åŠ›
var.custom_replacements.names = {
  enable_ddos_protection = true
  firewall_name = "fw-{{starter_location_01_short}}"
}

# jsonencode()ã§JSONåŒ–
# â†“
# {"enable_ddos_protection":true,"firewall_name":"fw-{{starter_location_01_short}}"}

# replace()ã§true/falseã‚’ä¿è­·
# â†“
# {"enable_ddos_protection":{{string_true}},"firewall_name":"fw-{{starter_location_01_short}}"}
```

**ãªã‚“ã§ä¿è­·ï¼Ÿ**
`templatestring()`ãŒ`true`/`false`ã‚’æ–‡å­—åˆ—`"true"`/`"false"`ã«å¤‰æ›ã—ã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚
ãã‚Œã‚’é˜²ããŸã‚ã«ä¸€æ™‚çš„ã«`{{string_true}}`ã«å¤‰ãˆã¦ã‚‹ã€‚

##### 2. custom_names_json_templated
```hcl
custom_names_json_templated = templatestring(local.custom_names_json, local.built_in_replacements)
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
```hcl
# å…¥åŠ›
# {"enable_ddos_protection":{{string_true}},"firewall_name":"fw-{{starter_location_01_short}}"}

# starter_location_01_short = "jp"ã§ç½®æ›
# â†“
# {"enable_ddos_protection":{{string_true}},"firewall_name":"fw-jp"}
```

##### 3. custom_names_json_final
```hcl
custom_names_json_final = replace(replace(...), ...)
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
`{{string_true}}`ã‚’`true`ã«æˆ»ã™ï¼ˆå…ƒã®ãƒ–ãƒ¼ãƒ«å€¤ã«ï¼‰ã€‚

##### 4. custom_names
```hcl
custom_names = jsondecode(local.custom_names_json_final)
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
JSONæ–‡å­—åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™ã€‚

```hcl
# çµæœ
local.custom_names = {
  enable_ddos_protection = true
  firewall_name = "fw-jp"
}
```

#### custom_name_replacements

```hcl title="ã‚«ã‚¹ã‚¿ãƒ åã¨çµ„ã¿è¾¼ã¿ã®ãƒãƒ¼ã‚¸"
locals {
  custom_name_replacements = merge(local.built_in_replacements, local.custom_names)
}
```

çµ„ã¿è¾¼ã¿ç½®æ› + ã‚«ã‚¹ã‚¿ãƒ åã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒªã‚½ãƒ¼ã‚¹IDã®å‡¦ç†

#### custom_resource_group_identifiers

```hcl title="ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—IDã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†"
locals {
  custom_resource_group_identifiers_json           = replace(replace(tostring(jsonencode(var.custom_replacements.resource_group_identifiers)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
  custom_resource_group_identifiers_json_templated = templatestring(local.custom_resource_group_identifiers_json, local.custom_name_replacements)
  custom_resource_group_identifiers_json_final     = replace(replace(replace(replace(local.custom_resource_group_identifiers_json_templated, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"")
  custom_resource_group_identifiers                = jsondecode(local.custom_resource_group_identifiers_json_final)
}
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
`custom_names`ã¨åŒã˜å‡¦ç†ã‚’`resource_group_identifiers`ã«å¯¾ã—ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

**é•ã„**ï¼š
`local.custom_name_replacements`ã‚’ä½¿ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ã€‚
ã¤ã¾ã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—IDã®ä¸­ã§ãƒªã‚½ãƒ¼ã‚¹åã‚’å‚ç…§ã§ãã‚‹ã€‚

**ä¾‹**ï¼š
```hcl
# tfvars
custom_replacements = {
  names = {
    resource_group_name = "rg-{{starter_location_01_short}}-hub"
  }
  resource_group_identifiers = {
    resource_group_id = "/subscriptions/{{subscription_id_connectivity}}/resourceGroups/{{resource_group_name}}"
  }
}

# çµæœ
# â†“
# resource_group_id = "/subscriptions/aaaa-bbbb-cccc-dddd/resourceGroups/rg-jp-hub"
```

`{{resource_group_name}}`ãŒ`rg-jp-hub`ã«ç½®ãæ›ã‚ã£ã¦ã‚‹ã€‚ã‚ã‹ã‚‹ï¼Ÿ

#### custom_resource_identifiers

```hcl title="ãƒªã‚½ãƒ¼ã‚¹IDã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†"
locals {
  custom_resource_identifiers_json           = replace(replace(tostring(jsonencode(var.custom_replacements.resource_identifiers)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
  custom_resource_identifiers_json_templated = templatestring(local.custom_resource_identifiers_json, local.custom_resource_group_replacements)
  custom_resource_identifiers_json_final     = replace(replace(replace(replace(local.custom_resource_identifiers_json_templated, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"")
  custom_resource_identifiers                = jsondecode(local.custom_resource_identifiers_json_final)
}
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
åŒã˜å‡¦ç†ã‚’`resource_identifiers`ã«å¯¾ã—ã¦å®Ÿè¡Œã€‚

`local.custom_resource_group_replacements`ã‚’ä½¿ã†ã‹ã‚‰ã€**ãƒªã‚½ãƒ¼ã‚¹IDã®ä¸­ã§ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’å‚ç…§ã§ãã‚‹**ã€‚

#### final_replacements

```hcl title="å…¨ç½®æ›ãƒ«ãƒ¼ãƒ«ã®çµ±åˆ"
locals {
  final_replacements = merge(local.custom_resource_group_replacements, local.custom_resource_identifiers)
}
```

**å…¨ã¦ã®ç½®æ›ãƒ«ãƒ¼ãƒ«ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹**ã€‚

**ä¸­èº«**ï¼ˆä¾‹ï¼‰ï¼š
```hcl
local.final_replacements = {
  # çµ„ã¿è¾¼ã¿
  "starter_location_01" = "japaneast"
  "starter_location_01_short" = "jp"
  "subscription_id_connectivity" = "aaaa-bbbb-cccc-dddd"
  
  # ã‚«ã‚¹ã‚¿ãƒ å
  "resource_group_name" = "rg-jp-hub"
  "firewall_name" = "fw-jp"
  
  # ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ID
  "resource_group_id" = "/subscriptions/.../resourceGroups/rg-jp-hub"
  
  # ãƒªã‚½ãƒ¼ã‚¹ID
  "log_analytics_workspace_id" = "/subscriptions/.../providers/Microsoft.OperationalInsights/workspaces/law-jp"
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—4: æœ€çµ‚å‡ºåŠ›ã®ç”Ÿæˆ

```hcl title="å…¨è¨­å®šã¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨"
locals {
  outputs_json           = { for key, value in var.inputs : key => replace(replace(tostring(jsonencode(value)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}") }
  outputs_json_templated = { for key, value in local.outputs_json : key => templatestring(value, local.final_replacements) }
  outputs_json_final     = { for key, value in local.outputs_json_templated : key => replace(replace(replace(replace(value, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"") }
  outputs                = { for key, value in local.outputs_json_final : key => jsondecode(value) }
}
```

**ã‚„ã£ã¦ã‚‹ã“ã¨**ï¼š
`var.inputs`ï¼ˆå…¨è¨­å®šï¼‰ã«å¯¾ã—ã¦ã€ä»Šã¾ã§ä½œã£ãŸç½®æ›ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã—ã¦ã„ã¾ã™ã€‚

**forå¼ã‚’ä½¿ã£ã¦ã‚‹**ï¼š
```hcl
{ for key, value in var.inputs : key => ... }
# â†‘var.inputsã®å„è¦ç´ ã«å¯¾ã—ã¦å‡¦ç†
```

**æµã‚Œ**ï¼š
1. **JSONåŒ–**ï¼šå„è¨­å®šã‚’JSONæ–‡å­—åˆ—ã«
2. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†**ï¼š`{{xxx}}`ã‚’ç½®æ›
3. **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™**ï¼šJSON â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

**çµæœ**ï¼š
```hcl
# å…¥åŠ›ï¼ˆvar.inputsï¼‰
{
  hub_virtual_networks = {
    primary = {
      name = "vnet-{{starter_location_01_short}}-hub"
      resource_group_name = "{{resource_group_name}}"
    }
  }
}

# å‡ºåŠ›ï¼ˆlocal.outputsï¼‰
{
  hub_virtual_networks = {
    primary = {
      name = "vnet-jp-hub"
      resource_group_name = "rg-jp-hub"
    }
  }
}
```

---

## ã¾ã¨ã‚ï¼šå‡¦ç†ã®å…¨ä½“åƒ

### 1. çµ„ã¿è¾¼ã¿ç½®æ›ã®ä½œæˆ
```
starter_locations â†’ starter_locations_short â†’ built_in_replacements
```

**çµæœ**ï¼š

- `starter_location_01`ã€`starter_location_01_short`
- `subscription_id_xxx`
- `root_parent_management_group_id`

### 2. ã‚«ã‚¹ã‚¿ãƒ ç½®æ›ã®æ®µéšçš„å‡¦ç†
```
custom_replacements.names
  â†“ (built_in_replacementsã§ç½®æ›)
custom_names â†’ custom_name_replacements

custom_replacements.resource_group_identifiers
  â†“ (custom_name_replacementsã§ç½®æ›)
custom_resource_group_identifiers â†’ custom_resource_group_replacements

custom_replacements.resource_identifiers
  â†“ (custom_resource_group_replacementsã§ç½®æ›)
custom_resource_identifiers â†’ final_replacements
```

**ãƒã‚¤ãƒ³ãƒˆ**ï¼š

- **æ®µéšçš„ã«å‡¦ç†**ï¼šåå‰ â†’ ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ID â†’ ãƒªã‚½ãƒ¼ã‚¹ID
- **å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’æ¬¡ã§ä½¿ã†**ï¼šåå‰ãŒRG IDã®ä¸­ã§ä½¿ãˆã‚‹

### 3. æœ€çµ‚å‡ºåŠ›
```
var.inputs
  â†“ (final_replacementsã§ç½®æ›)
local.outputs â†’ module.config.outputs
```

**åŠ¹æœ**ï¼š
å…¨ã¦ã®`{{xxx}}`ãŒå®Ÿéš›ã®å€¤ã«ç½®ãæ›ã‚ã‚‹ã€‚

---

## å®Ÿè·µï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è©¦ã—ã¦ã¿ã‚ˆã†

### ä¾‹1: å˜ç´”ãªç½®æ›

```hcl title="åŸºæœ¬çš„ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ›"
# tfvars
starter_locations = ["japaneast"]

custom_replacements = {
  names = {
    vnet_name = "vnet-{{starter_location_01_short}}-hub"
  }
}

# çµæœ
# vnet_name = "vnet-jp-hub"
```

### ä¾‹2: è¤‡æ•°æ®µéšã®ç½®æ›

```hcl title="ä¾å­˜é–¢ä¿‚ã‚’æŒã¤ç½®æ›"
# tfvars
starter_locations = ["japaneast"]

custom_replacements = {
  names = {
    rg_name = "rg-{{starter_location_01_short}}-network"
  }
  resource_group_identifiers = {
    rg_id = "/subscriptions/{{subscription_id_connectivity}}/resourceGroups/{{rg_name}}"
  }
  resource_identifiers = {
    vnet_id = "{{rg_id}}/providers/Microsoft.Network/virtualNetworks/vnet-hub"
  }
}

# çµæœ
# rg_name = "rg-jp-network"
# rg_id = "/subscriptions/aaaa-bbbb-cccc-dddd/resourceGroups/rg-jp-network"
# vnet_id = "/subscriptions/aaaa-bbbb-cccc-dddd/resourceGroups/rg-jp-network/providers/Microsoft.Network/virtualNetworks/vnet-hub"
```

**ä¾¿åˆ©ã§ã—ã‚‡ï¼Ÿ**

### ä¾‹3: æ¡ä»¶åˆ†å²ï¼ˆãƒ–ãƒ¼ãƒ«å€¤ï¼‰

```hcl title="ãƒ–ãƒ¼ãƒ«å€¤ã®ä¿æŒ"
# tfvars
custom_replacements = {
  names = {
    enable_firewall = true  # â†ãƒ–ãƒ¼ãƒ«å€¤
  }
}

# ãƒ–ãƒ¼ãƒ«å€¤ãŒãã®ã¾ã¾ä¿æŒã•ã‚Œã‚‹
# enable_firewall = trueï¼ˆæ–‡å­—åˆ—ã®"true"ã˜ã‚ƒãªã„ï¼‰
```

`{{string_true}}`ã®ãƒˆãƒªãƒƒã‚¯ã§ã€ãƒ–ãƒ¼ãƒ«å€¤ãŒä¿è­·ã•ã‚Œã¦ã‚‹ã‚“ã ã€‚

---

## ãƒ‡ãƒãƒƒã‚°æŠ€ï¼šç½®æ›ã®ç¢ºèª

### outputã§ä¸­é–“çµæœã‚’è¦‹ã‚‹

```hcl title="ãƒ‡ãƒãƒƒã‚°ç”¨outputå®šç¾©"
# modules/config-templating/outputs.tf
output "debug_replacements" {
  value = {
    built_in         = local.built_in_replacements
    custom_names     = local.custom_names
    final            = local.final_replacements
  }
}
```

```bash
terraform plan

# â†“ç½®æ›ãƒ«ãƒ¼ãƒ«ãŒå…¨éƒ¨è¦‹ãˆã‚‹
Outputs:
  debug_replacements = {
    built_in = { ... }
    custom_names = { ... }
    final = { ... }
  }
```

### ç‰¹å®šã®å€¤ã ã‘ç¢ºèª

```hcl title="å€‹åˆ¥å€¤ã®ãƒ‡ãƒãƒƒã‚°"
output "debug_vnet_name" {
  value = local.outputs.hub_virtual_networks.primary.name
}
```

---

## ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ©ç‚¹

### 1. DRYåŸå‰‡ï¼ˆDon't Repeat Yourselfï¼‰

**æ‚ªã„ä¾‹**ï¼š
```hcl
resource_group_name = "rg-jp-hub"
vnet_name = "vnet-jp-hub"
firewall_name = "fw-jp-hub"
# â†‘"jp"ã‚’ä½•åº¦ã‚‚æ›¸ã
```

**è‰¯ã„ä¾‹**ï¼š
```hcl
resource_group_name = "rg-{{starter_location_01_short}}-hub"
vnet_name = "vnet-{{starter_location_01_short}}-hub"
firewall_name = "fw-{{starter_location_01_short}}-hub"
# â†‘1ç®‡æ‰€ã ã‘ç®¡ç†ï¼ˆstarter_locationsï¼‰
```

### 2. è¤‡æ•°ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œãŒç°¡å˜

```hcl
# ãƒªãƒ¼ã‚¸ãƒ§ãƒ³è¿½åŠ 
starter_locations = ["japaneast", "japanwest", "eastus"]

# å…¨ã¦ã®è¨­å®šãŒè‡ªå‹•ã§3ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ†ã«ãªã‚‹
```

### 3. ä¾å­˜é–¢ä¿‚ã®è¡¨ç¾

```hcl
rg_name = "rg-hub"
rg_id = "/subscriptions/.../resourceGroups/{{rg_name}}"
vnet_id = "{{rg_id}}/providers/.../virtualNetworks/vnet"
```

å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’ä½¿ãˆã‚‹ã€‚

---

## ã¾ã¨ã‚

**config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²**ï¼š
1. **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ­£è¦åŒ–**ï¼š`japaneast` â†’ `jp`
2. **çµ„ã¿è¾¼ã¿ç½®æ›ã®ä½œæˆ**ï¼šãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ID
3. **ã‚«ã‚¹ã‚¿ãƒ ç½®æ›ã®æ®µéšçš„å‡¦ç†**ï¼šåå‰ â†’ RG ID â†’ ãƒªã‚½ãƒ¼ã‚¹ID
4. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†**ï¼š`{{xxx}}`ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
5. **ãƒ–ãƒ¼ãƒ«å€¤ã®ä¿è­·**ï¼š`true`/`false`ãŒæ–‡å­—åˆ—ã«ãªã‚‰ãªã„ã‚ˆã†ã«

**è¦šãˆã¦ãŠãã“ã¨**ï¼š

- `templatestring()`ï¼š`{{xxx}}`ã‚’ç½®æ›
- `jsonencode()`/`jsondecode()`ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â‡” JSONæ–‡å­—åˆ—
- `coalesce()`ï¼šæœ€åˆã®nullã˜ã‚ƒãªã„å€¤
- `try()`ï¼šã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ

æ¬¡ã®Chapterã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
å®Ÿéš›ã«Azureãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚

---

**æ‰€è¦æ™‚é–“**: 50åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜…â˜…  
**å‰**: [05_ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°.md](./05_ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°.md)  
**æ¬¡**: [07_ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—.md](./07_ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—.md)
