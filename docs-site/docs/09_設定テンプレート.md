# 09. ğŸ§© è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ç½®æ›ã‚¨ãƒ³ã‚¸ãƒ³å®Œå…¨è§£èª¬

!!! info "ã“ã®ç« ã§å­¦ã¶ã“ã¨"
    `modules/config-templating/`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Œå…¨è§£èª¬ã—ã¾ã™ï¼š

    1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã®å½¹å‰²ã¨ä»•çµ„ã¿
    2. terraform.tf - ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š
    3. variables.tf - å…¥åŠ›å¤‰æ•°ã®å®šç¾©ï¼ˆå…¨10å€‹ï¼‰
    4. data.tf - å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    5. locals.config.tf - ç½®æ›ãƒ­ã‚¸ãƒƒã‚¯ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—
    6. outputs.tf - å‡¦ç†çµæœã®å‡ºåŠ›
    7. å®Ÿè·µï¼šã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã®è¿½åŠ æ–¹æ³•


---

## ğŸ·ï¸ ã¯ã˜ã‚ã«ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®æ­£ä½“

### ğŸ•³ï¸ã€Œç©´åŸ‹ã‚ã‚²ãƒ¼ãƒ ã€ã®ä»•çµ„ã¿

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä½•ã‚’ã—ã¦ã„ã‚‹ã‹ã€è¶…ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã§ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

=== "å…¥åŠ›ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰"

    ```hcl title="è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«"
    resource_group_name = "rg-management-$${starter_location_01}"
    ```

    `$${starter_location_01}`ãŒã€Œç©´ã€ã§ã™ã€‚

=== "å¤‰æ•°"

    ```hcl title="å¤‰æ•°ã®å€¤"
    starter_locations = ["japaneast", "japanwest"]
    ```

    `starter_location_01` = "japaneast"

=== "å‡ºåŠ›ï¼ˆç½®æ›å¾Œï¼‰"

    ```hcl title="çµæœ"
    resource_group_name = "rg-management-japaneast"
    ```

    ç©´ãŒåŸ‹ã¾ã£ãŸï¼

ã“ã‚ŒãŒã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²ã§ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã—ã‚‡ï¼Ÿâœ¨

---

### ğŸ¤” ãªãœãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ã™ã‚‹ã®ï¼Ÿ

!!! question "ç›´æ¥æ›¸ã‘ã°ã„ã„ã‚“ã˜ã‚ƒãªã„ï¼Ÿ"
    ```hcl title="ç›´æ¥æ›¸ã„ãŸå ´åˆ"
    primary_resource_group_name   = "rg-management-japaneast"
    secondary_resource_group_name = "rg-management-japanwest"
    ```

**å•é¡Œç‚¹âš ï¸ï¼š**

- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸã„æ™‚ã€å…¨éƒ¨æ›¸ãç›´ã—
- 3ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã€4ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«å¢—ã‚„ã™æ™‚ã€å¤§å¤‰
- ã‚³ãƒ”ãƒšãƒŸã‚¹ãŒèµ·ãã‚„ã™ã„

**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ã¨ğŸ’¡ï¼š**
```hcl title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–¹å¼"
resource_group_name = "rg-management-$${starter_location_01}"
# â†‘ ã“ã®1è¡Œã ã‘ã§OK

starter_locations = ["japaneast", "japanwest", "koreacentral"]
# â†‘ ã“ã“ã‚’å¤‰ãˆã‚‹ã ã‘ã§å…¨éƒ¨é©ç”¨ã•ã‚Œã‚‹
```

æ¥½ã ã‚ˆã­ï¼ğŸ˜†

---

## ğŸ—ï¸ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ§‹é€ 

```text title="modules/config-templating/ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ"
modules/config-templating/
â”œâ”€â”€ terraform.tf      â† Terraformãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š
â”œâ”€â”€ variables.tf      â† å…¥åŠ›å¤‰æ•°ã®å®šç¾©ï¼ˆ10å€‹ï¼‰
â”œâ”€â”€ data.tf           â† Azureã‹ã‚‰æƒ…å ±ã‚’å–å¾—ï¼ˆ2ã¤ï¼‰
â”œâ”€â”€ locals.config.tf  â† ç½®æ›å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ75è¡Œï¼‰
â””â”€â”€ outputs.tf        â† å‡¦ç†çµæœã‚’å‡ºåŠ›ï¼ˆ2ã¤ï¼‰
```

**å‡¦ç†ã®æµã‚ŒğŸ› ï¸ï¼š**

```mermaid
graph TB
    A[terraform.tf<br/>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š] --> B[variables.tf<br/>å…¥åŠ›å—ä»˜]
    B --> C[data.tf<br/>ãƒ‡ãƒ¼ã‚¿å–å¾—]
    C --> D[locals.config.tf<br/>ç½®æ›å‡¦ç†]
    D --> E[outputs.tf<br/>çµæœå‡ºåŠ›]
    
    style A fill:#f0f0f0
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1e1
    style E fill:#e1ffe1
```

---

## ğŸ“ Part 1: terraform.tf - ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š

ã¾ãšã¯åŸºæœ¬è¨­å®šã‹ã‚‰ã€‚

```hcl title="modules/config-templating/terraform.tf"
terraform {
  required_version = "~> 1.12"
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
  }
}
```

**ä½•ã‚’å®šç¾©ã—ã¦ã‚‹ï¼ŸğŸ§**

| é …ç›® | å€¤ | æ„å‘³ |
|------|-----|------|
| `required_version` | `~> 1.12` | Terraform 1.12ä»¥ä¸ŠãŒå¿…è¦ |
| `azurerm` ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | `~> 4.0` | Azure Provider 4.xç³»ã‚’ä½¿ç”¨ |

**`~>`ã®æ„å‘³ğŸ“ï¼š**
```text
~> 1.12 = 1.12ä»¥ä¸Šã€2.0æœªæº€
~> 4.0  = 4.0ä»¥ä¸Šã€5.0æœªæº€
```

ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¯OKã€ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¯é¿ã‘ã‚‹è¨­å®šã§ã™ã€‚

---

## ğŸ§© Part 2: variables.tf - å…¥åŠ›å¤‰æ•°ã®å®šç¾©

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå—ã‘å–ã‚‹å¤‰æ•°ã‚’å…¨éƒ¨è¦‹ã¦ã„ãã¾ã™ã€‚**å…¨10å€‹ã‚ã‚Šã¾ã™ã€‚**

### ğŸ—ºï¸ å…¨ä½“åƒ

```hcl title="modules/config-templating/variables.tfï¼ˆå®Œå…¨ç‰ˆï¼š59è¡Œï¼‰"
variable "starter_locations" {
  type        = list(string)
  description = "The default for Azure resources. (e.g 'uksouth')"
}

variable "starter_locations_short" {
  type        = map(string)
  default     = {}
  description = "Optional overrides for starter location short codes. Keys should match the built-in replacement names (for example 'starter_location_01_short', 'starter_location_02_short')."
}

variable "subscription_id_connectivity" {
  type        = string
  description = "value of the subscription id for the Connectivity subscription"
}

variable "subscription_id_identity" {
  type        = string
  description = "value of the subscription id for the Identity subscription"
}

variable "subscription_id_management" {
  type        = string
  description = "value of the subscription id for the Management subscription"
}

variable "subscription_id_security" {
  type        = string
  description = "value of the subscription id for the Security subscription"
}

variable "root_parent_management_group_id" {
  type        = string
  default     = ""
  description = "This is the id of the management group that the ALZ hierarchy will be nested under, will default to the Tenant Root Group"
}

variable "custom_replacements" {
  type = object({
    names                      = optional(map(string), {})
    resource_group_identifiers = optional(map(string), {})
    resource_identifiers       = optional(map(string), {})
  })
  description = "Custom replacements"
}

variable "inputs" {
  type        = any
  description = "A map of input variables to be used in the configuration templating module."
}

variable "enable_telemetry" {
  type        = bool
  default     = true
  description = <<DESCRIPTION
This variable controls whether or not telemetry is enabled for the module.
For more information see <https://aka.ms/avm/telemetryinfo>.
If it is set to false, then no telemetry will be collected.
DESCRIPTION
  nullable    = false
}
```

---

### å¤‰æ•°1: starter_locations

```hcl
variable "starter_locations" {
  type        = list(string)
  description = "The default for Azure resources. (e.g 'uksouth')"
}
```

**å½¹å‰²ğŸ“ï¼š** ãƒ¡ã‚¤ãƒ³ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒªã‚¹ãƒˆ

**å…·ä½“ä¾‹ï¼š**
```hcl
starter_locations = ["japaneast", "japanwest"]
```

**ä½¿ã‚ã‚Œæ–¹ï¼š**

- `starter_location_01` = "japaneast"
- `starter_location_02` = "japanwest"

ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

---

### å¤‰æ•°2: starter_locations_short

```hcl
variable "starter_locations_short" {
  type        = map(string)
  default     = {}
  description = "Optional overrides for starter location short codes."
}
```

**å½¹å‰²ğŸ“ï¼š** ãƒªãƒ¼ã‚¸ãƒ§ãƒ³çŸ­ç¸®åã®ã‚«ã‚¹ã‚¿ãƒ ä¸Šæ›¸ãï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**å…·ä½“ä¾‹ï¼š**
```hcl
starter_locations_short = {
  "starter_location_01_short" = "je"  # japaneast â†’ je ã«ã—ãŸã„
}
```

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼š**
ç©º`{}`ã®å ´åˆã€regionsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰è‡ªå‹•å–å¾—ï¼ˆ`jpe`ï¼‰ã€‚

---

### å¤‰æ•°3-6: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDï¼ˆ4ã¤ï¼‰

```hcl
variable "subscription_id_connectivity" {
  type        = string
  description = "value of the subscription id for the Connectivity subscription"
}

variable "subscription_id_identity" {
  type        = string
  description = "value of the subscription id for the Identity subscription"
}

variable "subscription_id_management" {
  type        = string
  description = "value of the subscription id for the Management subscription"
}

variable "subscription_id_security" {
  type        = string
  description = "value of the subscription id for the Security subscription"
}
```

**å½¹å‰²ğŸ“ï¼š** 4ã¤ã®å°‚ç”¨ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ID

| ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ | ç”¨é€” |
|-------------------|------|
| `connectivity` | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ï¼ˆHub VNetãªã©ï¼‰ |
| `identity` | IDç®¡ç†ï¼ˆADãªã©ï¼‰ |
| `management` | ç®¡ç†ãƒªã‚½ãƒ¼ã‚¹ï¼ˆLog Analyticsãªã©ï¼‰ |
| `security` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆSentinelã€Defenderãªã©ï¼‰ |

**å…·ä½“ä¾‹ï¼š**
```hcl
subscription_id_connectivity = "xxxx-xxxx-xxxx-xxxx"
subscription_id_identity     = "yyyy-yyyy-yyyy-yyyy"
subscription_id_management   = "zzzz-zzzz-zzzz-zzzz"
subscription_id_security     = "aaaa-aaaa-aaaa-aaaa"
```

ã“ã‚Œã‚‰ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§`$${subscription_id_connectivity}`ã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ã€‚

---

### å¤‰æ•°7: root_parent_management_group_id

```hcl
variable "root_parent_management_group_id" {
  type        = string
  default     = ""
  description = "This is the id of the management group that the ALZ hierarchy will be nested under, will default to the Tenant Root Group"
}
```

**å½¹å‰²ğŸ“ï¼š** ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ€ä¸Šä½è¦ªID

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼š**

- ç©ºæ–‡å­—`""`ã®å ´åˆ â†’ ãƒ†ãƒŠãƒ³ãƒˆãƒ«ãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨
- æŒ‡å®šã—ãŸå ´åˆ â†’ ãã®ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ã®é…ä¸‹ã«ä½œæˆ

**å…·ä½“ä¾‹ï¼š**
```hcl
# ä¾‹1: ãƒ†ãƒŠãƒ³ãƒˆãƒ«ãƒ¼ãƒˆé…ä¸‹ã«ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
root_parent_management_group_id = ""

# ä¾‹2: ã‚«ã‚¹ã‚¿ãƒ ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—é…ä¸‹ã«ä½œæˆ
root_parent_management_group_id = "mg-my-company"
```

---

### å¤‰æ•°8: custom_replacements

```hcl
variable "custom_replacements" {
  type = object({
    names                      = optional(map(string), {})
    resource_group_identifiers = optional(map(string), {})
    resource_identifiers       = optional(map(string), {})
  })
  description = "Custom replacements"
}
```

**å½¹å‰²ğŸ“ï¼š** ã‚«ã‚¹ã‚¿ãƒ ç½®æ›å¤‰æ•°ã®å®šç¾©

**3ã¤ã®ãƒ¬ãƒ™ãƒ«ï¼š**

1. **names**: åŸºæœ¬çš„ãªåå‰
2. **resource_group_identifiers**: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ•ãƒ«ãƒ‘ã‚¹
3. **resource_identifiers**: å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ•ãƒ«ãƒ‘ã‚¹

**å…·ä½“ä¾‹ï¼š**
```hcl
custom_replacements = {
  names = {
    firewall_name = "fw-$${starter_location_01}"
    # fw-japaneast ã«ç½®æ›ã•ã‚Œã‚‹
  }
  
  resource_group_identifiers = {
    connectivity_rg_id = "/subscriptions/$${subscription_id_connectivity}/resourceGroups/$${connectivity_resource_group_name}"
  }
  
  resource_identifiers = {
    firewall_id = "$${connectivity_rg_id}/providers/Microsoft.Network/azureFirewalls/$${firewall_name}"
  }
}
```

**éšå±¤çš„ã«ç½®æ›ã•ã‚Œã¾ã™ï¼š**
```text
names â†’ resource_group_identifiers â†’ resource_identifiers
```

---

### å¤‰æ•°9: inputs

```hcl
variable "inputs" {
  type        = any
  description = "A map of input variables to be used in the configuration templating module."
}
```

**å½¹å‰²ğŸ“ï¼š** ç½®æ›å¯¾è±¡ã®å…¨è¨­å®š

**å…·ä½“ä¾‹ï¼š**
```hcl
inputs = {
  management_groups_enabled = true
  connectivity_resource_groups = {
    vnet_primary = {
      name     = "rg-connectivity-$${starter_location_01}"
      location = "$${starter_location_01}"
    }
  }
}
```

**`any`å‹ã®æ„å‘³ğŸ“ï¼š**

ã©ã‚“ãªæ§‹é€ ã§ã‚‚OKã€‚ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯JSONåŒ–ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ›ã™ã‚‹ã ã‘ãªã®ã§ã€‚

---

### å¤‰æ•°10: enable_telemetry

```hcl
variable "enable_telemetry" {
  type        = bool
  default     = true
  description = <<DESCRIPTION
This variable controls whether or not telemetry is enabled for the module.
For more information see <https://aka.ms/avm/telemetryinfo>.
If it is set to false, then no telemetry will be collected.
DESCRIPTION
  nullable    = false
}
```

**å½¹å‰²ğŸ“ï¼š** ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªï¼ˆåˆ©ç”¨çµ±è¨ˆï¼‰ã®é€ä¿¡å¯å¦

**å€¤ï¼š**
- `true` ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: Microsoftã«åˆ©ç”¨çµ±è¨ˆã‚’é€ä¿¡
- `false`: é€ä¿¡ã—ãªã„

**`nullable = false`ã®æ„å‘³ğŸ“ï¼š**

`null`ã¯è¨±å¯ã—ãªã„ã€‚å¿…ãš`true`ã‹`false`ã‚’æŒ‡å®šã€‚

---

## ğŸ—ƒï¸ Part 3: data.tf - å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—

ç½®æ›ã«ä½¿ã†ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã¾ã™ã€‚

```hcl title="modules/config-templating/data.tf"
module "regions" {
  source           = "Azure/avm-utl-regions/azurerm"
  version          = "0.9.2"
  use_cached_data  = false
  enable_telemetry = var.enable_telemetry
}

data "azurerm_client_config" "current" {}
```

---

### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹1: regionsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```hcl
module "regions" {
  source           = "Azure/avm-utl-regions/azurerm"
  version          = "0.9.2"
  use_cached_data  = false
  enable_telemetry = var.enable_telemetry
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  

Azureã®å…¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æä¾›ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚

**å–å¾—ã§ãã‚‹æƒ…å ±ğŸ“ï¼š**
```hcl
module.regions.regions_by_name["japaneast"] = {
  name         = "japaneast"
  display_name = "Japan East"
  geo_code     = "jpe"     # 3æ–‡å­—ã®åœ°ç†ã‚³ãƒ¼ãƒ‰
  short_name   = "jpe"     # çŸ­ç¸®å
  # ...ãã®ä»–ã®æƒ…å ±
}
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ğŸ“ï¼š**

- `use_cached_data = false`: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
- `enable_telemetry`: å¤‰æ•°ã‹ã‚‰å—ã‘ç¶™ã

**ä½¿ç”¨ä¾‹ï¼š**
```hcl
# japaneastã®çŸ­ç¸®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
module.regions.regions_by_name["japaneast"].geo_code
# çµæœ: "jpe"
```

---

### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹2: azurerm_client_config

```hcl
data "azurerm_client_config" "current" {}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®Azureç’°å¢ƒæƒ…å ±ã‚’å–å¾—ã€‚

**å–å¾—ã•ã‚Œã‚‹æƒ…å ±ğŸ“ï¼š**
```hcl
data.azurerm_client_config.current = {
  tenant_id       = "xxxx-xxxx-xxxx-xxxx"  # ãƒ†ãƒŠãƒ³ãƒˆID
  subscription_id = "yyyy-yyyy-yyyy-yyyy"  # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ID
  client_id       = "zzzz-zzzz-zzzz-zzzz"  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
  object_id       = "aaaa-aaaa-aaaa-aaaa"  # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆID
}
```

**ãªãœå¿…è¦ï¼ŸğŸ¤”**  
`root_parent_management_group_id`ãŒæœªæŒ‡å®šã®å ´åˆã€ãƒ†ãƒŠãƒ³ãƒˆIDã‚’ä½¿ã„ã¾ã™ã€‚

---

## ğŸ§¬ Part 4: locals.config.tf - ç½®æ›ãƒ­ã‚¸ãƒƒã‚¯ã®æ ¸å¿ƒ

ã“ã“ãŒã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¿ƒè‡“éƒ¨ã§ã™ã€‚

### ğŸ—ºï¸ å…¨ä½“ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TB
    A[starter_locations] --> B[starter_locations_short]
    B --> C[built_in_replacements]
    C --> D[custom_names]
    D --> E[custom_name_replacements]
    E --> F[custom_resource_group_identifiers]
    F --> G[custom_resource_group_replacements]
    G --> H[custom_resource_identifiers]
    H --> I[final_replacements]
    I --> J[outputs]
    
    style A fill:#e1f5ff
    style C fill:#ffe1e1
    style E fill:#ffe1e1
    style G fill:#ffe1e1
    style I fill:#ffe1e1
    style J fill:#e1ffe1
```

---

### ã‚¹ãƒ†ãƒƒãƒ—1: starter_locationsã®ãƒãƒƒãƒ—åŒ–

```hcl title="locals.config.tfï¼ˆ1-3è¡Œç›®ï¼‰"
locals {
  starter_locations = { for i, location in var.starter_locations : "starter_location_${format("%02d", i + 1)}" => location }
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ãƒªã‚¹ãƒˆã‚’ãƒãƒƒãƒ—ã«å¤‰æ›ã€‚

**å…·ä½“ä¾‹ï¼š**
```hcl
# å…¥åŠ›
var.starter_locations = ["japaneast", "japanwest"]

# å‡ºåŠ›
local.starter_locations = {
  "starter_location_01" = "japaneast"
  "starter_location_02" = "japanwest"
}
```

**`format("%02d", i + 1)`ã®æ„å‘³ğŸ“ï¼š**

- `i`ã¯0å§‹ã¾ã‚Š
- `i + 1`ã§1å§‹ã¾ã‚Šã«
- `%02d`ã§2æ¡ã‚¼ãƒ­åŸ‹ã‚ï¼ˆ01, 02, ...ï¼‰

---

### ã‚¹ãƒ†ãƒƒãƒ—2: çŸ­ç¸®åã®ç”Ÿæˆ

```hcl title="locals.config.tfï¼ˆ4-16è¡Œç›®ï¼‰"
  starter_locations_short = {
    for i, location in var.starter_locations :
    "starter_location_${format("%02d", i + 1)}_short" => coalesce(
      # 1. User override (if provided)
      try(var.starter_locations_short["starter_location_${format("%02d", i + 1)}_short"], null),
      # 2. Official geo_code from regions module
      try(module.regions.regions_by_name[location].geo_code, null),
      # 3. Calculated short_name from regions module
      try(module.regions.regions_by_name[location].short_name, null),
      # 4. Last resort: full region name
      location
    )
  }
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®çŸ­ç¸®åã‚’ä½œæˆã€‚4æ®µéšã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚

**coalesceã®ä»•çµ„ã¿ğŸ“ï¼š**
```hcl
coalesce(å€¤1, å€¤2, å€¤3, å€¤4)
# æœ€åˆã«è¦‹ã¤ã‹ã£ãŸnullã§ãªã„å€¤ã‚’è¿”ã™
```

**å„ªå…ˆé †ä½ï¼š**

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š**ï¼š`var.starter_locations_short`ã«ã‚ã‚Œã°ä½¿ã†
2. **geo_code**ï¼šregionsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¬å¼åœ°ç†ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: `jpe`ï¼‰
3. **short_name**ï¼šregionsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çŸ­ç¸®å
4. **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åãã®ã¾ã¾**ï¼šæœ€å¾Œã®æ‰‹æ®µ

**å…·ä½“ä¾‹ï¼š**
```hcl
# japaneastã®å ´åˆ
var.starter_locations_short = {}  # ç©º

# å‡¦ç†
try(var.starter_locations_short["starter_location_01_short"], null)  # â†’ nullï¼ˆå­˜åœ¨ã—ãªã„ï¼‰
try(module.regions.regions_by_name["japaneast"].geo_code, null)      # â†’ "jpe" â†æ¡ç”¨ï¼
# ä»¥é™ã¯ã‚¹ã‚­ãƒƒãƒ—

# çµæœ
starter_location_01_short = "jpe"
```

**ãªãœ`try()`ã‚’ä½¿ã†ï¼ŸğŸ¤”**  
å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€`try()`ã§`null`ã«å¤‰æ›ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—3: built_in_replacementsã®ä½œæˆ

```hcl title="locals.config.tfï¼ˆ17-27è¡Œç›®ï¼‰"
  built_in_replacements = merge(
    local.starter_locations,
    local.starter_locations_short,
    {
      root_parent_management_group_id = var.root_parent_management_group_id == "" ? data.azurerm_client_config.current.tenant_id : var.root_parent_management_group_id
      subscription_id_connectivity    = var.subscription_id_connectivity
      subscription_id_identity        = var.subscription_id_identity
      subscription_id_management      = var.subscription_id_management
      subscription_id_security        = var.subscription_id_security
  })
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
çµ„ã¿è¾¼ã¿å¤‰æ•°ã‚’ã™ã¹ã¦1ã¤ã®ãƒãƒƒãƒ—ã«çµ±åˆã€‚

**merge()ã®å‹•ä½œğŸ“ï¼š**
```hcl
merge(ãƒãƒƒãƒ—1, ãƒãƒƒãƒ—2, ãƒãƒƒãƒ—3)
# ã™ã¹ã¦ã®ã‚­ãƒ¼ã‚’1ã¤ã®ãƒãƒƒãƒ—ã«çµåˆ
```

**çµæœã®ä¸­èº«ï¼š**
```hcl
local.built_in_replacements = {
  # ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  "starter_location_01"       = "japaneast"
  "starter_location_02"       = "japanwest"
  
  # çŸ­ç¸®å
  "starter_location_01_short" = "jpe"
  "starter_location_02_short" = "jpw"
  
  # ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—
  "root_parent_management_group_id" = "ãƒ†ãƒŠãƒ³ãƒˆIDã¾ãŸã¯æŒ‡å®šå€¤"
  
  # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ID
  "subscription_id_connectivity" = "xxxx-xxxx"
  "subscription_id_identity"     = "yyyy-yyyy"
  "subscription_id_management"   = "zzzz-zzzz"
  "subscription_id_security"     = "aaaa-aaaa"
}
```

**ä¸‰é …æ¼”ç®—å­ã®å‡¦ç†ğŸ“ï¼š**
```hcl
var.root_parent_management_group_id == "" 
  ? data.azurerm_client_config.current.tenant_id 
  : var.root_parent_management_group_id
```

- ç©ºæ–‡å­— â†’ ãƒ†ãƒŠãƒ³ãƒˆIDã‚’ä½¿ç”¨
- å€¤ã‚ã‚Š â†’ ãã®å€¤ã‚’ä½¿ç”¨

---

### ã‚¹ãƒ†ãƒƒãƒ—4: custom_namesã®å‡¦ç†

```hcl title="locals.config.tfï¼ˆ29-34è¡Œç›®ï¼‰"
# Custom name replacements
locals {
  custom_names_json           = replace(replace(tostring(jsonencode(var.custom_replacements.names)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
  custom_names_json_templated = templatestring(local.custom_names_json, local.built_in_replacements)
  custom_names_json_final     = replace(replace(replace(replace(local.custom_names_json_templated, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"")
  custom_names                = jsondecode(local.custom_names_json_final)
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ã‚«ã‚¹ã‚¿ãƒ åã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ›ã‚’é©ç”¨ã€‚

**ãªãœè¤‡é›‘ï¼ŸğŸ¤”**  
`templatestring()`é–¢æ•°ãŒ`true`/`false`ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã£ã¦ã—ã¾ã†ãŸã‚ã€ç‰¹æ®Šå‡¦ç†ãŒå¿…è¦ã€‚

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ğŸ“ï¼š**

1. **JSONåŒ–**: `jsonencode()` â†’ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONæ–‡å­—åˆ—ã«
2. **ãƒ–ãƒ¼ãƒ«å€¤ä¿è­·**: `"true"` â†’ `"{{string_true}}"`
3. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ›**: `templatestring()` â†’ `$${xxx}`ã‚’ç½®æ›
4. **ãƒ–ãƒ¼ãƒ«å€¤å¾©å…ƒ**: `"{{string_true}}"` â†’ `"true"`
5. **JSONè§£æ**: `jsondecode()` â†’ æ–‡å­—åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™

**å…·ä½“ä¾‹ï¼š**

```hcl title="å…¥åŠ›"
var.custom_replacements.names = {
  firewall_enabled = true
  firewall_name = "fw-$${starter_location_01}"
}
```

```hcl title="å‡¦ç†éç¨‹"
# 1. JSONåŒ–
'{"firewall_enabled":"true","firewall_name":"fw-$${starter_location_01}"}'

# 2. ãƒ–ãƒ¼ãƒ«å€¤ä¿è­·
'{"firewall_enabled":"{{string_true}}","firewall_name":"fw-$${starter_location_01}"}'

# 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ›
'{"firewall_enabled":"{{string_true}}","firewall_name":"fw-japaneast"}'

# 4. ãƒ–ãƒ¼ãƒ«å€¤å¾©å…ƒ
'{"firewall_enabled":"true","firewall_name":"fw-japaneast"}'

# 5. JSONè§£æ
{
  firewall_enabled = true
  firewall_name = "fw-japaneast"
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—5: custom_name_replacementsã®ä½œæˆ

```hcl title="locals.config.tfï¼ˆ36-38è¡Œç›®ï¼‰"
locals {
  custom_name_replacements = merge(local.built_in_replacements, local.custom_names)
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
çµ„ã¿è¾¼ã¿å¤‰æ•°ã¨ã‚«ã‚¹ã‚¿ãƒ åã‚’çµ±åˆã€‚

**çµæœï¼š**
```hcl
{
  # built_in_replacements
  "starter_location_01" = "japaneast"
  "subscription_id_connectivity" = "xxxx-xxxx"
  # ...
  
  # custom_names
  "firewall_enabled" = true
  "firewall_name" = "fw-japaneast"
}
```

ã“ã®æ™‚ç‚¹ã§`$${firewall_name}`ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—6: custom_resource_group_identifiersã®å‡¦ç†

```hcl title="locals.config.tfï¼ˆ40-45è¡Œç›®ï¼‰"
# Custom resource group identifiers
locals {
  custom_resource_group_identifiers_json           = replace(replace(tostring(jsonencode(var.custom_replacements.resource_group_identifiers)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
  custom_resource_group_identifiers_json_templated = templatestring(local.custom_resource_group_identifiers_json, local.custom_name_replacements)
  custom_resource_group_identifiers_json_final     = replace(replace(replace(replace(local.custom_resource_group_identifiers_json_templated, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"")
  custom_resource_group_identifiers                = jsondecode(local.custom_resource_group_identifiers_json_final)
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’ç”Ÿæˆã€‚

**ã‚¹ãƒ†ãƒƒãƒ—4ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š**

JSONåŒ– â†’ ãƒ–ãƒ¼ãƒ«å€¤ä¿è­· â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ› â†’ ãƒ–ãƒ¼ãƒ«å€¤å¾©å…ƒ â†’ JSONè§£æ

**å…·ä½“ä¾‹ï¼š**
```hcl title="å…¥åŠ›"
var.custom_replacements.resource_group_identifiers = {
  connectivity_rg_id = "/subscriptions/$${subscription_id_connectivity}/resourceGroups/$${connectivity_resource_group_name}"
}
```

```hcl title="å‡ºåŠ›"
{
  connectivity_rg_id = "/subscriptions/xxxx-xxxx/resourceGroups/rg-connectivity-japaneast"
}
```

**å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œã£ãŸå¤‰æ•°ã‚’ä½¿ãˆã‚‹ï¼š

- `$${subscription_id_connectivity}` â† built_in_replacements
- `$${connectivity_resource_group_name}` â† custom_names

---

### ã‚¹ãƒ†ãƒƒãƒ—7: custom_resource_group_replacementsã®ä½œæˆ

```hcl title="locals.config.tfï¼ˆ47-49è¡Œç›®ï¼‰"
locals {
  custom_resource_group_replacements = merge(local.custom_name_replacements, local.custom_resource_group_identifiers)
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ã‚«ã‚¹ã‚¿ãƒ åã¨RGãƒ‘ã‚¹ã‚’çµ±åˆã€‚

**çµæœï¼š**
```hcl
{
  # custom_name_replacements
  "firewall_name" = "fw-japaneast"
  # ...
  
  # custom_resource_group_identifiers
  "connectivity_rg_id" = "/subscriptions/xxxx/resourceGroups/rg-connectivity-japaneast"
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—8: custom_resource_identifiersã®å‡¦ç†

```hcl title="locals.config.tfï¼ˆ51-56è¡Œç›®ï¼‰"
# Custom resource identifiers
locals {
  custom_resource_identifiers_json           = replace(replace(tostring(jsonencode(var.custom_replacements.resource_identifiers)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}")
  custom_resource_identifiers_json_templated = templatestring(local.custom_resource_identifiers_json, local.custom_resource_group_replacements)
  custom_resource_identifiers_json_final     = replace(replace(replace(replace(local.custom_resource_identifiers_json_templated, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"")
  custom_resource_identifiers                = jsondecode(local.custom_resource_identifiers_json_final)
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’ç”Ÿæˆã€‚

**å…·ä½“ä¾‹ï¼š**
```hcl title="å…¥åŠ›"
var.custom_replacements.resource_identifiers = {
  firewall_id = "$${connectivity_rg_id}/providers/Microsoft.Network/azureFirewalls/$${firewall_name}"
}
```

```hcl title="å‡ºåŠ›"
{
  firewall_id = "/subscriptions/xxxx/resourceGroups/rg-connectivity-japaneast/providers/Microsoft.Network/azureFirewalls/fw-japaneast"
}
```

**å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œã£ãŸå¤‰æ•°ã‚’ä½¿ãˆã‚‹ï¼š

- `$${connectivity_rg_id}` â† custom_resource_group_identifiers
- `$${firewall_name}` â† custom_names

---

### ã‚¹ãƒ†ãƒƒãƒ—9: final_replacementsã®ä½œæˆ

```hcl title="locals.config.tfï¼ˆ58-60è¡Œç›®ï¼‰"
locals {
  final_replacements = merge(local.custom_resource_group_replacements, local.custom_resource_identifiers)
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ã™ã¹ã¦ã®ç½®æ›å¤‰æ•°ã‚’1ã¤ã®ãƒãƒƒãƒ—ã«çµ±åˆã€‚

**æœ€çµ‚çš„ãªå†…å®¹ï¼š**
```hcl
{
  # built_in_replacements
  "starter_location_01" = "japaneast"
  "subscription_id_connectivity" = "xxxx-xxxx"
  
  # custom_names
  "firewall_name" = "fw-japaneast"
  
  # resource_group_identifiers
  "connectivity_rg_id" = "/subscriptions/xxxx/resourceGroups/..."
  
  # resource_identifiers
  "firewall_id" = "/subscriptions/xxxx/resourceGroups/.../providers/..."
}
```

**éšå±¤æ§‹é€ ã®å®ŒæˆğŸ§©ï¼š**
```text
çµ„ã¿è¾¼ã¿å¤‰æ•°
  â†“
ã‚«ã‚¹ã‚¿ãƒ åï¼ˆçµ„ã¿è¾¼ã¿ã‚’å‚ç…§å¯èƒ½ï¼‰
  â†“
RGãƒ‘ã‚¹ï¼ˆã‚«ã‚¹ã‚¿ãƒ åã‚’å‚ç…§å¯èƒ½ï¼‰
  â†“
ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆRGãƒ‘ã‚¹ã‚’å‚ç…§å¯èƒ½ï¼‰
```

---

### ã‚¹ãƒ†ãƒƒãƒ—10: outputsã®ç”Ÿæˆ

```hcl title="locals.config.tfï¼ˆ62-67è¡Œç›®ï¼‰"
locals {
  outputs_json           = { for key, value in var.inputs : key => replace(replace(tostring(jsonencode(value)), "\"true\"", "{{string_true}}"), "\"false\"", "{{string_false}}") }
  outputs_json_templated = { for key, value in local.outputs_json : key => templatestring(value, local.final_replacements) }
  outputs_json_final     = { for key, value in local.outputs_json_templated : key => replace(replace(replace(replace(value, "\"true\"", "true"), "\"false\"", "false"), "{{string_true}}", "\"true\""), "{{string_false}}", "\"false\"") }
  outputs                = { for key, value in local.outputs_json_final : key => jsondecode(value) }
}
```

**ä½•ã—ã¦ã‚‹ï¼ŸğŸ§**  
ã™ã¹ã¦ã®å…¥åŠ›è¨­å®šã«å¯¾ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç½®æ›ã‚’å®Ÿè¡Œã€‚

**forå¼ã®æ§‹é€ ğŸ“ï¼š**
```hcl
{ for key, value in var.inputs : key => å‡¦ç†(value) }
```

å„è¨­å®šã«å¯¾ã—ã¦åŒã˜å‡¦ç†ï¼ˆJSONåŒ– â†’ ãƒ–ãƒ¼ãƒ«å€¤ä¿è­· â†’ ç½®æ› â†’ ãƒ–ãƒ¼ãƒ«å€¤å¾©å…ƒ â†’ JSONè§£æï¼‰ã‚’å®Ÿè¡Œã€‚

**å…·ä½“ä¾‹ï¼š**
```hcl title="å…¥åŠ›"
var.inputs = {
  connectivity_resource_groups = {
    vnet_primary = {
      name     = "rg-connectivity-$${starter_location_01}"
      location = "$${starter_location_01}"
    }
  }
}
```

```hcl title="å‡ºåŠ›"
local.outputs = {
  connectivity_resource_groups = {
    vnet_primary = {
      name     = "rg-connectivity-japaneast"
      location = "japaneast"
    }
  }
}
```

---

## Part 5: outputs.tf - å‡¦ç†çµæœã®å‡ºåŠ›

æœ€å¾Œã«ã€å‡¦ç†æ¸ˆã¿ã®è¨­å®šã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```hcl title="modules/config-templating/outputs.tfï¼ˆå®Œå…¨ç‰ˆï¼š6è¡Œï¼‰"
output "custom_replacements" {
  value = local.final_replacements
}

output "outputs" {
  value = local.outputs
}
```

---

### output 1: custom_replacements

```hcl
output "custom_replacements" {
  value = local.final_replacements
}
```

**ä½•ã‚’å‡ºåŠ›ï¼ŸğŸ§**  
ã™ã¹ã¦ã®ç½®æ›å¤‰æ•°ã®ãƒãƒƒãƒ—ã€‚

**å…·ä½“ä¾‹ï¼š**
```hcl
{
  "starter_location_01"            = "japaneast"
  "starter_location_01_short"      = "jpe"
  "subscription_id_connectivity"   = "xxxx-xxxx"
  "firewall_name"                  = "fw-japaneast"
  "connectivity_rg_id"             = "/subscriptions/xxxx/..."
  "firewall_id"                    = "/subscriptions/xxxx/.../providers/..."
}
```

**ç”¨é€”ï¼š**

- ãƒ‡ãƒãƒƒã‚°ï¼šã©ã‚“ãªå¤‰æ•°ãŒä½¿ãˆã‚‹ã‹ç¢ºèª
- ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®å¼•ãç¶™ã

---

### output 2: outputs

```hcl
output "outputs" {
  value = local.outputs
}
```

**ä½•ã‚’å‡ºåŠ›ï¼ŸğŸ§**  
ç½®æ›æ¸ˆã¿ã®å…¨è¨­å®šã€‚

**å…·ä½“ä¾‹ï¼š**
```hcl
{
  management_groups_enabled = true
  connectivity_resource_groups = {
    vnet_primary = {
      name     = "rg-connectivity-japaneast"
      location = "japaneast"
    }
  }
  hub_virtual_networks = {
    primary = {
      name                = "vnet-hub-japaneast"
      resource_group_name = "rg-connectivity-japaneast"
      # ...
    }
  }
}
```

**ç”¨é€”ï¼š**
ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ä½¿ç”¨ã™ã‚‹æœ€çµ‚è¨­å®šã€‚

---

## ğŸ› ï¸ Part 6: å®Ÿè·µ - ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã®è¿½åŠ 

å®Ÿéš›ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ã‚·ãƒŠãƒªã‚ª: ç’°å¢ƒåã‚’è¿½åŠ ã—ãŸã„

**è¦ä»¶ğŸ“ï¼š**

- `dev`, `stg`, `prod`ã®ã‚ˆã†ãªç’°å¢ƒåã‚’ãƒªã‚½ãƒ¼ã‚¹åã«å«ã‚ãŸã„
- ä¾‹: `rg-connectivity-dev-japaneast`

---

### æ‰‹é †1: custom_replacementsã«ç’°å¢ƒåã‚’è¿½åŠ 

```hcl title="platform-landing-zone.auto.tfvars"
custom_replacements = {
  names = {
    # ç’°å¢ƒåã‚’å®šç¾©
    environment = "dev"
    
    # ã“ã®ç’°å¢ƒåã‚’ä½¿ã£ã¦åå‰ã‚’å®šç¾©
    connectivity_resource_group_name = "rg-connectivity-$${environment}-$${starter_location_01}"
    hub_vnet_name = "vnet-hub-$${environment}-$${starter_location_01}"
  }
}
```

---

### æ‰‹é †2: ä»–ã®è¨­å®šã§ä½¿ç”¨

```hcl title="platform-landing-zone.auto.tfvars"
connectivity_resource_groups = {
  vnet_primary = {
    name     = "$${connectivity_resource_group_name}"
    location = "$${starter_location_01}"
  }
}

hub_virtual_networks = {
  primary = {
    name                = "$${hub_vnet_name}"
    resource_group_name = "$${connectivity_resource_group_name}"
    location            = "$${starter_location_01}"
    # ...
  }
}
```

---

### æ‰‹é †3: ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
terraform plan
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœï¼š**
```text
+ resource_group "vnet_primary" {
    name     = "rg-connectivity-dev-japaneast"
    location = "japaneast"
  }

+ virtual_network "primary" {
    name                = "vnet-hub-dev-japaneast"
    resource_group_name = "rg-connectivity-dev-japaneast"
  }
```

ç’°å¢ƒåãŒå«ã¾ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ï¼

---

### æ‰‹é †4: ç’°å¢ƒã®åˆ‡ã‚Šæ›¿ãˆ

```hcl title="stgç’°å¢ƒã«åˆ‡ã‚Šæ›¿ãˆ"
custom_replacements = {
  names = {
    environment = "stg"  # devã‹ã‚‰stgã«å¤‰æ›´
    # ä»¥ä¸‹åŒã˜
    connectivity_resource_group_name = "rg-connectivity-$${environment}-$${starter_location_01}"
    hub_vnet_name = "vnet-hub-$${environment}-$${starter_location_01}"
  }
}
```

**çµæœï¼š**
```text
rg-connectivity-stg-japaneast
vnet-hub-stg-japaneast
```

ã“ã®1ç®‡æ‰€ã‚’å¤‰ãˆã‚‹ã ã‘ã§ã€ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹åãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ï¼âœ¨

---

## ğŸ“ ã¾ã¨ã‚

**config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²**ï¼š

1. **terraform.tf**: Terraform 1.12ä»¥ä¸Šã€azurerm 4.xä»¥ä¸Šã‚’è¦æ±‚
2. **variables.tf**: 10å€‹ã®å…¥åŠ›å¤‰æ•°ã‚’å®šç¾©
3. **data.tf**: regionsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨client_configã§ãƒ‡ãƒ¼ã‚¿å–å¾—
4. **locals.config.tf**: 10ã‚¹ãƒ†ãƒƒãƒ—ã®ç½®æ›å‡¦ç†
5. **outputs.tf**: ç½®æ›å¤‰æ•°ã¨ç½®æ›æ¸ˆã¿è¨­å®šã‚’å‡ºåŠ›

**å‡¦ç†ã®æµã‚ŒğŸ› ï¸**ï¼š

- regionsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
- client_configã§ç¾åœ¨ã®Azureèªè¨¼æƒ…å ±ã‚’å–å¾—
- 10ã‚¹ãƒ†ãƒƒãƒ—ã®æ®µéšçš„ãªå¤‰æ•°ç½®æ›ã‚’å®Ÿè¡Œ
- å„ã‚¹ãƒ†ãƒƒãƒ—ã§å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’æ´»ç”¨
- JSONå‡¦ç†ã§ãƒ–ãƒ¼ãƒ«å€¤ã‚’ä¿è­·
- æœ€çµ‚çš„ã«å…¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ•°ã‚’ç½®æ›

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆğŸ“**ï¼š

- æ®µéšçš„å‡¦ç†ã§10ã‚¹ãƒ†ãƒƒãƒ—ã®å¤‰æ•°ç½®æ›
- ãƒ–ãƒ¼ãƒ«å€¤ã¯JSONå‡¦ç†ã§ä¿è­·ï¼ˆtrue/falseãŒæ–‡å­—åˆ—ã«ãªã‚‰ãªã„ï¼‰
- coalesceã§4æ®µéšã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå„ªå…ˆé †ä½ä»˜ãï¼‰
- forå¼ã§å…¨è¨­å®šã«ä¸€æ‹¬å‡¦ç†
- éšå±¤çš„ç½®æ›ãŒå¯èƒ½ï¼ˆå¾Œã®å¤‰æ•°ãŒå‰ã®å¤‰æ•°ã‚’å‚ç…§ï¼‰



---

## ğŸ‹ï¸â€â™‚ï¸ ç·´ç¿’å•é¡Œ

ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚

### â“ å•é¡Œ1
config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸»ãªå½¹å‰²ã¯ä½•ã§ã™ã‹ï¼Ÿ

### â“ å•é¡Œ2
ä»¥ä¸‹ã®å¤‰æ•°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯ã€ã©ã®ã‚ˆã†ã«ç½®æ›ã•ã‚Œã¾ã™ã‹ï¼Ÿ

```hcl
location = "$${starter_location_01}"
```

### â“ å•é¡Œ3
`locals.config.tf`ã§è¡Œã‚ã‚Œã‚‹10ã‚¹ãƒ†ãƒƒãƒ—ã®å‡¦ç†ã®ã†ã¡ã€æœ€åˆã®3ã‚¹ãƒ†ãƒƒãƒ—ã¯ä½•ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ

### â“ å•é¡Œ4
ãªãœãƒ–ãƒ¼ãƒ«å€¤ï¼ˆtrue/falseï¼‰ã‚’JSONå‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ã‹ï¼Ÿ

---

## ğŸ“ ç·´ç¿’å•é¡Œã®ç­”ãˆ

### ğŸ’¡ ç­”ãˆ1

config-templatingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸»ãªå½¹å‰²ã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å¤‰æ•°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆ`$${å¤‰æ•°å}`ï¼‰ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›ã™ã‚‹ã“ã¨ã§ã™ã€‚

ä¾‹ï¼š

- `$${starter_location_01}` â†’ `japaneast`
- `$${subscription_id_management}` â†’ `12345678-1234-1234-1234-123456789012`

ã“ã‚Œã«ã‚ˆã‚Šã€åŒã˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ç•°ãªã‚‹ç’°å¢ƒã‚’ç°¡å˜ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚

### ğŸ’¡ ç­”ãˆ2
`$${starter_location_01}`ã¯ã€`variables.tf`ã§å®šç¾©ã•ã‚ŒãŸ`starter_locations`é…åˆ—ã®æœ€åˆã®è¦ç´ ã«ç½®æ›ã•ã‚Œã¾ã™ã€‚

å‡¦ç†ã®æµã‚Œï¼š

1. `var.starter_locations = ["japaneast", "japanwest"]`
2. `local.starter_locations[0] = "japaneast"`
3. `$${starter_location_01}` â†’ `"japaneast"`

### ğŸ’¡ ç­”ãˆ3
æœ€åˆã®3ã‚¹ãƒ†ãƒƒãƒ—ã¯ï¼š

**ã‚¹ãƒ†ãƒƒãƒ—1: starter_locations**

- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é…åˆ—ã®ä½œæˆ
- ä¾‹ï¼š`["japaneast", "japanwest"]`

**ã‚¹ãƒ†ãƒƒãƒ—2: starter_locations_short**

- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®çŸ­ç¸®åã‚’æ±ºå®š
- ä¾‹ï¼š`["jpe", "jpw"]`

**ã‚¹ãƒ†ãƒƒãƒ—3: built_in_replacements**

- çµ„ã¿è¾¼ã¿å¤‰æ•°ã®ç½®æ›ãƒãƒƒãƒ—ã‚’ä½œæˆ
- ä¾‹ï¼š`starter_location_01 = "japaneast"`
- ã“ã®æ®µéšã§30å€‹ä»¥ä¸Šã®å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã‚‹

### ğŸ’¡ ç­”ãˆ4

ãƒ–ãƒ¼ãƒ«å€¤ã‚’é€šå¸¸ã®æ–‡å­—åˆ—ç½®æ›ã§å‡¦ç†ã™ã‚‹ã¨ã€`true`ãŒ`"true"`ï¼ˆæ–‡å­—åˆ—ï¼‰ã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚

**å•é¡Œä¾‹**ï¼š
```hcl
enabled = $${some_boolean}
â†“ é€šå¸¸ã®ç½®æ›ã ã¨
enabled = "true"  # âŒ æ–‡å­—åˆ—ã«ãªã‚‹
```

**JSONå‡¦ç†ã™ã‚‹ã¨**ï¼š
```hcl
enabled = $${some_boolean}
â†“ JSONå‡¦ç†ã§
enabled = true  # âœ… ãƒ–ãƒ¼ãƒ«å€¤ã®ã¾ã¾
```

Terraformã¯ãƒ–ãƒ¼ãƒ«å€¤ã¨æ–‡å­—åˆ—ã‚’å³å¯†ã«åŒºåˆ¥ã™ã‚‹ãŸã‚ã€æ­£ã—ã„å‹ã‚’ä¿ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

æ¬¡ã®Chapterã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆã‚’è¦‹ã¦ã„ãã¾ã™ã€‚å®Ÿéš›ã®Azureãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã ã‚ˆã€‚

---

**æ‰€è¦æ™‚é–“**: 60åˆ†  
**é›£æ˜“åº¦**: â˜…â˜…â˜…â˜…â˜†  
**å‰**: [07_ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°.md](./07_ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°.md)  
**æ¬¡**: [09_ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—.md](./09_ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—.md)
